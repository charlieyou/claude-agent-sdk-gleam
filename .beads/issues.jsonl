{"id":"casg-axf","title":"Epic 4: Integration Tests","description":"## Overview\nImplement opt-in integration tests that validate the SDK against the real Claude CLI. These tests are gated by CLAUDE_INTEGRATION_TEST=1 environment variable.\n\n## Why This is Critical\n- Unit tests can't validate real CLI behavior\n- Integration tests catch CLI version incompatibilities\n- Preflight checks provide actionable skip messages\n\n## Scope\n1. **Preflight Checks** (test/query_integration_test.gleam):\n   - CLI exists in PATH check\n   - Version detection with timeout\n   - Auth detection (API key or claude login)\n   - Required flags presence check\n\n2. **Real CLI Query Tests**:\n   - integration__real_cli_query_test\n   - integration__session_resume_test\n   - integration__ndjson_purity_test\n\n3. **Error Scenario Tests**:\n   - CLI not found behavior\n   - Version too old behavior\n   - Unauthenticated CLI behavior\n\n4. **Integration Test Helpers**:\n   - integration_enabled() gate function\n   - is_authenticated() check\n   - Timeout protection (30s max)\n\n## Success Criteria\n- Tests skip cleanly when CLAUDE_INTEGRATION_TEST not set\n- Tests produce [SKIP] messages visible in output\n- Preflight catches environment issues before test failures\n- All real CLI tests pass when environment is correct\n\n## Dependencies\n- Depends on Epic 2 (query() must work)\n- Depends on Epic 3 (test helpers)\n\n## Plan References\n- Integration Test Gating section\n- Auth detection for query tests\n- Skip hierarchy (recommended)","status":"open","priority":2,"issue_type":"epic","created_at":"2026-01-10T23:19:44.997721494Z","created_by":"cyou","updated_at":"2026-01-10T23:19:44.997721494Z","dependencies":[{"issue_id":"casg-axf","depends_on_id":"casg-j37","type":"blocks","created_at":"2026-01-10T23:19:52.23413379Z","created_by":"cyou"},{"issue_id":"casg-axf","depends_on_id":"casg-tc3","type":"blocks","created_at":"2026-01-10T23:19:52.29006719Z","created_by":"cyou"}]}
{"id":"casg-axf.1","title":"Integration test file skeleton + integration_enabled() helper","description":"## Overview\nCreate the integration test file skeleton with the core gating helper function.\n\n## Deliverables\n\n### File: `test/query_integration_test.gleam`\n\n```gleam\n// In test/query_integration_test.gleam\nimport support/env_helpers.{get_env}\nimport gleam/io\nimport gleeunit/should\n\n/// Helper: Check if integration tests are enabled and log skip if not.\n/// Returns True if tests should run, False if skipped.\nfn integration_enabled(test_name: String) -\u003e Bool {\n  case get_env(\"CLAUDE_INTEGRATION_TEST\") {\n    Ok(\"1\") -\u003e True\n    _ -\u003e {\n      io.println(\"[SKIP] \" \u003c\u003e test_name \u003c\u003e \" (set CLAUDE_INTEGRATION_TEST=1 to run)\")\n      False\n    }\n  }\n}\n```\n\n## Acceptance Criteria\n- [ ] File exists at `test/query_integration_test.gleam`\n- [ ] `integration_enabled()` returns `True` when `CLAUDE_INTEGRATION_TEST=1`\n- [ ] `integration_enabled()` returns `False` and prints skip message otherwise\n- [ ] Skip message format: `[SKIP] test_name (set CLAUDE_INTEGRATION_TEST=1 to run)`\n- [ ] File compiles with `gleam build`\n\n## Test Contract\n- Tests SKIP by default (no env var set)\n- All integration tests use `integration__` prefix for easy grep","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-10T23:21:23.835633381Z","created_by":"cyou","updated_at":"2026-01-10T23:21:23.835633381Z","dependencies":[{"issue_id":"casg-axf.1","depends_on_id":"casg-axf","type":"parent-child","created_at":"2026-01-10T23:21:23.836185558Z","created_by":"cyou"}]}
{"id":"casg-axf.2","title":"Preflight checks and is_authenticated() helper","description":"## Overview\nImplement preflight checks that validate the environment before running integration tests.\n\n## Deliverables\n\n### Helper: `is_authenticated() -\u003e Bool`\n\n```gleam\nfn is_authenticated() -\u003e Bool {\n  // Check 1: ANTHROPIC_API_KEY in environment (preferred - no subprocess)\n  case get_env(\"ANTHROPIC_API_KEY\") {\n    Ok(_) -\u003e True\n    _ -\u003e\n      // Check 2: `claude auth status` with 5s timeout (if CLI supports it)\n      case run_with_timeout(\"claude\", [\"auth\", \"status\"], 5000) {\n        Ok(output) if string.contains(output, \"authenticated\") -\u003e True\n        _ -\u003e False  // Timeout, unsupported command, or not authenticated\n      }\n  }\n}\n```\n\n### Test: `integration__preflight_check_test`\n\n```gleam\npub fn integration__preflight_check_test() {\n  case integration_enabled(\"integration__preflight_check_test\") {\n    True -\u003e {\n      // 1. CLI exists and version is parseable\n      case find_executable(\"claude\") {\n        Error(_) -\u003e {\n          io.println(\"[SKIP:ENV] claude not in PATH - install CLI first\")\n          should.be_true(True)  // Skip, don't fail\n        }\n        Ok(path) -\u003e {\n          // 2. Version check (with 5s timeout)\n          case detect_cli_version_with_timeout(path, 5000) {\n            Error(_) -\u003e {\n              io.println(\"[SKIP:ENV] claude --version timed out or failed\")\n              should.be_true(True)\n            }\n            Ok(UnknownVersion(_)) -\u003e {\n              io.println(\"[WARN] Unparseable version - tests may fail\")\n            }\n            Ok(CliVersion(maj, _, _, _)) if maj \u003c 1 -\u003e {\n              io.println(\"[SKIP:ENV] CLI version \u003c 1.0.0 - upgrade required\")\n              should.be_true(True)\n            }\n            Ok(_) -\u003e {\n              // 3. Required flags exist (non-network check)\n              // Run: claude --help and verify flags present\n              io.println(\"[PREFLIGHT] All checks passed - integration tests will run\")\n            }\n          }\n        }\n      }\n    }\n    False -\u003e should.be_true(True)\n  }\n}\n```\n\n## Timeout Protection\n- Preflight version check: 5s\n- Preflight help check: 5s\n- No preflight can hang indefinitely\n\n## Skip Hierarchy\nTests skip unless ALL conditions met:\n1. `CLAUDE_INTEGRATION_TEST=1` env var set\n2. `claude` found in PATH (non-network check)\n3. `claude --version` succeeds with 5s timeout\n\n## Acceptance Criteria\n- [ ] `is_authenticated()` checks `ANTHROPIC_API_KEY` first (no subprocess)\n- [ ] `is_authenticated()` falls back to `claude auth status` with 5s timeout\n- [ ] `integration__preflight_check_test` validates CLI in PATH\n- [ ] `integration__preflight_check_test` validates version parseable\n- [ ] Skip messages are actionable: `[SKIP:ENV] reason`\n- [ ] All timeouts bounded to 5s","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-10T23:21:39.542323396Z","created_by":"cyou","updated_at":"2026-01-10T23:21:39.542323396Z","dependencies":[{"issue_id":"casg-axf.2","depends_on_id":"casg-axf","type":"parent-child","created_at":"2026-01-10T23:21:39.543446919Z","created_by":"cyou"},{"issue_id":"casg-axf.2","depends_on_id":"casg-axf.1","type":"blocks","created_at":"2026-01-10T23:22:28.673961804Z","created_by":"cyou"}]}
{"id":"casg-axf.3","title":"integration__real_cli_query_test implementation","description":"## Overview\nImplement the real CLI query integration test that exercises the full query pipeline with actual Claude CLI.\n\n## Deliverables\n\n### Test: `integration__real_cli_query_test`\n\n```gleam\n/// Integration test: real CLI query (opt-in via CLAUDE_INTEGRATION_TEST=1)\npub fn integration__real_cli_query_test() {\n  case integration_enabled(\"integration__real_cli_query_test\") {\n    True -\u003e {\n      case is_authenticated() {\n        True -\u003e {\n          // Actual integration test logic\n          let assert Ok(stream) = query(\"Hello\", default_options())\n          // Consume stream, verify messages\n          // Use max_turns=1 for fast test\n        }\n        False -\u003e {\n          io.println(\"[SKIP:AUTH] Auth not available - set ANTHROPIC_API_KEY or run claude login\")\n          should.be_true(True)\n        }\n      }\n    }\n    False -\u003e should.be_true(True)  // Skipped (message already printed)\n  }\n}\n```\n\n## Test Requirements\n- Requires authentication (API key or `claude login`)\n- Uses `max_turns=1` for fast execution\n- 30s max timeout protection\n- Verifies stream produces valid messages\n\n## Skip Conditions\n- `CLAUDE_INTEGRATION_TEST` not set -\u003e `[SKIP] test_name (set CLAUDE_INTEGRATION_TEST=1 to run)`\n- Auth not available -\u003e `[SKIP:AUTH] Auth not available - set ANTHROPIC_API_KEY or run claude login`\n\n## Acceptance Criteria\n- [ ] Test gates on `integration_enabled()` first\n- [ ] Test gates on `is_authenticated()` second\n- [ ] Skip messages are actionable\n- [ ] Test makes real CLI query with simple prompt\n- [ ] Test verifies stream produces at least one message\n- [ ] Test has 30s timeout protection\n- [ ] Test passes when auth available\n- [ ] Test skips cleanly when auth unavailable","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-10T23:21:52.914319788Z","created_by":"cyou","updated_at":"2026-01-10T23:21:52.914319788Z","dependencies":[{"issue_id":"casg-axf.3","depends_on_id":"casg-axf","type":"parent-child","created_at":"2026-01-10T23:21:52.914845785Z","created_by":"cyou"},{"issue_id":"casg-axf.3","depends_on_id":"casg-axf.2","type":"blocks","created_at":"2026-01-10T23:22:29.178335685Z","created_by":"cyou"}]}
{"id":"casg-axf.4","title":"integration__session_resume_test implementation","description":"## Overview\nImplement integration test for session resume functionality with real CLI.\n\n## Deliverables\n\n### Test: `integration__session_resume_test`\n\n```gleam\n/// Integration test: session resume (opt-in)\npub fn integration__session_resume_test() {\n  case integration_enabled(\"integration__session_resume_test\") {\n    True -\u003e {\n      case is_authenticated() {\n        True -\u003e {\n          // 1. Create initial session\n          let opts1 = QueryOptions(..default_options(), max_turns: Some(1))\n          let assert Ok(stream1) = query(\"Remember the number 42\", opts1)\n          \n          // 2. Consume stream to get session_id from SystemMessage\n          let session_id = extract_session_id(stream1)\n          \n          // 3. Resume session with follow-up\n          let opts2 = QueryOptions(\n            ..default_options(),\n            resume_session_id: Some(session_id),\n            max_turns: Some(1)\n          )\n          let assert Ok(stream2) = query(\"What number did I ask you to remember?\", opts2)\n          \n          // 4. Verify response references the number\n          // (This tests that session context is preserved)\n        }\n        False -\u003e {\n          io.println(\"[SKIP:AUTH] Auth not available\")\n          should.be_true(True)\n        }\n      }\n    }\n    False -\u003e should.be_true(True)  // Skipped\n  }\n}\n```\n\n## Test Requirements\n- Requires authentication\n- Creates initial session, extracts session_id\n- Resumes session with follow-up query\n- Verifies context preservation\n- Uses `max_turns=1` for each query\n- 30s timeout per query\n\n## Acceptance Criteria\n- [ ] Test gates on `integration_enabled()` and `is_authenticated()`\n- [ ] Test creates initial session with memorable prompt\n- [ ] Test extracts session_id from SystemMessage\n- [ ] Test resumes session using `resume_session_id` option\n- [ ] Test verifies session context is preserved\n- [ ] Each query has 30s timeout protection\n- [ ] Test skips cleanly when auth unavailable","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-10T23:22:04.786161785Z","created_by":"cyou","updated_at":"2026-01-10T23:22:04.786161785Z","dependencies":[{"issue_id":"casg-axf.4","depends_on_id":"casg-axf","type":"parent-child","created_at":"2026-01-10T23:22:04.786771082Z","created_by":"cyou"},{"issue_id":"casg-axf.4","depends_on_id":"casg-axf.3","type":"blocks","created_at":"2026-01-10T23:22:29.664399721Z","created_by":"cyou"}]}
{"id":"casg-axf.5","title":"integration__ndjson_purity_test implementation","description":"## Overview\nImplement integration test that verifies CLI produces pure NDJSON output.\n\n## Deliverables\n\n### Test: `integration__ndjson_purity_test`\n\n```gleam\n/// Integration test: NDJSON purity check\npub fn integration__ndjson_purity_test() {\n  case integration_enabled(\"integration__ndjson_purity_test\") {\n    True -\u003e {\n      case preflight_ndjson_check() {\n        Ok(True) -\u003e {\n          // Full NDJSON purity validation\n          // Verify every line from CLI is valid JSON\n          io.println(\"[PASS] CLI produces pure NDJSON\")\n        }\n        Ok(False) -\u003e {\n          io.println(\"[SKIP:NDJSON] CLI not producing pure NDJSON\")\n          should.be_true(True)\n        }\n        Error(Timeout) -\u003e {\n          io.println(\"[SKIP:TIMEOUT] Preflight check timed out\")\n          should.be_true(True)\n        }\n      }\n    }\n    False -\u003e should.be_true(True)\n  }\n}\n```\n\n## NDJSON Purity Contract\n\n| Scenario | Classification | SDK Behavior | Preflight Result |\n|----------|---------------|--------------|------------------|\n| All stdout lines are valid JSON | **Supported** | Normal operation | PASS |\n| 1-4 consecutive non-JSON lines | **Tolerated** | `JsonDecodeError` (non-terminal) | N/A (runtime only) |\n| 5+ consecutive non-JSON lines | **Not Supported** | `TooManyDecodeErrors` (terminal) | N/A (runtime only) |\n\n## Preflight Behavior\n\n| Preflight Result | Integration Tests | Message |\n|------------------|-------------------|---------|\n| PASS | Run normally | - |\n| FAIL | SKIP all integration tests | `[SKIP:NDJSON] CLI not producing pure NDJSON` |\n| TIMEOUT | SKIP all integration tests | `[SKIP:TIMEOUT] Preflight check timed out` |\n\n## Timeout Bounds\n- NDJSON purity check: 5s timeout (same as version detection)\n\n## Env Var Override\n```bash\n# Tolerate non-JSON for testing older CLI versions\nCLAUDE_INTEGRATION_TEST=1 CLAUDE_INTEGRATION_ALLOW_NONJSON=1 gleam test\n```\n\n## Acceptance Criteria\n- [ ] Test verifies all stdout lines are valid JSON\n- [ ] Test uses 5s timeout for preflight check\n- [ ] Test skips with `[SKIP:NDJSON]` if CLI produces non-JSON\n- [ ] Test skips with `[SKIP:TIMEOUT]` if check times out\n- [ ] `CLAUDE_INTEGRATION_ALLOW_NONJSON=1` relaxes strict mode\n- [ ] Test is stricter than runtime (ZERO tolerance vs 5-error threshold)","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-10T23:22:18.730438381Z","created_by":"cyou","updated_at":"2026-01-10T23:22:18.730438381Z","dependencies":[{"issue_id":"casg-axf.5","depends_on_id":"casg-axf","type":"parent-child","created_at":"2026-01-10T23:22:18.730966198Z","created_by":"cyou"},{"issue_id":"casg-axf.5","depends_on_id":"casg-axf.2","type":"blocks","created_at":"2026-01-10T23:22:30.154701572Z","created_by":"cyou"}]}
{"id":"casg-axf.6","title":"Add integration preflight negative-scenario coverage","description":"## Overview\nAdd explicit integration preflight checks and skip messaging for negative scenarios: CLI missing, CLI version too old, and unauthenticated CLI.\n\n## Deliverables\n- Extend `integration__preflight_check_test` (or add a dedicated test) to cover:\n  - CLI missing in PATH -\u003e `[SKIP:ENV] claude not in PATH - install CLI first`\n  - Version parseable but \u003c1.0.0 -\u003e `[SKIP:ENV] CLI version \u003c 1.0.0 - upgrade required`\n  - Auth unavailable -\u003e `[SKIP:AUTH] Auth not available - set ANTHROPIC_API_KEY or run claude login`\n\n## Notes\n- These scenarios should **skip**, not fail, to keep integration tests opt-in and non-flaky\n- Use clear, actionable skip messages\n\n## Acceptance Criteria\n- [ ] Each negative scenario emits the correct skip message\n- [ ] No integration test hard-fails due to missing CLI/auth/version\n","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-10T23:37:04.535676174Z","created_by":"cyou","updated_at":"2026-01-10T23:37:04.535676174Z","dependencies":[{"issue_id":"casg-axf.6","depends_on_id":"casg-axf","type":"parent-child","created_at":"2026-01-10T23:37:04.536270899Z","created_by":"cyou"},{"issue_id":"casg-axf.6","depends_on_id":"casg-axf.2","type":"blocks","created_at":"2026-01-10T23:43:17.365192997Z","created_by":"cyou"}]}
{"id":"casg-g03","title":"Epic 5: Documentation \u0026 Polish","description":"## Overview\nComplete SDK documentation including module docs, README with examples, and polish items.\n\n## Scope\n1. **Module Documentation**:\n   - All public modules have doc comments\n   - API examples in doc comments\n   - Cross-references to related modules\n\n2. **README.md**:\n   - Installation instructions\n   - Quick start example\n   - API overview\n   - Process ownership documentation\n   - Cancellation recipe (gleam_otp example)\n   - Integration test setup instructions\n\n3. **Blocking Behavior Documentation**:\n   - next() blocks until data\n   - Cross-process use is undefined behavior\n   - OTP wrapper pattern for cancellation\n\n4. **Example Code** (inline in README):\n   - Basic query iteration\n   - with_stream usage\n   - Error handling patterns\n   - Session resume\n\n## Success Criteria\n- All public functions documented\n- README has complete getting started guide\n- Process ownership constraints clearly documented\n- Examples compile and run\n\n## Dependencies\n- Depends on Epic 2, 3, 4 (all features must be complete)\n\n## Plan References\n- Phase 4: Documentation\n- Process Ownership Contract (CRITICAL)\n- Cancellation Pattern Recipe","status":"open","priority":3,"issue_type":"epic","created_at":"2026-01-10T23:19:45.514484408Z","created_by":"cyou","updated_at":"2026-01-10T23:19:45.514484408Z","dependencies":[{"issue_id":"casg-g03","depends_on_id":"casg-j37","type":"blocks","created_at":"2026-01-10T23:19:52.343119077Z","created_by":"cyou"},{"issue_id":"casg-g03","depends_on_id":"casg-tc3","type":"blocks","created_at":"2026-01-10T23:19:52.397471436Z","created_by":"cyou"},{"issue_id":"casg-g03","depends_on_id":"casg-axf","type":"blocks","created_at":"2026-01-10T23:19:52.452163173Z","created_by":"cyou"}]}
{"id":"casg-g03.1","title":"Add module documentation for all public APIs","description":"## Overview\nAdd comprehensive doc comments to all public modules, types, and functions in the SDK.\n\n## Deliverables\n\n### Public Modules to Document\n- `claude_agent_sdk` - Main entry point with `query()` and core re-exports\n- `claude_agent_sdk/options` - QueryOptions type + builder helpers\n- `claude_agent_sdk/stream` - Stream types (`QueryStream`, `StreamItem`, `next()`, `close()`)\n- `claude_agent_sdk/message` - Message types from Claude CLI\n- `claude_agent_sdk/content` - Content block types\n- `claude_agent_sdk/error` - QueryError, StreamError, Warning, ErrorDiagnostic\n- `claude_agent_sdk/runner` - `test_runner()` (test-only helper)\n\n### Documentation Standards\nEach public function/type needs:\n- Brief description (first line)\n- Parameters with expected values\n- Return value semantics\n- Example usage where helpful\n- Cross-references to related functions\n\n### Critical Warnings to Include\n- `QueryStream`: \"Single-process only. Use from the process that created it.\"\n- `next()`: \"Blocks until next message. Cannot be cancelled from another process.\"\n- `close()`: \"Only effective when called by the process that spawned the query.\"\n\n### Gleam Doc Comment Format\n```gleam\n/// Brief description of the function.\n///\n/// Longer description with details about behavior,\n/// edge cases, and important notes.\n///\n/// ## Example\n/// ```gleam\n/// let result = my_function(arg)\n/// ```\npub fn my_function(arg: Type) -\u003e ReturnType\n```\n\n## Acceptance Criteria\n- [ ] All public types have doc comments\n- [ ] All public functions have doc comments  \n- [ ] Process ownership warnings present on stream functions\n- [ ] `gleam docs build` succeeds without warnings\n- [ ] Generated docs are readable and complete\n","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-10T23:21:39.991194163Z","created_by":"cyou","updated_at":"2026-01-10T23:35:01.674465841Z","dependencies":[{"issue_id":"casg-g03.1","depends_on_id":"casg-g03","type":"parent-child","created_at":"2026-01-10T23:21:39.991805169Z","created_by":"cyou"}]}
{"id":"casg-g03.2","title":"Create comprehensive README.md","description":"## Overview\nCreate the main README.md with installation instructions, quick start guide, API overview, and critical usage warnings.\n\n## README Structure\n\n### 1. Header \u0026 Badges\n- Package name: `claude_agent_sdk`\n- Gleam version requirements\n- License badge\n\n### 2. Installation\n```bash\ngleam add claude_agent_sdk\n```\n\nPrerequisites:\n- Claude CLI installed and authenticated (`claude login` or `ANTHROPIC_API_KEY`)\n- Minimum CLI version requirement (if any)\n\n### 3. Quick Start Example\n```gleam\nimport claude_agent_sdk.{query}\nimport claude_agent_sdk/options.{default_options, with_max_turns}\nimport claude_agent_sdk/stream.{next, EndOfStream}\n\npub fn main() {\n  let options = default_options()\n    |\u003e with_max_turns(1)\n\n  case query(\"Hello, Claude!\", options) {\n    Ok(stream) -\u003e consume_stream(stream)\n    Error(e) -\u003e io.println(\"Error: \" \u003c\u003e error_to_string(e))\n  }\n}\n\nfn consume_stream(stream) {\n  case next(stream) {\n    #(Ok(EndOfStream), _) -\u003e io.println(\"Done!\")\n    #(Ok(item), new_stream) -\u003e {\n      handle_item(item)\n      consume_stream(new_stream)\n    }\n    #(Error(e), _) -\u003e io.println(\"Stream error: \" \u003c\u003e ...)\n  }\n}\n```\n\n### 4. API Overview\n- Core functions: `query()`, `next()`, `close()`\n- Types: `QueryOptions`, `QueryStream`, `StreamItem`, `Message`\n- Error handling: `QueryError`, `StreamError`\n- Helpers: `collect_messages()`, `collect_items()`\n\n### 5. Process Ownership (CRITICAL)\n**Must include these exact warnings from plan:**\n- \"QueryStream is not process-safe; use from the process that created it\"\n- \"close() is only effective when called by the process that spawned the query\"\n- \"Because next() blocks, cross-process cancellation requires an OTP wrapper\"\n- \"The SDK does not detect cross-process use; violating this contract results in undefined behavior (typically deadlock)\"\n\n### 6. Success Semantics in Automation\nDocument warning handling for CI pipelines (from plan lines 2827-2860).\n\n### 7. Troubleshooting\n- Empty stdout errors in CI/containers\n- Stderr capture guidance (`2\u003e/tmp/claude_stderr.log`)\n- Common causes table (auth, network, config)\n\n### 8. Integration Testing Setup\nHow to run integration tests with real CLI.\n\n## Acceptance Criteria\n- [ ] Installation instructions work\n- [ ] Quick start example is copy-paste runnable\n- [ ] All critical process ownership warnings included\n- [ ] Troubleshooting section covers common issues\n- [ ] Links to detailed docs (when available)\n","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-10T23:22:02.879898638Z","created_by":"cyou","updated_at":"2026-01-10T23:34:46.825264292Z","dependencies":[{"issue_id":"casg-g03.2","depends_on_id":"casg-g03","type":"parent-child","created_at":"2026-01-10T23:22:02.880619974Z","created_by":"cyou"},{"issue_id":"casg-g03.2","depends_on_id":"casg-g03.1","type":"blocks","created_at":"2026-01-10T23:23:12.248838127Z","created_by":"cyou"},{"issue_id":"casg-g03.2","depends_on_id":"casg-g03.4","type":"blocks","created_at":"2026-01-10T23:23:12.724092705Z","created_by":"cyou"}]}
{"id":"casg-g03.3","title":"Document process ownership contract in detail","description":"## Overview\nAdd detailed documentation about the process ownership contract - the most critical behavioral constraint of the SDK.\n\n## Why This Matters\nErlang ports deliver messages to the spawning process's mailbox. This creates fundamental constraints:\n- `next()` can only receive messages in the process that called `query()`\n- `close()` from another process closes the port but doesn't unblock a waiting `next()`\n- Cross-process use leads to deadlock or resource leaks\n\n## Documentation Locations\n\n### 1. Module Doc Comments (see T001)\nAdd to `stream.gleam` module header:\n```gleam\n//// ## Process Ownership Contract\n//// \n//// `QueryStream` is single-process. Behavior is UNDEFINED if:\n//// - `next()` is called from a different process than `query()`\n//// - `next()` is called from multiple processes concurrently\n//// - `close()` is called from a different process than `query()`\n////\n//// For cancellation patterns, see the Cancellation Recipe in README.\n```\n\n### 2. Function-Level Warnings\nOn `next()`:\n```gleam\n/// **Process Safety**: Must be called from the same process that called `query()`.\n/// Blocks until the next message arrives. Cannot be cancelled from another process.\n```\n\nOn `close()`:\n```gleam\n/// **Process Safety**: Only effective when called by the process that spawned the query.\n/// Calling from another process closes the port but does NOT unblock a waiting `next()`.\n```\n\n### 3. README Section (see T002)\nProminent \"Process Ownership\" section with:\n- The three undefined behaviors\n- Rationale (Erlang port semantics)\n- Link to cancellation recipe\n\n### 4. Mailbox Isolation Invariant\nDocument that every `receive` filters on the specific Port reference:\n```erlang\nreceive {Port, Msg} -\u003e ... end  % CORRECT\nreceive Msg -\u003e ... end          % WRONG - could get other port's messages\n```\n\n## Exact Phrases Required (from plan)\n- \"QueryStream is not process-safe; use from the process that created it\"\n- \"close() is only effective when called by the process that spawned the query\"\n- \"Because next() blocks, cross-process cancellation requires an OTP wrapper\"\n- \"The SDK does not detect cross-process use; violating this contract results in undefined behavior (typically deadlock)\"\n\n## Acceptance Criteria\n- [ ] Module-level doc comment in stream.gleam\n- [ ] Function-level warnings on next() and close()\n- [ ] All four exact phrases appear in docs\n- [ ] Mailbox isolation explained\n- [ ] Clear cross-references between module docs and README","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-10T23:22:20.220203227Z","created_by":"cyou","updated_at":"2026-01-10T23:22:20.220203227Z","dependencies":[{"issue_id":"casg-g03.3","depends_on_id":"casg-g03","type":"parent-child","created_at":"2026-01-10T23:22:20.220771004Z","created_by":"cyou"},{"issue_id":"casg-g03.3","depends_on_id":"casg-g03.1","type":"blocks","created_at":"2026-01-10T23:23:11.26677717Z","created_by":"cyou"}]}
{"id":"casg-g03.4","title":"Add cancellation recipe and advanced examples","description":"## Overview\nDocument the recommended pattern for cancellable queries using gleam_otp, plus other advanced usage examples.\n\n## Cancellation Recipe (from plan lines 2143-2239)\n\n### The Problem\n- `next()` blocks until the next message arrives\n- Single-threaded Gleam means you can't cancel a blocked call from the same process\n- Cross-process `close()` doesn't unblock the waiting `next()`\n\n### The Solution: OTP Task Wrapper\nSpawn a dedicated process to own the stream, communicate via subjects:\n\n```gleam\nimport gleam/erlang/process.{Subject}\nimport gleam/otp/task\n\n/// Run a query with cancellation support.\n/// Returns stream items via the result_subject.\n/// Send Cancel message to cancel_subject to abort.\npub fn query_with_cancellation(\n  prompt: String,\n  options: QueryOptions,\n  result_subject: Subject(Result(StreamItem, StreamError)),\n  cancel_subject: Subject(Cancel),\n) -\u003e task.Task(Nil) {\n  task.async(fn() {\n    // This process owns the stream\n    case query(prompt, options) {\n      Error(e) -\u003e {\n        process.send(result_subject, Error(QueryStartError(e)))\n      }\n      Ok(stream) -\u003e {\n        consume_with_cancellation(stream, result_subject, cancel_subject)\n      }\n    }\n  })\n}\n\nfn consume_with_cancellation(\n  stream: QueryStream,\n  result_subject: Subject(Result(StreamItem, StreamError)),\n  cancel_subject: Subject(Cancel),\n) {\n  // Check for cancellation before each blocking read\n  case process.receive(cancel_subject, 0) {\n    Ok(Cancel) -\u003e {\n      // Cancellation requested - close and exit\n      close(stream)\n      process.send(result_subject, Ok(EndOfStream))\n    }\n    Error(Nil) -\u003e {\n      // No cancellation - proceed with blocking read\n      case next(stream) {\n        #(Ok(EndOfStream), _) -\u003e {\n          process.send(result_subject, Ok(EndOfStream))\n        }\n        #(Ok(item), new_stream) -\u003e {\n          process.send(result_subject, Ok(item))\n          consume_with_cancellation(new_stream, result_subject, cancel_subject)\n        }\n        #(Error(e), _) -\u003e {\n          process.send(result_subject, Error(e))\n        }\n      }\n    }\n  }\n}\n\ntype Cancel { Cancel }\n```\n\n### Usage Example\n```gleam\nlet result_subject = process.new_subject()\nlet cancel_subject = process.new_subject()\n\nlet task = query_with_cancellation(\"prompt\", options, result_subject, cancel_subject)\n\n// To cancel:\nprocess.send(cancel_subject, Cancel)\n\n// To receive results with timeout:\ncase process.receive(result_subject, 30_000) {\n  Ok(Ok(item)) -\u003e handle_item(item)\n  Ok(Error(e)) -\u003e handle_error(e)\n  Error(Nil) -\u003e handle_timeout()\n}\n```\n\n### Key Points to Document\n1. The consuming process owns the stream (spawned via `task.async`)\n2. Parent process communicates via subjects (messages)\n3. Cancellation is checked between blocking `next()` calls\n4. `close()` is always called when cancelling (releases port resources)\n5. This pattern adds `gleam_otp` dependency but keeps SDK non-actor\n\n## Other Examples to Include\n\n### Basic Streaming\nSimple loop consuming all messages\n\n### Error Handling\nHandling recoverable vs terminal errors\n\n### CI/Automation\nStrict warning handling for pipelines\n\n## Placement\n- Full cancellation recipe in README.md \"Advanced Usage\" section\n- Summary reference in module docs with link to README\n\n## Acceptance Criteria\n- [ ] Full cancellation recipe in README\n- [ ] Key points explained clearly\n- [ ] Usage example is copy-paste runnable\n- [ ] Dependencies noted (gleam_otp)\n- [ ] Other helpful examples included","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-10T23:22:40.025864384Z","created_by":"cyou","updated_at":"2026-01-10T23:22:40.025864384Z","dependencies":[{"issue_id":"casg-g03.4","depends_on_id":"casg-g03","type":"parent-child","created_at":"2026-01-10T23:22:40.026857869Z","created_by":"cyou"},{"issue_id":"casg-g03.4","depends_on_id":"casg-g03.3","type":"blocks","created_at":"2026-01-10T23:23:11.765589194Z","created_by":"cyou"}]}
{"id":"casg-g03.5","title":"Document test fixtures and integration test setup","description":"## Overview\nCreate documentation for the test fixtures directory and integration test setup.\n\n## Deliverables\n\n### 1. test/fixtures/README.md\nDocument the test fixtures used for schema validation:\n\n```markdown\n# Test Fixtures\n\nThis directory contains JSON fixtures captured from the Claude CLI for testing.\n\n## CLI Version\n- **Version**: claude v1.x.x (exact version TBD during implementation)\n- **Capture Date**: 2026-01-XX\n- **Platform**: BEAM/Erlang\n\n## Fixture Files\n- `system_message.json` - System message example\n- `assistant_message.json` - Assistant message example\n- `result_success.json` - Result (success)\n- `result_error.json` - Result (error)\n- `unknown_message_type.json` - Forward-compat fixture\n- `unknown_content_block.json` - Forward-compat fixture\n- `cli_help_excerpt.txt` - `claude --help` excerpt showing required flags\n\n## Refreshing Fixtures\nTo update fixtures with a new CLI version:\n1. Run the fixture capture command\n2. Update version and date above\n3. Verify tests still pass\n\n## Note on Synthetic Fixtures\nSome fixtures may be synthetic (hand-crafted) rather than captured from CLI.\nThese are marked with a \"synthetic\" suffix or comment in the file.\n```\n\n### 2. Integration Test Documentation\nIn README.md or separate CONTRIBUTING.md:\n\n```markdown\n## Integration Testing\n\n### Prerequisites\n- Claude CLI installed and authenticated\n- ANTHROPIC_API_KEY or cached auth\n\n### Running Integration Tests\n```bash\n# Unit tests only (no CLI required)\ngleam test\n\n# Integration tests (requires CLI)\nCLAUDE_INTEGRATION_TEST=1 gleam test\n```\n\n### Phase 0 Validation\nPhase 0 tests validate the FFI layer against the real Erlang runtime:\n```bash\nPHASE0_RUNTIME=1 gleam test\n```\n\n### Test Categories\n- **Unit tests**: No external dependencies, always run\n- **Integration tests**: Require Claude CLI, opt-in via env var\n- **Phase 0 tests**: FFI validation, opt-in via env var\n```\n\n### 3. Environment Variables Reference\nDocument all environment variables the SDK uses:\n- `ANTHROPIC_API_KEY` - API key for authentication\n- `CLAUDE_INTEGRATION_TEST` - Enable integration tests\n- `CLAUDE_INTEGRATION_ALLOW_NONJSON` - Allow non-JSON preflight in integration tests\n- `PHASE0_RUNTIME` - Enable Phase 0 FFI validation\n\n## Acceptance Criteria\n- [ ] test/fixtures/README.md exists with version info\n- [ ] cli_help_excerpt.txt is captured and referenced\n- [ ] Integration test instructions in main README\n- [ ] All env vars documented\n- [ ] Clear distinction between test types\n","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-10T23:22:57.770789703Z","created_by":"cyou","updated_at":"2026-01-10T23:34:28.27609963Z","dependencies":[{"issue_id":"casg-g03.5","depends_on_id":"casg-g03","type":"parent-child","created_at":"2026-01-10T23:22:57.771934607Z","created_by":"cyou"}]}
{"id":"casg-g03.6","title":"Document scope divergence from MALA_SDK_REQUIREMENTS","description":"## Overview\nDocument the relationship between this CLI-based SDK plan and the separate `plans/MALA_SDK_REQUIREMENTS.md` document to avoid confusion for future contributors.\n\n## Context\n- The current SDK plan is CLI-based (Claude Code CLI subprocess)\n- `plans/MALA_SDK_REQUIREMENTS.md` calls for a direct, non-CLI SDK (\"No CLI hook dependence\")\n- This is an intentional scope boundary for this project phase\n\n## Deliverables\n- Add a short \"Scope \u0026 Non-Goals\" note in README or CONTRIBUTING:\n  - MALA requirements are **out of scope** for this CLI-based SDK version\n  - Provide a pointer to future work or separate project for direct API SDK\n\n## Acceptance Criteria\n- README or CONTRIBUTING contains explicit note about MALA requirements divergence\n- No implication that this SDK satisfies MALA's \"no CLI\" requirement\n","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-10T23:37:31.401653109Z","created_by":"cyou","updated_at":"2026-01-10T23:37:31.401653109Z","dependencies":[{"issue_id":"casg-g03.6","depends_on_id":"casg-g03","type":"parent-child","created_at":"2026-01-10T23:37:31.402236604Z","created_by":"cyou"},{"issue_id":"casg-g03.6","depends_on_id":"casg-g03.2","type":"blocks","created_at":"2026-01-10T23:43:22.441782856Z","created_by":"cyou"}]}
{"id":"casg-j37","title":"Epic 2: Core Query \u0026 Streaming","description":"## Overview\nImplement the core query functionality including CLI argument building, version detection, and the QueryStream abstraction. This is the architectural foundation of the SDK.\n\n## Why This is Critical\n- QueryStream is the primary user-facing API\n- v1 uses port_ffi directly (not Runner abstraction) for production\n- Version detection prevents cryptic errors from incompatible CLIs\n- CLI arg building must handle conflicting options correctly\n\n## Scope\n1. **QueryOptions** (src/claude_agent_sdk/options.gleam):\n   - All CLI options (model, max_turns, budget, permissions, etc.)\n   - Builder functions (with_model, with_max_turns, etc.)\n   - test_mode and skip_version_check for unit tests\n\n2. **CLI Argument Building** (src/claude_agent_sdk/internal/cli.gleam):\n   - build_args() function\n   - Conflicting option resolution (resume vs continue, etc.)\n   - All --flag mappings\n\n3. **Version Detection** (src/claude_agent_sdk/internal/cli.gleam):\n   - find_executable() via FFI\n   - detect_cli_version() with timeout\n   - parse_version_string() and version_meets_minimum()\n   - CliVersion and UnknownVersion types\n\n4. **QueryStream** (src/claude_agent_sdk/internal/stream.gleam):\n   - Opaque QueryStream type\n   - Line reassembly from port bytes\n   - Buffer limit (10MB) protection\n   - State machine for exit_status/Result ordering\n\n5. **Main API** (src/claude_agent_sdk.gleam):\n   - query() function\n   - next() function returning #(Result, QueryStream)\n   - close() function with cleanup\n\n6. **Resource Safety Helpers**:\n   - with_stream() - guaranteed cleanup\n   - collect_items(), collect_messages()\n   - fold_stream()\n\n## Success Criteria\n- query() spawns CLI subprocess correctly\n- next() iterates through NDJSON messages\n- Version detection catches incompatible CLIs\n- Resource cleanup happens even on early return\n\n## Dependencies\n- Depends on Epic 0 (FFI must work)\n- Depends on Epic 1 (message types for decoding)\n\n## Plan References\n- v1 Production Path (Canonical)\n- Canonical Version Policy\n- QueryStream State Machine\n- Process Ownership Contract","status":"open","priority":1,"issue_type":"epic","created_at":"2026-01-10T23:19:43.946733304Z","created_by":"cyou","updated_at":"2026-01-10T23:19:43.946733304Z","dependencies":[{"issue_id":"casg-j37","depends_on_id":"casg-va1","type":"blocks","created_at":"2026-01-10T23:19:52.025063466Z","created_by":"cyou"},{"issue_id":"casg-j37","depends_on_id":"casg-k92","type":"blocks","created_at":"2026-01-10T23:19:52.077305157Z","created_by":"cyou"}]}
{"id":"casg-j37.1","title":"QueryOptions type skeleton + failing build_args test","description":"## Overview\nCreate the QueryOptions type and builder functions skeleton in src/claude_agent_sdk/options.gleam.\n\n## TDD Approach\nWrite failing test first in test/cli_args_test.gleam that calls build_args() and expects specific CLI arguments.\n\n## Deliverables\n- src/claude_agent_sdk/options.gleam with:\n  - QueryOptions type with all fields (model, max_turns, system_prompt, etc.)\n  - PermissionMode enum (Default, AcceptEdits, BypassPermissions, Plan)\n  - default_options() -\u003e QueryOptions\n  - Builder functions: with_model, with_max_turns, with_max_budget, with_system_prompt, with_append_system_prompt, with_allowed_tools, with_disallowed_tools, with_mcp_config, with_permission_mode, with_resume, with_continue, with_cwd\n  - SDK-only options: test_mode, test_runner, skip_version_check, permissive_version_check\n\n## Test File\ntest/cli_args_test.gleam with:\n- basic_args_test: verify fixed flags (--print, --output-format, stream-json, --verbose)\n- model_option_test: verify --model flag generation\n- Tests should FAIL initially (build_args not implemented yet)\n\n## Key Invariants from Plan\n- All Option fields default to None\n- Bool fields default to False\n- cwd handling: None = inherit, Some(\"\") treated as None, Some(path) = use path\n- See plan lines 4144-4214 for complete type definition","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-10T23:21:48.865156778Z","created_by":"cyou","updated_at":"2026-01-10T23:21:48.865156778Z","dependencies":[{"issue_id":"casg-j37.1","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:21:48.865791135Z","created_by":"cyou"}]}
{"id":"casg-j37.10","title":"query() function wiring (spawn, version check, return QueryStream)","description":"## Overview\nImplement the main query() function that ties everything together.\n\n## Signature\n```gleam\npub fn query(\n  prompt: String,\n  options: QueryOptions,\n) -\u003e Result(QueryStream, QueryError)\n```\n\n## Implementation Flow (from plan lines 1528-1576)\n1. Find CLI in PATH (returns CliNotFoundError if not found)\n2. Check version (unless skip_version_check=True)\n   - detect_cli_version() -\u003e check meets minimum\n   - Handle permissive_version_check for unknown versions\n3. Build args via build_cli_args(prompt, options)\n4. Spawn port based on test_mode:\n   - False: port_ffi.ffi_open_port(cli_path, args, cwd) [v1 production]\n   - True: test_runner_spawn(options.test_runner, ...) [test path]\n5. Return Ok(QueryStream(...))\n\n## QueryError Types\n- CliNotFoundError(message: String)\n- UnsupportedCliVersionError(detected_version, minimum_required, suggestion)\n- UnknownVersionError(raw, message)\n- VersionDetectionError(reason)\n- SpawnError(reason: String)\n\n## Key Invariants (from plan)\n- v1 uses port_ffi directly (NOT Runner) for production path\n- Version detection uses raw FFI with 5s timeout\n- test_mode enables test_runner() path for unit tests\n- cwd handling: None = inherit, Some(\"\") = inherit, Some(path) = use path\n\n## Test Strategy\n- Unit tests use with_test_mode() to provide test_runner\n- Integration tests (opt-in) test real CLI spawning\n- Version check can be skipped via with_skip_version_check()","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-10T23:23:38.169749Z","created_by":"cyou","updated_at":"2026-01-10T23:23:38.169749Z","dependencies":[{"issue_id":"casg-j37.10","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:23:38.170379056Z","created_by":"cyou"},{"issue_id":"casg-j37.10","depends_on_id":"casg-j37.2","type":"blocks","created_at":"2026-01-10T23:24:24.852891558Z","created_by":"cyou"},{"issue_id":"casg-j37.10","depends_on_id":"casg-j37.4","type":"blocks","created_at":"2026-01-10T23:24:25.360130356Z","created_by":"cyou"},{"issue_id":"casg-j37.10","depends_on_id":"casg-j37.8","type":"blocks","created_at":"2026-01-10T23:24:30.831148563Z","created_by":"cyou"},{"issue_id":"casg-j37.10","depends_on_id":"casg-j37.9","type":"blocks","created_at":"2026-01-10T23:24:31.332181627Z","created_by":"cyou"},{"issue_id":"casg-j37.10","depends_on_id":"casg-j37.13","type":"blocks","created_at":"2026-01-10T23:42:36.74825903Z","created_by":"cyou"}]}
{"id":"casg-j37.11","title":"Resource helpers (with_stream, collect_items, collect_messages, fold_stream)","description":"## Overview\nImplement resource-safe helper functions that guarantee cleanup.\n\n## Deliverables\n\n### with_stream (from plan lines 3684-3687)\n```gleam\npub fn with_stream(\n  result: Result(QueryStream, QueryError),\n  f: fn(QueryStream) -\u003e a,\n) -\u003e Result(a, QueryError)\n```\nEnsures close() is called even on early return/panic.\n\n### collect_items (from plan lines 3701)\n```gleam\npub fn collect_items(stream: QueryStream) -\u003e CollectResult(StreamItem)\n```\nConsumes entire stream, collecting all items. Guarantees cleanup.\n\n### collect_messages (from plan lines 3707)\n```gleam\npub fn collect_messages(stream: QueryStream) -\u003e CollectResult(MessageEnvelope)\n```\nFilters to messages only; same semantics as collect_items.\n\n### fold_stream (from plan lines 3715)\n```gleam\npub fn fold_stream(\n  stream: QueryStream,\n  initial: a,\n  f: fn(a, Result(StreamItem, StreamError)) -\u003e FoldAction(a),\n) -\u003e #(a, Option(StreamError))\n```\nCustom accumulation with guaranteed cleanup.\n\n## CollectResult Type\n```gleam\npub type CollectResult(a) {\n  CollectResult(\n    items: List(a),\n    warnings: List(Warning),\n    non_terminal_errors: List(StreamError),\n    terminal_error: Option(StreamError),\n  )\n}\n```\n\n## Stability Promise (from plan lines 4354-4371)\nAll helpers are STABLE API - breaking changes require major version bump.\n\n## Unit Tests\n- with_stream closes port even on early return (from plan line 4705)\n- collect_items collects all items and closes port (from plan line 4706)","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-10T23:23:48.781437985Z","created_by":"cyou","updated_at":"2026-01-10T23:23:48.781437985Z","dependencies":[{"issue_id":"casg-j37.11","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:23:48.782165871Z","created_by":"cyou"},{"issue_id":"casg-j37.11","depends_on_id":"casg-j37.8","type":"blocks","created_at":"2026-01-10T23:24:31.808582911Z","created_by":"cyou"},{"issue_id":"casg-j37.11","depends_on_id":"casg-j37.9","type":"blocks","created_at":"2026-01-10T23:24:32.297991541Z","created_by":"cyou"}]}
{"id":"casg-j37.12","title":"to_iterator() with documented leak risk","description":"## Overview\nImplement to_iterator() for gleam/iterator combinator interop.\n\n## Signature (from plan line 3742)\n```gleam\npub fn to_iterator(stream: QueryStream) -\u003e Iterator(Result(StreamItem, StreamError))\n```\n\n## Stability Status (from plan line 4362)\n**Stable but Advanced** - documented leak risk; prefer with_stream/collect_* alternatives.\n\n## Leak Risk\nUnlike collect_* helpers, to_iterator() does NOT guarantee cleanup if:\n- Iterator is not fully consumed\n- Exception during iteration\n- Early break from iteration\n\n## Implementation\nWrap next() in iterator.unfold() pattern:\n```gleam\npub fn to_iterator(stream: QueryStream) -\u003e Iterator(Result(StreamItem, StreamError)) {\n  iterator.unfold(stream, fn(s) {\n    case next(s) {\n      #(Ok(EndOfStream), _) -\u003e Done\n      #(result, new_stream) -\u003e Next(result, new_stream)\n    }\n  })\n}\n```\n\n## Documentation Requirements\nREADME/module docs must explicitly warn:\n- \"Prefer with_stream(), collect_items(), or fold_stream() for guaranteed cleanup\"\n- \"to_iterator() may leak port resources if not fully consumed\"\n- \"Use for gleam/iterator combinator interop when cleanup is handled externally\"\n\n## Unit Tests\n- Basic iteration produces all items\n- Early termination leaves port unclosed (demonstrating the risk)","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-10T23:23:58.600719245Z","created_by":"cyou","updated_at":"2026-01-10T23:23:58.600719245Z","dependencies":[{"issue_id":"casg-j37.12","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:23:58.601271252Z","created_by":"cyou"},{"issue_id":"casg-j37.12","depends_on_id":"casg-j37.8","type":"blocks","created_at":"2026-01-10T23:24:36.280358887Z","created_by":"cyou"}]}
{"id":"casg-j37.13","title":"Centralize stream/CLI constants (timeouts, limits)","description":"## Goal\nCentralize all timeouts, buffer limits, and decode error thresholds into a single internal module so the stream/CLI logic uses consistent values.\n\n## Context\nPlan reference: \"All timeout values (single source of truth)\" and multiple sections referencing 5s/100ms/50ms/10MB/5-errors.\n\n## Deliverables\n- `src/claude_agent_sdk/internal/constants.gleam` (internal only) with:\n  - `const version_check_timeout_ms = 5000`\n  - `const post_result_drain_timeout_ms = 100`\n  - `const post_exit_drain_timeout_ms = 50`\n  - `const close_drain_timeout_ms = 50`\n  - `const close_drain_max_messages = 100`\n  - `const post_exit_drain_max_iterations = 10`\n  - `const post_exit_drain_max_bytes = 1024`\n  - `const max_line_bytes = 10_000_000`\n  - `const max_consecutive_decode_errors = 5`\n\n## Usage\n- internal/cli.gleam (version detection)\n- internal/stream.gleam (timeouts, drain bounds, buffer overflow)\n- internal/port_ffi.gleam (if needed for constants)\n\n## Acceptance Criteria\n- All timeout/limit values are defined in one place\n- No hard-coded numeric literals in stream/cli modules for these values\n- Values match the planâ€™s canonical tables\n","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-10T23:36:17.765651333Z","created_by":"cyou","updated_at":"2026-01-10T23:36:17.765651333Z","dependencies":[{"issue_id":"casg-j37.13","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:36:17.766801277Z","created_by":"cyou"}]}
{"id":"casg-j37.14","title":"Create public stream module (claude_agent_sdk/stream)","description":"## Goal\nCreate the public stream module that exposes QueryStream operations and re-exports stream-related types without leaking internal implementation details.\n\n## Context\nPlan references public module paths under `src/claude_agent_sdk/*` and internal modules under `src/claude_agent_sdk/internal/*`.\n\n## Deliverables\n- `src/claude_agent_sdk/stream.gleam` with:\n  - public type aliases/re-exports for `QueryStream`, `StreamItem`, `Warning`, `WarningCode`, `StreamError`\n  - `pub fn next(stream: QueryStream) -\u003e #(Result(StreamItem, StreamError), QueryStream)`\n  - `pub fn close(stream: QueryStream) -\u003e Nil`\n  - optional helpers for pattern matching if needed\n- Ensure `claude_agent_sdk.gleam` re-exports `next`/`close` (if desired by API surface)\n\n## Boundaries\n- The implementation should delegate to `internal/stream.gleam`\n- No FFI or internal types exposed from this module\n\n## Acceptance Criteria\n- Public module compiles and re-exports only approved types\n- Users can `import claude_agent_sdk/stream.{next, close, QueryStream, StreamItem}`\n- Internal modules remain inaccessible from outside package\n","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-10T23:36:30.351415213Z","created_by":"cyou","updated_at":"2026-01-10T23:36:30.351415213Z","dependencies":[{"issue_id":"casg-j37.14","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:36:30.352206019Z","created_by":"cyou"},{"issue_id":"casg-j37.14","depends_on_id":"casg-j37.8","type":"blocks","created_at":"2026-01-10T23:42:41.829346428Z","created_by":"cyou"},{"issue_id":"casg-j37.14","depends_on_id":"casg-j37.9","type":"blocks","created_at":"2026-01-10T23:42:46.906595742Z","created_by":"cyou"}]}
{"id":"casg-j37.2","title":"Implement build_cli_args with precedence rules","description":"## Overview\nImplement the build_cli_args() function in src/claude_agent_sdk/internal/cli.gleam that converts QueryOptions to CLI argument list.\n\n## Deliverables\n- src/claude_agent_sdk/internal/cli.gleam with:\n  - build_cli_args(options: QueryOptions, prompt: String) -\u003e List(String)\n  - Generates correct CLI flags from QueryOptions fields\n\n## Fixed Arguments (always included)\n`--print --output-format stream-json --verbose -- \u003cprompt\u003e`\n\n## CLI Argument Mapping (from plan)\n| QueryOptions Field | CLI Argument(s) |\n|-------------------|-----------------|\n| model | --model \u003cvalue\u003e |\n| max_turns | --max-turns \u003cvalue\u003e |\n| max_budget_usd | --max-budget-usd \u003cvalue\u003e |\n| system_prompt | --system-prompt \u003cvalue\u003e |\n| append_system_prompt | --append-system-prompt \u003cvalue\u003e |\n| allowed_tools | --allowed-tools tool1,tool2 |\n| disallowed_tools | --disallowed-tools tool1,tool2 |\n| mcp_config_path | --mcp-config \u003cpath\u003e |\n| permission_mode = AcceptEdits | --permission-mode acceptEdits |\n| permission_mode = BypassPermissions | --dangerously-skip-permissions |\n| permission_mode = Plan | --permission-mode plan |\n| resume_session_id | --resume \u003cuuid\u003e |\n| continue_session = True | --continue |\n\n## Precedence Rules (CRITICAL)\n1. system_prompt wins over append_system_prompt\n2. allowed_tools wins over disallowed_tools\n3. resume_session_id wins over continue_session\n\n## Acceptance Tests (from plan lines 4666-4669)\n- Given model=Some(\"sonnet\"), args include --model sonnet\n- Given system_prompt AND append_system_prompt set, only --system-prompt emitted\n- Given allowed_tools AND disallowed_tools set, only --allowed-tools emitted\n- Given resume_session_id AND continue_session=True, only --resume emitted","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-10T23:21:59.410902624Z","created_by":"cyou","updated_at":"2026-01-10T23:21:59.410902624Z","dependencies":[{"issue_id":"casg-j37.2","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:21:59.4116213Z","created_by":"cyou"},{"issue_id":"casg-j37.2","depends_on_id":"casg-j37.1","type":"blocks","created_at":"2026-01-10T23:24:09.31439788Z","created_by":"cyou"}]}
{"id":"casg-j37.3","title":"Version detection types and parse_version_string","description":"## Overview\nImplement pure version parsing functions that can be fully unit-tested without OS processes.\n\n## Deliverables\n- src/claude_agent_sdk/internal/cli.gleam additions:\n  - CliVersion type: CliVersion(major: Int, minor: Int, patch: Int, raw: String)\n  - UnknownVersion(raw: String) variant\n  - parse_version_string(output: String) -\u003e Result(CliVersion, Nil)\n  - version_meets_minimum(version: CliVersion, minimum: CliVersion) -\u003e Bool\n  - format_version_error(detected: CliVersion, required: CliVersion) -\u003e String\n  - minimum_cli_version constant (1, 0, 0)\n\n## Parse Version Rules (from plan)\nMust handle various formats:\n- \"claude v1.2.3\\n\" -\u003e Ok(CliVersion(1,2,3,\"1.2.3\"))\n- \"1.2.3\" -\u003e Ok(CliVersion(1,2,3,\"1.2.3\"))\n- \"v1.2.3\" -\u003e Ok(CliVersion(1,2,3,\"1.2.3\"))\n- \"Claude Code CLI 1.2.3-beta.1\" -\u003e Ok(CliVersion(1,2,3,\"1.2.3\"))\n- \"  1.2.3  \\n\" -\u003e Ok (whitespace tolerant)\n- \"garbage\" -\u003e Error\n- \"\" -\u003e Error\n\n## Version Comparison (semantic versioning)\n- version_meets_minimum(v0.9.0, v1.0.0) -\u003e False\n- version_meets_minimum(v1.0.0, v1.0.0) -\u003e True\n- version_meets_minimum(v1.0.0-beta.1, v1.0.0) -\u003e True (prerelease passes)\n\n## Unit Tests (test/version_test.gleam)\nAll acceptance criteria from plan lines 4670-4680","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-10T23:22:11.402418014Z","created_by":"cyou","updated_at":"2026-01-10T23:22:11.402418014Z","dependencies":[{"issue_id":"casg-j37.3","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:22:11.40302149Z","created_by":"cyou"},{"issue_id":"casg-j37.3","depends_on_id":"casg-j37.1","type":"blocks","created_at":"2026-01-10T23:24:09.803807719Z","created_by":"cyou"}]}
{"id":"casg-j37.4","title":"Version detection integration (detect_cli_version via FFI)","description":"## Overview\nImplement detect_cli_version() that spawns `claude --version` using port_ffi and parses output.\n\n## Deliverables\n- src/claude_agent_sdk/internal/cli.gleam additions:\n  - detect_cli_version(cli_path: String) -\u003e Result(CliVersion, VersionCheckError)\n  - VersionCheckError type (Timeout, SpawnFailed, ParseFailed)\n  - default_version_timeout_ms() -\u003e Int (5000ms)\n\n## Implementation Details\n- Uses port_ffi.ffi_open_port() directly (v1 canonical path)\n- Spawns: `cli_path --version`\n- Uses receive_timeout (5s) to avoid hanging\n- Reads all output until exit_status\n- Passes output to parse_version_string()\n\n## Key Invariants (from plan)\n- Version detection uses raw FFI, not Runner abstraction\n- Same port options as query() for consistency\n- 5-second timeout (same as all preflight checks)\n- This is INTEGRATION code - only tested in opt-in integration tests\n\n## Integration Tests (opt-in via CLAUDE_INTEGRATION_TEST=1)\n- Real `claude --version` returns parseable version\n- Port preflight receives data from echo command","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-10T23:22:21.635034991Z","created_by":"cyou","updated_at":"2026-01-10T23:22:21.635034991Z","dependencies":[{"issue_id":"casg-j37.4","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:22:21.635585478Z","created_by":"cyou"},{"issue_id":"casg-j37.4","depends_on_id":"casg-j37.3","type":"blocks","created_at":"2026-01-10T23:24:10.310309941Z","created_by":"cyou"},{"issue_id":"casg-j37.4","depends_on_id":"casg-j37.13","type":"blocks","created_at":"2026-01-10T23:42:31.673250319Z","created_by":"cyou"}]}
{"id":"casg-j37.5","title":"QueryStream skeleton + StreamState enum + failing tests","description":"## Overview\nCreate the QueryStream opaque type and StreamState state machine types with failing tests.\n\n## Deliverables\n- src/claude_agent_sdk/internal/stream.gleam with:\n  - pub opaque type QueryStream (contains port, buffer, state, closed flag)\n  - StreamState enum: Streaming, ResultReceived, PendingEndOfStream, Closed\n  - QueryStreamInternal record (port, buffer, state, counters)\n  - Placeholder next() and close() signatures (implement later)\n\n## QueryStream Internal Structure (from plan lines 1986-1992)\n```gleam\ntype QueryStreamInternal {\n  QueryStreamInternal(\n    port: Port,           // Direct BEAM port\n    buffer: BitArray,     // Line reassembly buffer\n    state: StreamState,\n    consecutive_decode_errors: Int,\n    drain_count: Int,\n    closed: Bool,\n  )\n}\n```\n\n## StreamState Transitions (from plan diagram lines 2727-2773)\n- Streaming -\u003e ResultReceived (on Result message)\n- Streaming -\u003e PendingEndOfStream (on exit_status after Result)\n- ResultReceived -\u003e PendingEndOfStream (on drain complete)\n- PendingEndOfStream -\u003e Closed (after yielding EndOfStream)\n\n## Failing Test\n- test/stream_test.gleam with a minimal test that asserts state transitions fail until implemented\n\n## Key Invariants\n- QueryStream is single-process (documented constraint)\n- result_seen flag determines error handling\n- Port handle is shared across copies; per-copy state is buffer/counters\n\n**Note**: StreamItem, Warning, and StreamError types live in src/claude_agent_sdk/error.gleam (not in stream.gleam). stream.gleam should import and use those types.\n","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-10T23:22:32.172900953Z","created_by":"cyou","updated_at":"2026-01-10T23:33:37.629005004Z","dependencies":[{"issue_id":"casg-j37.5","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:22:32.173627539Z","created_by":"cyou"},{"issue_id":"casg-j37.5","depends_on_id":"casg-j37.1","type":"blocks","created_at":"2026-01-10T23:24:10.802331175Z","created_by":"cyou"}]}
{"id":"casg-j37.6","title":"Line buffer implementation (byte-level, CRLF normalization)","description":"## Overview\nImplement the line reassembly buffer that handles arbitrary byte chunks from the port.\n\n## Deliverables\n- src/claude_agent_sdk/internal/stream.gleam additions:\n  - read_line(state: ReaderState) -\u003e #(ReadLineResult, ReaderState)\n  - normalize_crlf(buffer: BitArray) -\u003e BitArray\n  - ReadLineResult type: CompleteLine(String) | PortClosed | ExitReceived(Int) | BufferOverflow | Error(String)\n  - max_buffer_bytes constant (10MB)\n\n## Byte-Level Processing Pipeline (from plan lines 3229-3242)\nPort Data -\u003e Buffer -\u003e CRLF Normalize -\u003e Newline Split -\u003e UTF-8 Decode -\u003e JSON Parse -\u003e Message\n\n## Buffer Rules (from plan)\n1. Accumulate bytes until newline (0x0A) found\n2. Replace CRLF (\\r\\n) with LF (\\n) for Windows compat\n3. Split on newline at BYTE level (not String.split)\n4. UTF-8 decode per complete line (not per chunk)\n5. Return BufferOverflow if line exceeds 10MB\n\n## Incomplete Line Handling at exit_status (CRITICAL, from plan)\n| Buffer State | Exit Code | Result |\n|--------------|-----------|--------|\n| Empty | 0 | WarningEvent(CleanExitNoResult) | \n| Empty | !=0 | ProcessError(code, stdout_was_empty=True) |\n| Incomplete line | 0 | WarningEvent(IncompleteLastLine), EndOfStream (DO NOT parse line) |\n| Incomplete line | !=0 | ProcessError with last_non_json_line populated |\n\n**Important**: When exit_status arrives and the buffer does NOT end with a newline, do NOT attempt to parse it as JSON. The SDK must emit a warning and discard (exit=0) or include it as diagnostic context (exit!=0).\n\n## Unit Tests\n- Chunk reassembly across multiple Data messages\n- CRLF normalization\n- BufferOverflow at 10MB boundary\n- Incomplete line handling at exit_status (warning vs ProcessError)\n","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-10T23:22:44.88741655Z","created_by":"cyou","updated_at":"2026-01-10T23:33:10.498078707Z","dependencies":[{"issue_id":"casg-j37.6","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:22:44.888183666Z","created_by":"cyou"},{"issue_id":"casg-j37.6","depends_on_id":"casg-j37.5","type":"blocks","created_at":"2026-01-10T23:24:16.825397319Z","created_by":"cyou"},{"issue_id":"casg-j37.6","depends_on_id":"casg-j37.13","type":"blocks","created_at":"2026-01-10T23:42:16.431087799Z","created_by":"cyou"}]}
{"id":"casg-j37.7","title":"StreamState machine (transitions and result_seen precedence)","description":"## Overview\nImplement the stream state machine that handles Result vs exit_status precedence.\n\n## State Machine (from plan diagram lines 2727-2773)\n```\nSTREAMING\n   |\n   +-- Result message -\u003e Yield Ok(Message(Result)), state = ResultReceived\n   |\n   +-- exit_status (result_seen=FALSE) \n   |      +-- code=0 -\u003e WarningEvent(CleanExitNoResult), EndOfStream\n   |      +-- code!=0 -\u003e ProcessError (TERMINAL)\n   |\n   +-- exit_status (result_seen=TRUE)\n   |      +-- ANY code -\u003e WarningEvent + EndOfStream (Result is authoritative)\n   |\n   +-- Eof -\u003e EndOfStream (warn if no Result)\n```\n\n## Result vs exit_status Precedence (CRITICAL - from plan lines 2775-2784)\n| Scenario | result_seen | exit_status | Outcome |\n|----------|-------------|-------------|---------|\n| exit_status before Result | FALSE | 0 | EndOfStream (warn: no Result) |\n| exit_status before Result | FALSE | !=0 | ProcessError (terminal) |\n| exit_status after Result | TRUE | 0 | EndOfStream (normal) |\n| exit_status after Result | TRUE | !=0 | Warning only + EndOfStream |\n\n**Crisp invariant**: If result_seen == TRUE, no subsequent exit_status can produce ProcessError.\n\n## Deliverables\n- StreamState transition logic in next()\n- result_seen tracking\n- Proper warning generation for anomalies\n- consecutive_decode_errors counter (reset on success, threshold=5)\n\n## Unit Tests (using test_runner)\n- exit_status before Result -\u003e ProcessError (from plan line 4697)\n- Result then exit_status=0 -\u003e Result, EndOfStream (from plan line 4698)\n- Result then exit_status!=0 -\u003e Result, WarningEvent, EndOfStream (from plan line 4699)\n- exit_status=0 before Result -\u003e WarningEvent(CleanExitNoResult), EndOfStream (from plan line 4700)","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-10T23:22:57.919574224Z","created_by":"cyou","updated_at":"2026-01-10T23:22:57.919574224Z","dependencies":[{"issue_id":"casg-j37.7","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:22:57.92038274Z","created_by":"cyou"},{"issue_id":"casg-j37.7","depends_on_id":"casg-j37.5","type":"blocks","created_at":"2026-01-10T23:24:17.321699819Z","created_by":"cyou"},{"issue_id":"casg-j37.7","depends_on_id":"casg-j37.6","type":"blocks","created_at":"2026-01-10T23:24:17.801038656Z","created_by":"cyou"},{"issue_id":"casg-j37.7","depends_on_id":"casg-j37.13","type":"blocks","created_at":"2026-01-10T23:42:21.508248683Z","created_by":"cyou"}]}
{"id":"casg-j37.8","title":"next() implementation with state-based timeout behavior","description":"## Overview\nImplement the next() function with full state-dependent behavior.\n\n## Signature\n```gleam\npub fn next(stream: QueryStream) -\u003e #(Result(StreamItem, StreamError), QueryStream)\n```\n\n## Timeout Behavior by State (from plan lines 3622-3641)\n| Stream State | Timeout Behavior | Notes |\n|--------------|------------------|-------|\n| Streaming (before Result) | Blocks indefinitely | User controls via max_turns/max_budget |\n| ResultReceived (after Result) | 100ms timeout per call | Drain behavior |\n| Closed | Returns immediately | No I/O needed |\n\n## Return Value Classification\n**Ok variants**:\n- Ok(Message(envelope)) -\u003e call next() again\n- Ok(WarningEvent(warning)) -\u003e call next() again\n- Ok(EndOfStream) -\u003e stop iteration\n\n**Error variants**:\n- Error(JsonDecodeError(_)) -\u003e Non-terminal, call next() again\n- Error(UnexpectedMessageError(_)) -\u003e Non-terminal, call next() again\n- Error(ProcessError(_)) -\u003e Terminal, stop iteration\n- Error(BufferOverflow) -\u003e Terminal, stop iteration\n- Error(TooManyDecodeErrors(_)) -\u003e Terminal, stop iteration\n\n## Critical Contract (from plan lines 3532-3553)\n**Always use returned QueryStream** - old copies have stale buffer/counters.\n\n## Implementation\n1. Check closed flag -\u003e return Ok(EndOfStream) if true\n2. Check state for appropriate receive timeout\n3. Call port_ffi.receive_blocking() or receive_timeout()\n4. Process data through line buffer\n5. Parse JSON, update state machine\n6. Return (result, updated_stream)\n\n## Unit Tests (using test_runner)\n- All acceptance criteria from plan lines 4693-4701","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-10T23:23:09.780030412Z","created_by":"cyou","updated_at":"2026-01-10T23:23:09.780030412Z","dependencies":[{"issue_id":"casg-j37.8","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:23:09.781085056Z","created_by":"cyou"},{"issue_id":"casg-j37.8","depends_on_id":"casg-j37.6","type":"blocks","created_at":"2026-01-10T23:24:18.283731763Z","created_by":"cyou"},{"issue_id":"casg-j37.8","depends_on_id":"casg-j37.7","type":"blocks","created_at":"2026-01-10T23:24:23.869004528Z","created_by":"cyou"},{"issue_id":"casg-j37.8","depends_on_id":"casg-j37.13","type":"blocks","created_at":"2026-01-10T23:42:26.591790174Z","created_by":"cyou"}]}
{"id":"casg-j37.9","title":"close() with idempotent cleanup and mailbox drain","description":"## Overview\nImplement the close() function with proper cleanup semantics.\n\n## Signature\n```gleam\npub fn close(stream: QueryStream) -\u003e Nil\n```\n\n## Semantics (from plan lines 3658-3666)\n- **Idempotent**: Safe to call multiple times; subsequent calls are no-ops\n- **Bounded-blocking**: Closes port then drains mailbox (bounded)\n- **Auto-called**: Called automatically on terminal errors and EndOfStream\n- **Same-process**: MUST be called from same process that called query()\n\n## Implementation Notes\n- Use port_ffi.ffi_close_port(port) which performs a bounded mailbox drain (max 100 msgs, 50ms timeout per msg)\n- close() itself should not attempt semantic drain; explicit close is user abort\n- Must only drain messages **for this Port** (mailbox isolation)\n\n## Pseudocode\n```gleam\npub fn close(stream: QueryStream) -\u003e Nil {\n  case stream.closed {\n    True -\u003e Nil\n    False -\u003e port_ffi.ffi_close_port(stream.port)\n  }\n}\n```\n\n## Acceptance Criteria\n- Calling close() multiple times is safe and does not crash\n- close() always calls port_close + bounded drain once\n- close() does NOT parse/emit any remaining messages (user-initiated abort)\n- Mailbox drain filters on Port (no cross-contamination)\n","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-10T23:23:26.114000138Z","created_by":"cyou","updated_at":"2026-01-10T23:33:23.487848277Z","dependencies":[{"issue_id":"casg-j37.9","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:23:26.114637544Z","created_by":"cyou"},{"issue_id":"casg-j37.9","depends_on_id":"casg-j37.5","type":"blocks","created_at":"2026-01-10T23:24:24.364742411Z","created_by":"cyou"}]}
{"id":"casg-k92","title":"Epic 1: Foundation Types \u0026 Decoders","description":"## Overview\nDefine all message types and JSON decoders with forward compatibility. This establishes the data model that all streaming and query operations depend on.\n\n## Why This is Critical\n- Message schema assumptions affect all downstream streaming code\n- Wrong type definitions will cascade bugs through the entire SDK\n- Forward compatibility (UnknownBlock, raw_json preservation) prevents breaking on CLI updates\n\n## Scope\n1. **Message Types** (src/claude_agent_sdk/message.gleam):\n   - SystemMessage, AssistantMessage, UserMessage, ResultMessage\n   - Message union type with all variants\n   - Core vs Extra field classification\n\n2. **Content Block Types** (src/claude_agent_sdk/content.gleam):\n   - TextBlock, ToolUseBlock, ToolResultBlock\n   - UnknownBlock for forward compatibility\n   - ContentBlock union type\n\n3. **Error Types** (src/claude_agent_sdk/error.gleam):\n   - QueryError with all variants (CliNotFoundError, ProcessError, etc.)\n   - StreamError (JsonDecodeError, BufferOverflow, etc.)\n   - Terminal vs non-terminal error classification\n\n4. **JSON Decoders** (src/claude_agent_sdk/internal/decoder.gleam):\n   - Message decoder with type dispatch\n   - Content block decoders\n   - raw_json preservation contract\n\n5. **Test Fixtures** (test/fixtures/):\n   - system_message.json, assistant_message.json, result_*.json\n   - unknown_message_type.json, unknown_content_block.json\n   - README documenting CLI version used\n\n## Success Criteria\n- All message types compile with proper field classification\n- Decoders handle known and unknown types gracefully\n- raw_json is preserved exactly (no re-encoding)\n- Fixtures pass decode/encode roundtrip tests\n\n## Dependencies\n- Depends on Epic 0 (project setup must complete first)\n\n## Plan References\n- Message Schema sections\n- Content Block Type System\n- JSON Decode Contract\n- raw_json preservation contract","status":"open","priority":1,"issue_type":"epic","created_at":"2026-01-10T23:19:43.42464702Z","created_by":"cyou","updated_at":"2026-01-10T23:19:43.42464702Z","dependencies":[{"issue_id":"casg-k92","depends_on_id":"casg-va1","type":"blocks","created_at":"2026-01-10T23:19:51.971617021Z","created_by":"cyou"}]}
{"id":"casg-k92.1","title":"Create test fixtures and failing decode tests","description":"## Goal\nSet up JSON test fixtures and initial failing decode tests that will drive TDD implementation of all decoders.\n\n## Context\nSPEC: Schema Source and Forward Compatibility (lines 3131-3224)\nSPEC: Test Structure (lines 4743-4763)\n\n## Fixture Policy (from plan)\n- Unit tests must run without a real CLI installed\n- **Synthetic fixtures first** (spec-derived minimal JSON)\n- Real CLI fixtures are captured later and committed\n- Tests NEVER write fixtures at runtime\n\n## TDD Steps\n1. Create test/fixtures/ directory\n2. Create fixture files:\n   - system_message.json, system_message_minimal.json\n   - assistant_message.json, assistant_unknown_block.json\n   - user_message.json\n   - result_success.json, result_error.json\n   - unknown_message_type.json, unknown_content_block.json\n3. Create test/fixtures/README.md documenting CLI version and synthetic fixtures\n4. Create test/json_decode_test.gleam with failing tests\n5. Create skeleton src/claude_agent_sdk/internal/decoder.gleam (empty decoders that fail)\n\n## Files\n- test/fixtures/*.json â€” [New] â€” JSON fixtures (synthetic initially)\n- test/fixtures/README.md â€” [New] â€” CLI version documentation\n- test/json_decode_test.gleam â€” [New] â€” Failing decode tests\n- src/claude_agent_sdk/internal/decoder.gleam â€” [New] â€” Skeleton decoder module\n\n## Acceptance Criteria\n- All fixture files exist and contain valid JSON\n- test/json_decode_test.gleam compiles but tests fail (decoders not implemented)\n- gleam build passes, gleam test fails with expected decoder errors\n- README clearly marks synthetic fixtures\n\n## Verification\n- gleam build succeeds\n- gleam test shows failing tests for each fixture decode\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:21:59.859358604Z","created_by":"cyou","updated_at":"2026-01-11T00:25:30.788643187Z","closed_at":"2026-01-11T00:25:30.788643187Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-k92.1","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-10T23:21:59.85997814Z","created_by":"cyou"}]}
{"id":"casg-k92.10","title":"Create Phase 1 spec verification artifact","description":"## Goal\nCreate the Phase 1 spec verification artifact required by the plan: `test/phase1_spec_verification.gleam` with a comment block that records which spec headings were verified for required fields.\n\n## Context\nPlan reference: \"Required artifact (test/phase1_spec_verification.gleam comment block)\" in the Spec-Citation Verification Rules section.\n\nThis file is a **documentation-only artifact** (comments), used to preserve the reasoning behind required vs optional fields in decoders.\n\n## Deliverables\n- `test/phase1_spec_verification.gleam` with a comment block:\n```gleam\n// Spec Verification Results - Phase 1\n// Date: YYYY-MM-DD\n// Spec version: plans/CLAUDE_AGENT_SDK_SPEC.md (commit hash)\n//\n// Field: type (all messages)\n// Heading: SPEC: Message Schema\n// Verified: YES - \"type field MUST be present\"\n//\n// Field: session_id (SystemMessage)\n// Heading: SPEC: System Message (NOT FOUND - used \"System Init\")\n// Verified: NO - SHOULD language only, defaulted to Optional\n```\n\n## Procedure (from plan)\n1. Search spec for exact heading cited in plan\n2. If found: check for MUST/REQUIRED language\n3. If not found: update heading string and default field to Optional\n4. Record result in the comment block (â‰¤25 words per field)\n\n## Acceptance Criteria\n- Comment block exists with date + spec commit hash\n- Each required field lists heading + verification result\n- Any heading mismatch is recorded and defaults to Optional\n- File contains no executable code (comments only)\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:36:03.64301621Z","created_by":"cyou","updated_at":"2026-01-11T00:22:56.911228421Z","closed_at":"2026-01-11T00:22:56.911228421Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-k92.10","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-10T23:36:03.643581867Z","created_by":"cyou"}]}
{"id":"casg-k92.11","title":"Capture real CLI fixtures and help excerpt","description":"## Goal\nCapture real CLI fixtures (follow-up to synthetic fixtures) and save the `claude --help` excerpt used for flag validation.\n\n## Context\nPlan reference: \"Real fixture capture (follow-up)\" and \"cli_help_excerpt.txt\" in fixtures policy.\n\n## Deliverables\n- `test/fixtures/*.json` captured from real CLI output:\n  - system_message.json\n  - assistant_message.json\n  - user_message.json\n  - result_success.json\n  - result_error.json\n- `test/fixtures/cli_help_excerpt.txt` captured from `claude --help`\n- Update `test/fixtures/README.md` with:\n  - CLI version\n  - capture date\n  - capture command(s)\n\n## Capture Commands\n```bash\nclaude --print --output-format stream-json --verbose -- \"hello\"\nclaude --help\n```\n\n## Acceptance Criteria\n- Fixtures reflect real CLI output (not synthetic)\n- README records exact CLI version and capture date\n- cli_help_excerpt.txt includes required flags: --print, --output-format, --verbose\n","status":"in_progress","priority":2,"issue_type":"task","created_at":"2026-01-10T23:37:18.765438822Z","created_by":"cyou","updated_at":"2026-01-11T00:25:31.306340231Z","dependencies":[{"issue_id":"casg-k92.11","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-10T23:37:18.766424934Z","created_by":"cyou"},{"issue_id":"casg-k92.11","depends_on_id":"casg-k92.1","type":"blocks","created_at":"2026-01-10T23:42:01.197734624Z","created_by":"cyou"}]}
{"id":"casg-k92.12","title":"[Review] 3 non-blocking findings from casg-k92.10","description":"## Review Findings\n\nThis issue consolidates 3 non-blocking findings from code review.\n\n**Source issue:** casg-k92.10\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Incomplete field verification - missing 3 required fields\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** test/phase1_spec_verification.gleam:1-23\n\nThe **Canonical decoder policy table** in the plan (lines 3158-3165) specifies 5 fields that need Phase 1 verification:\n\n1. All messages - `type` âœ“ (verified)\n2. SystemMessage - `session_id` âœ“ (verified)\n3. AssistantMessage - `message.content` âœ— (missing)\n4. UserMessage - `message.content` âœ— (missing)\n5. ResultMessage - `subtype` âœ— (missing)\n\nThe verification artifact only covers items 1-2 and additionally verifies `subtype` and `uuid` for SystemMessage (which weren't in the canonical table). The verification is incomplete as it doesn't check AssistantMessage.message.content, UserMessage.message.content, or ResultMessage.subtype.\n\n**Fix**: Add verification entries for the 3 missing fields from the canonical table.\n\n---\n\n### Finding 2: [P3] Incorrect spec commit hash reference\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** test/phase1_spec_verification.gleam:3\n\nLine 3 references commit `bfb17717657136334390902e97a9f20c669f913f` as the spec version, but this commit (\"bd-casg-va1.12: Remove stale reference to deleted confirmed_imports.gleam\") doesn't modify the spec file at all - it only changes .beads/issues.jsonl.\n\nThe actual spec file (plans/CLAUDE_AGENT_SDK_SPEC.md) has only been modified in commit `e28b490` (initial commit). The commit hash should reference the actual commit that contains the spec version being verified.\n\n**Fix**: Update line 3 to reference `e28b490` or use `git log -1 --format=%H plans/CLAUDE_AGENT_SDK_SPEC.md` to get the correct hash.\n\n---\n\n### Finding 3: [P3] Verification claim contradicts spec-citation rules\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** test/phase1_spec_verification.gleam:5-7\n\nLine 7 claims verification \"YES - 'All messages are JSON objects with a `type` field'\" but this doesn't follow the spec-citation verification rules.\n\nPer plan lines 20-21:\n- **Required**: Spec uses MUST/REQUIRED language under an EXACT heading match\n- **Optional**: Spec uses SHOULD/MAY, or field not mentioned, or heading not found\n\nThe spec statement \"All messages are JSON objects with a `type` field\" is a factual assertion but doesn't use MUST/REQUIRED keywords. The spec contains NO instances of MUST or REQUIRED anywhere (verified via grep).\n\n**According to the verification procedure**, this should be marked as Optional, not Required. However, `type` is semantically required for message dispatch, so the conclusion may be correct even if the reasoning is flawed.\n\n**Recommendation**: Either:\n1. Clarify that semantic requirements override keyword rules, OR\n2. Mark as \"NO - no MUST/REQUIRED keywords, but semantically required for dispatch\"\n\n---\n\n\u003c!-- fp:ecb19a30979b5de5 --\u003e\n\u003c!-- fp:6dfe721a5d035209 --\u003e\n\u003c!-- fp:7034b9db0e2cda9d --\u003e\n\u003c!-- review_finding:e33b1825bb75 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T00:22:57.09291335Z","created_by":"cyou","updated_at":"2026-01-11T00:25:54.954593012Z","closed_at":"2026-01-11T00:25:54.954593012Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-k92.10"],"dependencies":[{"issue_id":"casg-k92.12","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-11T00:22:57.093989962Z","created_by":"cyou"}]}
{"id":"casg-k92.13","title":"[Review] 1 non-blocking finding from casg-k92.2","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-k92.2\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] ToolResultBlock missing required fields from JSON schema\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/message.gleam:157-164\n\nThe `ToolResultBlock` type definition is incomplete compared to the actual JSON structure in test fixtures.\n\n**Current definition:**\n```gleam\npub type ToolResultBlock {\n  ToolResultBlock(\n    tool_use_id: String,\n    content: String,\n  )\n}\n```\n\n**Actual JSON structure** (from `test/fixtures/user_message.json`):\n```json\n{\n  \"tool_use_id\": \"toolu_01BeipFBP3sUY3EAwVg3qQnE\",\n  \"type\": \"tool_result\",\n  \"content\": \"...\",\n  \"is_error\": false\n}\n```\n\n**Missing fields:**\n- `type`: String field (always \"tool_result\") - may be needed for decoder discrimination\n- `is_error`: Boolean field indicating if the tool execution failed\n\n**Recommended fix:**\n```gleam\npub type ToolResultBlock {\n  ToolResultBlock(\n    tool_use_id: String,\n    block_type: Option(String),  // or hardcode as \"tool_result\"\n    content: String,\n    is_error: Option(Bool),\n  )\n}\n```\n\nThis mismatch will cause the decoder implementation to either fail or silently ignore these fields, potentially losing important error information.\n\n---\n\n\u003c!-- fp:d21e0652e431f399 --\u003e\n\u003c!-- review_finding:2a8dbde2dd11 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T00:28:57.535454663Z","created_by":"cyou","updated_at":"2026-01-11T00:31:48.541078721Z","closed_at":"2026-01-11T00:31:48.541078721Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-k92.2"],"dependencies":[{"issue_id":"casg-k92.13","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-11T00:28:57.53599831Z","created_by":"cyou"}]}
{"id":"casg-k92.14","title":"[Review] 1 non-blocking finding from casg-k92.3","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-k92.3\n**Highest priority:** P3\n\n---\n\n### Finding 1: [P3] ToolResultBlock missing is_error field from API spec\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/content.gleam:22-24\n\nThe `ToolResultBlock` type only captures `tool_use_id` and `content` fields, but the Anthropic Messages API specification includes an optional `is_error: boolean` field for tool_result blocks. The actual CLI output (test/fixtures/user_message.json:10) contains this field.\n\n**Current implementation:**\n```gleam\npub type ToolResultBlock {\n  ToolResultBlock(tool_use_id: String, content: String)\n}\n```\n\n**Suggestion:** Consider adding `is_error: Option(Bool)` to capture error state:\n```gleam\npub type ToolResultBlock {\n  ToolResultBlock(\n    tool_use_id: String,\n    content: String,\n    is_error: Option(Bool)\n  )\n}\n```\n\nThis field indicates whether a tool execution resulted in an error, which can be useful for error handling and debugging. While the decoder policy states that unmentioned fields should be ignored, capturing documented API fields improves type safety and developer experience.\n\n**Note:** This is marked P3 because the decoder will handle the missing field gracefully per the forward compatibility policy (unknown fields are silently ignored). However, capturing all documented API fields would make the SDK more complete and useful.\n\n---\n\n\u003c!-- fp:00e2301ed806604c --\u003e\n\u003c!-- review_finding:6319f310369c --\u003e","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-11T00:30:09.611363874Z","created_by":"cyou","updated_at":"2026-01-11T00:30:43.872135955Z","closed_at":"2026-01-11T00:30:43.872135955Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-k92.3"],"dependencies":[{"issue_id":"casg-k92.14","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-11T00:30:09.612021209Z","created_by":"cyou"}]}
{"id":"casg-k92.15","title":"[Review] 1 non-blocking finding from casg-k92.13","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-k92.13\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Duplicate ToolResultBlock type definitions may cause confusion\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/message.gleam:160-169\n\nThe commit adds `is_error: Option(Bool)` to `ToolResultBlock` in both `content.gleam` and `message.gleam`. However, this creates two separate type definitions with the same name and structure:\n\n**In content.gleam (lines 23-32)**:\n```gleam\npub type ToolResultBlock {\n  ToolResultBlock(\n    tool_use_id: String,\n    content: String,\n    is_error: Option(Bool),\n  )\n}\n```\n\n**In message.gleam (lines 160-169)**:\n```gleam\npub type ToolResultBlock {\n  ToolResultBlock(\n    tool_use_id: String,\n    content: String,\n    is_error: Option(Bool),\n  )\n}\n```\n\n**Issue**: Having two separate definitions with identical structure is confusing and error-prone. If one is updated and not the other, they will diverge. The `message.gleam` file doesn't import from `content.gleam`, suggesting these are meant to be independent, but this violates DRY principle.\n\n**Recommendation**: \n1. Define `ToolResultBlock` once in `content.gleam` (since it's a content block type)\n2. Import and re-export it from `message.gleam` if needed for API surface\n3. Or, document why two separate definitions are intentional\n\nThis issue was introduced by updating both definitions when adding the `is_error` field, but the duplication pre-existed this commit.\n\n---\n\n\u003c!-- fp:e6e57ddd7f39edd7 --\u003e\n\u003c!-- review_finding:01ee24bb1e52 --\u003e","status":"in_progress","priority":2,"issue_type":"task","created_at":"2026-01-11T00:31:48.763898009Z","created_by":"cyou","updated_at":"2026-01-11T00:31:48.941776641Z","labels":["auto_generated","review_finding","source:casg-k92.13"],"dependencies":[{"issue_id":"casg-k92.15","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-11T00:31:48.765028092Z","created_by":"cyou"}]}
{"id":"casg-k92.2","title":"Define base message types in message.gleam","description":"## Goal\nImplement all message type definitions that will be populated by JSON decoders.\n\n## Context\nSPEC: Message Types (lines 3282-3494)\nSPEC: Message Field Classification (lines 3348-3494)\n\n## TDD Steps\n1. Read existing test/json_decode_test.gleam to understand expected types\n2. Create src/claude_agent_sdk/message.gleam with:\n   - Message (discriminated union: System, Assistant, User, Result)\n   - MessageEnvelope (message, raw_json, raw_bytes)\n   - SystemMessage with all Optional fields per decoder policy\n   - AssistantMessage with AssistantMessageContent\n   - UserMessage with UserMessageContent\n   - ResultMessage with ResultSubtype\n   - Usage, McpServerStatus, PermissionDenial supporting types\n3. Update tests to import and use types\n\n## Files\n- src/claude_agent_sdk/message.gleam â€” [New] â€” All message type definitions\n- test/json_decode_test.gleam â€” [Exists] â€” Update imports\n\n## Acceptance Criteria\n- All message types compile with proper Option wrapping\n- Message is discriminated union with System/Assistant/User/Result\n- ResultSubtype includes Success, ErrorMaxTurns, ErrorDuringExecution, ErrorMaxBudget, UnknownSubtype\n- Usage type has optional input_tokens, output_tokens, cache_* fields\n\n## Verification\n- gleam build succeeds\n- Types can be imported in test file","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:22:10.49035084Z","created_by":"cyou","updated_at":"2026-01-11T00:28:57.328337241Z","closed_at":"2026-01-11T00:28:57.328337241Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-k92.2","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-10T23:22:10.491474704Z","created_by":"cyou"},{"issue_id":"casg-k92.2","depends_on_id":"casg-k92.1","type":"blocks","created_at":"2026-01-10T23:23:39.129713415Z","created_by":"cyou"},{"issue_id":"casg-k92.2","depends_on_id":"casg-k92.10","type":"blocks","created_at":"2026-01-10T23:42:06.268254797Z","created_by":"cyou"}]}
{"id":"casg-k92.3","title":"Define content block types in content.gleam","description":"## Goal\nImplement content block type definitions for assistant and user message content.\n\n## Context\nSPEC: Content block types (lines 3407-3442)\nSPEC: Forward compatibility (lines 3146-3147)\n\n## TDD Steps\n1. Create src/claude_agent_sdk/content.gleam with:\n   - ContentBlock discriminated union (TextBlock, ToolUseBlock, UnknownBlock)\n   - TextBlock(text: String)\n   - ToolUseBlock(id: String, name: String, input: Dynamic)\n   - UnknownBlock(raw: Dynamic) for forward compatibility\n   - ToolResultBlock(tool_use_id: String, content: String)\n2. Update message.gleam imports if needed\n3. Update tests to verify types compile\n\n## Files\n- src/claude_agent_sdk/content.gleam â€” [New] â€” Content block type definitions\n- src/claude_agent_sdk/message.gleam â€” [Exists] â€” May need to import content types\n\n## Acceptance Criteria\n- ContentBlock is discriminated union with TextBlock, ToolUseBlock, UnknownBlock\n- UnknownBlock preserves raw Dynamic for forward compatibility\n- ToolUseBlock.input is Dynamic (not decoded further)\n- ToolResultBlock separate type for user message content\n\n## Verification\n- gleam build succeeds\n- Content types can be used in message.gleam","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:22:20.057771515Z","created_by":"cyou","updated_at":"2026-01-11T00:30:09.386919519Z","closed_at":"2026-01-11T00:30:09.386919519Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-k92.3","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-10T23:22:20.058417461Z","created_by":"cyou"},{"issue_id":"casg-k92.3","depends_on_id":"casg-k92.1","type":"blocks","created_at":"2026-01-10T23:23:39.19005098Z","created_by":"cyou"},{"issue_id":"casg-k92.3","depends_on_id":"casg-k92.10","type":"blocks","created_at":"2026-01-10T23:42:11.348511695Z","created_by":"cyou"}]}
{"id":"casg-k92.4","title":"Define error types in error.gleam","description":"## Goal\nImplement all error, warning, and stream item types used for SDK error handling.\n\n## Context\nSPEC: StreamError Type (lines 3867-3959)\nSPEC: QueryError Type (lines 4111-4139)\nSPEC: Warning Type (lines 4025-4042)\nSPEC: Error Taxonomy (lines 4090-4107)\n\n## TDD Steps\n1. Create src/claude_agent_sdk/error.gleam with:\n   - StreamError variants: ProcessError, BufferOverflow, TooManyDecodeErrors, JsonDecodeError, UnexpectedMessageError\n   - QueryError variants: CliNotFoundError, UnsupportedCliVersionError, UnknownVersionError, VersionDetectionError, SpawnError\n   - ErrorDiagnostic for ProcessError context\n   - Warning and WarningCode types\n   - StreamItem discriminated union (Message, WarningEvent, EndOfStream)\n   - is_terminal(StreamError) -\u003e Bool function\n   - error_to_string and stream_error_to_string functions\n2. Write tests for is_terminal() behavior\n\n## Files\n- src/claude_agent_sdk/error.gleam â€” [New] â€” All error type definitions\n- test/error_test.gleam â€” [New] â€” Tests for is_terminal()\n\n## Acceptance Criteria\n- ProcessError, BufferOverflow, TooManyDecodeErrors are terminal (is_terminal returns True)\n- JsonDecodeError, UnexpectedMessageError are non-terminal (is_terminal returns False)\n- ErrorDiagnostic includes last_non_json_line, stdout_was_empty, exit_code_hint, troubleshooting\n- WarningCode includes CleanExitNoResult, NonZeroExitAfterResult, UnexpectedMessageAfterResult, UnparseableCliVersion\n\n## Verification\n- gleam build succeeds\n- gleam test error_test.gleam passes","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:22:32.817457245Z","created_by":"cyou","updated_at":"2026-01-11T00:32:38.218545201Z","closed_at":"2026-01-11T00:32:38.218545201Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-k92.4","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-10T23:22:32.818072181Z","created_by":"cyou"},{"issue_id":"casg-k92.4","depends_on_id":"casg-k92.1","type":"blocks","created_at":"2026-01-10T23:23:39.249358672Z","created_by":"cyou"}]}
{"id":"casg-k92.5","title":"Implement content block JSON decoders","description":"## Goal\nImplement JSON decoders for ContentBlock and ToolResultBlock with UnknownBlock fallback for forward compatibility.\n\n## Context\nSPEC: JSON Decoding Strategy (lines 3496-3502)\nSPEC: Content block types (lines 3407-3442)\nSPEC: Forward compatibility (lines 3146-3147)\n\n## TDD Steps\n1. Update src/claude_agent_sdk/internal/decoder.gleam with:\n   - decode_content_block(Dynamic) -\u003e Result(ContentBlock, DecodeErrors)\n   - decode_text_block(Dynamic) -\u003e Result(TextBlock, DecodeErrors)\n   - decode_tool_use_block(Dynamic) -\u003e Result(ToolUseBlock, DecodeErrors)\n   - decode_tool_result_block(Dynamic) -\u003e Result(ToolResultBlock, DecodeErrors)\n2. Implement type-dispatch logic: check type field, route to appropriate decoder\n3. Unknown type field values yield UnknownBlock(raw) instead of decode error\n4. Run tests against unknown_content_block.json fixture\n\n## Files\n- src/claude_agent_sdk/internal/decoder.gleam â€” [Exists] â€” Add content block decoders\n- test/json_decode_test.gleam â€” [Exists] â€” Verify content block decode tests pass\n\n## Acceptance Criteria\n- TextBlock decodes {\"type\":\"text\",\"text\":\"hello\"} correctly\n- ToolUseBlock decodes id, name, input fields\n- Unknown block type yields UnknownBlock(raw) with original Dynamic\n- Missing required fields (text for TextBlock, id/name for ToolUseBlock) yield decode error\n\n## Verification\n- gleam test test/json_decode_test.gleam passes for content block fixtures","status":"in_progress","priority":1,"issue_type":"task","created_at":"2026-01-10T23:22:44.224585433Z","created_by":"cyou","updated_at":"2026-01-11T00:30:09.804259313Z","dependencies":[{"issue_id":"casg-k92.5","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-10T23:22:44.225155799Z","created_by":"cyou"},{"issue_id":"casg-k92.5","depends_on_id":"casg-k92.3","type":"blocks","created_at":"2026-01-10T23:23:42.878265074Z","created_by":"cyou"}]}
{"id":"casg-k92.6","title":"Implement message type JSON decoders","description":"## Goal\nImplement JSON decoders for all message types with proper Optional field handling per decoder policy.\n\n## Context\nSPEC: Message Types (lines 3282-3494)\nSPEC: Canonical Decoder Policy Table (lines 3154-3213)\nSPEC: Decode Failure Semantics (lines 3172-3183)\n\n## TDD Steps\n1. Update src/claude_agent_sdk/internal/decoder.gleam with:\n   - decode_system_message(Dynamic) -\u003e Result(SystemMessage, DecodeErrors)\n   - decode_assistant_message(Dynamic) -\u003e Result(AssistantMessage, DecodeErrors)\n   - decode_user_message(Dynamic) -\u003e Result(UserMessage, DecodeErrors)\n   - decode_result_message(Dynamic) -\u003e Result(ResultMessage, DecodeErrors)\n   - decode_message(Dynamic) -\u003e Result(Message, DecodeErrors) (top-level dispatcher)\n2. Only `type` field is required; all others use optional_field\n3. Dispatch based on type field: system, assistant, user, result\n4. Unknown type field yields appropriate error for UnexpectedMessageError\n\n## Files\n- src/claude_agent_sdk/internal/decoder.gleam â€” [Exists] â€” Add message decoders\n- test/json_decode_test.gleam â€” [Exists] â€” Verify message decode tests pass\n\n## Acceptance Criteria\n- System message decodes with all Optional fields (session_id, uuid, cwd, model, tools, etc.)\n- Assistant message decodes with Optional message.content containing List(ContentBlock)\n- User message decodes with Optional message.content containing List(ToolResultBlock)\n- Result message decodes with Optional subtype (Success, ErrorMaxTurns, etc.)\n- Unknown message type returns error (will become UnexpectedMessageError in stream layer)\n- Minimal fixtures (only type field) decode successfully\n\n## Verification\n- gleam test test/json_decode_test.gleam passes for all message fixtures\n- system_message_minimal.json decodes to SystemMessage with all None fields","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-10T23:22:56.194434878Z","created_by":"cyou","updated_at":"2026-01-10T23:22:56.194434878Z","dependencies":[{"issue_id":"casg-k92.6","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-10T23:22:56.194988655Z","created_by":"cyou"},{"issue_id":"casg-k92.6","depends_on_id":"casg-k92.2","type":"blocks","created_at":"2026-01-10T23:23:46.828157975Z","created_by":"cyou"},{"issue_id":"casg-k92.6","depends_on_id":"casg-k92.5","type":"blocks","created_at":"2026-01-10T23:23:46.885895816Z","created_by":"cyou"},{"issue_id":"casg-k92.6","depends_on_id":"casg-k92.8","type":"blocks","created_at":"2026-01-10T23:23:46.945865024Z","created_by":"cyou"}]}
{"id":"casg-k92.7","title":"Implement MessageEnvelope decoder with raw_json preservation","description":"## Goal\nImplement MessageEnvelope decoder that preserves raw_json byte-for-byte per the preservation contract.\n\n## Context\nSPEC: raw_json preservation contract (lines 3302-3345)\nSPEC: MessageEnvelope type (lines 3294-3300)\n\n## TDD Steps\n1. Update src/claude_agent_sdk/internal/decoder.gleam with:\n   - decode_message_envelope(json_string: String, raw_bytes: BitArray) -\u003e Result(MessageEnvelope, DecodeError)\n2. Implementation:\n   a. Store raw_json = json_string (exact UTF-8 string)\n   b. Store raw_bytes = raw_bytes (exact bytes)\n   c. Parse JSON with gleam_json\n   d. Decode Message using decode_message\n   e. Return MessageEnvelope(message, raw_json, raw_bytes)\n3. Add test verifying raw_json == fixture content byte-for-byte\n4. Add test verifying raw_bytes matches original input\n\n## Files\n- src/claude_agent_sdk/internal/decoder.gleam â€” [Exists] â€” Add envelope decoder\n- test/json_decode_test.gleam â€” [Exists] â€” Add raw preservation tests\n\n## Acceptance Criteria\n- raw_json field contains exact input string, not re-encoded JSON\n- raw_bytes field contains exact input BitArray\n- Decode errors include the raw_json for debugging\n- MessageEnvelope.message contains fully decoded Message\n\n## Verification\n- gleam test verifies raw_json byte-for-byte matches fixture file\n- gleam test verifies raw_bytes matches bit_array.from_string(fixture)","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-10T23:23:07.650539252Z","created_by":"cyou","updated_at":"2026-01-10T23:23:07.650539252Z","dependencies":[{"issue_id":"casg-k92.7","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-10T23:23:07.651112878Z","created_by":"cyou"},{"issue_id":"casg-k92.7","depends_on_id":"casg-k92.6","type":"blocks","created_at":"2026-01-10T23:23:50.957716833Z","created_by":"cyou"}]}
{"id":"casg-k92.8","title":"Implement supporting type decoders (Usage, ResultSubtype, McpServerStatus)","description":"## Goal\nImplement JSON decoders for supporting types used within message structures.\n\n## Context\nSPEC: Usage type (lines 3474-3481)\nSPEC: ResultSubtype (lines 3466-3472)\nSPEC: McpServerStatus (lines 3483-3485)\nSPEC: PermissionDenial (lines 3487-3493)\n\n## TDD Steps\n1. Update src/claude_agent_sdk/internal/decoder.gleam with:\n   - decode_usage(Dynamic) -\u003e Result(Usage, DecodeErrors)\n   - decode_result_subtype(String) -\u003e ResultSubtype\n   - decode_mcp_server_status(Dynamic) -\u003e Result(McpServerStatus, DecodeErrors)\n   - decode_permission_denial(Dynamic) -\u003e Result(PermissionDenial, DecodeErrors)\n2. ResultSubtype dispatch:\n   - \"success\" -\u003e Success\n   - \"error_max_turns\" -\u003e ErrorMaxTurns\n   - \"error_during_execution\" -\u003e ErrorDuringExecution\n   - \"error_max_budget\" -\u003e ErrorMaxBudget\n   - unknown -\u003e UnknownSubtype(raw_string)\n3. All Usage fields are optional (may be absent in older CLI versions)\n\n## Files\n- src/claude_agent_sdk/internal/decoder.gleam â€” [Exists] â€” Add supporting type decoders\n- test/json_decode_test.gleam â€” [Exists] â€” Add tests for edge cases\n\n## Acceptance Criteria\n- Usage decodes with all Optional Int fields\n- ResultSubtype handles unknown values via UnknownSubtype(String)\n- McpServerStatus decodes name and status fields\n- PermissionDenial decodes tool_name, tool_use_id, tool_input\n\n## Verification\n- gleam test passes for result_success.json and result_error.json fixtures\n- Unknown subtype string yields UnknownSubtype rather than decode error","notes":"Quality gate failed: Killed as deadlock victim (will retry after blocker completes)","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-10T23:23:19.341451233Z","created_by":"cyou","updated_at":"2026-01-11T00:30:43.254847886Z","labels":["needs-followup"],"dependencies":[{"issue_id":"casg-k92.8","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-10T23:23:19.34204528Z","created_by":"cyou"},{"issue_id":"casg-k92.8","depends_on_id":"casg-k92.2","type":"blocks","created_at":"2026-01-10T23:23:42.932051107Z","created_by":"cyou"},{"issue_id":"casg-k92.8","depends_on_id":"casg-k92.11","type":"blocks","created_at":"2026-01-11T00:30:41.030569744Z","created_by":"cyou"}]}
{"id":"casg-k92.9","title":"Wire up public API re-exports for Epic 1 types","description":"## Goal\nConfigure public module exports so Epic 1 types are accessible via the main SDK module.\n\n## Context\nSPEC: Main module re-exports (lines 4335-4345)\nSPEC: Module paths (lines 51-57)\n\n## TDD Steps\n1. Update src/claude_agent_sdk.gleam to re-export:\n   - From message.gleam: Message, MessageEnvelope, SystemMessage, AssistantMessage, UserMessage, ResultMessage\n   - From content.gleam: ContentBlock, TextBlock, ToolUseBlock, UnknownBlock\n   - From error.gleam: QueryError, StreamError, ErrorDiagnostic, is_terminal, StreamItem, Warning, WarningCode\n   - Supporting types: ResultSubtype, Usage, McpServerStatus, PermissionDenial\n2. Verify internal decoder module is NOT exported (internal only)\n3. Add example imports to test that validates API surface\n\n## Files\n- src/claude_agent_sdk.gleam â€” [Exists] â€” Add re-exports\n- test/api_surface_test.gleam â€” [New] â€” Verify public imports work\n\n## Acceptance Criteria\n- Users can import types via: import claude_agent_sdk.{Message, SystemMessage, ...}\n- Internal decoder module not accessible from outside package\n- All Epic 1 types importable from main module\n\n## Verification\n- gleam build succeeds\n- test/api_surface_test.gleam compiles and passes\n- gleam docs generates documentation for all public types","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-10T23:23:30.289225131Z","created_by":"cyou","updated_at":"2026-01-10T23:23:30.289225131Z","dependencies":[{"issue_id":"casg-k92.9","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-10T23:23:30.290184975Z","created_by":"cyou"},{"issue_id":"casg-k92.9","depends_on_id":"casg-k92.2","type":"blocks","created_at":"2026-01-10T23:23:54.91926884Z","created_by":"cyou"},{"issue_id":"casg-k92.9","depends_on_id":"casg-k92.3","type":"blocks","created_at":"2026-01-10T23:23:54.974472825Z","created_by":"cyou"},{"issue_id":"casg-k92.9","depends_on_id":"casg-k92.4","type":"blocks","created_at":"2026-01-10T23:23:55.031348591Z","created_by":"cyou"},{"issue_id":"casg-k92.9","depends_on_id":"casg-k92.7","type":"blocks","created_at":"2026-01-10T23:23:55.086289268Z","created_by":"cyou"}]}
{"id":"casg-tc3","title":"Epic 3: Testing Infrastructure","description":"## Overview\nBuild the testing infrastructure including test_runner() for unit tests, mock state management, and comprehensive stream semantics tests.\n\n## Why This is Critical\n- TDD requires test infrastructure before implementation tests\n- test_runner() enables testing without real CLI subprocess\n- Unit tests must not require claude binary (CI portability)\n\n## Scope\n1. **Test Helpers** (test/support/):\n   - env_helpers.gleam - FFI for os:getenv (no envoy dependency)\n   - ets_helpers.gleam - ETS FFI for mock state (TEST-ONLY)\n\n2. **test_runner()** (src/claude_agent_sdk/runner.gleam):\n   - Runner type with spawn/read_next/close function records\n   - test_runner() constructor for mocks\n   - ETS-based state management for stateful mocks\n\n3. **Stream Semantics Tests** (test/stream_test.gleam):\n   - Malformed JSON handling (non-terminal error)\n   - 5+ consecutive errors (terminal error)\n   - Buffer overflow (\u003e10MB line)\n   - exit_status ordering scenarios\n   - Result message semantics\n\n4. **Resource Safety Tests** (test/resource_test.gleam):\n   - with_stream cleanup on early return\n   - with_stream cleanup on panic\n   - collect_items cleanup\n   - Sequential queries don't cross-contaminate\n\n5. **JSON Decoder Tests** (test/json_decode_test.gleam):\n   - Fixture-based decode tests\n   - Unknown type handling\n   - raw_json preservation\n\n6. **CLI Args Tests** (test/cli_args_test.gleam):\n   - Option builder tests\n   - Conflicting option resolution\n   - All flag mappings\n\n## Success Criteria\n- All unit tests pass without claude binary\n- test_runner() provides full mock control\n- Stream error scenarios all tested\n- 100% coverage of error paths\n\n## Dependencies\n- Depends on Epic 0 (basic project structure)\n- Depends on Epic 1 (types to test)\n- Can start in parallel with Epic 2 (test infrastructure first)\n\n## Plan References\n- Unit Test Isolation Contract\n- test_runner() specification\n- Acceptance Criteria (Behavioral) table\n","status":"open","priority":2,"issue_type":"epic","created_at":"2026-01-10T23:19:44.468098163Z","created_by":"cyou","updated_at":"2026-01-10T23:35:36.084255609Z","dependencies":[{"issue_id":"casg-tc3","depends_on_id":"casg-va1","type":"blocks","created_at":"2026-01-10T23:19:52.129618638Z","created_by":"cyou"},{"issue_id":"casg-tc3","depends_on_id":"casg-k92","type":"blocks","created_at":"2026-01-10T23:19:52.182192807Z","created_by":"cyou"}]}
{"id":"casg-tc3.1","title":"Create ETS helpers skeleton for test_runner state management","description":"## Summary\nCreate `test/support/ets_helpers.gleam` with FFI bindings for ETS operations needed by test_runner().\n\n## Deliverables\n- `test/support/ets_helpers.gleam` with:\n  - `new(name: String) -\u003e Table` - FFI to ets:new/2\n  - `insert(table: Table, key: Dynamic, value: Dynamic) -\u003e Nil` - FFI to ets:insert/2\n  - `lookup(table: Table, key: Dynamic) -\u003e Option(Dynamic)` - FFI to ets:lookup/2\n  - `delete(table: Table, key: Dynamic) -\u003e Nil` - FFI to ets:delete/2\n  - `make_ref() -\u003e Dynamic` - FFI to erlang:make_ref/0\n\n## Unit Test Isolation Contract\n- ETS FFI MUST be in test/ directory only, NOT in src/\n- Ensures ETS is never used by runtime modules\n- Invariant: No src/**/*.gleam may import from test/**\n\n## Acceptance Criteria\n- [ ] ets_helpers.gleam compiles successfully\n- [ ] Basic test creates table, inserts, lookups, deletes\n- [ ] make_ref() returns unique refs on each call\n\n## Plan References\n- Lines 2319-2337: ETS FFI Requirements (TEST-ONLY)\n- Lines 2283-2317: ETS Example (Canonical)","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-10T23:21:39.794793674Z","created_by":"cyou","updated_at":"2026-01-10T23:21:39.794793674Z","dependencies":[{"issue_id":"casg-tc3.1","depends_on_id":"casg-tc3","type":"parent-child","created_at":"2026-01-10T23:21:39.79551163Z","created_by":"cyou"}]}
{"id":"casg-tc3.10","title":"Add resource safety helper tests","description":"## Summary\nAdd `test/resource_test.gleam` to validate resource-safety helpers (with_stream, collect_items, collect_messages, fold_stream).\n\n## Deliverables\n- `test/resource_test.gleam` with tests for:\n  - with_stream closes port on early return\n  - with_stream closes port on panic (use gleeunit should.panic or equivalent)\n  - collect_items closes port after full consumption\n  - collect_messages closes port and filters to messages\n  - fold_stream closes port even when fold stops early\n\n## Notes\n- Tests should use test_runner() mocks (no real CLI)\n- Verify close() is invoked exactly once for each helper\n\n## Acceptance Criteria\n- [ ] All helpers guarantee cleanup in tests\n- [ ] Early return/panic scenarios still close the stream\n- [ ] No real subprocesses spawned\n","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-10T23:36:41.645038839Z","created_by":"cyou","updated_at":"2026-01-10T23:36:41.645038839Z","dependencies":[{"issue_id":"casg-tc3.10","depends_on_id":"casg-tc3","type":"parent-child","created_at":"2026-01-10T23:36:41.645547486Z","created_by":"cyou"},{"issue_id":"casg-tc3.10","depends_on_id":"casg-j37.11","type":"blocks","created_at":"2026-01-10T23:42:51.988779891Z","created_by":"cyou"},{"issue_id":"casg-tc3.10","depends_on_id":"casg-tc3.3","type":"blocks","created_at":"2026-01-10T23:42:57.063815587Z","created_by":"cyou"}]}
{"id":"casg-tc3.11","title":"Add empty-stdout and incomplete-line warning tests","description":"## Summary\nAdd stream tests for empty-stdout and incomplete-line warning behavior at exit_status.\n\n## Deliverables\n- Additional tests in `test/stream_test.gleam`:\n  - exit_status=0 with no data -\u003e WarningEvent(CleanExitNoResult), EndOfStream\n  - exit_status=0 with incomplete buffer -\u003e WarningEvent(IncompleteLastLine), EndOfStream\n  - exit_status!=0 with empty stdout -\u003e ProcessError with stdout_was_empty=True\n  - exit_status!=0 with incomplete buffer -\u003e ProcessError with last_non_json_line populated\n\n## Acceptance Criteria\n- [ ] All scenarios map to the correct Warning or ProcessError\n- [ ] Warnings are non-terminal and followed by EndOfStream\n- [ ] Diagnostics fields (stdout_was_empty, last_non_json_line) populated correctly\n","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-10T23:36:52.818092331Z","created_by":"cyou","updated_at":"2026-01-10T23:36:52.818092331Z","dependencies":[{"issue_id":"casg-tc3.11","depends_on_id":"casg-tc3","type":"parent-child","created_at":"2026-01-10T23:36:52.818696747Z","created_by":"cyou"},{"issue_id":"casg-tc3.11","depends_on_id":"casg-tc3.4","type":"blocks","created_at":"2026-01-10T23:43:02.139249778Z","created_by":"cyou"},{"issue_id":"casg-tc3.11","depends_on_id":"casg-j37.6","type":"blocks","created_at":"2026-01-10T23:43:07.214962555Z","created_by":"cyou"},{"issue_id":"casg-tc3.11","depends_on_id":"casg-j37.7","type":"blocks","created_at":"2026-01-10T23:43:12.289891744Z","created_by":"cyou"}]}
{"id":"casg-tc3.2","title":"Create environment helpers for integration test gating","description":"## Summary\nCreate integration-gating helpers that use `test/support/env_helpers.gleam` (shared with Phase 0) to read environment variables.\n\n## Clarification (avoid duplication)\n- `test/support/env_helpers.gleam` is created in Phase 0 (casg-va1.4).\n- This task **reuses** that helper for integration test gating.\n- If env_helpers does not exist yet, create it here **exactly as specified** in casg-va1.4 (do not fork or diverge).\n\n## Deliverables\n- `test/query_integration_test.gleam` (or relevant integration test file) includes:\n  - `integration_enabled(test_name: String) -\u003e Bool`\n  - Reads `CLAUDE_INTEGRATION_TEST` env var via env_helpers.get_env\n\n## Usage Pattern\n```gleam\n// In integration tests\nimport support/env_helpers.{get_env}\n\nfn integration_enabled(test_name: String) -\u003e Bool {\n  case get_env(\"CLAUDE_INTEGRATION_TEST\") {\n    Ok(\"1\") -\u003e True\n    _ -\u003e {\n      io.println(\"[SKIP] \" \u003c\u003e test_name \u003c\u003e \" (set CLAUDE_INTEGRATION_TEST=1 to run)\")\n      False\n    }\n  }\n}\n```\n\n## Acceptance Criteria\n- [ ] integration_enabled() returns True when CLAUDE_INTEGRATION_TEST=1\n- [ ] integration_enabled() returns False and prints skip message otherwise\n- [ ] Uses env_helpers from Phase 0 (single shared helper)\n","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-10T23:21:48.410502245Z","created_by":"cyou","updated_at":"2026-01-10T23:34:08.693432399Z","dependencies":[{"issue_id":"casg-tc3.2","depends_on_id":"casg-tc3","type":"parent-child","created_at":"2026-01-10T23:21:48.410989332Z","created_by":"cyou"}]}
{"id":"casg-tc3.3","title":"Implement Runner type and test_runner() with ETS state","description":"## Summary\nImplement the Runner type and test_runner() function in `src/claude_agent_sdk/runner.gleam` that enables unit testing stream semantics without OS processes.\n\n## Deliverables\n- `src/claude_agent_sdk/runner.gleam` with:\n  - `Runner` opaque type (function record with spawn, read_next, close)\n  - `ReadResult` type: `Data(BitArray) | ExitStatus(Int) | ReadError(String) | Eof`\n  - `test_runner(on_spawn, on_read, on_close) -\u003e Runner` - public API for tests\n  - Handle as internal sum type (ErlangHandle, TestHandle)\n\n## test_runner() Signature\n```gleam\npub fn test_runner(\n  on_spawn: fn(String, List(String), String) -\u003e Result(Dynamic, String),\n  on_read: fn(Dynamic) -\u003e ReadResult,\n  on_close: fn(Dynamic) -\u003e Nil,\n) -\u003e Runner\n```\n\n## ETS State Pattern\nTests use ETS with unique ref key for concurrency-safe state management:\n- on_spawn: Create ref, insert initial state into ETS\n- on_read: Lookup state by ref, update ETS, return next ReadResult\n- on_close: Delete ref from ETS\n\n## Unit Test Isolation Contract\n- Handle is NOT pub - test code cannot construct directly\n- test_runner() accepts Dynamic values, wraps in TestHandle internally\n- Tests provide mock functions with their own state types (cast to/from Dynamic)\n\n## Acceptance Criteria\n- [ ] Runner type compiles with spawn, read_next, close functions\n- [ ] test_runner() creates Runner that calls provided callbacks\n- [ ] Handle variants distinguish ErlangHandle vs TestHandle\n- [ ] ReadResult covers Data, ExitStatus, ReadError, Eof cases\n\n## Plan References\n- Lines 2240-2270: test_runner() implementation\n- Lines 2279-2317: State Evolution with ETS\n- Lines 4403: runner.gleam in file map","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-10T23:22:03.65736901Z","created_by":"cyou","updated_at":"2026-01-10T23:22:03.65736901Z","dependencies":[{"issue_id":"casg-tc3.3","depends_on_id":"casg-tc3","type":"parent-child","created_at":"2026-01-10T23:22:03.658015826Z","created_by":"cyou"},{"issue_id":"casg-tc3.3","depends_on_id":"casg-tc3.1","type":"blocks","created_at":"2026-01-10T23:23:39.863220631Z","created_by":"cyou"}]}
{"id":"casg-tc3.4","title":"Create basic stream semantics test with valid JSON","description":"## Summary\nCreate `test/stream_test.gleam` with initial test demonstrating test_runner() usage with valid NDJSON stream.\n\n## Deliverables\n- `test/stream_test.gleam` with:\n  - Basic test that spawns via test_runner()\n  - Mock yields valid JSON lines (System, Assistant, Result messages)\n  - Verify next() returns Ok(Message(...)) for each valid line\n  - Verify stream ends with Ok(EndOfStream)\n\n## Test Pattern\n```gleam\npub fn valid_json_stream_test() {\n  let table = ets.new(\"mock_state\", [set, public])\n  \n  let runner = test_runner(\n    on_spawn: fn(_, _, _) {\n      let ref = make_ref()\n      ets.insert(table, {ref, [valid_system_json, valid_result_json]})\n      Ok(dynamic.from(ref))\n    },\n    on_read: fn(state) {\n      let ref = dynamic.unsafe_coerce(state)\n      case ets.lookup(table, ref) {\n        [{_, [line, ..rest]}] -\u003e {\n          ets.insert(table, {ref, rest})\n          Data(bit_array.from_string(line))\n        }\n        _ -\u003e Eof\n      }\n    },\n    on_close: fn(state) {\n      let ref = dynamic.unsafe_coerce(state)\n      ets.delete(table, ref)\n    },\n  )\n  \n  let options = default_options()\n    |\u003e with_test_mode(True, runner)\n    |\u003e with_skip_version_check(True)\n  \n  // Verify stream behavior...\n}\n```\n\n## Acceptance Criteria\n- [ ] Test file compiles and runs with `gleam test`\n- [ ] test_runner() successfully mocks stream behavior\n- [ ] Valid JSON lines decode to correct message types\n- [ ] Stream terminates cleanly with EndOfStream\n\n## Plan References\n- Lines 219-237: Standard unit test setup pattern\n- Lines 2287-2315: ETS Example (Canonical)\n- Lines 4751: stream_test.gleam in test structure","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-10T23:22:17.760502458Z","created_by":"cyou","updated_at":"2026-01-10T23:22:17.760502458Z","dependencies":[{"issue_id":"casg-tc3.4","depends_on_id":"casg-tc3","type":"parent-child","created_at":"2026-01-10T23:22:17.761079625Z","created_by":"cyou"},{"issue_id":"casg-tc3.4","depends_on_id":"casg-tc3.3","type":"blocks","created_at":"2026-01-10T23:23:40.3506747Z","created_by":"cyou"},{"issue_id":"casg-tc3.4","depends_on_id":"casg-tc3.1","type":"blocks","created_at":"2026-01-10T23:23:40.864216511Z","created_by":"cyou"}]}
{"id":"casg-tc3.5","title":"Implement malformed JSON error tests (non-terminal and terminal)","description":"## Summary\nAdd tests to `test/stream_test.gleam` for malformed JSON handling: 1-4 consecutive errors (non-terminal) and 5+ consecutive errors (terminal TooManyDecodeErrors).\n\n## Test Scenarios\n\n### Non-Terminal (1-4 consecutive malformed lines)\n```gleam\npub fn malformed_json_non_terminal_test() {\n  // Mock yields: valid_json, \"bad json\", valid_json\n  // Expected: Ok(Message), Error(JsonDecodeError), Ok(Message)\n  // Error counter resets on success\n}\n```\n\n### Terminal (5+ consecutive malformed lines)\n```gleam\npub fn malformed_json_terminal_test() {\n  // Mock yields: 5x \"bad json line N\"\n  // Expected: Error(JsonDecodeError) x4, then Error(TooManyDecodeErrors)\n  // TooManyDecodeErrors is terminal - stream stops\n}\n```\n\n## NDJSON Policy (from plan)\n| Scenario | Classification | SDK Behavior |\n|----------|---------------|--------------|\n| 1-4 consecutive non-JSON | Tolerated | JsonDecodeError (non-terminal), continues |\n| 5+ consecutive non-JSON | Not Supported | TooManyDecodeErrors (terminal) |\n| Non-JSON mixed with valid | Tolerated | Errors for bad, processes good |\n\n## Acceptance Criteria\n- [ ] Single malformed line returns Error(JsonDecodeError), stream continues\n- [ ] 4 consecutive malformed lines return 4 JsonDecodeErrors, stream continues\n- [ ] 5 consecutive malformed lines: 4 JsonDecodeErrors then TooManyDecodeErrors\n- [ ] Error counter resets to 0 after successful parse\n- [ ] TooManyDecodeErrors is terminal (subsequent next() returns EndOfStream)\n\n## Plan References\n- Lines 2429-2436: NDJSON Policy table\n- Lines 4693-4694: Acceptance criteria for malformed JSON\n- Lines 4844: Error counter resets on success","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-10T23:22:31.73025987Z","created_by":"cyou","updated_at":"2026-01-10T23:22:31.73025987Z","dependencies":[{"issue_id":"casg-tc3.5","depends_on_id":"casg-tc3","type":"parent-child","created_at":"2026-01-10T23:22:31.731380793Z","created_by":"cyou"},{"issue_id":"casg-tc3.5","depends_on_id":"casg-tc3.4","type":"blocks","created_at":"2026-01-10T23:23:46.278936678Z","created_by":"cyou"}]}
{"id":"casg-tc3.6","title":"Implement buffer overflow test (\u003e10MB = terminal)","description":"## Summary\nAdd test to `test/stream_test.gleam` for buffer overflow handling: lines \u003e10MB trigger terminal BufferOverflow error.\n\n## Test Scenario\n```gleam\npub fn buffer_overflow_at_10mb_test() {\n  let huge_json = generate_large_message(11_000_000)  // 11MB\n  // Mock yields this oversized line\n  // Expected: Error(BufferOverflow) - terminal error\n}\n\n/// Generate a valid NDJSON message with specified content size\nfn generate_large_message(size_bytes: Int) -\u003e String {\n  let padding = string.repeat(\"A\", size_bytes - 100)  // Account for JSON structure\n  json.object([\n    #(\"type\", json.string(\"assistant\")),\n    #(\"message\", json.object([\n      #(\"content\", json.array([\n        json.object([\n          #(\"type\", json.string(\"text\")),\n          #(\"text\", json.string(padding))\n        ])\n      ]))\n    ]))\n  ])\n  |\u003e json.to_string\n}\n```\n\n## Also test valid large message (1MB) works\n```gleam\npub fn buffer_handles_1mb_message_test() {\n  let large_json = generate_large_message(1_000_000)\n  // Should decode successfully - not near limit\n}\n```\n\n## Key Points\n- Large payloads generated at runtime, NOT stored as fixtures\n- 10MB limit from internal/constants.gleam\n- BufferOverflow is terminal - stream stops after this error\n\n## Acceptance Criteria\n- [ ] 1MB message decodes successfully\n- [ ] 10MB message triggers BufferOverflow (terminal)\n- [ ] 15MB message triggers BufferOverflow (terminal)\n- [ ] BufferOverflow is terminal (subsequent next() returns EndOfStream)\n- [ ] No large fixtures stored in repo (generated at runtime)\n\n## Plan References\n- Lines 4695: Acceptance criteria for buffer overflow\n- Lines 4765-4799: Large payload testing (generated at runtime)\n- Lines 4813: 10MB buffer limit decision","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-10T23:22:46.245788538Z","created_by":"cyou","updated_at":"2026-01-10T23:22:46.245788538Z","dependencies":[{"issue_id":"casg-tc3.6","depends_on_id":"casg-tc3","type":"parent-child","created_at":"2026-01-10T23:22:46.246428324Z","created_by":"cyou"},{"issue_id":"casg-tc3.6","depends_on_id":"casg-tc3.4","type":"blocks","created_at":"2026-01-10T23:23:50.857984292Z","created_by":"cyou"}]}
{"id":"casg-tc3.7","title":"Implement exit status ordering tests","description":"## Summary\nAdd tests to `test/stream_test.gleam` for exit status ordering relative to Result message.\n\n## Test Scenarios\n\n### exit_status BEFORE Result (abnormal)\n```gleam\npub fn exit_status_before_result_test() {\n  // Mock yields: System message, ExitStatus(1) - no Result\n  // Expected: Error(ProcessError) with diagnostic\n}\n```\n\n### Result THEN exit_status=0 (normal completion)\n```gleam\npub fn result_then_exit_zero_test() {\n  // Mock yields: System, Assistant, Result, ExitStatus(0)\n  // Expected: Ok(Message(System)), Ok(Message(Assistant)), \n  //           Ok(Message(Result)), Ok(EndOfStream)\n  // exit_status=0 after Result is ignored silently\n}\n```\n\n### Result THEN exit_status!=0 (warning case)\n```gleam\npub fn result_then_nonzero_exit_test() {\n  // Mock yields: Result, ExitStatus(1)\n  // Expected: Ok(Message(Result)), \n  //           Ok(WarningEvent(NonZeroExitAfterResult(1))),\n  //           Ok(EndOfStream)\n}\n```\n\n### exit_status=0 BEFORE Result (clean but unexpected)\n```gleam\npub fn clean_exit_no_result_test() {\n  // Mock yields: System, ExitStatus(0) - no Result\n  // Expected: Ok(Message(System)),\n  //           Ok(WarningEvent(CleanExitNoResult)),\n  //           Ok(EndOfStream)\n}\n```\n\n## Key Points\n- Result message is authoritative (once seen, exit_status matters less)\n- Non-zero exit after Result = Warning, not Error\n- Exit before Result = ProcessError (actionable diagnostic)\n\n## Acceptance Criteria\n- [ ] exit_status before Result â†’ Error(ProcessError) with diagnostic\n- [ ] Result then exit_status=0 â†’ normal EndOfStream\n- [ ] Result then exit_status!=0 â†’ WarningEvent then EndOfStream\n- [ ] exit_status=0 before Result â†’ WarningEvent(CleanExitNoResult)\n\n## Plan References\n- Lines 4697-4700: Acceptance criteria for exit status scenarios\n- Lines 4825: Result message authoritative decision","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-10T23:23:00.501330623Z","created_by":"cyou","updated_at":"2026-01-10T23:23:00.501330623Z","dependencies":[{"issue_id":"casg-tc3.7","depends_on_id":"casg-tc3","type":"parent-child","created_at":"2026-01-10T23:23:00.502359437Z","created_by":"cyou"},{"issue_id":"casg-tc3.7","depends_on_id":"casg-tc3.4","type":"blocks","created_at":"2026-01-10T23:23:47.317734923Z","created_by":"cyou"}]}
{"id":"casg-tc3.8","title":"Create CLI argument building tests","description":"## Summary\nCreate `test/cli_args_test.gleam` with tests for CLI argument building from QueryOptions.\n\n## Deliverables\n- `test/cli_args_test.gleam` testing build_cli_args() pure function\n\n## Test Scenarios\n\n### Required flags always present\n```gleam\npub fn required_flags_test() {\n  // All queries MUST include: --output-format stream-json --verbose --print\n}\n```\n\n### Optional model flag\n```gleam\npub fn model_flag_test() {\n  // with_model(\"sonnet\") â†’ args include \"--model sonnet\"\n}\n```\n\n### Precedence rules for conflicting options\n```gleam\npub fn system_prompt_precedence_test() {\n  // system_prompt AND append_system_prompt set â†’ only --system-prompt emitted\n}\n\npub fn allowed_disallowed_tools_precedence_test() {\n  // allowed_tools AND disallowed_tools set â†’ only --allowed-tools emitted\n}\n\npub fn session_precedence_test() {\n  // resume_session_id AND continue_session=True â†’ only --resume emitted\n}\n```\n\n### MCP flags\n```gleam\npub fn mcp_config_flag_test() {\n  // with_mcp_config(\"/path/mcp.json\") â†’ args include \"--mcp-config /path/mcp.json\"\n}\n```\n\n## Key Points\n- Pure function tests - no I/O, no FFI\n- Tests option builder behavior without subprocess\n- Validates precedence rules from plan\n\n## Acceptance Criteria\n- [ ] Required flags (--output-format, --verbose, --print) always included\n- [ ] --model flag included when model set\n- [ ] system_prompt takes precedence over append_system_prompt\n- [ ] allowed_tools takes precedence over disallowed_tools\n- [ ] resume_session_id takes precedence over continue_session\n- [ ] MCP config path correctly formatted\n\n## Plan References\n- Lines 4665-4669: CLI argument acceptance criteria\n- Lines 4836: Consolidated precedence rules decision\n- Lines 4750: cli_args_test.gleam in test structure","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-10T23:23:14.854219223Z","created_by":"cyou","updated_at":"2026-01-10T23:23:14.854219223Z","dependencies":[{"issue_id":"casg-tc3.8","depends_on_id":"casg-tc3","type":"parent-child","created_at":"2026-01-10T23:23:14.854907599Z","created_by":"cyou"}]}
{"id":"casg-tc3.9","title":"Create message type invariant tests","description":"## Summary\nCreate `test/message_test.gleam` with tests for message type construction and invariants.\n\n## Deliverables\n- `test/message_test.gleam` testing message type behavior\n\n## Test Scenarios\n\n### StreamItem type coverage\n```gleam\npub fn stream_item_variants_test() {\n  // Verify all StreamItem variants exist and are constructable:\n  // - Message(msg)\n  // - WarningEvent(warning)\n  // - EndOfStream\n}\n```\n\n### Message type variants\n```gleam\npub fn message_variants_test() {\n  // Verify all Message variants:\n  // - System(system_data)\n  // - Assistant(assistant_data)\n  // - Result(result_data)\n  // - User(user_data)\n}\n```\n\n### ContentBlock type coverage\n```gleam\npub fn content_block_variants_test() {\n  // Verify ContentBlock variants:\n  // - TextBlock(text)\n  // - ToolUseBlock(id, name, input)\n  // - ToolResultBlock(tool_use_id, content, is_error)\n  // - ThinkingBlock(thinking)\n  // - UnknownBlock(raw_json)  // Forward compatibility\n}\n```\n\n### Warning type coverage\n```gleam\npub fn warning_variants_test() {\n  // Verify Warning/WarningCode variants:\n  // - NonZeroExitAfterResult(exit_code)\n  // - CleanExitNoResult\n  // - UnexpectedMessageAfterResult\n  // - UnparseableCliVersion(raw_string)\n  // - IncompleteLastLine\n}\n```\n\n### Error type terminal classification\n```gleam\npub fn error_terminal_classification_test() {\n  // Verify is_terminal() for each error type:\n  // Terminal: TooManyDecodeErrors, BufferOverflow, ProcessError (abnormal)\n  // Non-terminal: JsonDecodeError, UnexpectedMessageError\n}\n```\n\n## Key Points\n- Type-level tests - constructability and pattern matching\n- No I/O or subprocess spawning\n- Forward compatibility: UnknownBlock for new content types\n\n## Acceptance Criteria\n- [ ] All StreamItem variants constructable and matchable\n- [ ] All Message variants constructable with correct fields\n- [ ] All ContentBlock variants including UnknownBlock\n- [ ] All Warning variants constructable\n- [ ] is_terminal() correctly classifies all error types\n- [ ] UnexpectedMessageError preserves raw_json for forward compat\n\n## Plan References\n- Lines 4662-4664: Message decoding acceptance criteria\n- Lines 4692-4701: Stream behavior acceptance criteria\n- Lines 4747: message_test.gleam in test structure\n","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-10T23:23:30.233811017Z","created_by":"cyou","updated_at":"2026-01-10T23:33:55.119418661Z","dependencies":[{"issue_id":"casg-tc3.9","depends_on_id":"casg-tc3","type":"parent-child","created_at":"2026-01-10T23:23:30.23509584Z","created_by":"cyou"}]}
{"id":"casg-va1","title":"Epic 0: Phase 0 - FFI \u0026 Port Validation","description":"## Overview\nThis is the **gating epic** - all other work depends on this completing successfully. Phase 0 validates that the Erlang FFI port operations work correctly before any other SDK implementation begins.\n\n## Why This is Critical\nThe plan states: \"This validation is a blocking prerequisite - no further implementation proceeds until port options are confirmed working.\"\n\nKey gating invariants:\n- Port config failure = nothing works\n- v1 uses port_ffi directly (not Runner) for production\n- Port lifecycle: drain-then-close\n\n## Scope\n1. Project setup with pinned dependencies in gleam.toml\n2. Erlang FFI module (claude_agent_sdk_ffi.erl) with:\n   - open_port/3 - spawn subprocess with required options\n   - receive_port_msg_blocking/1 - blocking read\n   - receive_port_msg_timeout/2 - timed read with timeout\n   - close_port/1 - close port with mailbox drain\n3. Gleam port bindings (port_ffi.gleam) with:\n   - Opaque Port type\n   - PortMessage type (Data, ExitStatus, Eof, Timeout)\n   - ffi_open_port, receive_blocking, receive_timeout, ffi_close_port\n4. Phase 0 validation tests (compile + runtime)\n\n## Success Criteria\n- `gleam build` compiles successfully\n- Phase 0 compile tests pass (typecheck FFI bindings)\n- Phase 0 runtime tests pass (spawn echo, receive data, receive exit_status)\n\n## Plan References\n- Authoritative FFI Interface section\n- Phase 0 Two-Suite Structure\n- Port Lifecycle Contract","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-01-10T23:18:56.381509513Z","created_by":"cyou","updated_at":"2026-01-11T00:19:09.945230106Z","closed_at":"2026-01-11T00:19:09.945230106Z","close_reason":"Closed"}
{"id":"casg-va1.1","title":"Project setup with gleam.toml and failing Phase 0 compile test skeleton","description":"## Goal\nEstablish the Gleam project structure with pinned dependencies and create failing compile tests that will verify FFI bindings exist.\n\n## Context\nThis is the foundation task for Phase 0 - FFI \u0026 Port Validation. All other Phase 0 work depends on this project structure being in place.\n\nPlan reference: Phase 0 Dependency Version Policy, Naming \u0026 Namespace section\n\n## TDD Steps\n1. Create gleam.toml with exact pinned dependencies (tests will fail because FFI modules don't exist yet)\n2. Create skeleton src/claude_agent_sdk.gleam (main module placeholder)\n3. Create src/claude_agent_sdk/internal/.gitkeep for internal module directory\n4. Create test/phase0_compile_check_test.gleam with imports that will fail to compile until FFI is implemented\n5. Verify `gleam build` fails with expected missing module errors\n\n## Files\n- gleam.toml - [New] - Project config with pinned dependencies:\n  - gleam_stdlib = \"= 0.44.0\"\n  - gleam_erlang = \"= 1.3.0\"\n  - gleam_json = \"= 2.0.0\"\n  - gleeunit = \"= 1.2.0\" (dev)\n- src/claude_agent_sdk.gleam - [New] - Main module placeholder\n- src/claude_agent_sdk/internal/.gitkeep - [New] - Directory structure\n- test/phase0_compile_check_test.gleam - [New] - Compile test skeleton (will fail initially)\n\n## Acceptance Criteria\n- gleam.toml exists with exact version pins (= syntax, not ^)\n- `gleam deps download` succeeds\n- `gleam build` fails with expected errors (FFI module not found)\n- Directory structure matches plan Naming \u0026 Namespace section\n- Package name is claude_agent_sdk\n\n## Verification\n- gleam deps download succeeds\n- gleam build fails with predictable FFI import error (expected at this stage)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:21:48.372868729Z","created_by":"cyou","updated_at":"2026-01-10T23:47:49.493254355Z","closed_at":"2026-01-10T23:47:49.493254355Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-va1.1","depends_on_id":"casg-va1","type":"parent-child","created_at":"2026-01-10T23:21:48.373466826Z","created_by":"cyou"}]}
{"id":"casg-va1.10","title":"[Review] 3 non-blocking findings from casg-va1.6","description":"## Review Findings\n\nThis issue consolidates 3 non-blocking findings from code review.\n\n**Source issue:** casg-va1.6\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Port not closed on test failure (resource leak)\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** test/phase0_runtime_test.gleam:61-100\n\nIn `run_spawn_test()` (lines 61-100) and `run_timed_receive_test()` (lines 111-144), if any assertion fails or panic occurs, the port is not closed because `ffi_close_port(port)` is at the end of the function and won't be reached after a panic.\n\n**Impact**: Resource leak when tests fail. Ports remain open until process termination.\n\n**Fix**: Wrap test logic in a function that returns Result, use a defer-like pattern, or ensure ports are closed in all branches. Example:\n```gleam\nlet port = port_ffi.ffi_open_port(executable, args, \"\")\nlet result = test_operations(port)\nport_ffi.ffi_close_port(port)\ncase result {\n  Ok(_) -\u003e Nil\n  Error(msg) -\u003e panic as msg\n}\n```\n\n---\n\n### Finding 2: [P2] Incorrect FFI binding for bitarray_to_string\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** test/phase0_runtime_test.gleam:175-176\n\nLine 176 declares `bitarray_to_string` as calling `erlang:binary_to_list`, but this function converts a binary to a charlist (List(Int)), not to a String. The type signature claims it returns `String`, which is incorrect.\n\n**Impact**: When `int_to_string()` is called (currently only in error paths), it will fail at runtime with a type error because `binary_to_list` returns a charlist, not a string.\n\n**Fix**: Since Gleam Strings are UTF-8 binaries at runtime, BitArray and String are already compatible. Remove this function and directly cast, or use an identity function:\n```gleam\nfn bitarray_to_string(bin: BitArray) -\u003e String {\n  // In Erlang, binaries and strings are the same at runtime\n  // This is just a type-level conversion\n  case bit_array.to_string(bin) {\n    Ok(s) -\u003e s\n    Error(_) -\u003e panic as \"Invalid UTF-8\"\n  }\n}\n```\n\nAlternatively, since `list_to_binary` already returns a BitArray that is a valid String representation, you can skip the conversion entirely.\n\n---\n\n### Finding 3: [P3] Inefficient drain on already-closed ports\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk_ffi.erl:52-59\n\nIn `close_port/1` (lines 52-59), the function calls `drain_port_messages(Port, 100)` before attempting to close the port. If the port is already closed, the drain will still execute up to 100 iterations with 50ms timeouts (potentially 5 seconds of wasted time), even though no messages will arrive.\n\n**Impact**: Performance degradation when closing already-closed ports. Each failed drain iteration waits 50ms unnecessarily.\n\n**Fix**: Move the drain inside the try block, or check if port is valid before draining:\n```erlang\nclose_port(Port) -\u003e\n    try\n        drain_port_messages(Port, 100),\n        erlang:port_close(Port)\n    catch\n        error:badarg -\u003e ok  % Port already closed\n    end,\n    ok.\n```\n\nAlternatively, add a port validity check before draining, though this adds complexity.\n\n---\n\n\u003c!-- fp:0045e49b4c17338b --\u003e\n\u003c!-- fp:efc643c219dc49a2 --\u003e\n\u003c!-- fp:c545b82083b9dd7b --\u003e\n\u003c!-- review_finding:1df4e5b33fbc --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T00:10:28.467495857Z","created_by":"cyou","updated_at":"2026-01-11T00:15:23.968300166Z","closed_at":"2026-01-11T00:15:23.968300166Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-va1.6"],"dependencies":[{"issue_id":"casg-va1.10","depends_on_id":"casg-va1","type":"parent-child","created_at":"2026-01-11T00:10:28.468125913Z","created_by":"cyou"}]}
{"id":"casg-va1.11","title":"[Review] 3 non-blocking findings from casg-va1.7","description":"## Review Findings\n\nThis issue consolidates 3 non-blocking findings from code review.\n\n**Source issue:** casg-va1.7\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] confirmed_imports.gleam has no actual usage in codebase\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/internal/confirmed_imports.gleam:1-66\n\nThe file `src/claude_agent_sdk/internal/confirmed_imports.gleam` was created as a \"reference\" for other modules to import from (per task description: \"All modules should import from here to ensure consistency\"), but:\n\n1. No modules actually import from it (grep shows no imports except in docs)\n2. The `verify_imports()` function at lines 54-65 exists only to suppress unused import warnings\n3. The version info functions (lines 41-51) are exported but never called\n\nThis creates maintenance burden without providing value. The module doesn't enforce consistency - it just documents what was verified.\n\n**Impact**: Dead code that will become stale over time as dependencies are updated.\n\n**Recommendation**: Either:\n- Have actual modules import from this file to enforce consistency (as intended)\n- Or remove the file and keep only the phase0-confirmation.md documentation\n\n---\n\n### Finding 2: [P3] Missing imports documented in issue specification\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/internal/confirmed_imports.gleam:1-40\n\nThe issue specification (casg-va1.7) specified importing `gleam/regex` (\"from_string, scan\") at line in the template, but the actual implementation in `confirmed_imports.gleam` does not include this import.\n\nOriginal spec imports:\n```gleam\nimport gleam/regex      // from_string, scan\n```\n\nActual implementation: No regex import present.\n\nWhile this may be intentional (regex not actually needed), it creates a discrepancy between the documented requirements and implementation. The issue acceptance criteria states \"confirmed_imports.gleam lists all verified stdlib imports\" but regex is missing.\n\n**Impact**: Minor - documentation/spec mismatch. If regex is actually needed later, this will need to be updated.\n\n**Recommendation**: Either add regex imports or update the issue spec to reflect that regex is not required.\n\n---\n\n### Finding 3: [P3] Issue status shows 'open' despite commit completion\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** .beads/issues.jsonl:0\n\nIn the `.beads/issues.jsonl` diff, issue `casg-va1.7` has status `\"status\":\"in_progress\"` at line after the commit, but the commit message and artifacts indicate the task is complete:\n\n- Commit message: \"Create Phase 0 confirmation artifact and confirmed imports\" (done)\n- phase0-confirmation.md line 49: \"Phase 0: COMPLETE\"\n- All acceptance criteria appear met\n\nThe issue should have `\"status\":\"closed\"` to match the completion state.\n\n**Impact**: Tracking inconsistency - completed work appears incomplete in issue tracker.\n\n**Recommendation**: Update issue status to `\"closed\"` with appropriate `closed_at` timestamp and `close_reason`.\n\n---\n\n\u003c!-- fp:5a1db9a3545b17b3 --\u003e\n\u003c!-- fp:494f38c2511c8342 --\u003e\n\u003c!-- fp:3cae267e3925f116 --\u003e\n\u003c!-- review_finding:94de111a078d --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T00:14:51.083281647Z","created_by":"cyou","updated_at":"2026-01-11T00:17:04.283235511Z","closed_at":"2026-01-11T00:17:04.283235511Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-va1.7"],"dependencies":[{"issue_id":"casg-va1.11","depends_on_id":"casg-va1","type":"parent-child","created_at":"2026-01-11T00:14:51.083804253Z","created_by":"cyou"}]}
{"id":"casg-va1.12","title":"[Review] 1 non-blocking finding from casg-va1.11","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-va1.11\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Stale reference to deleted file in phase0-confirmation.md\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** plans/phase0-confirmation.md:42\n\nThe commit successfully deleted `src/claude_agent_sdk/internal/confirmed_imports.gleam` as intended (addressing Finding 1), but failed to update the documentation artifact `plans/phase0-confirmation.md` which still references this file.\n\n**Location**: `plans/phase0-confirmation.md:42` lists the deleted file in the Artifacts table:\n```markdown\n| `src/claude_agent_sdk/internal/confirmed_imports.gleam` | Re-exports verified imports for consistency |\n```\n\n**Impact**: Documentation is now inconsistent with the codebase. Users following the Phase 0 confirmation artifact will expect a file that doesn't exist.\n\n**Fix**: Remove line 42 from the Artifacts table in `phase0-confirmation.md`, or update the documentation to reflect that import verification is documented only in the markdown file itself, not in a separate `.gleam` file.\n\n---\n\n\u003c!-- fp:e9dfeeda81716162 --\u003e\n\u003c!-- review_finding:506d354949b3 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T00:19:10.044799985Z","created_by":"cyou","updated_at":"2026-01-11T00:20:27.586891017Z","closed_at":"2026-01-11T00:20:27.586891017Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-va1.11"],"dependencies":[{"issue_id":"casg-va1.12","depends_on_id":"casg-va1","type":"parent-child","created_at":"2026-01-11T00:19:10.045387671Z","created_by":"cyou"}]}
{"id":"casg-va1.2","title":"Implement Erlang FFI module (claude_agent_sdk_ffi.erl)","description":"## Goal\nCreate the Erlang FFI module that provides low-level port operations. This is the core FFI layer that all port communication flows through.\n\n## Context\nPlan reference: Authoritative FFI Interface (Single Source of Truth)\n\nThe SDK uses FFI-only for port operations because gleam_erlang/port does NOT expose required options (spawn_executable, use_stdio).\n\n## TDD Steps\n1. Create src/claude_agent_sdk_ffi.erl with all exported functions\n2. Verify Erlang module compiles with `gleam build`\n3. Module name MUST match filename exactly (case-sensitive)\n\n## Files\n- src/claude_agent_sdk_ffi.erl - [New] - Erlang FFI module with:\n  - -module(claude_agent_sdk_ffi).\n  - -export([open_port/3, receive_port_msg_blocking/1, receive_port_msg_timeout/2, close_port/1]).\n  - open_port/3: Spawns port with spawn_executable, args, cd, stream, binary, exit_status, use_stdio\n  - receive_port_msg_blocking/1: Blocking receive, returns {\"data\", Bytes} | {\"exit_status\", Code} | {\"eof\", nil}\n  - receive_port_msg_timeout/2: Timed receive, adds {\"timeout\", nil} case\n  - close_port/1: port_close + bounded mailbox drain (max 100 msgs, 50ms timeout)\n\n## Implementation Details\nPort options (all required):\n| Option | Purpose |\n|--------|---------|\n| spawn_executable | Spawn by executable path |\n| stream | Raw byte stream mode |\n| binary | Binary data (not list) |\n| exit_status | Receive exit code |\n| use_stdio | Connect stdin/stdout |\n\nFFI returns STRING tags (not atoms) for simpler Gleam decoding:\n- {\"data\", Bytes}\n- {\"exit_status\", Code}\n- {\"eof\", nil}\n- {\"timeout\", nil}\n\n## Acceptance Criteria\n- Module name matches filename: claude_agent_sdk_ffi\n- All 4 functions exported: open_port/3, receive_port_msg_blocking/1, receive_port_msg_timeout/2, close_port/1\n- No Erlang syntax errors\n- Bounded drain in close_port prevents infinite loops (max 100 iterations, 50ms timeout per message)\n\n## Verification\n- gleam build compiles .erl to .beam without errors\n- No Erlang compilation warnings","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:22:05.89054076Z","created_by":"cyou","updated_at":"2026-01-10T23:58:58.387874397Z","closed_at":"2026-01-10T23:58:58.387874397Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-va1.2","depends_on_id":"casg-va1","type":"parent-child","created_at":"2026-01-10T23:22:05.891334326Z","created_by":"cyou"},{"issue_id":"casg-va1.2","depends_on_id":"casg-va1.1","type":"blocks","created_at":"2026-01-10T23:23:40.171487532Z","created_by":"cyou"}]}
{"id":"casg-va1.3","title":"Implement Gleam port_ffi bindings","description":"## Goal\nCreate Gleam bindings that wrap the Erlang FFI module with type-safe APIs.\n\n## Context\nPlan reference: Authoritative FFI Interface - Gleam bindings section\n\nThese bindings provide the Gleam-side interface to the Erlang FFI functions. Uses opaque Port type for type safety.\n\n## TDD Steps\n1. Create src/claude_agent_sdk/internal/port_ffi.gleam\n2. Implement opaque Port type wrapping Dynamic\n3. Implement @external bindings to Erlang FFI\n4. Implement decode_port_message for uniform 2-tuple decoding\n5. Verify `gleam build` succeeds\n\n## Files\n- src/claude_agent_sdk/internal/port_ffi.gleam - [New] - Gleam FFI bindings with:\n  - opaque type Port { Port(inner: Dynamic) }\n  - type PortMessage { Data(BitArray) | ExitStatus(Int) | Eof | Timeout }\n  - ffi_open_port(path, args, cwd) -\u003e Port\n  - receive_blocking(port) -\u003e Result(PortMessage, String)\n  - receive_timeout(port, timeout_ms) -\u003e Result(PortMessage, String)\n  - ffi_close_port(port) -\u003e Nil\n  - decode_port_message(raw) - internal decoder for 2-tuple FFI responses\n\n## Implementation Details\nFFI contract (2-tuples ONLY):\n- {\"data\", Bytes} -\u003e Data(BitArray)\n- {\"exit_status\", Code} -\u003e ExitStatus(Int)\n- {\"eof\", nil} -\u003e Eof\n- {\"timeout\", nil} -\u003e Timeout\n\nDecoder uses dynamic.tuple2(dynamic.string, dynamic.any) for uniform parsing.\n\n## Acceptance Criteria\n- Port type is opaque (internal Dynamic hidden from users)\n- All 4 FFI functions have Gleam wrappers\n- decode_port_message handles all 4 message types\n- Errors return Result with descriptive String messages\n- No public export of raw FFI functions (only wrapped versions)\n\n## Verification\n- gleam build succeeds\n- gleam check passes type checking\n- Imports from claude_agent_sdk/internal/port_ffi work in tests","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:22:20.482219092Z","created_by":"cyou","updated_at":"2026-01-11T00:01:59.463715412Z","closed_at":"2026-01-11T00:01:59.463715412Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-va1.3","depends_on_id":"casg-va1","type":"parent-child","created_at":"2026-01-10T23:22:20.483490215Z","created_by":"cyou"},{"issue_id":"casg-va1.3","depends_on_id":"casg-va1.2","type":"blocks","created_at":"2026-01-10T23:23:40.667719512Z","created_by":"cyou"}]}
{"id":"casg-va1.4","title":"Implement test env_helpers.gleam for environment variable access","description":"## Goal\nCreate a minimal FFI helper for environment variable access in tests, avoiding the need for an envoy dependency.\n\n## Context\nPlan reference: Testing Constraints - No envoy dependency\n\nThe plan explicitly states: \"Environment variable access in tests uses a tiny FFI helper instead of adding envoy as a dependency. This reduces supply chain surface for minimal benefit.\"\n\n## TDD Steps\n1. Create test/support/ directory\n2. Create test/support/env_helpers.gleam with os:getenv FFI\n3. Verify import works in test files\n\n## Files\n- test/support/env_helpers.gleam - [New] - FFI helper with:\n  - @external(erlang, \"os\", \"getenv\") fn ffi_getenv(name: String) -\u003e Dynamic\n  - pub fn get_env(name: String) -\u003e Result(String, Nil)\n    - Returns Ok(value) if set and non-empty\n    - Returns Error(Nil) if not set or empty\n\n## Implementation Details\n```gleam\nimport gleam/dynamic.{type Dynamic}\n\n@external(erlang, \"os\", \"getenv\")\nfn ffi_getenv(name: String) -\u003e Dynamic\n\npub fn get_env(name: String) -\u003e Result(String, Nil) {\n  case dynamic.string(ffi_getenv(name)) {\n    Ok(value) if value != \"\" -\u003e Ok(value)\n    _ -\u003e Error(Nil)  // Not set or empty\n  }\n}\n```\n\n## Acceptance Criteria\n- No envoy dependency in gleam.toml\n- get_env returns Result(String, Nil)\n- Empty string treated same as not set (Error(Nil))\n- Used by Phase 0 runtime tests for PHASE0_RUNTIME check\n\n## Verification\n- gleam build succeeds\n- Import from test/support/env_helpers works in test files","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:22:35.368982412Z","created_by":"cyou","updated_at":"2026-01-10T23:50:19.18308996Z","closed_at":"2026-01-10T23:50:19.18308996Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-va1.4","depends_on_id":"casg-va1","type":"parent-child","created_at":"2026-01-10T23:22:35.370301004Z","created_by":"cyou"},{"issue_id":"casg-va1.4","depends_on_id":"casg-va1.1","type":"blocks","created_at":"2026-01-10T23:23:41.162677329Z","created_by":"cyou"}]}
{"id":"casg-va1.5","title":"Implement Phase 0 compile-check tests (Suite A)","description":"## Goal\nCreate compile-check tests that verify all required APIs exist at the pinned dependency versions. These are ALWAYS REQUIRED tests that run in all environments.\n\n## Context\nPlan reference: Phase 0 Two-Suite Structure - Suite A: Compile Checks\n\nSuite A validates: gleam build succeeds, FFI bindings exist and typecheck. No subprocess spawning.\n\n## TDD Steps\n1. Create test/phase0_compile_check_test.gleam\n2. Add tests that verify API existence by referencing functions (compile-time check)\n3. Add tests that verify FFI bindings typecheck correctly\n4. Run `gleam test test/phase0_compile_check_test.gleam` to verify\n\n## Files\n- test/phase0_compile_check_test.gleam - [New] - Compile-time verification tests:\n  - api_exists_compile_check_test() - verifies stdlib APIs exist:\n    - bit_array.from_string, bit_array.byte_size, bit_array.to_string\n    - dynamic.tuple2, dynamic.string, dynamic.int, dynamic.bit_array\n    - regex.from_string, regex.scan\n  - ffi_bindings_typecheck_test() - verifies port_ffi module loads:\n    - Import port_ffi\n    - Reference function types (compile-time check)\n  - api_confirmation_test() - runtime verification of stdlib behaviors:\n    - bit_array functions work correctly\n    - dynamic decoding works for tagged tuples\n    - regex works for version parsing pattern\n\n## Implementation Details\nFrom plan:\n```gleam\n/// This test verifies that required APIs exist by attempting to use them.\n/// If compilation succeeds, the APIs exist in the pinned dependency versions.\n/// No runtime behavior tested - just existence.\npub fn api_exists_compile_check_test() {\n  // These calls will fail compilation if APIs don't exist\n  let _ = bit_array.from_string\n  let _ = bit_array.byte_size\n  // ...etc\n  Nil\n}\n```\n\n## Acceptance Criteria\n- Suite A tests pass in ALL environments (compile-only, no subprocess spawning)\n- Verifies gleam_stdlib APIs at pinned version 0.44.0\n- Verifies port_ffi bindings compile and typecheck\n- Tests run successfully with `gleam test`\n\n## Verification\n- gleam build succeeds\n- gleam test test/phase0_compile_check_test.gleam passes\n- No runtime subprocess spawning in these tests","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:22:52.19501534Z","created_by":"cyou","updated_at":"2026-01-11T00:06:25.131578357Z","closed_at":"2026-01-11T00:06:25.131578357Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-va1.5","depends_on_id":"casg-va1","type":"parent-child","created_at":"2026-01-10T23:22:52.196028414Z","created_by":"cyou"},{"issue_id":"casg-va1.5","depends_on_id":"casg-va1.3","type":"blocks","created_at":"2026-01-10T23:23:41.654756962Z","created_by":"cyou"}]}
{"id":"casg-va1.6","title":"Implement Phase 0 runtime port validation tests (Suite B)","description":"## Goal\nCreate runtime tests that validate the actual port spawn/read/close operations work correctly. These tests are OPT-IN via PHASE0_RUNTIME=1 environment variable.\n\n## Context\nPlan reference: Phase 0 Two-Suite Structure - Suite B: Runtime Spawn Checks\n\nSuite B validates: port_ffi spawn/read/close works with real subprocess. Opt-in only to avoid failures in restricted environments.\n\n## TDD Steps\n1. Create test/phase0_runtime_test.gleam\n2. Implement PHASE0_RUNTIME check using env_helpers.get_env\n3. Implement phase0_test_command() for cross-platform test (Unix: /bin/echo, Windows: cmd.exe)\n4. Implement port spawn/read/exit_status/close validation\n5. Implement timed receive validation\n6. Run with `PHASE0_RUNTIME=1 gleam test test/phase0_runtime_test.gleam`\n\n## Files\n- test/phase0_runtime_test.gleam - [New] - Runtime validation tests:\n  - phase0_runtime_spawn_test() - validates spawn -\u003e read -\u003e exit_status -\u003e close flow\n  - phase0_timed_receive_test() - validates receive_timeout behavior\n  - Helper: record_phase0_skip(test_name, reason) - prints [SKIP:PHASE0] to stdout\n  - Helper: phase0_test_command() - returns platform-specific echo command\n  - Helper: decode_os_family(raw) - decodes os:type/0 result\n\n## Implementation Details\nCross-platform test commands:\n| Platform | Executable | Args | Expected Output |\n|----------|-----------|------|-----------------|\n| Linux/macOS | /bin/echo | [\"test\"] | test\\n (5 bytes) |\n| Windows | cmd.exe | [\"/c\", \"echo test\"] | test\\r\\n (6 bytes) |\n\nSkip mechanism (stdout-only, no file writes):\n```gleam\nfn record_phase0_skip(test_name: String, reason: String) -\u003e Nil {\n  let line = \"[SKIP:PHASE0] \" \u003c\u003e test_name \u003c\u003e \": \" \u003c\u003e reason\n  io.println(line)  // Stdout only - NO file.write()\n}\n```\n\nRuntime test structure:\n```gleam\npub fn phase0_runtime_spawn_test() {\n  case get_env(\"PHASE0_RUNTIME\") {\n    Ok(\"1\") -\u003e run_spawn_test()\n    _ -\u003e record_phase0_skip(\"phase0_runtime_spawn_test\", \"PHASE0_RUNTIME not set\")\n  }\n}\n```\n\n## Acceptance Criteria\n- Tests skip with stdout message when PHASE0_RUNTIME not set\n- Tests run and pass when PHASE0_RUNTIME=1\n- Validates: spawn port, read Data message, read ExitStatus message, close port\n- Validates: receive_timeout returns Timeout after exit\n- Cross-platform support (Unix/Windows via os:type detection)\n- No file writes - skip messages go to stdout only\n\n## Verification\n- gleam test passes (with skips) when PHASE0_RUNTIME not set\n- PHASE0_RUNTIME=1 gleam test passes on Linux/macOS\n- Skip messages visible: [SKIP:PHASE0] test_name: reason","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:23:13.502252926Z","created_by":"cyou","updated_at":"2026-01-11T00:10:28.286091447Z","closed_at":"2026-01-11T00:10:28.286091447Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-va1.6","depends_on_id":"casg-va1","type":"parent-child","created_at":"2026-01-10T23:23:13.502828162Z","created_by":"cyou"},{"issue_id":"casg-va1.6","depends_on_id":"casg-va1.3","type":"blocks","created_at":"2026-01-10T23:23:48.296476981Z","created_by":"cyou"},{"issue_id":"casg-va1.6","depends_on_id":"casg-va1.4","type":"blocks","created_at":"2026-01-10T23:23:48.825965991Z","created_by":"cyou"}]}
{"id":"casg-va1.7","title":"Create Phase 0 confirmation artifact and document verified imports","description":"## Goal\nCreate the Phase 0 confirmation artifact documenting validation results and create the confirmed_imports.gleam file for other modules to reference.\n\n## Context\nPlan reference: Phase 0 Confirmation artifact, Confirmed imports file\n\nThis is the final Phase 0 deliverable that certifies the FFI layer is working and documents verified API imports.\n\n## TDD Steps\n1. Run all Phase 0 tests (compile + runtime)\n2. Create src/claude_agent_sdk/internal/confirmed_imports.gleam with verified imports\n3. Create Phase 0 confirmation markdown artifact in plans/\n4. Commit manifest.toml (Gleam's lockfile)\n\n## Files\n- src/claude_agent_sdk/internal/confirmed_imports.gleam - [New] - Verified imports:\n  ```gleam\n  // Phase 0 verified these imports exist at pinned versions.\n  // All modules should import from here to ensure consistency.\n\n  // Standard library (verified at gleam_stdlib = 0.44.0)\n  import gleam/bit_array  // byte_size, from_string, to_string\n  import gleam/dynamic    // tuple2, string, int, bit_array\n  import gleam/regex      // from_string, scan\n  import gleam/result     // map, try, unwrap\n  import gleam/list       // map, filter, fold\n  import gleam/option     // Some, None, unwrap\n\n  // JSON (verified at gleam_json = 2.0.0)\n  import gleam/json       // decode, object, array, string, int\n  ```\n\n- plans/phase0-confirmation.md - [New] - Confirmation artifact:\n  ```markdown\n  # Phase 0 Confirmation\n  Date: YYYY-MM-DD\n  Environment: Linux/macOS/Windows, OTP version, Gleam version\n\n  ## Compile Check: PASS/FAIL\n  ## Runtime Port Test: PASS/SKIP (reason)\n  ## Notes: ...\n  ```\n\n- manifest.toml - [Commit] - Gleam lockfile for reproducible builds\n\n## Acceptance Criteria\n- confirmed_imports.gleam lists all verified stdlib imports\n- Phase 0 confirmation artifact documents test results\n- manifest.toml committed to version control\n- All imports verified against pinned dependency versions\n- Phase 0 complete - gate passed for subsequent implementation\n\n## Verification\n- gleam build succeeds with confirmed_imports.gleam\n- confirmation artifact has completed status\n- manifest.toml exists and is committed\n- No floating version ranges in gleam.toml (all = syntax)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:23:31.068383237Z","created_by":"cyou","updated_at":"2026-01-11T00:14:50.885136681Z","closed_at":"2026-01-11T00:14:50.885136681Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-va1.7","depends_on_id":"casg-va1","type":"parent-child","created_at":"2026-01-10T23:23:31.06954292Z","created_by":"cyou"},{"issue_id":"casg-va1.7","depends_on_id":"casg-va1.5","type":"blocks","created_at":"2026-01-10T23:23:49.301507089Z","created_by":"cyou"},{"issue_id":"casg-va1.7","depends_on_id":"casg-va1.6","type":"blocks","created_at":"2026-01-10T23:23:49.782969693Z","created_by":"cyou"}]}
{"id":"casg-va1.8","title":"[Review] 3 non-blocking findings from casg-va1.2","description":"## Review Findings\n\nThis issue consolidates 3 non-blocking findings from code review.\n\n**Source issue:** casg-va1.2\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P3] Unused import in phase0_compile_check_test.gleam\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** test/phase0_compile_check_test.gleam:10\n\nThe `port_ffi` module is imported at line 10 but never used in the test file. The compiler warning indicates this import should be removed or the test should actually use the imported module to verify FFI bindings.\n\n```gleam\nimport claude_agent_sdk/internal/port_ffi  // Line 10 - unused\n```\n\nThis suggests the test suite is incomplete - it should verify that the FFI bindings exist and are callable, which was the stated goal of Phase 0 compile checks.\n\n---\n\n### Finding 2: [P2] close_port drain may miss messages due to port_close timing\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk_ffi.erl:44-46\n\nIn `close_port/1`, the implementation calls `erlang:port_close(Port)` before draining messages:\n\n```erlang\nclose_port(Port) -\u003e\n    erlang:port_close(Port),\n    drain_port_messages(Port, 100).\n```\n\nOnce `port_close` is called, the port is closed and no new messages will be queued. However, there may be messages already in the mailbox that were sent before the close. The current implementation is correct for draining those existing messages.\n\nHowever, if the port sends final messages (like exit_status) at close time, there's a race condition where those messages might arrive between the close and the drain. The specification states the drain prevents \"infinite loops\" but doesn't address whether all final messages are guaranteed to be received.\n\nThis is not a critical bug since the bounded drain (100 iterations, 50ms timeout) prevents hangs, but it could lead to lost exit_status messages in edge cases.\n\n---\n\n### Finding 3: [P3] Decoder error messages discard underlying error details\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/internal/port_ffi.gleam:74-86\n\nIn `decode_port_message/1`, when decoding fails, the underlying error is discarded:\n\n```gleam\nOk(#(\"data\", payload)) -\u003e\n  case decode.run(payload, decode.bit_array) {\n    Ok(bytes) -\u003e Ok(Data(bytes))\n    Error(_) -\u003e Error(\"Invalid data payload: expected BitArray\")  // Line 76\n  }\n```\n\nThe `Error(_)` pattern throws away the actual decode error, which could contain useful debugging information about why the decode failed (e.g., \"expected BitArray but got integer 42\").\n\nWhile the fixed error messages are clear about what was expected, they don't include information about what was actually received. Consider preserving the error details:\n\n```gleam\nError(errors) -\u003e Error(\"Invalid data payload: expected BitArray. Details: \" \u003c\u003e string.inspect(errors))\n```\n\nThis applies to lines 76, 81, and 86.\n\n---\n\n\u003c!-- fp:42d8130dede63fa3 --\u003e\n\u003c!-- fp:37883c59be1b9c79 --\u003e\n\u003c!-- fp:62eb94ce1aefb51e --\u003e\n\u003c!-- review_finding:efd28601cced --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:58:58.570296321Z","created_by":"cyou","updated_at":"2026-01-11T00:01:28.281561539Z","closed_at":"2026-01-11T00:01:28.281561539Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-va1.2"],"dependencies":[{"issue_id":"casg-va1.8","depends_on_id":"casg-va1","type":"parent-child","created_at":"2026-01-10T23:58:58.570828588Z","created_by":"cyou"}]}
{"id":"casg-va1.9","title":"[Review] 3 non-blocking findings from casg-va1.5","description":"## Review Findings\n\nThis issue consolidates 3 non-blocking findings from code review.\n\n**Source issue:** casg-va1.5\n**Highest priority:** P3\n\n---\n\n### Finding 1: [P3] Tuple decoder test doesn't verify runtime behavior\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** test/phase0_compile_check_test.gleam:94-100\n\nThe `api_confirmation_test` function at lines 94-100 creates a tuple decoder but only assigns it to `_` without testing it. The comment states \"Can't create Dynamic tuples directly, so we verify the decoder compiles\" - but this is only a compile-time check, not a runtime confirmation as the function name suggests.\n\nWhile the decoder does get tested indirectly in `port_ffi.gleam`, the test structure is misleading. Consider either:\n1. Moving this to `api_exists_compile_check_test` since it's a compile-time check\n2. Removing it entirely since the port_ffi tests already verify tuple decoding\n3. Adding a comment explaining that runtime tuple decoding is verified in port_ffi tests\n\n---\n\n### Finding 2: [P3] Missing regex API checks mentioned in requirements\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** test/phase0_compile_check_test.gleam:29-54\n\nThe implementation context and task description specify verifying `regex.from_string` and `regex.scan` APIs, but these are not included in the compile check tests. The task description states:\n\n```\napi_exists_compile_check_test() - verifies stdlib APIs exist:\n  - regex.from_string, regex.scan\n```\n\nHowever, no regex imports or checks are present in the test file. While this may be intentional if regex is not actually needed, it creates a discrepancy between the documented requirements and the implementation.\n\nConsider either:\n1. Adding regex checks if they're actually needed\n2. Updating the task description to remove regex from the requirements\n\n---\n\n### Finding 3: [P3] Dynamic tuple test comment is misleading\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** test/phase0_compile_check_test.gleam:83-91\n\nAt line 83, the comment says \"decode a tagged tuple (simulates FFI message format)\" but the actual test at line 84 only creates a simple Dynamic string, not a tuple. The test is:\n\n```gleam\nlet tagged: Dynamic = dynamic.string(\"test_tag\")\nlet decoder = decode.string\n```\n\nThis doesn't test tuple decoding at all - it just tests string decoding. The comment implies this is testing the FFI message format (which uses 2-tuples), but the actual code doesn't match.\n\nConsider updating the comment to accurately reflect what's being tested, e.g., \"Test basic dynamic string decoding\"\n\n---\n\n\u003c!-- fp:d31039693df72571 --\u003e\n\u003c!-- fp:b7e82da20f6d6771 --\u003e\n\u003c!-- fp:f605cb0c5ca4140e --\u003e\n\u003c!-- review_finding:fe1b213cd81b --\u003e","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-11T00:06:25.315249199Z","created_by":"cyou","updated_at":"2026-01-11T00:09:01.919849679Z","closed_at":"2026-01-11T00:09:01.919849679Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-va1.5"],"dependencies":[{"issue_id":"casg-va1.9","depends_on_id":"casg-va1","type":"parent-child","created_at":"2026-01-11T00:06:25.315751736Z","created_by":"cyou"}]}
