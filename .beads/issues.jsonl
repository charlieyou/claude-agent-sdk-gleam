{"id":"casg-1ku","title":"Emit UnparseableCliVersion warning when permissive_version_check allows unknown CLI version","notes":"SELF-DOC UPDATE (2026-01-11)\nCONTEXT:\n- When `permissive_version_check` is enabled and CLI version parsing fails, we currently proceed silently.\n- We should emit a non-fatal warning (`UnparseableCliVersion`) to inform users while still proceeding.\n\nGOAL / OUTCOME:\n- A warning event is emitted when permissive mode allows an unparseable CLI version.\n- The stream remains usable; this is a non-terminal warning.\n\nSUBTASKS:\n- Identify the version-check branch in `src/claude_agent_sdk.gleam` where parse failures are permitted.\n- Introduce a warning emission mechanism on the stream when permissive mode allows unknown version.\n- Add coverage (unit or integration) to ensure the warning is surfaced.\n\nFILES (planned):\n- `src/claude_agent_sdk.gleam` (version-check branching and warning hook).\n- `src/claude_agent_sdk/internal/stream.gleam` (if needed to seed an initial warning event).\n- `test/query_integration_test.gleam` or `test/stream_test.gleam` for warning verification.\n\nDEPENDENCIES:\n- Depends on casg-bev (both touch `src/claude_agent_sdk.gleam`).\n- Depends on casg-47z (both touch `src/claude_agent_sdk/internal/stream.gleam`).\n\nCONSIDERATIONS:\n- Warning must not change error semantics when permissive_version_check is False.\n- Ensure warning context includes raw version output for debugging.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T04:20:58.927003374Z","created_by":"cyou","updated_at":"2026-01-11T06:07:34.695881915Z","closed_at":"2026-01-11T06:07:34.695881915Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-1ku","depends_on_id":"casg-bev","type":"blocks","created_at":"2026-01-11T04:45:40.571640502Z","created_by":"cyou"},{"issue_id":"casg-1ku","depends_on_id":"casg-47z","type":"blocks","created_at":"2026-01-11T04:45:50.565415639Z","created_by":"cyou"}]}
{"id":"casg-2yc","title":"[Review] 2 non-blocking findings from casg-xjv.9","description":"## Review Findings\n\nThis issue consolidates 2 non-blocking findings from code review.\n\n**Source issue:** casg-xjv.9\n**Highest priority:** P3\n\n---\n\n### Finding 1: [P3] Custom list_length function duplicates stdlib functionality\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** test/json_decode_test.gleam:341-346\n\nThe test implements a custom `list_length` helper function at lines 341-346, but Gleam's standard library already provides `list.length`. While the custom function works correctly, it adds unnecessary code.\n\n**Current implementation:**\n```gleam\nfn list_length(lst: List(content.ContentBlock)) -\u003e Int {\n  case lst {\n    [] -\u003e 0\n    [_, ..rest] -\u003e 1 + list_length(rest)\n  }\n}\n```\n\n**Recommended fix:** Import `gleam/list` and use `list.length(blocks)` instead of `list_length(blocks)` at line 326.\n\nNote: This is purely a code quality improvement - the current implementation is functionally correct.\n\n---\n\n### Finding 2: [P3] Permission denial test could verify tool_input more explicitly\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** test/json_decode_test.gleam:305-307\n\nThe `decode_permission_denial_test` includes a comment at line 305 stating \"tool_input is Dynamic, just verify it's present (not None/nil)\" but then doesn't perform any verification - it just returns `Nil`.\n\nWhile the test does indirectly verify that `tool_input` is present (the decoder would fail if the required field was missing), the test could be more explicit. Consider adding an assertion like:\n\n```gleam\ncase denial.tool_input {\n  _ -\u003e Nil  // Just verify it's bound, don't inspect contents\n}\n```\n\nOr add a comment explaining that successful decoding implies field presence:\n```gleam\n// tool_input is Dynamic - decoder success implies it's present\nNil\n```\n\nNote: This is a minor test clarity issue - the test is functionally correct as the decoder validates all required fields.\n\n---\n\n\u003c!-- fp:275796d78d8d053d --\u003e\n\u003c!-- fp:bb8f7f1f76b0c34e --\u003e\n\u003c!-- review_finding:3ef2068eb31b --\u003e","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-11T06:06:56.124240366Z","created_by":"cyou","updated_at":"2026-01-11T06:09:43.145909054Z","closed_at":"2026-01-11T06:09:43.145909054Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-xjv.9"]}
{"id":"casg-2zv","title":"[Review] 4 non-blocking findings from casg-xjv.11","description":"## Review Findings\n\nThis issue consolidates 4 non-blocking findings from code review.\n\n**Source issue:** casg-xjv.11\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Missing .gitignore entries for artifacts and __pycache__\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** .gitignore:0\n\nThe commit adds Python scripts that create artifacts in `artifacts/e2e/` and generate `__pycache__/` directories, but these patterns are not in `.gitignore`. The git status shows `scripts/e2e/__pycache__/` as untracked.\n\n**Fix**: Add these lines to `.gitignore`:\n```\nartifacts/\n__pycache__/\n*.pyc\n```\n\nThis prevents committing generated files and test artifacts.\n\n---\n\n### Finding 2: [P3] Overly broad secret pattern may cause false positives\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** scripts/e2e/helpers.py:50\n\nThe regex pattern `r\"[a-zA-Z0-9_-]{32,}\"` in `SECRET_PATTERNS` will match any alphanumeric string 32+ characters long, which could incorrectly redact legitimate identifiers like session IDs, commit SHAs, or UUIDs.\n\n**Consideration**: This pattern is described as \"conservative\" in the comment, suggesting intentional over-redaction for security. However, it may redact useful diagnostic information. Consider:\n1. Making this pattern more specific (e.g., only match if preceded by common secret indicators)\n2. Documenting this trade-off in the README\n3. Adding a flag to control redaction strictness\n\nGiven the security-first intent, this is low priority but worth documenting.\n\n---\n\n### Finding 3: [P2] EventLogger files not closed on exception during main()\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** scripts/e2e/run_e2e.py:628-696\n\nIn `run_e2e.py`, the `EventLogger` is created at line 628 and closed at line 696, but if an exception occurs between these lines (e.g., during scenario execution), the file handles remain open. While Python's GC eventually closes them, this violates best practices.\n\n**Fix**: Use a context manager or try/finally block:\n```python\ntry:\n    logger = EventLogger(run_id=run_id, output_dir=output_dir)\n    # ... run scenarios ...\nfinally:\n    logger.close()\n```\n\nAlternatively, make `EventLogger` a context manager with `__enter__` and `__exit__` methods.\n\n---\n\n### Finding 4: [P3] Type hint uses dict instead of Dict from typing\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** scripts/e2e/helpers.py:89-91\n\nThe code uses `dict[str, str]` syntax (PEP 585, Python 3.9+) but README states Python 3.10+ is required. While this works, mixing modern syntax with explicit imports from `typing` module would be more consistent.\n\n**Current**: Uses `dict[str, str]` in function signatures\n**Alternative**: Use `Dict[str, str]` from `typing` for consistency with older Python typing conventions\n\nThis is purely stylistic since Python 3.10+ is required. The current approach is actually preferred for modern Python. This is informational only - no change needed.\n\n---\n\n\u003c!-- fp:71c11a510158b9f6 --\u003e\n\u003c!-- fp:f72d95dbbdb780d8 --\u003e\n\u003c!-- fp:70bbdcfc8a323486 --\u003e\n\u003c!-- fp:cbe9ff7a1666f6ba --\u003e\n\u003c!-- review_finding:726154331144 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T05:04:31.404100263Z","created_by":"cyou","updated_at":"2026-01-11T05:17:26.846682563Z","closed_at":"2026-01-11T05:17:26.846682563Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-xjv.11"]}
{"id":"casg-3ac","title":"Epic: Bidirectional Protocol - Integration Testing","description":"## Overview\nEnd-to-end testing with mock runner and real CLI. Validates everything works together.\n\n## Source Plan\n`plans/2026-01-12-bidir-protocol-plan.md` - \"Testing \u0026 Validation Strategy\" section\n\n## Key Deliverables\n- Mock BidirRunner for unit/integration tests\n- Full session lifecycle tests\n- Real CLI integration tests (opt-in)\n- Regression tests for query()\n\n## Test Categories\n1. **Unit Tests** (mock runner)\n   - Control message round-trips\n   - Hook dispatch and timeout\n   - Request ID correlation\n\n2. **Integration Tests** (mock runner)\n   - State transitions\n   - Handshake flow\n   - Message routing\n\n3. **E2E Tests** (real CLI, opt-in)\n   - Full session with hooks\n   - Control operations\n   - MCP routing\n\n4. **Regression Tests**\n   - query() unchanged\n   - Message types unchanged\n   - Options builders compose\n\n## Acceptance Criteria Coverage\n| AC | Test |\n|----|------|\n| Bidir mode via --input-format | CLI args test |\n| NDJSON framing | Stream/encoder tests |\n| Request ID correlation | Tracker tests |\n| Hook callbacks | Dispatch tests |\n| Permission callbacks | Permission tests |\n| Control operations | Control ops tests |\n\n## Files\n- test/support/mock_bidir_runner.gleam (New)\n- test/bidir_integration_test.gleam (New)\n- test/e2e/bidir_e2e_test.gleam (New)\n- test/regression_test.gleam (New)","status":"open","priority":2,"issue_type":"epic","created_at":"2026-01-12T04:07:32.161821016Z","created_by":"cyou","updated_at":"2026-01-12T04:07:32.161821016Z","dependencies":[{"issue_id":"casg-3ac","depends_on_id":"casg-7l4","type":"blocks","created_at":"2026-01-12T04:07:44.10092046Z","created_by":"cyou"}]}
{"id":"casg-3ac.1","title":"Full mock runner integration test","description":"## Goal\nCreate a comprehensive mock runner that simulates the full Claude CLI bidirectional protocol, enabling end-to-end testing of session lifecycle without requiring the real CLI.\n\n## Background\nThe existing `Runner` type abstracts CLI execution. We need a new mock runner that:\n- Simulates the full bidirectional protocol (initialize handshake, hooks, messages)\n- Routes messages correctly (control channel vs regular stdout)\n- Maintains proper session state\n\n## Files to Create/Modify\n- `test/support/full_mock_runner.gleam` - New mock runner implementation\n- `test/bidir_integration_test.gleam` - Integration tests using mock runner\n\n## TDD Steps\n\n### Red Phase\n1. Write test: `test_full_session_lifecycle` \n   - Start session -\u003e receive init ack -\u003e send message -\u003e receive hooks -\u003e stop\n   - Expect: session completes successfully\n\n2. Write test: `test_message_routing`\n   - Mock runner sends control message and regular message\n   - Expect: control goes to control channel, regular to stdout\n\n3. Write test: `test_init_handshake`\n   - Session starts with hooks registered\n   - Expect: mock runner receives `initialize` with correct hook list\n\n### Green Phase\n1. Implement `FullMockRunner` type with:\n   - `new()` constructor with configurable behavior\n   - `with_auto_init_ack()` - automatically respond to initialize\n   - `with_hook_simulation(hook_name, response)` - queue hook events\n   - `with_message_sequence(messages)` - queue messages to emit\n\n2. Implement protocol simulation:\n   - Parse incoming NDJSON\n   - Respond to `initialize` with ack\n   - Emit queued hooks at appropriate times\n   - Track session state\n\n### Refactor Phase\n- Extract common test utilities\n- Add builder pattern for mock configuration\n\n## Acceptance Criteria\n- [ ] Mock runner simulates full session lifecycle\n- [ ] Message routing distinguishes control from regular messages\n- [ ] Initialize handshake works with hook registration\n- [ ] Tests can inject arbitrary protocol sequences\n- [ ] Mock is reusable across other integration tests\n\n## Technical Notes\n- Mock must satisfy the `Runner` protocol\n- Use `gleam_erlang/process` for async message simulation\n- Consider using `Subject` for mock message emission\n\n## Spec AC Coverage\n- AC #1: Bidirectional mode via `--input-format stream-json`\n- AC #4: Initialize handshake registers hooks","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-12T04:10:57.205443031Z","created_by":"cyou","updated_at":"2026-01-12T04:13:10.91581506Z","labels":["integration","tdd","test"],"dependencies":[{"issue_id":"casg-3ac.1","depends_on_id":"casg-3ac","type":"parent-child","created_at":"2026-01-12T04:10:57.20604399Z","created_by":"cyou"}]}
{"id":"casg-3ac.2","title":"Hook flow integration tests","description":"## Goal\nVerify that all hook callbacks work correctly end-to-end through the mock runner, including context passing, response handling, and timeout behavior.\n\n## Background\nHooks are the core feature of bidirectional mode. Each hook type must:\n- Receive correct context from the CLI\n- Invoke user-provided callbacks with that context\n- Return responses back to the CLI\n- Handle timeouts gracefully (fail-open for most, fail-deny for permissions)\n\n## Files to Create/Modify\n- `test/hook_integration_test.gleam` - Hook integration tests\n\n## TDD Steps\n\n### Red Phase\n1. Write test: `test_pre_tool_use_receives_context`\n   - Register PreToolUse hook\n   - Mock runner emits hook request with tool_name, input\n   - Expect: callback receives HookContext with correct fields\n\n2. Write test: `test_post_tool_use_receives_output`\n   - Register PostToolUse hook\n   - Mock runner emits hook request with tool output\n   - Expect: callback receives output in context\n\n3. Write test: `test_can_use_tool_permission`\n   - Register can_use_tool callback\n   - Mock runner emits permission request\n   - Expect: callback invoked, response sent back\n\n4. Write test: `test_hook_timeout_fails_open`\n   - Register slow hook (sleeps 100ms)\n   - Configure 50ms timeout\n   - Expect: hook times out, returns `continue: true`\n\n5. Write test: `test_permission_timeout_fails_deny`\n   - Register slow permission callback\n   - Configure 50ms timeout\n   - Expect: permission times out, returns `deny`\n\n### Green Phase\n1. Enhance mock runner to emit hook requests\n2. Verify GenServer dispatches to correct callback\n3. Verify responses are properly formatted and sent\n\n### Refactor Phase\n- Extract hook test helpers\n- Parameterize timeout tests\n\n## Acceptance Criteria\n- [ ] PreToolUse hook receives tool name and input\n- [ ] PostToolUse hook receives tool output\n- [ ] can_use_tool receives permission context\n- [ ] Timeouts work correctly per hook type\n- [ ] Hook errors are caught and fail-open\n\n## Technical Notes\n- Use mock runner from T1 (integration-path-test)\n- Test both sync and async hook patterns\n- Verify JSON encoding of responses\n\n## Spec AC Coverage\n- AC #5: Hook callbacks invoke user functions\n- AC #6: Permission callbacks consult can_use_tool\n- AC #9: Timeouts default 60s, configurable per-hook\n- AC #10: Hook errors fail-open\n- AC #11: Permission errors fail-deny","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-12T04:11:13.778719878Z","created_by":"cyou","updated_at":"2026-01-12T04:13:37.369892669Z","labels":["integration","tdd","test"],"dependencies":[{"issue_id":"casg-3ac.2","depends_on_id":"casg-3ac","type":"parent-child","created_at":"2026-01-12T04:11:13.779270727Z","created_by":"cyou"},{"issue_id":"casg-3ac.2","depends_on_id":"casg-3ac.1","type":"blocks","created_at":"2026-01-12T04:12:23.79131673Z","created_by":"cyou"}]}
{"id":"casg-3ac.3","title":"Control operations integration tests","description":"## Goal\nTest all control operations (interrupt, set_permission_mode, set_model, rewind_files) through the mock runner to verify correct message encoding and response handling.\n\n## Background\nControl operations are SDK-initiated requests to the CLI. Each must:\n- Encode correctly as control_request JSON\n- Include proper request_id for correlation\n- Handle CLI response correctly\n- Report errors appropriately\n\n## Files to Create/Modify\n- `test/control_integration_test.gleam` - Control operation integration tests\n\n## TDD Steps\n\n### Red Phase\n1. Write test: `test_interrupt_flow`\n   - Call `interrupt(session)`\n   - Expect: mock runner receives control_request with operation=\"interrupt\"\n   - Expect: function returns after CLI ack\n\n2. Write test: `test_set_permission_mode_flow`\n   - Call `set_permission_mode(session, Reject)`\n   - Expect: mock runner receives control_request with operation=\"set_permission_mode\", mode=\"reject\"\n\n3. Write test: `test_set_model_flow`\n   - Call `set_model(session, \"opus\")`\n   - Expect: mock runner receives control_request with operation=\"set_model\", model=\"opus\"\n\n4. Write test: `test_rewind_files_with_checkpointing`\n   - Start session with file_checkpointing enabled\n   - Call `rewind_files(session)`\n   - Expect: mock runner receives control_request with operation=\"rewind_files\"\n\n5. Write test: `test_rewind_files_without_checkpointing_fails`\n   - Start session without file_checkpointing\n   - Call `rewind_files(session)`\n   - Expect: Error returned (operation not available)\n\n6. Write test: `test_control_request_id_correlation`\n   - Send two control operations\n   - Expect: each has unique request_id\n   - Expect: responses correlate correctly\n\n### Green Phase\n1. Implement control operation functions in bidir module\n2. Wire up request_tracker for ID generation\n3. Add response handlers in GenServer\n\n### Refactor Phase\n- Extract control operation test helpers\n- Add timeout handling for unresponsive CLI\n\n## Acceptance Criteria\n- [ ] interrupt() sends correct control_request\n- [ ] set_permission_mode() encodes mode correctly\n- [ ] set_model() encodes model correctly\n- [ ] rewind_files() works only with checkpointing\n- [ ] Request IDs are unique and correlate properly\n- [ ] Control errors are reported to caller\n\n## Technical Notes\n- Mock runner must simulate control_response messages\n- Test async nature of control operations\n- Verify GenServer state updates on control completion\n\n## Spec AC Coverage\n- AC #8: Control operations send control_request\n- AC #3: Request ID correlation (via control operations)","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-12T04:11:26.653055945Z","created_by":"cyou","updated_at":"2026-01-12T04:13:37.869556181Z","labels":["integration","tdd","test"],"dependencies":[{"issue_id":"casg-3ac.3","depends_on_id":"casg-3ac","type":"parent-child","created_at":"2026-01-12T04:11:26.653689744Z","created_by":"cyou"},{"issue_id":"casg-3ac.3","depends_on_id":"casg-3ac.1","type":"blocks","created_at":"2026-01-12T04:12:24.298640116Z","created_by":"cyou"}]}
{"id":"casg-3ac.4","title":"Regression tests for query() API","description":"## Goal\nEnsure the existing `query()` API continues to work unchanged after adding bidirectional support, maintaining backward compatibility for existing users.\n\n## Background\nThe `query()` function is the original simple API. After adding `start_session()` and bidirectional support:\n- `query()` must continue working exactly as before\n- Existing test mocks (Runner) must still work\n- All existing Message types must parse correctly\n- Bidir-specific options should be ignored with a warning\n\n## Files to Create/Modify\n- `test/query_regression_test.gleam` - Regression tests for query API\n\n## TDD Steps\n\n### Red Phase\n1. Write test: `test_query_returns_message_iterator`\n   - Call `query(\"Hello\")` with mock runner\n   - Expect: returns Iterator(Message)\n   - Expect: messages parse as before\n\n2. Write test: `test_query_ignores_bidir_options_with_warning`\n   - Call `query(\"Hello\", opts |\u003e with_pre_tool_use(fn(_) { Continue })`\n   - Expect: query succeeds (option ignored)\n   - Expect: warning logged about ignored option\n\n3. Write test: `test_existing_message_types_parse`\n   - Mock runner emits all known message types\n   - Expect: each type parses to correct variant\n   - Cover: AssistantMessage, ToolUseMessage, ToolResultMessage, SystemMessage, ErrorMessage\n\n4. Write test: `test_existing_runner_mock_works`\n   - Use existing simple Runner mock from test suite\n   - Call query with mock\n   - Expect: query works without changes to mock\n\n5. Write test: `test_query_options_still_compose`\n   - Chain multiple options: with_model, with_max_turns, with_system_prompt\n   - Expect: all options applied correctly\n\n### Green Phase\n1. Ensure query() implementation unchanged\n2. Add option validation with warnings for bidir options\n3. Verify message decoder handles all types\n\n### Refactor Phase\n- Extract common query test patterns\n- Add test coverage for edge cases\n\n## Acceptance Criteria\n- [ ] query() returns Iterator(Message) as before\n- [ ] Bidir options ignored with logged warning\n- [ ] All existing Message types parse correctly\n- [ ] Existing Runner mocks work without changes\n- [ ] Option composition works as before\n- [ ] No breaking changes to public API\n\n## Technical Notes\n- Use existing test fixtures where possible\n- Compare output with pre-bidir baseline if available\n- Check deprecation warnings are clear and helpful\n\n## Spec AC Coverage\n- Regression testing (not specific AC, but critical for backward compatibility)\n- Verifies \"query() continues to work\" from plan's Regression Tests section","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-12T04:11:42.280349292Z","created_by":"cyou","updated_at":"2026-01-12T04:14:24.106215307Z","labels":["regression","tdd","test"],"dependencies":[{"issue_id":"casg-3ac.4","depends_on_id":"casg-3ac","type":"parent-child","created_at":"2026-01-12T04:11:42.281031631Z","created_by":"cyou"},{"issue_id":"casg-3ac.4","depends_on_id":"casg-3ac.1","type":"blocks","created_at":"2026-01-12T04:12:24.811803239Z","created_by":"cyou"}]}
{"id":"casg-3ac.5","title":"Real CLI end-to-end tests (opt-in)","description":"## Goal\nCreate end-to-end tests that run against the real Claude CLI when available, validating the full bidirectional protocol works in production conditions.\n\n## Background\nMock tests verify logic, but E2E tests verify:\n- Actual NDJSON framing works\n- Real CLI protocol matches expectations\n- Hooks fire at correct times with real data\n- Control operations execute correctly\n\nThese tests are opt-in (skipped when CLI unavailable) to allow CI without Claude CLI.\n\n## Files to Create/Modify\n- `test/e2e/bidir_e2e_test.gleam` - E2E tests with real CLI\n- `docs/E2E_TESTING.md` - Documentation for running E2E tests\n\n## TDD Steps\n\n### Red Phase\n1. Write test: `test_real_session_with_hook`\n   - Skip if CLI not available\n   - Start real session with PreToolUse hook\n   - Send prompt that triggers tool use\n   - Expect: hook fires with real tool context\n\n2. Write test: `test_real_control_operations`\n   - Skip if CLI not available\n   - Start real session\n   - Call set_model(\"sonnet\")\n   - Expect: operation succeeds\n\n3. Write test: `test_real_permission_callback`\n   - Skip if CLI not available\n   - Register can_use_tool that denies Bash\n   - Send prompt requesting bash\n   - Expect: tool denied, session continues\n\n4. Write test: `test_real_interrupt`\n   - Skip if CLI not available\n   - Start session with long-running task\n   - Call interrupt()\n   - Expect: session stops gracefully\n\n### Green Phase\n1. Implement CLI detection helper: `is_cli_available()`\n2. Create skip wrapper for conditional tests\n3. Run tests against real CLI\n4. Document any CLI version requirements\n\n### Refactor Phase\n- Add detailed logging for E2E debugging\n- Create test fixtures that work offline for demo\n\n## Acceptance Criteria\n- [ ] E2E tests run successfully with real CLI\n- [ ] Tests skip gracefully when CLI unavailable\n- [ ] Hook registration works with real CLI\n- [ ] Control operations execute with real CLI\n- [ ] Documentation explains how to run E2E tests\n- [ ] CI skips E2E tests by default\n\n## Technical Notes\n- Use `gleeunit` skip functionality\n- Set environment variable for opt-in: `CLAUDE_E2E_TESTS=1`\n- Consider test timeouts (real CLI may be slow)\n- Log CLI version for debugging\n\n## Documentation Requirements (E2E_TESTING.md)\n- Prerequisites (CLI version, API key)\n- How to enable E2E tests\n- Troubleshooting common issues\n- Example output\n\n## Spec AC Coverage\n- End-to-End Tests section of plan\n- Validates all ACs in production conditions","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-12T04:11:56.964543868Z","created_by":"cyou","updated_at":"2026-01-12T04:14:24.616144576Z","labels":["e2e","tdd","test"],"dependencies":[{"issue_id":"casg-3ac.5","depends_on_id":"casg-3ac","type":"parent-child","created_at":"2026-01-12T04:11:56.965233516Z","created_by":"cyou"},{"issue_id":"casg-3ac.5","depends_on_id":"casg-3ac.2","type":"blocks","created_at":"2026-01-12T04:12:28.221747872Z","created_by":"cyou"},{"issue_id":"casg-3ac.5","depends_on_id":"casg-3ac.3","type":"blocks","created_at":"2026-01-12T04:12:28.733873934Z","created_by":"cyou"}]}
{"id":"casg-3ac.6","title":"Acceptance criteria coverage verification","description":"## Goal\nCreate a test suite that explicitly verifies each acceptance criterion from the spec is covered by tests, providing a traceable mapping from requirements to test cases.\n\n## Background\nThe plan defines 11 acceptance criteria (AC #1-11). This task creates:\n- Explicit tests that map to each AC\n- Documentation of which tests cover which ACs\n- A verification that all ACs have test coverage\n\n## Files to Create/Modify\n- `test/acceptance_criteria_test.gleam` - AC verification tests\n\n## Acceptance Criteria from Spec\n\n| AC | Description | Covered By |\n|----|-------------|------------|\n| AC #1 | Bidirectional mode via `--input-format stream-json` | CLI arg tests |\n| AC #2 | NDJSON framing both directions | Stream layer tests |\n| AC #3 | Request ID correlation | request_tracker tests |\n| AC #4 | Initialize handshake registers hooks | bidir init tests |\n| AC #5 | Hook callbacks invoke user functions | hook tests |\n| AC #6 | Permission callbacks consult can_use_tool | permission tests |\n| AC #7 | SDK MCP servers route to handlers | MCP tests |\n| AC #8 | Control operations send control_request | control tests |\n| AC #9 | Timeouts default 60s, configurable per-hook | timeout tests |\n| AC #10 | Hook errors fail-open | error handling tests |\n| AC #11 | Permission errors fail-deny | permission error tests |\n\n## TDD Steps\n\n### Red Phase\n1. Write test: `test_ac1_bidir_mode_cli_flag`\n   - Verify `--input-format stream-json` passed to CLI\n   - Check args builder includes flag\n\n2. Write test: `test_ac2_ndjson_framing`\n   - Verify messages end with newlines\n   - Verify parsing handles NDJSON\n\n3. Write test: `test_ac3_request_id_correlation`\n   - Send request, verify ID in response matches\n\n4. Write test: `test_ac4_init_handshake`\n   - Start session, verify initialize sent with hooks\n\n5. Write test: `test_ac5_hook_callbacks`\n   - Register hook, trigger it, verify callback invoked\n\n6. Write test: `test_ac6_permission_callbacks`\n   - Register can_use_tool, verify consulted\n\n7. Write test: `test_ac7_mcp_routing`\n   - Register MCP server, verify messages routed\n\n8. Write test: `test_ac8_control_requests`\n   - Call control operation, verify control_request sent\n\n9. Write test: `test_ac9_hook_timeouts`\n   - Configure timeout, verify enforced\n\n10. Write test: `test_ac10_hook_errors_fail_open`\n    - Hook throws error, verify continue: true\n\n11. Write test: `test_ac11_permission_errors_fail_deny`\n    - Permission throws error, verify deny\n\n### Green Phase\n- These tests should pass once all other integration tests are implemented\n- Each test is a focused verification of one AC\n\n### Refactor Phase\n- Add test documentation with AC references\n- Generate coverage report\n\n## Acceptance Criteria (Meta)\n- [ ] Each of the 11 ACs has explicit test\n- [ ] Tests reference AC numbers in names\n- [ ] Documentation maps ACs to test files\n- [ ] All AC tests pass\n\n## Technical Notes\n- This is a consolidation/verification task\n- May reference tests from other files\n- Serves as living documentation of coverage","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-12T04:12:14.73758187Z","created_by":"cyou","updated_at":"2026-01-12T04:14:25.11662483Z","labels":["tdd","test","verification"],"dependencies":[{"issue_id":"casg-3ac.6","depends_on_id":"casg-3ac","type":"parent-child","created_at":"2026-01-12T04:12:14.738244158Z","created_by":"cyou"},{"issue_id":"casg-3ac.6","depends_on_id":"casg-3ac.1","type":"blocks","created_at":"2026-01-12T04:12:33.066784319Z","created_by":"cyou"},{"issue_id":"casg-3ac.6","depends_on_id":"casg-3ac.2","type":"blocks","created_at":"2026-01-12T04:12:33.581534439Z","created_by":"cyou"},{"issue_id":"casg-3ac.6","depends_on_id":"casg-3ac.3","type":"blocks","created_at":"2026-01-12T04:12:34.118833189Z","created_by":"cyou"},{"issue_id":"casg-3ac.6","depends_on_id":"casg-3ac.4","type":"blocks","created_at":"2026-01-12T04:12:34.637271618Z","created_by":"cyou"}]}
{"id":"casg-3gt","title":"[Review] 2 non-blocking findings from casg-poj","description":"## Review Findings\n\nThis issue consolidates 2 non-blocking findings from code review.\n\n**Source issue:** casg-poj\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Avoid making flush_queued_ops public unless required\n\n**Priority:** P2\n**Reviewer:** codex\n**Location:** src/claude_agent_sdk/internal/bidir.gleam:1604-1613\n\n`flush_queued_ops` is now `pub fn`, which expands `bidir`’s public API surface for what looks like an internal lifecycle helper (“Flush queued operations after successful init”). External callers can invoke it at arbitrary times, potentially bypassing intended sequencing around init completion and request sending.\n\nIf this was only needed internally/tests, prefer keeping it non-public (or exposing a narrower, documented public entrypoint).\n\n---\n\n### Finding 2: [P2] Use consistent error type for pending_requests overflow\n\n**Priority:** P2\n**Reviewer:** codex\n**Location:** src/claude_agent_sdk/internal/bidir.gleam:1625-1634\n\nThe overflow condition in `flush_queued_ops` sends `RequestError(\"Too many pending control requests (max 64)\")` when `dict.size(pending) \u003e= max_pending_requests`.\n\nElsewhere, the dedicated backpressure path returns `Error(TooManyPendingRequests(\"Too many pending control requests (max 64)\"))`, so callers that pattern-match on `TooManyPendingRequests` won’t see the same signal during init-flush overflow.\n\nConcrete mismatch in this function:\n```gleam\nprocess.send(reply_to, RequestError(\"Too many pending control requests (max 64)\"))\n```\nConsider reusing `TooManyPendingRequests` semantics (or renaming/documenting why init-flush overflow is intentionally surfaced as `RequestError`).\n\n---\n\n\u003c!-- fp:b89009b371af86c0 --\u003e\n\u003c!-- fp:b42c1d35f3d1d8ec --\u003e\n\u003c!-- review_finding:9016bcd164a3 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T17:33:32.962736011Z","created_by":"cyou","updated_at":"2026-01-12T17:47:13.982972314Z","closed_at":"2026-01-12T17:47:13.982972314Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-poj"]}
{"id":"casg-47z","title":"Emit UnexpectedMessageAfterResult warning when messages arrive after Result","notes":"SELF-DOC UPDATE (2026-01-11)\nCONTEXT:\n- Stream state transitions allow ResultReceived; messages arriving after Result should be flagged.\n- A warning (`UnexpectedMessageAfterResult`) exists in the error model but is not emitted yet.\n\nGOAL / OUTCOME:\n- Emit a WarningEvent with code UnexpectedMessageAfterResult when data arrives after Result.\n- Continue streaming (non-terminal warning), then proceed to end-of-stream behavior.\n\nSUBTASKS:\n- Update stream state handling in `src/claude_agent_sdk/internal/stream.gleam` to detect late messages.\n- Include raw JSON context in the warning for diagnostics.\n- Add tests to cover late-message behavior.\n\nFILES (planned):\n- `src/claude_agent_sdk/internal/stream.gleam` (state machine + warning emission).\n- `test/stream_test.gleam` (late message test cases).\n\nDEPENDENCIES:\n- Depends on casg-xjv.6 because both will touch `test/stream_test.gleam`.\n- Blocks casg-1ku because both will touch `src/claude_agent_sdk/internal/stream.gleam`.\n\nCONSIDERATIONS:\n- Ensure this warning does not change terminal/non-terminal error classification.\n- Avoid duplicating warnings for multiple late messages unless explicitly desired.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T04:21:17.65468191Z","created_by":"cyou","updated_at":"2026-01-11T05:18:30.877333827Z","closed_at":"2026-01-11T05:18:30.877333827Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-47z","depends_on_id":"casg-xjv.6","type":"blocks","created_at":"2026-01-11T04:45:59.697778321Z","created_by":"cyou"}]}
{"id":"casg-4jq","title":"Epic: Bidirectional Protocol - GenServer Session","description":"## Overview\nImplement the BidirSession GenServer for session lifecycle and message routing.\n\n## Source Plan\n`plans/2026-01-12-bidir-protocol-plan.md` - \"Architecture\", \"Initialization State Machine\" sections\n\n## State Machine\nStarting → InitSent → Running → Stopped/Failed\n\n## Key Deliverables\n- internal/bidir.gleam: GenServer with init, handle_call, handle_info\n- SessionState: runner, lifecycle, pending_requests, pending_hooks, queued_ops\n- Initialization handshake (send initialize, await response or implicit confirmation)\n- Message routing (control vs regular)\n- Backpressure limits (queued_ops: 16, pending_requests: 64, pending_hooks: 32)\n\n## Implicit Confirmation Rules\n| Incoming Subtype | Triggers RUNNING? |\n|------------------|-------------------|\n| hook_callback | Yes |\n| can_use_tool | Yes |\n| mcp_message | Yes |\n| Regular messages | No |\n\n## TDD Focus\n- State transitions tested in isolation\n- Initialization timeout (10s) handling\n- Queue overflow handling\n- Message routing to correct handler\n\n## Files\n- src/claude_agent_sdk/internal/bidir.gleam (New)\n- test/bidir_session_test.gleam (New)\n- test/support/mock_bidir_runner.gleam (New)","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-12T04:06:50.576283404Z","created_by":"cyou","updated_at":"2026-01-12T15:41:16.975992505Z","closed_at":"2026-01-12T15:41:16.975992505Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-4jq","depends_on_id":"casg-de0","type":"blocks","created_at":"2026-01-12T04:07:43.72930005Z","created_by":"cyou"},{"issue_id":"casg-4jq","depends_on_id":"casg-lde","type":"blocks","created_at":"2026-01-12T04:07:43.791522049Z","created_by":"cyou"}]}
{"id":"casg-4jq.1","title":"T1: GenServer skeleton - actor with SessionState types and init/handle_call stubs","description":"## GenServer Skeleton for BidirSession\n\nCreate the foundational GenServer (OTP actor) skeleton for managing bidirectional protocol sessions.\n\n### Goal\nEstablish a working OTP actor that can be spawned and receive messages, laying the groundwork for all session management.\n\n### TDD Approach\n1. **Skeleton first**: Create `bidir.gleam` with type definitions and empty handler stubs\n2. **Failing test**: Write integration test that attempts to start actor and send a message\n3. **Make it pass**: Implement minimal `init` and `handle_call` to satisfy test\n\n### Implementation Details\n\n**SessionState type** (from spec):\n```gleam\npub type SessionState {\n  SessionState(\n    runner: Runner,\n    lifecycle: SessionLifecycle,\n    pending_requests: Map(String, PendingRequest),\n    pending_hooks: Map(String, PendingHook),\n    queued_ops: List(QueuedOperation),\n    hooks: HookConfig,\n    mcp_handlers: Map(String, fn(Dynamic) -\u003e Dynamic),\n    next_request_id: Int,\n    next_callback_id: Int,\n    subscriber: Subject(Message),\n    capabilities: Option(CliCapabilities),\n    default_timeout_ms: Int,\n    hook_timeouts: Map(HookEvent, Int),\n  )\n}\n```\n\n**Actor pattern**:\n- Use `gleam/otp/actor` with `start`, `call`, `send`\n- Port owned by GenServer process (critical for message routing)\n- Messages arrive as native `{Port, {data, Binary}}` tuples\n\n### Files\n- `src/claude_agent_sdk/internal/bidir.gleam` - Main GenServer module\n- `test/bidir_session_test.gleam` - Integration tests\n\n### Acceptance Criteria\n- [ ] `SessionState` type defined with all fields\n- [ ] `SessionLifecycle` type defined (Starting, InitSent, Running, Stopped, Failed)\n- [ ] `PendingRequest` and `PendingHook` types defined\n- [ ] Actor can be started with `actor.start`\n- [ ] Actor responds to basic call messages\n- [ ] Test verifies actor starts and processes at least one message","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:09:44.214173645Z","created_by":"cyou","updated_at":"2026-01-12T06:12:47.488113394Z","closed_at":"2026-01-12T06:12:47.488113394Z","close_reason":"Closed","labels":["actor","integration-path-test","tdd"],"dependencies":[{"issue_id":"casg-4jq.1","depends_on_id":"casg-4jq","type":"parent-child","created_at":"2026-01-12T04:09:44.214820804Z","created_by":"cyou"}]}
{"id":"casg-4jq.2","title":"T2: Lifecycle state machine - validated Starting/InitSent/Running/Stopped/Failed transitions","description":"## Lifecycle State Machine Implementation\n\nImplement the complete session lifecycle state machine with validated transitions.\n\n### Goal\nEnsure the session can only transition between valid states, catching programming errors early.\n\n### State Machine\n```\nSTARTING → INIT_SENT → RUNNING → STOPPED\n                ↓           ↓\n             FAILED      FAILED\n```\n\n### TDD Approach\n1. **Skeleton**: Define `transition` function signature returning `Result(SessionLifecycle, InvalidTransition)`\n2. **Failing tests**: Write tests for all valid/invalid transition combinations\n3. **Implement**: Fill in transition logic\n\n### Implementation Details\n\n**SessionLifecycle states**:\n```gleam\npub type SessionLifecycle {\n  Starting       // CLI spawn in progress\n  InitSent       // Initialize request sent, awaiting response\n  Running        // Initialization confirmed, normal operation\n  Stopped        // Session terminated\n  Failed(reason: SessionError)  // Terminal error state\n}\n```\n\n**State Transitions** (from spec):\n| From | Event | To | Action |\n|------|-------|-----|--------|\n| STARTING | CLI spawned | INIT_SENT | Send initialize control_request |\n| INIT_SENT | Success response | RUNNING | Store capabilities, flush queued ops |\n| INIT_SENT | Error response | FAILED | Return InitializationError |\n| INIT_SENT | 10s timeout | FAILED | Return InitializationTimeout |\n| INIT_SENT | Port closed | FAILED | Return CliExitedDuringInit |\n| RUNNING | stop() called | STOPPED | Close port, notify subscribers |\n| RUNNING | Port closed | STOPPED | Notify subscribers with exit code |\n\n**Invalid transitions** (should error):\n- STOPPED → any state\n- FAILED → any state\n- RUNNING → INIT_SENT (going backwards)\n- STARTING → RUNNING (skipping INIT_SENT)\n\n### Files\n- `src/claude_agent_sdk/internal/bidir.gleam` - Add transition functions\n- `test/lifecycle_test.gleam` - State transition tests\n\n### Acceptance Criteria\n- [ ] `transition(from, event) -\u003e Result(to, error)` function\n- [ ] All valid transitions return Ok(new_state)\n- [ ] All invalid transitions return Error(InvalidTransition)\n- [ ] Terminal states (Stopped, Failed) reject all transitions\n- [ ] Test coverage for all transition combinations","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:10:00.285675063Z","created_by":"cyou","updated_at":"2026-01-12T06:25:01.554922941Z","closed_at":"2026-01-12T06:25:01.554922941Z","close_reason":"Closed","labels":["state-machine","tdd"],"dependencies":[{"issue_id":"casg-4jq.2","depends_on_id":"casg-4jq","type":"parent-child","created_at":"2026-01-12T04:10:00.286300902Z","created_by":"cyou"},{"issue_id":"casg-4jq.2","depends_on_id":"casg-4jq.1","type":"blocks","created_at":"2026-01-12T04:11:24.694978816Z","created_by":"cyou"}]}
{"id":"casg-4jq.3","title":"T3: Initialization handshake - send initialize, handle success/error/timeout","description":"## Initialization Handshake\n\nImplement the initialization handshake sequence that transitions from INIT_SENT to RUNNING.\n\n### Goal\nHandle the critical initialization phase where the SDK and CLI negotiate capabilities and confirm the session is operational.\n\n### TDD Approach\n1. **Skeleton**: Add init handshake logic stubs in `handle_info`\n2. **Failing tests**: Mock runner to send success/error/timeout responses\n3. **Implement**: Wire up response handling and timeouts\n\n### Protocol Flow\n```\nSDK                                      CLI\n │                                        │\n │ ─── control_request (initialize) ────\u003e │\n │     request_id: \"req_0\"                │\n │     hooks: {...}                       │\n │     mcp_servers: [...]                 │\n │                                        │\n │ \u003c── control_response ───────────────── │\n │     subtype: \"success\"                 │\n │     request_id: \"req_0\"                │\n │     response: {capabilities: {...}}    │\n │                                        │\n │ ─── [RUNNING state] ─────────────────\u003e │\n```\n\n### Implementation Details\n\n**Initialize request format**:\n```json\n{\n  \"type\": \"control_request\",\n  \"request_id\": \"req_0\",\n  \"request\": {\n    \"subtype\": \"initialize\",\n    \"hooks\": {\"PreToolUse\": [...], ...},\n    \"mcp_servers\": [\"server-1\"],\n    \"enable_file_checkpointing\": true\n  }\n}\n```\n\n**Success handling**:\n1. Match response.request_id with pending init request\n2. Extract capabilities from response.response\n3. Transition to RUNNING\n4. Flush queued_ops (non-blocking)\n\n**Error handling**:\n1. Response has subtype: \"error\"\n2. Transition to FAILED with InitializationError(message)\n3. Return error to all queued callers\n\n**Timeout (10s)**:\n1. Start timer on init request send\n2. If timer fires before response, transition to FAILED\n3. Return InitializationTimeout to all callers\n\n### Files\n- `src/claude_agent_sdk/internal/bidir.gleam` - Init handshake in handle_info\n- `test/init_handshake_test.gleam` - Test with mock runner\n\n### Acceptance Criteria\n- [ ] Init control_request sent in GenServer init\n- [ ] Success response transitions to RUNNING\n- [ ] Error response transitions to FAILED(InitializationError)\n- [ ] 10s timeout transitions to FAILED(InitializationTimeout)\n- [ ] Capabilities stored in state on success\n- [ ] queued_ops flushed on success (sent, not awaited)\n- [ ] Test with mock runner for each scenario","notes":"Quality gate failed: Timeout after 60 minutes\nLog: /home/cyou/.claude/projects/-home-cyou-claude-agent-sdk-gleam/46ceac3a-2713-4179-8306-c4bf91816947.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:10:14.390983302Z","created_by":"cyou","updated_at":"2026-01-12T15:07:59.909320737Z","closed_at":"2026-01-12T15:07:59.909320737Z","close_reason":"Closed","labels":["needs-followup","protocol","tdd","timeout"],"dependencies":[{"issue_id":"casg-4jq.3","depends_on_id":"casg-4jq","type":"parent-child","created_at":"2026-01-12T04:10:14.391569911Z","created_by":"cyou"},{"issue_id":"casg-4jq.3","depends_on_id":"casg-4jq.2","type":"blocks","created_at":"2026-01-12T04:11:25.186278895Z","created_by":"cyou"}]}
{"id":"casg-4jq.4","title":"T4: Implicit confirmation - hook_callback/can_use_tool during InitSent triggers Running","description":"## Implicit Confirmation During InitSent\n\nImplement the implicit confirmation rules that transition to RUNNING when CLI sends hook/permission requests before explicit init response.\n\n### Goal\nHandle edge case where CLI starts sending hooks before responding to initialize - proving it accepted the handshake.\n\n### Why This Matters\nSome CLI versions may start invoking hooks before sending an explicit success response. Receiving a `hook_callback` or `can_use_tool` request proves the CLI understood our initialization and registered our hooks.\n\n### TDD Approach\n1. **Skeleton**: Add detection logic in message handling\n2. **Failing tests**: Simulate hook_callback during InitSent\n3. **Implement**: Wire up implicit confirmation triggers\n\n### Implicit Confirmation Rules (from spec)\n\n**Subtypes that trigger RUNNING confirmation**:\n| Incoming Subtype | Triggers RUNNING? | Rationale |\n|------------------|-------------------|-----------|\n| `hook_callback` | **Yes** | CLI is invoking a registered hook |\n| `can_use_tool` | **Yes** | CLI is requesting permission |\n| `mcp_message` | **Yes** | CLI is routing MCP message |\n| Regular messages | **No** | CLI may emit output while ignoring init |\n\n**Why regular messages don't count**:\n- CLI may emit `system` or `assistant` messages before processing our initialize\n- Treating them as confirmation would cause false-positive RUNNING\n\n### Implementation Details\n\n**Detection in handle_info**:\n```gleam\ncase state.lifecycle, message {\n  InitSent, ControlRequest(HookCallback(_)) -\u003e \n    // Implicit confirmation - transition to Running, then process hook\n  InitSent, ControlRequest(CanUseTool(_)) -\u003e\n    // Implicit confirmation - transition to Running, then process permission\n  InitSent, RegularMessage(_) -\u003e\n    // DO NOT transition - just buffer or drop\n  ...\n}\n```\n\n**Processing after confirmation**:\n1. Transition to RUNNING\n2. Cancel init timeout timer (if still pending)\n3. Flush queued_ops (non-blocking)\n4. Process the triggering message normally\n\n### Files\n- `src/claude_agent_sdk/internal/bidir.gleam` - Implicit confirmation logic\n- `test/implicit_confirm_test.gleam` - Test various triggers\n\n### Acceptance Criteria\n- [ ] hook_callback during InitSent transitions to RUNNING\n- [ ] can_use_tool during InitSent transitions to RUNNING\n- [ ] mcp_message during InitSent transitions to RUNNING\n- [ ] Regular messages during InitSent do NOT transition\n- [ ] Init timeout canceled on implicit confirmation\n- [ ] Triggering message processed after transition\n- [ ] Unknown callback_id still transitions (with warning log)","notes":"Quality gate failed: Killed as deadlock victim (will retry after blocker completes)\nLog: /home/cyou/.claude/projects/-home-cyou-claude-agent-sdk-gleam/e5da4a0b-f1bc-4876-9381-e1a3d7bab65a.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:10:30.446432151Z","created_by":"cyou","updated_at":"2026-01-12T15:36:10.106950297Z","closed_at":"2026-01-12T15:36:10.106950297Z","close_reason":"Closed","labels":["needs-followup","protocol","tdd"],"dependencies":[{"issue_id":"casg-4jq.4","depends_on_id":"casg-4jq","type":"parent-child","created_at":"2026-01-12T04:10:30.44698623Z","created_by":"cyou"},{"issue_id":"casg-4jq.4","depends_on_id":"casg-4jq.3","type":"blocks","created_at":"2026-01-12T04:11:25.726556189Z","created_by":"cyou"},{"issue_id":"casg-4jq.4","depends_on_id":"casg-4jq.6","type":"blocks","created_at":"2026-01-12T15:26:23.301568431Z","created_by":"cyou"}]}
{"id":"casg-4jq.5","title":"T5: Message routing - dispatch control_request/response/regular to correct handlers","description":"## Message Routing by Type\n\nImplement correct routing for all message types in the GenServer's handle_info.\n\n### Goal\nEnsure each message type is handled correctly: control requests dispatched internally, responses correlated with pending requests, regular messages forwarded to subscriber.\n\n### TDD Approach\n1. **Skeleton**: Define routing dispatch table\n2. **Failing tests**: Send each message type, verify correct handler called\n3. **Implement**: Wire up routing logic\n\n### Message Types and Routing\n\n**Incoming message types**:\n| Message Type | Source | Route To |\n|--------------|--------|----------|\n| control_request (hook_callback) | CLI | Internal hook dispatcher |\n| control_request (can_use_tool) | CLI | Internal permission dispatcher |\n| control_request (mcp_message) | CLI | MCP handler |\n| control_response | CLI | Correlate with pending_requests |\n| Regular messages (system/assistant/user/result) | CLI | subscriber Subject |\n\n### Implementation Details\n\n**Routing in handle_info**:\n```gleam\nfn handle_info(message: PortMessage, state: SessionState) {\n  case decode_message(message.data) {\n    Ok(ControlRequest(HookCallback(..))) -\u003e handle_hook_callback(state, ..)\n    Ok(ControlRequest(CanUseTool(..))) -\u003e handle_permission_request(state, ..)\n    Ok(ControlRequest(McpMessage(..))) -\u003e handle_mcp_message(state, ..)\n    Ok(ControlResponse(response)) -\u003e correlate_response(state, response)\n    Ok(RegularMessage(msg)) -\u003e forward_to_subscriber(state, msg)\n    Error(decode_error) -\u003e log_and_continue(state)\n  }\n}\n```\n\n**Response correlation**:\n1. Extract request_id from response\n2. Look up in pending_requests map\n3. Cancel associated timer\n4. Validate response matches expected kind (e.g., InitializeOp expects capabilities)\n5. Send result to reply_to Subject\n6. Remove from pending_requests\n\n**Subscriber forwarding**:\n1. Wrap message in appropriate envelope\n2. Send to subscriber Subject\n3. Continue processing\n\n### Files\n- `src/claude_agent_sdk/internal/bidir.gleam` - Routing logic in handle_info\n- `test/message_routing_test.gleam` - Test each message type routes correctly\n\n### Acceptance Criteria\n- [ ] control_request (hook_callback) dispatched to hook handler\n- [ ] control_request (can_use_tool) dispatched to permission handler\n- [ ] control_request (mcp_message) dispatched to MCP handler\n- [ ] control_response correlated with pending_requests by request_id\n- [ ] Matched response cancels timer and resolves caller\n- [ ] Unmatched response logged and dropped\n- [ ] Regular messages forwarded to subscriber\n- [ ] Malformed messages logged and dropped (fail-safe)","notes":"Quality gate failed: Timeout after 60 minutes\nLog: /home/cyou/.claude/projects/-home-cyou-claude-agent-sdk-gleam/f8630471-1af8-454a-82f4-f264a41dca29.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:10:44.028749565Z","created_by":"cyou","updated_at":"2026-01-12T15:37:40.048415806Z","closed_at":"2026-01-12T15:37:40.048415806Z","close_reason":"Closed","labels":["needs-followup","routing","tdd"],"dependencies":[{"issue_id":"casg-4jq.5","depends_on_id":"casg-4jq","type":"parent-child","created_at":"2026-01-12T04:10:44.029423024Z","created_by":"cyou"},{"issue_id":"casg-4jq.5","depends_on_id":"casg-4jq.2","type":"blocks","created_at":"2026-01-12T04:11:26.24932653Z","created_by":"cyou"}]}
{"id":"casg-4jq.6","title":"T6: Backpressure limits - enforce max 16 queued, 64 pending_requests, 32 pending_hooks","description":"## Backpressure Limits\n\nImplement size limits on queued_ops, pending_requests, and pending_hooks to prevent unbounded memory growth.\n\n### Goal\nProtect against resource exhaustion from stuck operations, runaway loops, or misconfigured clients.\n\n### TDD Approach\n1. **Skeleton**: Add limit checks in add-to-map functions\n2. **Failing tests**: Fill each map to limit, verify next add fails\n3. **Implement**: Return appropriate errors on overflow\n\n### Limits (from spec)\n\n| Map | Max Size | On Overflow |\n|-----|----------|-------------|\n| `queued_ops` | 16 | Return `InitQueueOverflow` to caller |\n| `pending_requests` | 64 | Return `TooManyPendingRequests` to caller |\n| `pending_hooks` | 32 | Send immediate fail-open/deny response |\n\n**Rationale**:\n- `queued_ops` (16): During INIT_SENT, unlikely to have \u003e16 pending control calls\n- `pending_requests` (64): Accounts for init + 16 queued + normal concurrent ops\n- `pending_hooks` (32): CLI sends hooks sequentially; 32 allows burst during rapid tool use\n\n### Implementation Details\n\n**queued_ops overflow**:\n```gleam\nfn queue_operation(state, op) -\u003e Result(SessionState, SessionError) {\n  case list.length(state.queued_ops) \u003e= 16 {\n    True -\u003e Error(InitQueueOverflow(\"Too many control operations queued during initialization (max 16)\"))\n    False -\u003e Ok(SessionState(..state, queued_ops: [op, ..state.queued_ops]))\n  }\n}\n```\n\n**pending_requests overflow**:\n```gleam\nfn add_pending_request(state, request_id, pending) -\u003e Result(SessionState, SessionError) {\n  case map.size(state.pending_requests) \u003e= 64 {\n    True -\u003e Error(TooManyPendingRequests(\"Too many pending control requests (max 64)\"))\n    False -\u003e Ok(SessionState(..state, pending_requests: map.insert(state.pending_requests, request_id, pending)))\n  }\n}\n```\n\n**pending_hooks overflow** (different - fail-open/deny instead of error):\n```gleam\nfn add_pending_hook(state, callback_id, hook) -\u003e #(SessionState, Option(ImmediateResponse)) {\n  case map.size(state.pending_hooks) \u003e= 32 {\n    True -\u003e \n      // Log warning, send immediate response without spawning task\n      #(state, Some(fail_response_for(hook)))\n    False -\u003e \n      #(SessionState(..state, pending_hooks: map.insert(..)), None)\n  }\n}\n```\n\n### Files\n- `src/claude_agent_sdk/internal/bidir.gleam` - Limit checks in add functions\n- `test/backpressure_test.gleam` - Overflow handling tests\n\n### Acceptance Criteria\n- [ ] queued_ops rejects at 17th item with InitQueueOverflow\n- [ ] pending_requests rejects at 65th item with TooManyPendingRequests\n- [ ] pending_hooks at 33 sends fail-open response without spawning\n- [ ] Error messages include max limit for debugging\n- [ ] Existing items not affected by overflow rejection\n- [ ] Test verifies exact limit (16, 64, 32)","notes":"Quality gate failed: Timeout after 60 minutes\nLog: /home/cyou/.claude/projects/-home-cyou-claude-agent-sdk-gleam/cab61b9b-1ac5-49df-b2c1-ba3258fbcce7.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:11:01.312068688Z","created_by":"cyou","updated_at":"2026-01-12T15:35:16.520445935Z","closed_at":"2026-01-12T15:35:16.520445935Z","close_reason":"Closed","labels":["needs-followup","safety","tdd"],"dependencies":[{"issue_id":"casg-4jq.6","depends_on_id":"casg-4jq","type":"parent-child","created_at":"2026-01-12T04:11:01.312674457Z","created_by":"cyou"},{"issue_id":"casg-4jq.6","depends_on_id":"casg-4jq.2","type":"blocks","created_at":"2026-01-12T04:11:26.749439689Z","created_by":"cyou"}]}
{"id":"casg-4jq.7","title":"T7: Session termination cleanup - cancel timers, resolve pending, close runner","description":"## Session Termination Cleanup\n\nImplement proper cleanup when session stops: cancel timers, resolve pending requests, close runner.\n\n### Goal\nEnsure clean shutdown with no resource leaks, orphaned timers, or stuck callers.\n\n### TDD Approach\n1. **Skeleton**: Define terminate/cleanup function\n2. **Failing tests**: Start session, queue operations, stop, verify cleanup\n3. **Implement**: Wire up cleanup sequence\n\n### Cleanup Requirements\n\n**On session stop (normal or error)**:\n1. Cancel all pending request timers\n2. Cancel all pending hook timers  \n3. Resolve all pending_requests with SessionStopped error\n4. Resolve all queued_ops with SessionStopped error\n5. Clear all state maps\n6. Close runner (terminates CLI process)\n7. Notify subscriber of session end\n\n### Implementation Details\n\n**Cleanup sequence** (from spec termination handler):\n```gleam\nfn cleanup_session(state: SessionState, reason: StopReason) -\u003e Nil {\n  // 1. Cancel all timers\n  map.fold(state.pending_requests, Nil, fn(_, _, pending) {\n    timer.cancel(pending.timer_ref)\n    Nil\n  })\n  map.fold(state.pending_hooks, Nil, fn(_, _, hook) {\n    timer.cancel(hook.timer_ref)\n    Nil\n  })\n  \n  // 2. Resolve pending callers with error\n  let error = SessionStopped(reason)\n  map.fold(state.pending_requests, Nil, fn(_, _, pending) {\n    actor.send(pending.reply_to, Error(error))\n    Nil\n  })\n  \n  // 3. Resolve queued ops with error\n  list.each(state.queued_ops, fn(op) {\n    actor.send(op.reply_to, Error(error))\n  })\n  \n  // 4. Close runner\n  runner.close(state.runner)\n  \n  // 5. Notify subscriber\n  actor.send(state.subscriber, SessionEnded(reason))\n}\n```\n\n**Invariants after cleanup**:\n- No timers running (verified by monitor)\n- No Subjects awaiting response\n- Runner process terminated\n- Port closed\n\n**Stop reasons**:\n```gleam\npub type StopReason {\n  UserRequested         // stop() called\n  CliExited(code: Int)  // Port closed with exit code\n  InitFailed(SessionError)  // Failed during initialization\n}\n```\n\n### Files\n- `src/claude_agent_sdk/internal/bidir.gleam` - Cleanup in terminate handler\n- `test/termination_test.gleam` - Verify cleanup invariants\n\n### Acceptance Criteria\n- [ ] All pending_request timers canceled\n- [ ] All pending_hook timers canceled\n- [ ] All pending_requests resolved with SessionStopped\n- [ ] All queued_ops resolved with SessionStopped  \n- [ ] Runner closed (CLI process terminated)\n- [ ] Subscriber notified with SessionEnded\n- [ ] No lingering processes or timers (verified by test)\n- [ ] Works for both normal stop() and error cleanup","notes":"Quality gate failed: Timeout after 60 minutes\nLog: /home/cyou/.claude/projects/-home-cyou-claude-agent-sdk-gleam/5565a017-8d73-413a-b79a-63b68dd2334b.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:11:16.707576105Z","created_by":"cyou","updated_at":"2026-01-12T15:33:00.084363562Z","closed_at":"2026-01-12T15:33:00.084363562Z","close_reason":"Closed","labels":["cleanup","needs-followup","tdd"],"dependencies":[{"issue_id":"casg-4jq.7","depends_on_id":"casg-4jq","type":"parent-child","created_at":"2026-01-12T04:11:16.708255173Z","created_by":"cyou"},{"issue_id":"casg-4jq.7","depends_on_id":"casg-4jq.2","type":"blocks","created_at":"2026-01-12T04:11:27.242433188Z","created_by":"cyou"}]}
{"id":"casg-4jq.8","title":"[Review] 1 non-blocking finding from casg-4jq.2","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-4jq.2\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] SessionLifecycle.Failed type mismatch with spec (String vs SessionError)\n\n**Priority:** P2\n**Reviewer:** gemini\n**Location:** src/claude_agent_sdk/internal/bidir.gleam:118-119\n\nTask spec defines `SessionLifecycle.Failed(reason: SessionError)` with specific variants (`InitializationError`, `InitializationTimeout`, etc.). Implementation uses `Failed(String)` with hardcoded strings (e.g., \"initialization timeout\"), which prevents programmatic error handling and deviates from the spec.\n\n---\n\n\u003c!-- fp:e5ca8fabf3663eb5 --\u003e\n\u003c!-- review_finding:a25a4e352630 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T06:25:01.765524704Z","created_by":"cyou","updated_at":"2026-01-12T06:30:47.534294627Z","closed_at":"2026-01-12T06:30:47.534294627Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-4jq.2"],"dependencies":[{"issue_id":"casg-4jq.8","depends_on_id":"casg-4jq","type":"parent-child","created_at":"2026-01-12T06:25:01.766106316Z","created_by":"cyou"}]}
{"id":"casg-4re","title":"Epic: Bidirectional Protocol - Foundation \u0026 FFI","description":"## Overview\nAdd gleam_otp dependency and extend FFI for bidirectional port IO. This is the highest-risk foundational layer.\n\n## Source Plan\n`plans/2026-01-12-bidir-protocol-plan.md`\n\n## Key Deliverables\n- Add `gleam_otp` to gleam.toml\n- Extend `claude_agent_sdk_ffi.erl` with port_write/2\n- Extend `internal/port_ffi.gleam` with write binding\n- Verify OTP 25+ for stderr_to_stdout\n\n## Risk\nHighest - if FFI/deps don't work, nothing else does\n\n## Files\n- gleam.toml (Exists)\n- src/claude_agent_sdk_ffi.erl (Exists)\n- src/claude_agent_sdk/internal/port_ffi.gleam (Exists)","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-12T04:06:16.736260809Z","created_by":"cyou","updated_at":"2026-01-12T04:58:33.622152282Z","closed_at":"2026-01-12T04:58:33.622152282Z","close_reason":"Closed"}
{"id":"casg-4re.1","title":"[T001] Add gleam_otp dependency [integration-path-test]","description":"## Summary\nAdd the gleam_otp dependency to enable OTP actor support for bidirectional sessions.\nThis is the integration-path test for Epic 1: Foundation \u0026 FFI.\n\n## TDD Approach\n\n### Phase 1: Skeleton + Failing Test\n1. Create test file `test/otp_import_test.gleam`\n2. Write test that imports `gleam/otp/actor` and calls basic function\n3. Test should fail because gleam_otp is not yet in dependencies\n\n### Phase 2: Implementation\n1. Update `gleam.toml` to add `gleam_otp` dependency (version TBD, compatible with gleam_erlang 1.3.0)\n2. Run `gleam deps download` to fetch dependency\n3. Run test to verify import works\n\n## Acceptance Criteria\n- [ ] `gleam.toml` includes `gleam_otp` dependency\n- [ ] Test file imports `gleam/otp/actor` successfully\n- [ ] Test compiles and passes with `gleam test`\n- [ ] No changes to existing tests\n\n## Files\n- `gleam.toml` - add dependency\n- `test/otp_import_test.gleam` - integration test for OTP import\n\n## Notes\n- Use latest stable gleam_otp version\n- This is a minimal task to unblock downstream work\n- Integration-path test pattern: validate dependency works before building on it","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:09:43.407137911Z","created_by":"cyou","updated_at":"2026-01-12T04:43:29.301404859Z","closed_at":"2026-01-12T04:43:29.301404859Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-4re.1","depends_on_id":"casg-4re","type":"parent-child","created_at":"2026-01-12T04:09:43.40791648Z","created_by":"cyou"}]}
{"id":"casg-4re.2","title":"[T002] Extend FFI with port_write for bidirectional IO","description":"## Summary\nAdd `port_write/2` function to FFI layer to enable writing to CLI stdin for bidirectional protocol.\nCurrently the FFI only supports reading from ports (receive_port_msg_blocking/timeout).\nBidirectional mode requires writing control messages to the CLI process.\n\n## TDD Approach\n\n### Phase 1: Skeleton + Failing Test\n1. Create test file `test/port_ffi_test.gleam`\n2. Write test that spawns a simple echo process and calls port_write\n3. Test should fail because port_write function doesn't exist yet\n\n### Phase 2: Implementation\n1. Add `port_write/2` to `src/claude_agent_sdk_ffi.erl`:\n   - Function signature: `port_write(Port, Data) -\u003e ok | error`\n   - Use `erlang:port_command(Port, Data)` internally\n   - Handle badarg exception for closed ports\n   - Return ok/error tagged tuple for Gleam Result type\n\n2. Add Gleam binding in `src/claude_agent_sdk/internal/port_ffi.gleam`:\n   - Create new file for port FFI bindings\n   - External function: `pub fn port_write(port, data) -\u003e Result(Nil, WriteError)`\n   - Type definitions for Port and WriteError\n\n3. Update test to verify:\n   - Write to valid port returns Ok(Nil)\n   - Write to closed port returns Error(PortClosed)\n\n## Acceptance Criteria\n- [ ] `port_write/2` exported from claude_agent_sdk_ffi.erl\n- [ ] Gleam binding in internal/port_ffi.gleam\n- [ ] Unit test for successful write\n- [ ] Unit test for write to closed port (error case)\n- [ ] All existing tests still pass\n\n## Files\n- `src/claude_agent_sdk_ffi.erl` - add port_write/2 function\n- `src/claude_agent_sdk/internal/port_ffi.gleam` - new file for port FFI bindings\n- `test/port_ffi_test.gleam` - unit tests for port_write\n\n## Technical Notes\n- Use `port_command/2` not `port_command/3` (no options needed)\n- Binary data expected (Gleam BitArray/String)\n- Consider: should we use nif-like error handling or exceptions?\n- Reference existing open_port/3 pattern for error handling\n\n## Wire Protocol Context\nBidirectional mode sends NDJSON lines to CLI stdin:\n\\`\\`\\`json\n{\"type\":\"control_request\",\"request\":{\"subtype\":\"initialize\",...}}\\n\n\\`\\`\\`","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:09:58.187891634Z","created_by":"cyou","updated_at":"2026-01-12T04:47:59.255231763Z","closed_at":"2026-01-12T04:47:59.255231763Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-4re.2","depends_on_id":"casg-4re","type":"parent-child","created_at":"2026-01-12T04:09:58.188447954Z","created_by":"cyou"},{"issue_id":"casg-4re.2","depends_on_id":"casg-4re.1","type":"blocks","created_at":"2026-01-12T04:10:17.654656013Z","created_by":"cyou"}]}
{"id":"casg-4re.3","title":"[T003] Add OTP version check for stderr_to_stdout support","description":"## Summary\nAdd OTP version detection to check for `stderr_to_stdout` port option support.\nThe `stderr_to_stdout` option is required for proper bidirectional IO (CLI writes stderr for logs)\nbut is only available in OTP 25+. We need to detect the OTP version and either:\n- Use stderr_to_stdout when OTP \u003e= 25\n- Log a warning and document fallback for OTP \u003c 25\n\n## TDD Approach\n\n### Phase 1: Skeleton + Failing Test\n1. Create test `test/otp_version_test.gleam`\n2. Write test that calls `get_otp_version()` and checks format\n3. Test should fail because function doesn't exist\n\n### Phase 2: Implementation\n1. Add `otp_version/0` to `src/claude_agent_sdk_ffi.erl`:\n   - Use `erlang:system_info(otp_release)` to get major version\n   - Return as integer (e.g., 25, 26, 27)\n\n2. Add `check_stderr_support/0` to Erlang FFI:\n   - Returns `{supported, true/false}` tuple\n   - OTP \u003e= 25 returns supported=true\n\n3. Add Gleam bindings in `src/claude_agent_sdk/internal/port_ffi.gleam`:\n   - `pub fn get_otp_version() -\u003e Int`\n   - `pub fn supports_stderr_to_stdout() -\u003e Bool`\n\n4. Add documentation for fallback approach in module doc\n\n## Acceptance Criteria\n- [ ] `otp_version/0` returns OTP major version as integer\n- [ ] `check_stderr_support/0` correctly detects OTP \u003e= 25\n- [ ] Gleam bindings type-safe and documented\n- [ ] Module docs explain fallback for OTP \u003c 25\n- [ ] Tests pass on current OTP version\n\n## Files\n- `src/claude_agent_sdk_ffi.erl` - add otp_version/0, check_stderr_support/0\n- `src/claude_agent_sdk/internal/port_ffi.gleam` - add Gleam bindings\n- `test/otp_version_test.gleam` - version detection tests\n\n## Technical Notes\n- `erlang:system_info(otp_release)` returns string like \"27\"\n- Need to parse to integer for comparison\n- stderr_to_stdout option: `{stderr_to_stdout, true}` in open_port options\n- Fallback for OTP \u003c 25: CLI stderr goes to terminal, not captured\n  - This is acceptable for MVP (logs visible to user, not SDK)\n  - Document in user-facing docs that OTP 25+ recommended\n\n## OTP Compatibility Matrix\n| OTP Version | stderr_to_stdout | Notes |\n|-------------|------------------|-------|\n| 27          | Yes              | Current recommended |\n| 26          | Yes              | Supported |\n| 25          | Yes              | Minimum for feature |\n| 24          | No               | Works, no stderr capture |\n| \u003c 24        | No               | Not tested |","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:10:12.743617167Z","created_by":"cyou","updated_at":"2026-01-12T04:51:26.400655734Z","closed_at":"2026-01-12T04:51:26.400655734Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-4re.3","depends_on_id":"casg-4re","type":"parent-child","created_at":"2026-01-12T04:10:12.744489306Z","created_by":"cyou"},{"issue_id":"casg-4re.3","depends_on_id":"casg-4re.2","type":"blocks","created_at":"2026-01-12T04:10:18.171184207Z","created_by":"cyou"}]}
{"id":"casg-4re.4","title":"[Review] 1 non-blocking finding from casg-4re.2","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-4re.2\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Decode full port_write tuple, not just tag\n\n**Priority:** P2\n**Reviewer:** codex\n**Location:** src/claude_agent_sdk/internal/port_ffi.gleam:94-111\n\n`claude_agent_sdk_ffi:port_write/2` returns a 2-tuple `{\u003c\u003c\"ok\"\u003e\u003e, nil}` or `{\u003c\u003c\"error\"\u003e\u003e, \u003c\u003c\"port_closed\"\u003e\u003e}`. However, the Gleam decoder in `port_write` only decodes field 0 (tag) and ignores field 1 entirely.\n\nConcrete failure path: if the Erlang side returns a malformed tuple like `{\u003c\u003c\"ok\"\u003e\u003e, \u003c\u003c\"unexpected\"\u003e\u003e}` (or `{\u003c\u003c\"error\"\u003e\u003e, \u003c\u003c\"some_other_reason\"\u003e\u003e}`), the Gleam code will still treat it as `Ok(Nil)` for the first case (or always `Error(PortClosed)` for the second), silently discarding the payload and losing the ability to distinguish/validate reasons. This makes debugging and future extension (more error reasons) error-prone.\n\nSuggested fix: decode both fields and pattern-match tags + expected payload shapes, similar to `ffi_open_port_safe`’s tuple decoding.\n\n```gleam\nuse tag \u003c- decode.field(0, decode.string)\nuse payload \u003c- decode.field(1, decode.dynamic)\n```\n\n\n---\n\n\u003c!-- fp:dab488369601f5a2 --\u003e\n\u003c!-- review_finding:22b79f00031c --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:47:59.466947002Z","created_by":"cyou","updated_at":"2026-01-12T04:52:46.413385333Z","closed_at":"2026-01-12T04:52:46.413385333Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-4re.2"],"dependencies":[{"issue_id":"casg-4re.4","depends_on_id":"casg-4re","type":"parent-child","created_at":"2026-01-12T04:47:59.467478779Z","created_by":"cyou"}]}
{"id":"casg-4re.5","title":"[Review] 1 non-blocking finding from casg-4re.3","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-4re.3\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Make otp_release parsing robust to non-integer values\n\n**Priority:** P2\n**Reviewer:** codex\n**Location:** src/claude_agent_sdk_ffi.erl:160-164\n\n`otp_version/0` assumes `erlang:system_info(otp_release)` is always a string like \"27\" and calls `list_to_integer/1` unconditionally.\n\nOn some runtimes (e.g., non-standard builds, future formats, or unexpected values), `list_to_integer(Release)` will raise `badarg`, which would crash any call to `get_otp_version()` and therefore also crash capability checks.\n\nConcrete failure path: if `otp_release` returns something non-numeric (e.g. includes a suffix), `list_to_integer/1` throws and the Gleam external `get_otp_version()` has no way to handle it.\n\nSuggested fix: use `string:to_integer/1` (or `list_to_integer` guarded by a regex/digit check) and return a safe default / `{error, Reason}` shape that Gleam can decode, similar to the existing \"safe\" FFI patterns in this repo.\n\n---\n\n\u003c!-- fp:38962dbede62f1ee --\u003e\n\u003c!-- review_finding:1d1250d9e3c3 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:51:26.617869485Z","created_by":"cyou","updated_at":"2026-01-12T04:56:53.80568383Z","closed_at":"2026-01-12T04:56:53.80568383Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-4re.3"],"dependencies":[{"issue_id":"casg-4re.5","depends_on_id":"casg-4re","type":"parent-child","created_at":"2026-01-12T04:51:26.618557161Z","created_by":"cyou"}]}
{"id":"casg-4re.6","title":"[Review] 1 non-blocking finding from casg-4re.5","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-4re.5\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Reject otp_release values with non-empty suffix\n\n**Priority:** P2\n**Reviewer:** codex\n**Location:** src/claude_agent_sdk_ffi.erl:163-171\n\n`otp_version/0` accepts any `{Version, _Rest}` from `string:to_integer/1` as OK, even when `_Rest` is non-empty. That means a release like `\"27-rc1\"` (or any leading-integer string) will be treated as OTP 27, enabling capability checks (e.g., `check_stderr_support/0`) based on a value that the comments say should be treated as non-standard/invalid.\n\nConcrete failure path: when `erlang:system_info(otp_release)` returns a string with a numeric prefix and suffix, this code returns `{\u003c\u003c\"ok\"\u003e\u003e, Version}` and `check_stderr_support/0` may report support based on that parsed prefix.\n\nIf the intent is to be strict, require `_Rest == []` before returning ok.\n\n```erlang\n{Version, Rest} when is_integer(Version), Rest =:= [] -\u003e ...\n```\n\n---\n\n\u003c!-- fp:57cb078e7f9c8007 --\u003e\n\u003c!-- review_finding:85700911ae5e --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:58:33.7547822Z","created_by":"cyou","updated_at":"2026-01-12T05:08:36.173898356Z","closed_at":"2026-01-12T05:08:36.173898356Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-4re.5"],"dependencies":[{"issue_id":"casg-4re.6","depends_on_id":"casg-4re","type":"parent-child","created_at":"2026-01-12T04:58:33.755707644Z","created_by":"cyou"}]}
{"id":"casg-5ar","title":"[P2] Ensure queued requests get a reply when flushed","description":"## Review Finding\n\n**Priority:** P2\n**Trigger:** run_end\n**Baseline:** 6b1bc9c..548f92b\n**Location:** src/claude_agent_sdk/internal/bidir.gleam:762-766\n\n---\n\n`QueuedOperation.QueuedRequest` now carries `reply_to`, and `cleanup_session/2` correctly sends `RequestSessionStopped` for queued ops. However, `flush_queued_ops/1` still just clears the queue without sending anything.\n\nConcrete failure path: if the session reaches init success (and calls `flush_queued_ops(new_state)`), any queued `QueuedRequest(..., reply_to)` entries will be dropped with no response sent to callers, causing indefinite waits/timeouts.\n\n```gleam\nfn flush_queued_ops(state: SessionState) -\u003e SessionState {\n  SessionState(..state, queued_ops: [])\n}\n```\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T07:42:41.957815834Z","created_by":"cyou","updated_at":"2026-01-12T15:37:37.172091949Z","closed_at":"2026-01-12T15:37:37.172091949Z","close_reason":"Closed","labels":["auto_generated","cumulative-review","fp:19f744cbc73be77c","review_finding","trigger:run_end"]}
{"id":"casg-5eh","title":"[Review] 2 non-blocking findings from casg-xjv.13","description":"## Review Findings\n\nThis issue consolidates 2 non-blocking findings from code review.\n\n**Source issue:** casg-xjv.13\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Test job runs unnecessarily on schedule and manual triggers\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** .github/workflows/test.yml:4-12\n\nThe `workflow_dispatch` and `schedule` triggers are added at the top-level `on:` section, causing the regular `test` job to run on weekly schedules and manual dispatches. Since the `test` job has no `if:` condition, it will execute for all events including `schedule` and `workflow_dispatch`, which are intended only for E2E tests.\n\n**Impact**: Unnecessary CI resource usage when triggering weekly runs or manual workflows.\n\n**Fix**: Move the opt-in triggers to job-level or add an `if:` condition to the `test` job to exclude schedule/workflow_dispatch events:\n\n```yaml\ntest:\n  runs-on: ubuntu-latest\n  if: github.event_name != 'schedule' \u0026\u0026 github.event_name != 'workflow_dispatch'\n```\n\nOr restructure to have separate workflows for unit tests and E2E tests.\n\n---\n\n### Finding 2: [P2] Missing explicit Node.js setup for npm install\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** .github/workflows/test.yml:57-59\n\nThe workflow uses `npm install -g @anthropic-ai/claude-code` without explicitly setting up Node.js via `actions/setup-node`. While Ubuntu runners currently include Node.js pre-installed, this creates an implicit dependency on runner image configuration.\n\n**Impact**: Fragile dependency on runner defaults. If GitHub changes the ubuntu-latest image or Node.js is not available, the workflow will fail without clear error messaging.\n\n**Fix**: Add explicit Node.js setup before the npm install step:\n\n```yaml\n- uses: actions/setup-node@v4\n  with:\n    node-version: '20'\n- name: Install Claude CLI\n  if: steps.prereq.outputs.skip != 'true'\n  run: npm install -g @anthropic-ai/claude-code\n```\n\nThis makes dependencies explicit and improves workflow maintainability.\n\n---\n\n\u003c!-- fp:e0d201492950a89c --\u003e\n\u003c!-- fp:73948eff37f7b5a5 --\u003e\n\u003c!-- review_finding:a933582a6467 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T05:07:43.791799556Z","created_by":"cyou","updated_at":"2026-01-11T05:08:53.798548015Z","closed_at":"2026-01-11T05:08:53.798548015Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-xjv.13"]}
{"id":"casg-74o","title":"[Review] 1 non-blocking finding from casg-1ku","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-1ku\n**Highest priority:** P3\n\n---\n\n### Finding 1: [P3] Redundant port cleanup in pending warnings tests\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** test/stream_test.gleam:1664-1665\n\nThe new tests `new_with_warnings_yields_warnings_first_test` and `new_with_warnings_multiple_warnings_test` call both `close(stream)` and `port_ffi.ffi_close_port(port)` during cleanup (e.g., lines 1664-1665).\n\nSince `close(stream)` already closes the underlying port via `mark_closed()` → `ffi_close_port()`, the direct call to `ffi_close_port(port)` is redundant.\n\n**Why this is minor:** Port closing is likely idempotent, so this doesn't cause functional issues, just unnecessary cleanup code.\n\n**How to fix:** Remove the direct `port_ffi.ffi_close_port(port)` calls and rely solely on `close(stream)`, or follow the pattern used in other tests which only call `ffi_close_port()` when the stream wasn't explicitly closed.\n\n---\n\n\u003c!-- fp:99440127aff7705b --\u003e\n\u003c!-- review_finding:f6dc34cd6021 --\u003e","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-11T06:07:34.799174211Z","created_by":"cyou","updated_at":"2026-01-11T06:09:58.951274729Z","closed_at":"2026-01-11T06:09:58.951274729Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-1ku"]}
{"id":"casg-7l4","title":"Epic: Bidirectional Protocol - Public API \u0026 Options","description":"## Overview\nExpose public API (start_session, messages, events) and extend options with hook/permission/mcp builders.\n\n## Source Plan\n`plans/2026-01-12-bidir-protocol-plan.md` - \"Public API\" and \"Options Builder Extensions\" sections\n\n## Key Deliverables\n- claude_agent_sdk.gleam: start_session(), messages(), events(), interrupt(), set_model(), etc.\n- options.gleam: with_pre_tool_use, with_can_use_tool, with_mcp_server, etc.\n- Session type (opaque handle to GenServer)\n- SessionEvent type for events() Subject\n- Version detection and error handling\n\n## Public API\n\\`\\`\\`gleam\npub fn start_session(prompt, options) -\u003e Result(Session, StartError)\npub fn messages(session) -\u003e Subject(Message)\npub fn events(session) -\u003e Subject(SessionEvent)\npub fn interrupt(session) -\u003e Result(Nil, ControlError)\npub fn set_permission_mode(session, mode) -\u003e Result(Nil, ControlError)\npub fn set_model(session, model) -\u003e Result(Nil, ControlError)\npub fn rewind_files(session, user_message_id) -\u003e Result(Nil, ControlError)\npub fn stop(session) -\u003e Result(Nil, StopError)\n\\`\\`\\`\n\n## Options Builders\n- with_pre_tool_use(callback)\n- with_post_tool_use(callback)\n- with_user_prompt_submit(callback)\n- with_stop(callback)\n- with_subagent_stop(callback)\n- with_pre_compact(callback)\n- with_can_use_tool(callback)\n- with_mcp_server(name, handler)\n- with_file_checkpointing()\n- with_timeout(timeout_ms)\n- with_hook_timeout(event, timeout_ms)\n- with_bidir_runner_factory(factory) [testing]\n\n## TDD Focus\n- start_session integrates with GenServer\n- Options builders compose correctly\n- query() ignores bidir options with warning\n- Version detection flow\n\n## Files\n- src/claude_agent_sdk.gleam (Exists - extend)\n- src/claude_agent_sdk/options.gleam (Exists - extend)\n- src/claude_agent_sdk/internal/cli.gleam (Exists - add --input-format)\n- test/api_test.gleam (New)\n- test/options_test.gleam (New)","status":"open","priority":2,"issue_type":"epic","created_at":"2026-01-12T04:07:31.659432531Z","created_by":"cyou","updated_at":"2026-01-12T04:07:31.659432531Z","dependencies":[{"issue_id":"casg-7l4","depends_on_id":"casg-red","type":"blocks","created_at":"2026-01-12T04:07:43.978449634Z","created_by":"cyou"},{"issue_id":"casg-7l4","depends_on_id":"casg-lqg","type":"blocks","created_at":"2026-01-12T04:07:44.041244592Z","created_by":"cyou"}]}
{"id":"casg-7l4.1","title":"Session type and start_session skeleton","description":"## Summary\nAdd Session opaque type and start_session() stub to claude_agent_sdk.gleam. This is the foundation for bidirectional mode - start_session() will eventually spawn a GenServer actor that manages the CLI process.\n\n## TDD Approach\n\n### Phase 1: Skeleton + Failing Test\n1. Add Session opaque type to claude_agent_sdk.gleam\n2. Add start_session(prompt, options) -\u003e Result(Session, StartError) stub that returns Error(NotImplemented)\n3. Add StartError type with Timeout and NotImplemented variants\n4. Write failing integration test that calls start_session and expects Ok(Session)\n\n### Phase 2: Implementation (separate task)\n- Actual GenServer spawning will be implemented in Epic 8\n\n## Files to Create/Modify\n\n| File | Action | Description |\n|------|--------|-------------|\n| src/claude_agent_sdk.gleam | Modify | Add Session type alias, start_session fn, StartError type |\n| src/claude_agent_sdk/session.gleam | Create | Session opaque type definition |\n| src/claude_agent_sdk/error.gleam | Modify | Add StartError type |\n| test/start_session_test.gleam | Create | Failing integration test for start_session |\n\n## Acceptance Criteria\n- [ ] Session opaque type exists and is re-exported from main module\n- [ ] start_session(prompt, options) compiles and returns Result(Session, StartError)\n- [ ] StartError has Timeout and NotImplemented variants\n- [ ] Test file exists with test that fails because start_session returns NotImplemented\n- [ ] gleam build succeeds\n- [ ] gleam test runs (test fails as expected)\n\n## API Signature\n```gleam\n/// Opaque session handle for bidirectional mode\npub opaque type Session {\n  Session(subject: Subject(SessionMessage))\n}\n\n/// Start a bidirectional session with Claude CLI.\n/// Blocks up to 10s waiting for CLI initialization; returns Timeout on expiry.\npub fn start_session(\n  prompt: String,\n  options: QueryOptions,\n) -\u003e Result(Session, StartError)\n\npub type StartError {\n  Timeout\n  SpawnFailed(reason: String)\n  NotImplemented  // Temporary during TDD\n}\n```","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-12T04:10:47.938284303Z","created_by":"cyou","updated_at":"2026-01-12T04:10:47.938284303Z","labels":["integration-path-test","size:S","tdd"],"dependencies":[{"issue_id":"casg-7l4.1","depends_on_id":"casg-7l4","type":"parent-child","created_at":"2026-01-12T04:10:47.939058492Z","created_by":"cyou"}]}
{"id":"casg-7l4.2","title":"Hook options builders","description":"## Summary\nAdd hook callback option builders to options.gleam for PreToolUse, PostToolUse, UserPromptSubmit, Stop, SubagentStop, and PreCompact. These builders store callbacks in QueryOptions for later use by the GenServer.\n\n## TDD Approach\n\n### Phase 1: Skeleton + Failing Test\n1. Add hook callback fields to QueryOptions record\n2. Add with_pre_tool_use, with_post_tool_use, with_user_prompt_submit builders\n3. Add with_stop, with_subagent_stop, with_pre_compact builders\n4. Add placeholder hook context and result types\n5. Write tests verifying builders compose correctly\n\n### Phase 2: Implementation\n- Builders should store callbacks in QueryOptions\n- Types can be placeholders initially (refined in hook dispatch epic)\n\n## Files to Create/Modify\n\n| File | Action | Description |\n|------|--------|-------------|\n| src/claude_agent_sdk/options.gleam | Modify | Add hook callback fields and builder functions |\n| src/claude_agent_sdk/hook.gleam | Create | Hook context types (PreToolUseContext, etc.) and HookResult |\n| test/hook_options_test.gleam | Create | Tests for hook option builders |\n\n## Acceptance Criteria\n- [ ] QueryOptions has fields for all 6 hook callbacks\n- [ ] Each with_* builder sets the corresponding callback\n- [ ] Builders chain correctly (pipeline composition)\n- [ ] Hook context types exist (can be placeholders)\n- [ ] HookResult type exists\n- [ ] Tests verify builder composition\n- [ ] Re-export builders from main module\n\n## API Signatures\n```gleam\n// options.gleam additions\npub fn with_pre_tool_use(\n  options: QueryOptions,\n  callback: fn(PreToolUseContext) -\u003e HookResult,\n) -\u003e QueryOptions\n\npub fn with_post_tool_use(\n  options: QueryOptions,\n  callback: fn(PostToolUseContext) -\u003e HookResult,\n) -\u003e QueryOptions\n\npub fn with_user_prompt_submit(\n  options: QueryOptions,\n  callback: fn(UserPromptSubmitContext) -\u003e HookResult,\n) -\u003e QueryOptions\n\npub fn with_stop(\n  options: QueryOptions,\n  callback: fn(StopContext) -\u003e HookResult,\n) -\u003e QueryOptions\n\npub fn with_subagent_stop(\n  options: QueryOptions,\n  callback: fn(SubagentStopContext) -\u003e HookResult,\n) -\u003e QueryOptions\n\npub fn with_pre_compact(\n  options: QueryOptions,\n  callback: fn(PreCompactContext) -\u003e HookResult,\n) -\u003e QueryOptions\n```\n\n```gleam\n// hook.gleam\npub type HookResult {\n  Continue\n  Block(reason: String)\n}\n\npub type PreToolUseContext { PreToolUseContext(tool_name: String, tool_input: Dynamic) }\npub type PostToolUseContext { PostToolUseContext(tool_name: String, output: String) }\npub type UserPromptSubmitContext { UserPromptSubmitContext(prompt: String) }\npub type StopContext { StopContext(reason: String) }\npub type SubagentStopContext { SubagentStopContext(agent_id: String) }\npub type PreCompactContext { PreCompactContext(message_count: Int) }\n```","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-12T04:11:01.624087919Z","created_by":"cyou","updated_at":"2026-01-12T04:11:01.624087919Z","labels":["size:S","tdd"],"dependencies":[{"issue_id":"casg-7l4.2","depends_on_id":"casg-7l4","type":"parent-child","created_at":"2026-01-12T04:11:01.624760987Z","created_by":"cyou"},{"issue_id":"casg-7l4.2","depends_on_id":"casg-7l4.1","type":"blocks","created_at":"2026-01-12T04:12:19.76860814Z","created_by":"cyou"}]}
{"id":"casg-7l4.3","title":"Permission and MCP options builders","description":"## Summary\nAdd permission callback (can_use_tool) and MCP server handler options to options.gleam. Also add file checkpointing enablement option for rewind_files support.\n\n## TDD Approach\n\n### Phase 1: Skeleton + Failing Test\n1. Add can_use_tool callback field to QueryOptions\n2. Add mcp_servers field (list of name+handler pairs) to QueryOptions\n3. Add file_checkpointing_enabled field to QueryOptions\n4. Add with_can_use_tool, with_mcp_server, with_file_checkpointing builders\n5. Add CanUseToolContext and PermissionResult types\n6. Write tests verifying options store callbacks correctly\n\n### Phase 2: Implementation\n- Builders store callbacks/config in QueryOptions\n- Types can be placeholders initially\n\n## Files to Create/Modify\n\n| File | Action | Description |\n|------|--------|-------------|\n| src/claude_agent_sdk/options.gleam | Modify | Add permission/MCP fields and builders |\n| src/claude_agent_sdk/permission.gleam | Create | CanUseToolContext and PermissionResult types |\n| test/permission_options_test.gleam | Create | Tests for permission/MCP option builders |\n\n## Acceptance Criteria\n- [ ] QueryOptions has can_use_tool callback field\n- [ ] QueryOptions has mcp_servers list field\n- [ ] QueryOptions has file_checkpointing_enabled bool field\n- [ ] with_can_use_tool sets the permission callback\n- [ ] with_mcp_server adds to the mcp_servers list (accumulates)\n- [ ] with_file_checkpointing sets the flag to True\n- [ ] CanUseToolContext includes tool_name, tool_input, permission_suggestions, blocked_path\n- [ ] PermissionResult has Allow and Deny variants\n- [ ] Tests verify all builders work correctly\n- [ ] Re-export builders from main module\n\n## API Signatures\n```gleam\n// options.gleam additions\npub fn with_can_use_tool(\n  options: QueryOptions,\n  callback: fn(CanUseToolContext) -\u003e PermissionResult,\n) -\u003e QueryOptions\n\npub fn with_mcp_server(\n  options: QueryOptions,\n  name: String,\n  handler: fn(Dynamic) -\u003e Dynamic,\n) -\u003e QueryOptions\n\npub fn with_file_checkpointing(options: QueryOptions) -\u003e QueryOptions\n```\n\n```gleam\n// permission.gleam\npub type CanUseToolContext {\n  CanUseToolContext(\n    tool_name: String,\n    tool_input: Dynamic,\n    permission_suggestions: List(String),\n    blocked_path: Option(String),\n  )\n}\n\npub type PermissionResult {\n  Allow\n  Deny(reason: String)\n}\n```","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-12T04:11:12.846421904Z","created_by":"cyou","updated_at":"2026-01-12T04:11:12.846421904Z","labels":["size:S","tdd"],"dependencies":[{"issue_id":"casg-7l4.3","depends_on_id":"casg-7l4","type":"parent-child","created_at":"2026-01-12T04:11:12.847078143Z","created_by":"cyou"},{"issue_id":"casg-7l4.3","depends_on_id":"casg-7l4.1","type":"blocks","created_at":"2026-01-12T04:12:20.315642116Z","created_by":"cyou"}]}
{"id":"casg-7l4.4","title":"Timeout options builders","description":"## Summary\nAdd timeout configuration options to options.gleam for global and per-hook timeout control. Also add the bidir_runner_factory testing seam for start_session() tests.\n\n## TDD Approach\n\n### Phase 1: Skeleton + Failing Test\n1. Add timeout_ms and hook_timeouts fields to QueryOptions\n2. Add bidir_runner_factory field for testing\n3. Add with_timeout(timeout_ms) builder for global timeout\n4. Add with_hook_timeout(event, timeout_ms) for per-hook override\n5. Add with_bidir_runner_factory(factory) for testing seam\n6. Add HookEvent type for identifying hook types\n7. Write tests verifying timeout config is stored correctly\n\n### Phase 2: Implementation\n- Timeout defaults (60s global) will be applied in GenServer\n- Hook timeouts override global when present\n\n## Files to Create/Modify\n\n| File | Action | Description |\n|------|--------|-------------|\n| src/claude_agent_sdk/options.gleam | Modify | Add timeout fields and builders |\n| src/claude_agent_sdk/hook.gleam | Modify | Add HookEvent enum |\n| src/claude_agent_sdk/internal/bidir_runner.gleam | Create | BidirRunner type placeholder |\n| test/timeout_options_test.gleam | Create | Tests for timeout option builders |\n\n## Acceptance Criteria\n- [ ] QueryOptions has timeout_ms field (Option(Int))\n- [ ] QueryOptions has hook_timeouts field (Dict(HookEvent, Int))\n- [ ] QueryOptions has bidir_runner_factory field\n- [ ] with_timeout sets global timeout\n- [ ] with_hook_timeout adds to hook_timeouts dict\n- [ ] with_bidir_runner_factory sets the factory function\n- [ ] HookEvent enum has all 6 hook types\n- [ ] Tests verify timeout configuration works\n- [ ] Tests verify factory is stored correctly\n- [ ] Re-export builders from main module\n\n## API Signatures\n```gleam\n// options.gleam additions\npub fn with_timeout(options: QueryOptions, timeout_ms: Int) -\u003e QueryOptions\n\npub fn with_hook_timeout(\n  options: QueryOptions,\n  event: HookEvent,\n  timeout_ms: Int,\n) -\u003e QueryOptions\n\n/// For testing bidir mode: provide a factory for mock BidirRunner\n/// Only used by start_session(); ignored by query()\npub fn with_bidir_runner_factory(\n  options: QueryOptions,\n  factory: fn() -\u003e BidirRunner,\n) -\u003e QueryOptions\n```\n\n```gleam\n// hook.gleam additions\npub type HookEvent {\n  PreToolUseEvent\n  PostToolUseEvent\n  UserPromptSubmitEvent\n  StopEvent\n  SubagentStopEvent\n  PreCompactEvent\n}\n```\n\n```gleam\n// internal/bidir_runner.gleam\npub type BidirRunner {\n  BidirRunner(\n    port: Port,\n    write: fn(String) -\u003e Result(Nil, WriteError),\n    close: fn() -\u003e Nil,\n  )\n}\n```","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-12T04:11:25.816236115Z","created_by":"cyou","updated_at":"2026-01-12T04:11:25.816236115Z","labels":["size:S","tdd"],"dependencies":[{"issue_id":"casg-7l4.4","depends_on_id":"casg-7l4","type":"parent-child","created_at":"2026-01-12T04:11:25.816923144Z","created_by":"cyou"},{"issue_id":"casg-7l4.4","depends_on_id":"casg-7l4.1","type":"blocks","created_at":"2026-01-12T04:12:20.843592652Z","created_by":"cyou"}]}
{"id":"casg-7l4.5","title":"Public control operations","description":"## Summary\nAdd public control operation functions to claude_agent_sdk.gleam: interrupt, set_permission_mode, set_model, rewind_files, and stop. These functions will call into the GenServer via actor.call.\n\n## TDD Approach\n\n### Phase 1: Skeleton + Failing Test\n1. Add interrupt(session) -\u003e Result(Nil, ControlError) stub\n2. Add set_permission_mode(session, mode) -\u003e Result(Nil, ControlError) stub\n3. Add set_model(session, model) -\u003e Result(Nil, ControlError) stub\n4. Add rewind_files(session, user_message_id) -\u003e Result(Nil, ControlError) stub\n5. Add stop(session) -\u003e Result(Nil, StopError) stub\n6. Add ControlError and StopError types\n7. Write tests that call each operation (expect NotImplemented initially)\n\n### Phase 2: Implementation (separate task)\n- Actual GenServer calls will be implemented in Epic 8\n\n## Files to Create/Modify\n\n| File | Action | Description |\n|------|--------|-------------|\n| src/claude_agent_sdk.gleam | Modify | Add control operation functions |\n| src/claude_agent_sdk/error.gleam | Modify | Add ControlError and StopError types |\n| test/control_api_test.gleam | Create | Tests for control operations |\n\n## Acceptance Criteria\n- [ ] interrupt(session) compiles and has correct signature\n- [ ] set_permission_mode(session, mode) compiles\n- [ ] set_model(session, model) compiles\n- [ ] rewind_files(session, user_message_id) compiles\n- [ ] stop(session) compiles\n- [ ] ControlError has Timeout, SessionClosed, NotImplemented variants\n- [ ] StopError has SessionClosed, NotImplemented variants\n- [ ] Tests exist for each operation\n- [ ] All operations return NotImplemented for now\n\n## API Signatures\n```gleam\n// claude_agent_sdk.gleam additions\n\n/// Send interrupt signal to stop current operation.\n/// Blocks up to 5s waiting for CLI acknowledgment.\npub fn interrupt(session: Session) -\u003e Result(Nil, ControlError)\n\n/// Change permission mode during session.\n/// Blocks up to 5s waiting for CLI acknowledgment.\npub fn set_permission_mode(\n  session: Session,\n  mode: PermissionMode,\n) -\u003e Result(Nil, ControlError)\n\n/// Change model during session.\n/// Blocks up to 5s waiting for CLI acknowledgment.\npub fn set_model(session: Session, model: String) -\u003e Result(Nil, ControlError)\n\n/// Rewind files to checkpoint at specified message.\n/// Requires enable_file_checkpointing option.\n/// Blocks up to 30s waiting for CLI acknowledgment.\npub fn rewind_files(session: Session, user_message_id: String) -\u003e Result(Nil, ControlError)\n\n/// Gracefully stop the session.\n/// Non-blocking; initiates shutdown and returns immediately.\npub fn stop(session: Session) -\u003e Result(Nil, StopError)\n```\n\n```gleam\n// error.gleam additions\npub type ControlError {\n  ControlTimeout\n  SessionClosed\n  ControlNotImplemented\n}\n\npub type StopError {\n  StopSessionClosed\n  StopNotImplemented\n}\n```","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-12T04:11:40.070076Z","created_by":"cyou","updated_at":"2026-01-12T04:11:40.070076Z","labels":["size:S","tdd"],"dependencies":[{"issue_id":"casg-7l4.5","depends_on_id":"casg-7l4","type":"parent-child","created_at":"2026-01-12T04:11:40.070712459Z","created_by":"cyou"},{"issue_id":"casg-7l4.5","depends_on_id":"casg-7l4.1","type":"blocks","created_at":"2026-01-12T04:12:21.356300137Z","created_by":"cyou"}]}
{"id":"casg-7l4.6","title":"messages() and events() subscriptions","description":"## Summary\nAdd subscription functions to claude_agent_sdk.gleam for receiving messages and session lifecycle events. These return Subjects that the caller can use to receive push-based updates.\n\n## TDD Approach\n\n### Phase 1: Skeleton + Failing Test\n1. Add messages(session) -\u003e Subject(Message) function\n2. Add events(session) -\u003e Subject(SessionEvent) function\n3. Add SessionEvent type with lifecycle variants\n4. Store subjects in Session type\n5. Write tests that verify subscriptions can be created\n\n### Phase 2: Implementation (separate task)\n- GenServer will send messages to these subjects in Epic 8\n\n## Files to Create/Modify\n\n| File | Action | Description |\n|------|--------|-------------|\n| src/claude_agent_sdk.gleam | Modify | Add messages() and events() functions |\n| src/claude_agent_sdk/session.gleam | Modify | Add subject fields to Session |\n| src/claude_agent_sdk/event.gleam | Create | SessionEvent type definition |\n| test/subscription_test.gleam | Create | Tests for subscription functions |\n\n## Acceptance Criteria\n- [ ] messages(session) returns Subject(Message)\n- [ ] events(session) returns Subject(SessionEvent)\n- [ ] SessionEvent has SessionCompleted, SessionStopped, SessionFailed variants\n- [ ] Session type stores both subjects internally\n- [ ] Tests verify subjects can be obtained from session\n- [ ] Re-export SessionEvent from main module\n\n## API Signatures\n```gleam\n// claude_agent_sdk.gleam additions\n\n/// Get the message stream from an active session.\n/// Non-blocking; returns immediately with Subject for receiving messages.\npub fn messages(session: Session) -\u003e Subject(Message)\n\n/// Get session lifecycle events (completion, stop, failure).\n/// Separate from messages() to avoid changing the Message type.\npub fn events(session: Session) -\u003e Subject(SessionEvent)\n```\n\n```gleam\n// event.gleam\npub type SessionEvent {\n  /// Session completed normally with result\n  SessionCompleted(result: ResultMessage)\n  /// Session was stopped via stop() call\n  SessionStopped\n  /// Session failed with error\n  SessionFailed(error: String)\n}\n```\n\n```gleam\n// session.gleam (internal structure)\npub opaque type Session {\n  Session(\n    actor: Subject(ActorMessage),\n    messages: Subject(Message),\n    events: Subject(SessionEvent),\n  )\n}\n```\n\n## Notes\n- Subjects are part of gleam_erlang/gleam_otp\n- The GenServer (implemented in Epic 8) will call process.send to push messages\n- Callers use process.receive or process.selecting to consume","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-12T04:11:53.048471796Z","created_by":"cyou","updated_at":"2026-01-12T04:11:53.048471796Z","labels":["size:S","tdd"],"dependencies":[{"issue_id":"casg-7l4.6","depends_on_id":"casg-7l4","type":"parent-child","created_at":"2026-01-12T04:11:53.049088145Z","created_by":"cyou"},{"issue_id":"casg-7l4.6","depends_on_id":"casg-7l4.1","type":"blocks","created_at":"2026-01-12T04:12:21.834798002Z","created_by":"cyou"}]}
{"id":"casg-7l4.7","title":"CLI --input-format flag and version detection","description":"## Summary\nExtend internal/cli.gleam to support bidirectional mode CLI arguments. Add --input-format stream-json flag when bidir features are enabled. Add version detection for minimum bidir CLI version. Make query() warn and ignore bidir options.\n\n## TDD Approach\n\n### Phase 1: Skeleton + Failing Test\n1. Add minimum_bidir_cli_version constant (e.g., 1.1.0)\n2. Add has_bidir_features(options) helper to detect bidir options\n3. Add build_bidir_cli_args(options, prompt) that includes --input-format stream-json\n4. Add bidir version check in start_session path\n5. Modify query() to warn when bidir features detected\n6. Write tests for CLI arg building with bidir features\n\n### Phase 2: Integration\n- start_session() will use build_bidir_cli_args\n- query() will use existing build_cli_args with warning\n\n## Files to Create/Modify\n\n| File | Action | Description |\n|------|--------|-------------|\n| src/claude_agent_sdk/internal/cli.gleam | Modify | Add bidir CLI args builder and version constant |\n| src/claude_agent_sdk.gleam | Modify | Add bidir feature detection warning in query() |\n| test/cli_bidir_test.gleam | Create | Tests for bidir CLI arg building |\n\n## Acceptance Criteria\n- [ ] minimum_bidir_cli_version constant exists (1.1.0 or appropriate)\n- [ ] has_bidir_features(options) returns True if hooks/can_use_tool/mcp_servers set\n- [ ] build_bidir_cli_args includes --input-format stream-json\n- [ ] build_bidir_cli_args includes all standard args from build_cli_args\n- [ ] query() logs warning when bidir features detected (via io.debug for now)\n- [ ] query() proceeds with legacy mode despite bidir options\n- [ ] Tests verify --input-format appears in bidir args\n- [ ] Tests verify bidir feature detection works\n\n## API Signatures\n```gleam\n// internal/cli.gleam additions\n\n/// Minimum CLI version for bidirectional protocol support\npub const minimum_bidir_cli_version = CliVersion(1, 1, 0, \"1.1.0\")\n\n/// Check if options contain any bidirectional features\npub fn has_bidir_features(options: QueryOptions) -\u003e Bool {\n  // True if any hooks, can_use_tool, or mcp_servers are set\n}\n\n/// Build CLI arguments for bidirectional mode\n/// Includes --input-format stream-json and all standard args\npub fn build_bidir_cli_args(options: QueryOptions, prompt: String) -\u003e List(String) {\n  let base_args = build_cli_args(options, prompt)\n  // Insert --input-format stream-json after initial fixed args\n}\n```\n\n## CLI Arguments for Bidir Mode\nStandard args + bidir-specific:\n```\nclaude --print --output-format stream-json --input-format stream-json --verbose [options] -- \u003cprompt\u003e\n```\n\n## Warning Message for query()\nWhen has_bidir_features(options) is True:\n```\n\"Warning: query() ignores hooks/can_use_tool/mcp_servers. Use start_session() for bidirectional features.\"\n```","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-12T04:12:10.310594741Z","created_by":"cyou","updated_at":"2026-01-12T04:12:10.310594741Z","labels":["size:S","tdd"],"dependencies":[{"issue_id":"casg-7l4.7","depends_on_id":"casg-7l4","type":"parent-child","created_at":"2026-01-12T04:12:10.31125179Z","created_by":"cyou"},{"issue_id":"casg-7l4.7","depends_on_id":"casg-7l4.1","type":"blocks","created_at":"2026-01-12T04:12:22.351462976Z","created_by":"cyou"}]}
{"id":"casg-81w","title":"[Review] 2 non-blocking findings from casg-47z","description":"## Review Findings\n\nThis issue consolidates 2 non-blocking findings from code review.\n\n**Source issue:** casg-47z\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Missing drain_count increment after Result message\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/internal/stream.gleam:751-761\n\nAccording to the design plan (plans/2026-01-10-gleam-agent-sdk-plan.md:3048), when data arrives after a Result message, the `drain_count` should be incremented to track drain iterations. However, the implementation at line 754-761 resets decode errors and emits the warning but doesn't increment `drain_count`.\n\nThe plan shows:\n```gleam\nData(bytes) if drain_count \u003c 10 -\u003e\n  yield Warning(UnexpectedMessageAfterResult(bytes))\n  ResultReceived(result, drain_count + 1)\n```\n\nBut the implementation only does:\n```gleam\nlet updated = reset_decode_errors(stream)\nlet warning = Warning(...)\n#(Ok(WarningEvent(warning)), updated)\n```\n\n**Impact**: The drain counter remains at 0 forever, preventing the drain limit from working correctly.\n\n**Fix**: Add a helper function `increment_drain_count()` similar to `increment_decode_errors()`, and call it when emitting the `UnexpectedMessageAfterResult` warning.\n\n---\n\n### Finding 2: [P2] Missing drain iteration limit check\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/internal/stream.gleam:751-761\n\nThe design plan (plans/2026-01-10-gleam-agent-sdk-plan.md:3045) specifies that drain should be capped at 10 iterations: `Data(bytes) if drain_count \u003c 10`. The constant `post_result_drain_max_iterations = 10` exists in constants.gleam:11 but is never used.\n\nWithout this check, if a CLI process emits many messages after Result, the stream will continue processing them indefinitely (only limited by 100ms timeout per iteration), rather than forcing EndOfStream after 10 drain warnings.\n\n**Expected behavior**: After 10 drain iterations, subsequent data should transition to PendingEndOfStream rather than emitting more warnings.\n\n**Fix**: Before emitting the warning at line 755, check if `internal.drain_count \u003e= constants.post_result_drain_max_iterations`. If true, transition to PendingEndOfStream instead of emitting another warning.\n\n---\n\n\u003c!-- fp:b9992d9eaed60788 --\u003e\n\u003c!-- fp:cee3273503982f96 --\u003e\n\u003c!-- review_finding:842c2142b850 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T05:18:30.974133607Z","created_by":"cyou","updated_at":"2026-01-11T05:22:02.306081853Z","closed_at":"2026-01-11T05:22:02.306081853Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-47z"]}
{"id":"casg-8o2","title":"[Review] 1 non-blocking finding from casg-81w","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-81w\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Off-by-one error in drain_count limit check allows only 9 warnings\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/internal/stream.gleam:435\n\nThe implementation increments `drain_count` before checking the limit, which causes it to emit only 9 warnings instead of the intended 10.\n\n**Current behavior** (stream.gleam:794-799):\n- Message 1: drain_count 0→1, check 1 \u003e= 10 ✗, emit warning #1\n- Message 2: drain_count 1→2, check 2 \u003e= 10 ✗, emit warning #2  \n- ...\n- Message 9: drain_count 8→9, check 9 \u003e= 10 ✗, emit warning #9\n- Message 10: drain_count 9→10, check 10 \u003e= 10 ✓, return EndOfStream (no warning)\n\n**Expected behavior** per plan (plans/2026-01-10-gleam-agent-sdk-plan.md:3045):\n- The guard `if drain_count \u003c 10` should allow drain_count values 0-9 to emit warnings (10 warnings total)\n- When drain_count reaches 10, transition to PendingEndOfStream\n\n**Root cause**: Line 435 uses `new_count \u003e= constants.post_result_drain_max_iterations` after incrementing, which triggers on the 10th message instead of the 11th.\n\n**Fix**: Change line 435 to:\n```gleam\nlet limit_exceeded = new_count \u003e constants.post_result_drain_max_iterations\n```\n\nThis will allow 10 warnings (drain_count 0→1 through 9→10) before forcing EndOfStream on the 11th message (drain_count 10→11).\n\n---\n\n\u003c!-- fp:683e7b4177d5bbf3 --\u003e\n\u003c!-- review_finding:4b43edb4b741 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T05:22:02.404841535Z","created_by":"cyou","updated_at":"2026-01-11T05:25:15.57081976Z","closed_at":"2026-01-11T05:25:15.57081976Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-81w"]}
{"id":"casg-9us","title":"[Review] 1 non-blocking finding from casg-3gt","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-3gt\n**Highest priority:** P3\n\n---\n\n### Finding 1: [P3] Comment references wrong function name\n\n**Priority:** P3\n**Reviewer:** gemini\n**Location:** src/claude_agent_sdk/internal/bidir.gleam:2206\n\nThe new documentation references `handle_control_request` as performing capacity checks for `pending_requests`. However, `handle_control_request` (line 1445) handles incoming hooks/messages. The function that handles outgoing requests and checks `pending_requests` capacity is `handle_send_control_request` (line 1604).\n\n---\n\n\u003c!-- fp:eb75d223ae8756a8 --\u003e\n\u003c!-- review_finding:7d14e9fd63e0 --\u003e","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-12T17:47:14.088684705Z","created_by":"cyou","updated_at":"2026-01-12T17:54:05.664759163Z","closed_at":"2026-01-12T17:54:05.664759163Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-3gt"]}
{"id":"casg-axf","title":"Epic 4: Integration Tests","description":"## Overview\nImplement opt-in integration tests that validate the SDK against the real Claude CLI. These tests are gated by CLAUDE_INTEGRATION_TEST=1 environment variable.\n\n## Why This is Critical\n- Unit tests can't validate real CLI behavior\n- Integration tests catch CLI version incompatibilities\n- Preflight checks provide actionable skip messages\n\n## Scope\n1. **Preflight Checks** (test/query_integration_test.gleam):\n   - CLI exists in PATH check\n   - Version detection with timeout\n   - Auth detection (API key or claude login)\n   - Required flags presence check\n\n2. **Real CLI Query Tests**:\n   - integration__real_cli_query_test\n   - integration__session_resume_test\n   - integration__ndjson_purity_test\n\n3. **Error Scenario Tests**:\n   - CLI not found behavior\n   - Version too old behavior\n   - Unauthenticated CLI behavior\n\n4. **Integration Test Helpers**:\n   - integration_enabled() gate function\n   - is_authenticated() check\n   - Timeout protection (30s max)\n\n## Success Criteria\n- Tests skip cleanly when CLAUDE_INTEGRATION_TEST not set\n- Tests produce [SKIP] messages visible in output\n- Preflight catches environment issues before test failures\n- All real CLI tests pass when environment is correct\n\n## Dependencies\n- Depends on Epic 2 (query() must work)\n- Depends on Epic 3 (test helpers)\n\n## Plan References\n- Integration Test Gating section\n- Auth detection for query tests\n- Skip hierarchy (recommended)","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-01-10T23:19:44.997721494Z","created_by":"cyou","updated_at":"2026-01-11T03:21:15.599032129Z","closed_at":"2026-01-11T03:21:15.599032129Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-axf","depends_on_id":"casg-j37","type":"blocks","created_at":"2026-01-10T23:19:52.23413379Z","created_by":"cyou"},{"issue_id":"casg-axf","depends_on_id":"casg-tc3","type":"blocks","created_at":"2026-01-10T23:19:52.29006719Z","created_by":"cyou"}]}
{"id":"casg-axf.1","title":"Integration test file skeleton + integration_enabled() helper","description":"## Overview\nCreate the integration test file skeleton with the core gating helper function.\n\n## Deliverables\n\n### File: `test/query_integration_test.gleam`\n\n```gleam\n// In test/query_integration_test.gleam\nimport support/env_helpers.{get_env}\nimport gleam/io\nimport gleeunit/should\n\n/// Helper: Check if integration tests are enabled and log skip if not.\n/// Returns True if tests should run, False if skipped.\nfn integration_enabled(test_name: String) -\u003e Bool {\n  case get_env(\"CLAUDE_INTEGRATION_TEST\") {\n    Ok(\"1\") -\u003e True\n    _ -\u003e {\n      io.println(\"[SKIP] \" \u003c\u003e test_name \u003c\u003e \" (set CLAUDE_INTEGRATION_TEST=1 to run)\")\n      False\n    }\n  }\n}\n```\n\n## Acceptance Criteria\n- [ ] File exists at `test/query_integration_test.gleam`\n- [ ] `integration_enabled()` returns `True` when `CLAUDE_INTEGRATION_TEST=1`\n- [ ] `integration_enabled()` returns `False` and prints skip message otherwise\n- [ ] Skip message format: `[SKIP] test_name (set CLAUDE_INTEGRATION_TEST=1 to run)`\n- [ ] File compiles with `gleam build`\n\n## Test Contract\n- Tests SKIP by default (no env var set)\n- All integration tests use `integration__` prefix for easy grep","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:21:23.835633381Z","created_by":"cyou","updated_at":"2026-01-11T02:55:09.342376606Z","closed_at":"2026-01-11T02:55:09.342376606Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-axf.1","depends_on_id":"casg-axf","type":"parent-child","created_at":"2026-01-10T23:21:23.836185558Z","created_by":"cyou"}]}
{"id":"casg-axf.10","title":"[Review] 1 non-blocking finding from casg-axf.3","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-axf.3\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] CollectResult imported from internal module instead of public API\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** test/query_integration_test.gleam:8\n\nAt line 8 of `test/query_integration_test.gleam`, the test imports `CollectResult` from the internal module:\n\n```gleam\nimport claude_agent_sdk/internal/stream.{CollectResult}\n```\n\nHowever, `CollectResult` is re-exported in the public API at `src/claude_agent_sdk.gleam:245-246`. Test code should use the public API rather than internal modules to ensure stability.\n\n**Why this matters:**\n- Internal modules are implementation details subject to change\n- Public API is documented as **STABLE API** with semantic versioning guarantees\n- Tests should model how external users would consume the SDK\n\n**Fix:** Change the import to use the public module:\n```gleam\nimport claude_agent_sdk.{type CollectResult}\n```\n\nOr access it through the fully-qualified path without importing the type separately. The same issue applies to the usage pattern at line 178 where it pattern matches on `CollectResult` - this would work fine with the public import.\n\n---\n\n\u003c!-- fp:3e05279db2a6387b --\u003e\n\u003c!-- review_finding:ca52b73a6809 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T03:05:00.913300629Z","created_by":"cyou","updated_at":"2026-01-11T03:11:48.327023471Z","closed_at":"2026-01-11T03:11:48.327023471Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-axf.3"],"dependencies":[{"issue_id":"casg-axf.10","depends_on_id":"casg-axf","type":"parent-child","created_at":"2026-01-11T03:05:00.913814115Z","created_by":"cyou"}]}
{"id":"casg-axf.11","title":"[Review] 2 non-blocking findings from casg-axf.5","description":"## Review Findings\n\nThis issue consolidates 2 non-blocking findings from code review.\n\n**Source issue:** casg-axf.5\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] CLI missing returns PreflightTimeout instead of distinct error\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** test/support/integration_helpers.gleam:183-184\n\nIn `preflight_ndjson_check()` at line 183-184, when `find_executable(\"claude\")` returns `Error(_)`, the function returns `PreflightTimeout`. This is semantically incorrect—the CLI is missing from PATH, not timing out.\n\n**Impact:** Users will see `[SKIP:TIMEOUT] Preflight check timed out` when the actual issue is `[SKIP:ENV] claude not in PATH`. This creates confusion and misdirects troubleshooting.\n\n**Why this matters:** The `integration__preflight_check_test()` already has proper messaging for CLI missing vs timeout scenarios. This function should follow the same pattern.\n\n**Fix:** Either:\n1. Add a distinct `CliMissing` variant to `PreflightResult` type\n2. Return `NdjsonImpure` for missing CLI (treating it as \"cannot verify purity\")\n3. Skip the NDJSON check entirely if CLI is missing (since `integration__preflight_check_test()` already covers this)\n\nOption 3 is recommended since `integration__preflight_check_test()` should run first and skip all tests if CLI is missing.\n\n---\n\n### Finding 2: [P3] Empty output treated as pure NDJSON\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** test/support/integration_helpers.gleam:211-212\n\nIn `validate_ndjson_output()` at line 211-212, empty output (zero non-empty lines after filtering) returns `NdjsonPure`. This could hide actual failures where the CLI crashes or produces no output due to errors.\n\n**Example scenario:**\n```bash\n# CLI crashes immediately with exit code 139 (segfault)\n$ claude --print --output-format stream-json test\n# (no output, exits immediately)\n```\n\nIn this case, `run_command_with_timeout()` would return `Error(Nil)` due to non-zero exit (caught by line 139), so this is protected. However, if the exit code check were ever removed or changed, this would silently succeed.\n\n**Why this is P3:** The current implementation is protected by exit code checking in `collect_output_with_deadline()` (line 133-140). This is a defensive programming concern rather than an active bug.\n\n**Fix (optional):** Add a comment explaining the assumption:\n```gleam\ncase lines {\n  // Empty output is OK: either exit code was non-zero (caught earlier)\n  // or CLI legitimately produced no output for this simple command\n  [] -\u003e NdjsonPure\n```\n\n---\n\n\u003c!-- fp:c1986662264c9c0c --\u003e\n\u003c!-- fp:a45952b607b40cc3 --\u003e\n\u003c!-- review_finding:8b4952e883cb --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T03:08:50.80316291Z","created_by":"cyou","updated_at":"2026-01-11T03:14:09.353674277Z","closed_at":"2026-01-11T03:14:09.353674277Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-axf.5"],"dependencies":[{"issue_id":"casg-axf.11","depends_on_id":"casg-axf","type":"parent-child","created_at":"2026-01-11T03:08:50.803836706Z","created_by":"cyou"}]}
{"id":"casg-axf.12","title":"[Review] 3 non-blocking findings from casg-axf.4","description":"## Review Findings\n\nThis issue consolidates 3 non-blocking findings from code review.\n\n**Source issue:** casg-axf.4\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] First query's terminal_error is not checked\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** test/query_integration_test.gleam:324-326\n\nIn `integration__session_resume_test()` at lines 323-325, after the initial query succeeds and its stream is consumed with `collect_messages()`, the test does not check `result1.terminal_error`.\n\n**Why this matters:**\n\nThe first query could complete with a terminal error (e.g., `ProcessError`, `TooManyDecodeErrors`) but still return some messages. If a terminal error occurred:\n1. The session_id might not be valid or usable\n2. The session might be in an incomplete/error state\n3. The resume attempt would likely fail\n\n**Current behavior:**\nThe test proceeds to extract session_id even if the stream ended with a terminal error, which could lead to confusing test failures during the resume step.\n\n**Comparison to existing test:**\nThe `integration__real_cli_query_test()` at lines 173-201 properly checks `terminal_err` when there are no messages and reports it clearly.\n\n**Fix:**\nAfter line 324, add a check for terminal errors:\n```gleam\nlet result1 = claude_agent_sdk.collect_messages(stream1)\n\ncase result1.terminal_error {\n  Some(err) -\u003e {\n    io.println(\n      \"[FAIL] Initial query had terminal error: \"\n      \u003c\u003e stream_error_to_string(err),\n    )\n    should.be_true(False)\n  }\n  None -\u003e {\n    // Continue with session_id extraction...\n  }\n}\n```\n\nThis ensures the test fails early with a clear message if the initial session creation encounters a terminal error, rather than failing later with a confusing \"session not found\" error during resume.\n\n---\n\n### Finding 2: [P2] Second query's terminal_error is not checked\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** test/query_integration_test.gleam:355-357\n\nIn `integration__session_resume_test()` at lines 354-357, after the resumed query succeeds and its stream is consumed, the test does not check `result2.terminal_error` before validating the response content.\n\n**Why this matters:**\n\nThe resumed query could complete with a terminal error but still return partial messages. Without checking terminal errors:\n1. The test might pass even if the resume partially failed\n2. False positives: If the response happened to mention \"42\" before a terminal error occurred, the test would pass incorrectly\n3. Unclear failures: If the response doesn't contain \"42\" due to a terminal error cutting it off, the test reports \"context not preserved\" when the real issue was a stream error\n\n**Fix:**\nAfter line 355, check for terminal errors before validating content:\n```gleam\nlet result2 = claude_agent_sdk.collect_messages(stream2)\n\ncase result2.terminal_error {\n  Some(err) -\u003e {\n    io.println(\n      \"[FAIL] Resume query had terminal error: \"\n      \u003c\u003e stream_error_to_string(err),\n    )\n    should.be_true(False)\n  }\n  None -\u003e {\n    // Proceed to check_response_contains_42...\n  }\n}\n```\n\nThis ensures the test validates session resume only when both queries complete successfully without terminal errors.\n\n---\n\n### Finding 3: [P3] Test could verify session_id format\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** test/query_integration_test.gleam:331-332\n\nAt line 332, the test prints the session_id but doesn't validate its format. According to `message.gleam:57`, session_id is documented as \"Session identifier (UUID)\".\n\n**Optional enhancement:**\nWhile not required for correctness, validating that the session_id looks like a UUID would catch potential issues early:\n- Invalid/malformed session_ids from CLI bugs\n- Empty strings that would cause resume to fail\n- Ensure the test is working with well-formed data\n\n**Example check:**\n```gleam\nSome(session_id) -\u003e {\n  case string.length(session_id) \u003e 0 {\n    True -\u003e {\n      io.println(\"[INFO] Session ID: \" \u003c\u003e session_id)\n      // Continue...\n    }\n    False -\u003e {\n      io.println(\"[FAIL] Empty session_id extracted\")\n      should.be_true(False)\n    }\n  }\n}\n```\n\nThis is P3 (low priority) because an invalid session_id would cause the resume query to fail anyway, so the test would still catch the issue (just later).\n\n---\n\n\u003c!-- fp:64cd642b82160216 --\u003e\n\u003c!-- fp:5db2190fb3ada9b3 --\u003e\n\u003c!-- fp:93131edf89d43622 --\u003e\n\u003c!-- review_finding:721d81588b45 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T03:13:53.731618957Z","created_by":"cyou","updated_at":"2026-01-11T03:18:36.259881886Z","closed_at":"2026-01-11T03:18:36.259881886Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-axf.4"],"dependencies":[{"issue_id":"casg-axf.12","depends_on_id":"casg-axf","type":"parent-child","created_at":"2026-01-11T03:13:53.732273892Z","created_by":"cyou"}]}
{"id":"casg-axf.2","title":"Preflight checks and is_authenticated() helper","description":"## Overview\nImplement preflight checks that validate the environment before running integration tests.\n\n## Deliverables\n\n### Helper: `is_authenticated() -\u003e Bool`\n\n```gleam\nfn is_authenticated() -\u003e Bool {\n  // Check 1: ANTHROPIC_API_KEY in environment (preferred - no subprocess)\n  case get_env(\"ANTHROPIC_API_KEY\") {\n    Ok(_) -\u003e True\n    _ -\u003e\n      // Check 2: `claude auth status` with 5s timeout (if CLI supports it)\n      case run_with_timeout(\"claude\", [\"auth\", \"status\"], 5000) {\n        Ok(output) if string.contains(output, \"authenticated\") -\u003e True\n        _ -\u003e False  // Timeout, unsupported command, or not authenticated\n      }\n  }\n}\n```\n\n### Test: `integration__preflight_check_test`\n\n```gleam\npub fn integration__preflight_check_test() {\n  case integration_enabled(\"integration__preflight_check_test\") {\n    True -\u003e {\n      // 1. CLI exists and version is parseable\n      case find_executable(\"claude\") {\n        Error(_) -\u003e {\n          io.println(\"[SKIP:ENV] claude not in PATH - install CLI first\")\n          should.be_true(True)  // Skip, don't fail\n        }\n        Ok(path) -\u003e {\n          // 2. Version check (with 5s timeout)\n          case detect_cli_version_with_timeout(path, 5000) {\n            Error(_) -\u003e {\n              io.println(\"[SKIP:ENV] claude --version timed out or failed\")\n              should.be_true(True)\n            }\n            Ok(UnknownVersion(_)) -\u003e {\n              io.println(\"[WARN] Unparseable version - tests may fail\")\n            }\n            Ok(CliVersion(maj, _, _, _)) if maj \u003c 1 -\u003e {\n              io.println(\"[SKIP:ENV] CLI version \u003c 1.0.0 - upgrade required\")\n              should.be_true(True)\n            }\n            Ok(_) -\u003e {\n              // 3. Required flags exist (non-network check)\n              // Run: claude --help and verify flags present\n              io.println(\"[PREFLIGHT] All checks passed - integration tests will run\")\n            }\n          }\n        }\n      }\n    }\n    False -\u003e should.be_true(True)\n  }\n}\n```\n\n## Timeout Protection\n- Preflight version check: 5s\n- Preflight help check: 5s\n- No preflight can hang indefinitely\n\n## Skip Hierarchy\nTests skip unless ALL conditions met:\n1. `CLAUDE_INTEGRATION_TEST=1` env var set\n2. `claude` found in PATH (non-network check)\n3. `claude --version` succeeds with 5s timeout\n\n## Acceptance Criteria\n- [ ] `is_authenticated()` checks `ANTHROPIC_API_KEY` first (no subprocess)\n- [ ] `is_authenticated()` falls back to `claude auth status` with 5s timeout\n- [ ] `integration__preflight_check_test` validates CLI in PATH\n- [ ] `integration__preflight_check_test` validates version parseable\n- [ ] Skip messages are actionable: `[SKIP:ENV] reason`\n- [ ] All timeouts bounded to 5s","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:21:39.542323396Z","created_by":"cyou","updated_at":"2026-01-11T02:59:02.325364159Z","closed_at":"2026-01-11T02:59:02.325364159Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-axf.2","depends_on_id":"casg-axf","type":"parent-child","created_at":"2026-01-10T23:21:39.543446919Z","created_by":"cyou"},{"issue_id":"casg-axf.2","depends_on_id":"casg-axf.1","type":"blocks","created_at":"2026-01-10T23:22:28.673961804Z","created_by":"cyou"}]}
{"id":"casg-axf.3","title":"integration__real_cli_query_test implementation","description":"## Overview\nImplement the real CLI query integration test that exercises the full query pipeline with actual Claude CLI.\n\n## Deliverables\n\n### Test: `integration__real_cli_query_test`\n\n```gleam\n/// Integration test: real CLI query (opt-in via CLAUDE_INTEGRATION_TEST=1)\npub fn integration__real_cli_query_test() {\n  case integration_enabled(\"integration__real_cli_query_test\") {\n    True -\u003e {\n      case is_authenticated() {\n        True -\u003e {\n          // Actual integration test logic\n          let assert Ok(stream) = query(\"Hello\", default_options())\n          // Consume stream, verify messages\n          // Use max_turns=1 for fast test\n        }\n        False -\u003e {\n          io.println(\"[SKIP:AUTH] Auth not available - set ANTHROPIC_API_KEY or run claude login\")\n          should.be_true(True)\n        }\n      }\n    }\n    False -\u003e should.be_true(True)  // Skipped (message already printed)\n  }\n}\n```\n\n## Test Requirements\n- Requires authentication (API key or `claude login`)\n- Uses `max_turns=1` for fast execution\n- 30s max timeout protection\n- Verifies stream produces valid messages\n\n## Skip Conditions\n- `CLAUDE_INTEGRATION_TEST` not set -\u003e `[SKIP] test_name (set CLAUDE_INTEGRATION_TEST=1 to run)`\n- Auth not available -\u003e `[SKIP:AUTH] Auth not available - set ANTHROPIC_API_KEY or run claude login`\n\n## Acceptance Criteria\n- [ ] Test gates on `integration_enabled()` first\n- [ ] Test gates on `is_authenticated()` second\n- [ ] Skip messages are actionable\n- [ ] Test makes real CLI query with simple prompt\n- [ ] Test verifies stream produces at least one message\n- [ ] Test has 30s timeout protection\n- [ ] Test passes when auth available\n- [ ] Test skips cleanly when auth unavailable","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:21:52.914319788Z","created_by":"cyou","updated_at":"2026-01-11T03:05:00.725766118Z","closed_at":"2026-01-11T03:05:00.725766118Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-axf.3","depends_on_id":"casg-axf","type":"parent-child","created_at":"2026-01-10T23:21:52.914845785Z","created_by":"cyou"},{"issue_id":"casg-axf.3","depends_on_id":"casg-axf.2","type":"blocks","created_at":"2026-01-10T23:22:29.178335685Z","created_by":"cyou"}]}
{"id":"casg-axf.4","title":"integration__session_resume_test implementation","description":"## Overview\nImplement integration test for session resume functionality with real CLI.\n\n## Deliverables\n\n### Test: `integration__session_resume_test`\n\n```gleam\n/// Integration test: session resume (opt-in)\npub fn integration__session_resume_test() {\n  case integration_enabled(\"integration__session_resume_test\") {\n    True -\u003e {\n      case is_authenticated() {\n        True -\u003e {\n          // 1. Create initial session\n          let opts1 = QueryOptions(..default_options(), max_turns: Some(1))\n          let assert Ok(stream1) = query(\"Remember the number 42\", opts1)\n          \n          // 2. Consume stream to get session_id from SystemMessage\n          let session_id = extract_session_id(stream1)\n          \n          // 3. Resume session with follow-up\n          let opts2 = QueryOptions(\n            ..default_options(),\n            resume_session_id: Some(session_id),\n            max_turns: Some(1)\n          )\n          let assert Ok(stream2) = query(\"What number did I ask you to remember?\", opts2)\n          \n          // 4. Verify response references the number\n          // (This tests that session context is preserved)\n        }\n        False -\u003e {\n          io.println(\"[SKIP:AUTH] Auth not available\")\n          should.be_true(True)\n        }\n      }\n    }\n    False -\u003e should.be_true(True)  // Skipped\n  }\n}\n```\n\n## Test Requirements\n- Requires authentication\n- Creates initial session, extracts session_id\n- Resumes session with follow-up query\n- Verifies context preservation\n- Uses `max_turns=1` for each query\n- 30s timeout per query\n\n## Acceptance Criteria\n- [ ] Test gates on `integration_enabled()` and `is_authenticated()`\n- [ ] Test creates initial session with memorable prompt\n- [ ] Test extracts session_id from SystemMessage\n- [ ] Test resumes session using `resume_session_id` option\n- [ ] Test verifies session context is preserved\n- [ ] Each query has 30s timeout protection\n- [ ] Test skips cleanly when auth unavailable","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:22:04.786161785Z","created_by":"cyou","updated_at":"2026-01-11T03:13:53.541251491Z","closed_at":"2026-01-11T03:13:53.541251491Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-axf.4","depends_on_id":"casg-axf","type":"parent-child","created_at":"2026-01-10T23:22:04.786771082Z","created_by":"cyou"},{"issue_id":"casg-axf.4","depends_on_id":"casg-axf.3","type":"blocks","created_at":"2026-01-10T23:22:29.664399721Z","created_by":"cyou"}]}
{"id":"casg-axf.5","title":"integration__ndjson_purity_test implementation","description":"## Overview\nImplement integration test that verifies CLI produces pure NDJSON output.\n\n## Deliverables\n\n### Test: `integration__ndjson_purity_test`\n\n```gleam\n/// Integration test: NDJSON purity check\npub fn integration__ndjson_purity_test() {\n  case integration_enabled(\"integration__ndjson_purity_test\") {\n    True -\u003e {\n      case preflight_ndjson_check() {\n        Ok(True) -\u003e {\n          // Full NDJSON purity validation\n          // Verify every line from CLI is valid JSON\n          io.println(\"[PASS] CLI produces pure NDJSON\")\n        }\n        Ok(False) -\u003e {\n          io.println(\"[SKIP:NDJSON] CLI not producing pure NDJSON\")\n          should.be_true(True)\n        }\n        Error(Timeout) -\u003e {\n          io.println(\"[SKIP:TIMEOUT] Preflight check timed out\")\n          should.be_true(True)\n        }\n      }\n    }\n    False -\u003e should.be_true(True)\n  }\n}\n```\n\n## NDJSON Purity Contract\n\n| Scenario | Classification | SDK Behavior | Preflight Result |\n|----------|---------------|--------------|------------------|\n| All stdout lines are valid JSON | **Supported** | Normal operation | PASS |\n| 1-4 consecutive non-JSON lines | **Tolerated** | `JsonDecodeError` (non-terminal) | N/A (runtime only) |\n| 5+ consecutive non-JSON lines | **Not Supported** | `TooManyDecodeErrors` (terminal) | N/A (runtime only) |\n\n## Preflight Behavior\n\n| Preflight Result | Integration Tests | Message |\n|------------------|-------------------|---------|\n| PASS | Run normally | - |\n| FAIL | SKIP all integration tests | `[SKIP:NDJSON] CLI not producing pure NDJSON` |\n| TIMEOUT | SKIP all integration tests | `[SKIP:TIMEOUT] Preflight check timed out` |\n\n## Timeout Bounds\n- NDJSON purity check: 5s timeout (same as version detection)\n\n## Env Var Override\n```bash\n# Tolerate non-JSON for testing older CLI versions\nCLAUDE_INTEGRATION_TEST=1 CLAUDE_INTEGRATION_ALLOW_NONJSON=1 gleam test\n```\n\n## Acceptance Criteria\n- [ ] Test verifies all stdout lines are valid JSON\n- [ ] Test uses 5s timeout for preflight check\n- [ ] Test skips with `[SKIP:NDJSON]` if CLI produces non-JSON\n- [ ] Test skips with `[SKIP:TIMEOUT]` if check times out\n- [ ] `CLAUDE_INTEGRATION_ALLOW_NONJSON=1` relaxes strict mode\n- [ ] Test is stricter than runtime (ZERO tolerance vs 5-error threshold)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:22:18.730438381Z","created_by":"cyou","updated_at":"2026-01-11T03:08:50.616899585Z","closed_at":"2026-01-11T03:08:50.616899585Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-axf.5","depends_on_id":"casg-axf","type":"parent-child","created_at":"2026-01-10T23:22:18.730966198Z","created_by":"cyou"},{"issue_id":"casg-axf.5","depends_on_id":"casg-axf.2","type":"blocks","created_at":"2026-01-10T23:22:30.154701572Z","created_by":"cyou"}]}
{"id":"casg-axf.6","title":"Add integration preflight negative-scenario coverage","description":"## Overview\nAdd explicit integration preflight checks and skip messaging for negative scenarios: CLI missing, CLI version too old, and unauthenticated CLI.\n\n## Deliverables\n- Extend `integration__preflight_check_test` (or add a dedicated test) to cover:\n  - CLI missing in PATH -\u003e `[SKIP:ENV] claude not in PATH - install CLI first`\n  - Version parseable but \u003c1.0.0 -\u003e `[SKIP:ENV] CLI version \u003c 1.0.0 - upgrade required`\n  - Auth unavailable -\u003e `[SKIP:AUTH] Auth not available - set ANTHROPIC_API_KEY or run claude login`\n\n## Notes\n- These scenarios should **skip**, not fail, to keep integration tests opt-in and non-flaky\n- Use clear, actionable skip messages\n\n## Acceptance Criteria\n- [ ] Each negative scenario emits the correct skip message\n- [ ] No integration test hard-fails due to missing CLI/auth/version\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:37:04.535676174Z","created_by":"cyou","updated_at":"2026-01-11T03:02:06.094561211Z","closed_at":"2026-01-11T03:02:06.094561211Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-axf.6","depends_on_id":"casg-axf","type":"parent-child","created_at":"2026-01-10T23:37:04.536270899Z","created_by":"cyou"},{"issue_id":"casg-axf.6","depends_on_id":"casg-axf.2","type":"blocks","created_at":"2026-01-10T23:43:17.365192997Z","created_by":"cyou"}]}
{"id":"casg-axf.7","title":"[Review] 2 non-blocking findings from casg-axf.2","description":"## Review Findings\n\nThis issue consolidates 2 non-blocking findings from code review.\n\n**Source issue:** casg-axf.2\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Timeout applies per-message, not total duration\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** test/support/integration_helpers.gleam:94-106\n\nIn `collect_output_with_timeout()` at line 94-126, each `receive_timeout()` call uses the full `timeout_ms` parameter. This means if the subprocess sends multiple `Data` messages before `ExitStatus`/`Eof`, each message resets the timeout window.\n\n**Example:** With a 5s timeout, if the CLI sends 10 data chunks spaced 4.9s apart, the total time would be 49s instead of the intended 5s maximum.\n\n**Impact:** Preflight checks meant to be bounded to 5s could take much longer if the CLI produces slow, incremental output.\n\n**Fix:** Track elapsed time across iterations or use a deadline-based approach:\n```gleam\nfn collect_output_with_timeout_deadline(port, acc, deadline_ms) {\n  let remaining = deadline_ms - elapsed_time()\n  case remaining \u003c= 0 {\n    True -\u003e Error(Nil)  // Timeout\n    False -\u003e {\n      case port_ffi.receive_timeout(port, remaining) {\n        // ... rest of logic\n      }\n    }\n  }\n}\n```\n\nAlternatively, document this behavior clearly if it's intentional.\n\n---\n\n### Finding 2: [P2] Exit status code not validated\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** test/support/integration_helpers.gleam:108-113\n\nIn `collect_output_with_timeout()` at line 108 and `detect_cli_version_with_timeout()` at line 46-53, non-zero exit codes are ignored. If `claude --version` or `claude --help` fails (e.g., returns exit code 1), the function still returns `Ok(output)` with whatever was written to stdout before failure.\n\n**Impact:** Failed commands appear successful, potentially causing:\n- False positives in preflight checks\n- Misleading error messages (e.g., \"Unparseable version\" when the actual issue is command failure)\n- Integration tests continuing when they should skip\n\n**Fix:** Check exit status and return appropriate errors:\n```gleam\nExitStatus(code) -\u003e {\n  case code {\n    0 -\u003e {\n      // Success - return output\n      case bit_array.to_string(acc) {\n        Ok(s) -\u003e Ok(s)\n        Error(Nil) -\u003e Error(Nil)\n      }\n    }\n    _ -\u003e Error(Nil)  // Non-zero exit = failure\n  }\n}\n```\n\nThis matches the pattern used in the main `cli.gleam` module where exit codes are significant.\n\n---\n\n\u003c!-- fp:54b039302e5696ab --\u003e\n\u003c!-- fp:946ad397ef451f51 --\u003e\n\u003c!-- review_finding:d887ef0a27b8 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T02:59:02.518006737Z","created_by":"cyou","updated_at":"2026-01-11T03:03:16.546293752Z","closed_at":"2026-01-11T03:03:16.546293752Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-axf.2"],"dependencies":[{"issue_id":"casg-axf.7","depends_on_id":"casg-axf","type":"parent-child","created_at":"2026-01-11T02:59:02.518851003Z","created_by":"cyou"}]}
{"id":"casg-axf.8","title":"[Review] 1 non-blocking finding from casg-axf.6","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-axf.6\n**Highest priority:** P3\n\n---\n\n### Finding 1: [P3] Documentation tests provide no runtime validation\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** test/query_integration_test.gleam:96-133\n\nThe three new \"documentation tests\" (lines 96-133 in `test/query_integration_test.gleam`) use trivial string comparisons that always pass:\n\n```gleam\nshould.equal(\n  expected_message,\n  \"[SKIP:ENV] claude not in PATH - install CLI first\",\n)\n```\n\nThis compares a hardcoded string to itself, which always succeeds and provides no validation.\n\n**Why this is low priority:** While these tests don't catch bugs, they serve their stated purpose as documentation of expected skip message formats. The actual skip logic is tested by `integration__preflight_check_test()`. However, a better approach would be to either:\n\n1. Extract the skip messages as constants and validate both the test logic and documentation use the same constants\n2. Make these tests actually exercise the skip paths (though this would require mocking the environment)\n3. Simply document the messages in comments rather than creating always-passing tests\n\n**Current impact:** Tests will never fail even if the actual skip messages change, potentially causing documentation drift.\n\n---\n\n\u003c!-- fp:d289c22021c54281 --\u003e\n\u003c!-- review_finding:4da1fab1753a --\u003e","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-11T03:02:06.279873669Z","created_by":"cyou","updated_at":"2026-01-11T03:06:32.137747554Z","closed_at":"2026-01-11T03:06:32.137747554Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-axf.6"],"dependencies":[{"issue_id":"casg-axf.8","depends_on_id":"casg-axf","type":"parent-child","created_at":"2026-01-11T03:02:06.281101389Z","created_by":"cyou"}]}
{"id":"casg-axf.9","title":"[Review] 1 non-blocking finding from casg-axf.7","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-axf.7\n**Highest priority:** P3\n\n---\n\n### Finding 1: [P3] EOF path returns Ok without validating exit status\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** test/support/integration_helpers.gleam:142-147\n\nIn `collect_output_with_deadline()` at lines 142-147, when `Eof` is received, the function returns `Ok(s)` without ever checking the process exit code. This violates the documented contract (line 90-91) which states the function \"Returns Ok(stdout) on successful completion (exit code 0)\".\n\n**Impact:** If a process sends EOF before ExitStatus (rare but platform-dependent), a failed command could return Ok instead of Error.\n\n**Current behavior:**\n```gleam\nEof -\u003e {\n  // EOF without ExitStatus - convert accumulated bytes\n  case bit_array.to_string(acc) {\n    Ok(s) -\u003e Ok(s)  // Returns Ok without checking exit code!\n    Error(Nil) -\u003e Error(Nil)\n  }\n}\n```\n\n**Fix:** Either continue waiting for ExitStatus after EOF, or document that EOF-only termination is treated as success:\n```gleam\nEof -\u003e {\n  // Continue waiting for exit status after EOF\n  collect_output_with_deadline(port, acc, deadline_ms)\n}\n```\n\nAlternatively, if EOF-only is acceptable as success for these simple commands (`--version`, `--help`), update the docstring to reflect this behavior.\n\n**Note:** This is low priority because:\n- EOF is platform-dependent and rare (per design doc)\n- Current use cases (`--version`, `--help`) reliably send ExitStatus\n- Main SDK treats EOF-without-ExitStatus as acceptable edge case\n\n---\n\n\u003c!-- fp:f84ca27182adf6e3 --\u003e\n\u003c!-- review_finding:db4c3ad6d6f2 --\u003e","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-11T03:03:16.746483805Z","created_by":"cyou","updated_at":"2026-01-11T03:09:49.385717751Z","closed_at":"2026-01-11T03:09:49.385717751Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-axf.7"],"dependencies":[{"issue_id":"casg-axf.9","depends_on_id":"casg-axf","type":"parent-child","created_at":"2026-01-11T03:03:16.7471611Z","created_by":"cyou"}]}
{"id":"casg-ayj","title":"[Review] 2 non-blocking findings from casg-xjv.6","description":"## Review Findings\n\nThis issue consolidates 2 non-blocking findings from code review.\n\n**Source issue:** casg-xjv.6\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P3] New test duplicates existing non-zero exit coverage\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** test/stream_test.gleam:1278-1292\n\nThe new test `nonzero_exit_via_real_port_test` (lines 1278-1292) is redundant with the existing test `exit_nonzero_empty_stdout_yields_process_error_with_stdout_was_empty_test` (lines 1355-1374).\n\n**Both tests:**\n- Execute `/bin/sh -c \"exit 42\"`\n- Verify exit code is 42\n- Verify `diagnostic.stdout_was_empty` is true\n- Verify stream is closed\n\n**The existing test is more thorough:** it also validates `diagnostic.last_non_json_line` is None.\n\n**Recommendation:** Remove the new `nonzero_exit_via_real_port_test` as it provides no additional coverage beyond the existing test. The commit message claims \"existing tests at lines 1294+ already cover exit-status handling,\" yet adds this duplicate test anyway.\n\n---\n\n### Finding 2: [P2] Commit message claim about 'result sequencing' is misleading\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n\nThe commit message states: \"The existing tests at lines 1294+ already cover: Buffer overflow, exit-status handling, result sequencing via real ports\"\n\nHowever, examination of tests at lines 1294+ shows they do NOT cover \"result sequencing\" (reading multiple valid messages in sequence). The tests at those lines only cover:\n- Empty stdout warnings (line 1300)\n- Incomplete line warnings (line 1324)\n- Non-zero exit errors (line 1355)\n\n**Actual situation:** The new `multi_line_ndjson_stream_via_real_port_test` appears to be the FIRST test that validates reading 3 consecutive valid NDJSON messages via real ports. This is valuable new coverage that replaces the mock-based test.\n\n**Recommendation:** Update the commit message to accurately reflect that this test adds NEW coverage for multi-message sequencing, not just replaces mock-based tests with equivalent real-port tests.\n\n---\n\n\u003c!-- fp:bcb0111f1b008090 --\u003e\n\u003c!-- fp:06413800161816c5 --\u003e\n\u003c!-- review_finding:77f5a26cb9bf --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T05:07:17.06592691Z","created_by":"cyou","updated_at":"2026-01-11T05:09:21.806637666Z","closed_at":"2026-01-11T05:09:21.806637666Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-xjv.6"]}
{"id":"casg-bev","title":"Fix query() to honor test_mode/test_runner (no real CLI when enabled)","notes":"SELF-DOC UPDATE (2026-01-11)\nCONTEXT:\n- `query()` should respect test_mode/test_runner so unit tests never touch the real CLI.\n- Current flow risks invoking CLI discovery/version checks when test_mode is enabled.\n\nGOAL / OUTCOME:\n- When `test_mode=True` and `test_runner` is provided, query() must avoid all real CLI work.\n- If test_mode is enabled without a runner, return a clear error immediately.\n\nSUBTASKS:\n- Audit `query()` and `spawn_query()` flow in `src/claude_agent_sdk.gleam`.\n- Ensure test_mode path never calls `port_ffi.find_cli_path` or version checks.\n- Add or update tests to lock behavior (prefer unit-level coverage).\n\nFILES (planned):\n- `src/claude_agent_sdk.gleam` (query/test_mode path).\n- `test/query_integration_test.gleam` or a targeted unit test module for regression coverage.\n\nDEPENDENCIES:\n- casg-1ku depends on this because both touch `src/claude_agent_sdk.gleam`.\n\nCONSIDERATIONS:\n- Maintain existing public API behavior; only adjust test-mode branching.\n- Avoid reintroducing test_runner usage in unit tests beyond what policy allows.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-11T04:20:48.396784992Z","created_by":"cyou","updated_at":"2026-01-11T05:04:46.094541253Z","closed_at":"2026-01-11T05:04:46.094541253Z","close_reason":"Closed"}
{"id":"casg-bus","title":"[P2] Fix stale docs claiming `{packet, 0}` is used","description":"## Review Finding\n\n**Priority:** P2\n**Trigger:** run_end\n**Baseline:** 6b1bc9c..548f92b\n**Location:** src/claude_agent_sdk/internal/bidir_runner.gleam:39-42\n\n---\n\n`src/claude_agent_sdk_ffi.erl` removes `{packet, 0}` from `open_port_bidir/2`, but `bidir_runner.gleam` still documents that bidir ports use `{packet, 0}`. This will mislead future changes/debugging around port framing.\n\nConcrete impact: engineers may assume framing/packet options are present when diagnosing stream parsing behavior.\n\n```gleam\n/// Uses spawn_executable with binary, {packet, 0}, exit_status, use_stdio,\n```\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T07:42:41.849901713Z","created_by":"cyou","updated_at":"2026-01-12T15:09:01.488370819Z","closed_at":"2026-01-12T15:09:01.488370819Z","close_reason":"Closed","labels":["auto_generated","cumulative-review","fp:45eb33b9dbc4c51a","review_finding","trigger:run_end"]}
{"id":"casg-de0","title":"Epic: Bidirectional Protocol - Control Types \u0026 Protocol","description":"## Overview\nDefine control message types, wire format encoders/decoders, request ID tracking, and hook types. This defines the interfaces everything else uses.\n\n## Source Plan\n`plans/2026-01-12-bidir-protocol-plan.md` - \"Data Model\" and \"Control Message Wire Format\" sections\n\n## Key Deliverables\n- control.gleam: OutgoingControlRequest, IncomingMessage, IncomingControlRequest, IncomingControlResponse types\n- hook.gleam: HookEvent, context types (PreToolUseContext, etc.), HookResult, PermissionResult\n- internal/control_decoder.gleam: JSON decoders for control_request/control_response\n- internal/control_encoder.gleam: JSON encoders for outgoing messages\n- internal/request_tracker.gleam: Request ID generation, correlation\n\n## Wire Format (NDJSON)\nSDK→CLI: `{\"type\":\"control_request\",\"request_id\":\"req_N\",\"request\":{\"subtype\":\"...\"}}`\nCLI→SDK: `{\"type\":\"control_response\",\"response\":{\"subtype\":\"success|error\",\"request_id\":\"...\"}}`\n\n## TDD Focus\n- Round-trip encode/decode tests for ALL message types\n- Tolerant decoding (request_id at response.request_id OR top-level)\n- Exact enum/string values per spec\n\n## Files\n- src/claude_agent_sdk/control.gleam (New)\n- src/claude_agent_sdk/hook.gleam (New)\n- src/claude_agent_sdk/internal/control_decoder.gleam (New)\n- src/claude_agent_sdk/internal/control_encoder.gleam (New)\n- src/claude_agent_sdk/internal/request_tracker.gleam (New)\n- test/control_test.gleam (New)\n- test/hook_test.gleam (New)","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-12T04:06:49.51332211Z","created_by":"cyou","updated_at":"2026-01-12T05:39:17.96170023Z","closed_at":"2026-01-12T05:39:17.96170023Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-de0","depends_on_id":"casg-4re","type":"blocks","created_at":"2026-01-12T04:07:43.604914724Z","created_by":"cyou"}]}
{"id":"casg-de0.1","title":"Control message types","description":"## Overview\nDefine the core control message types that enable bidirectional communication between SDK and CLI. This is the foundation for all control operations.\n\n## TDD Approach\n1. Create skeleton types that compile\n2. Write failing test: `decode_line` returns correct variant\n3. Types will be populated in encoder/decoder tasks\n\n## Types to Define\n\n### OutgoingControlRequest (SDK → CLI)\n```gleam\npub type OutgoingControlRequest {\n  Initialize(request_id: String, hooks: List(HookRegistration), mcp_servers: List(String), enable_file_checkpointing: Bool)\n  Interrupt(request_id: String)\n  SetPermissionMode(request_id: String, mode: PermissionMode)\n  SetModel(request_id: String, model: String)\n  RewindFiles(request_id: String, user_message_id: String)\n}\n```\n\n### IncomingMessage (CLI → SDK, decoder output)\n```gleam\npub type IncomingMessage {\n  RegularMessage(Message)\n  ControlRequest(IncomingControlRequest)\n  ControlResponse(IncomingControlResponse)\n}\n```\n\n### IncomingControlRequest (CLI-initiated)\n```gleam\npub type IncomingControlRequest {\n  HookCallback(request_id: String, callback_id: String, input: Dynamic, tool_use_id: Option(String))\n  CanUseTool(request_id: String, tool_name: String, input: Dynamic, permission_suggestions: List(String), blocked_path: Option(String))\n  McpMessage(request_id: String, server_name: String, message: Dynamic)\n}\n```\n\n### IncomingControlResponse\n```gleam\npub type IncomingControlResponse {\n  Success(request_id: String, payload: Dynamic)\n  Error(request_id: String, message: String)\n}\n```\n\n### OutgoingControlResponse\n```gleam\npub type OutgoingControlResponse {\n  HookResponse(request_id: String, result: HookResult)\n  PermissionResponse(request_id: String, result: PermissionResult)\n  McpResponse(request_id: String, response: Dynamic)\n}\n```\n\n## Files\n- src/claude_agent_sdk/control.gleam - Type definitions\n- test/control_types_test.gleam - Construction tests\n\n## Acceptance Criteria\n- All types compile without errors\n- Types are exported from control.gleam\n- Placeholder test file exists with failing decode_line test\n- PermissionMode, HookRegistration also defined\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:09:38.630866706Z","created_by":"cyou","updated_at":"2026-01-12T05:08:19.143530952Z","closed_at":"2026-01-12T05:08:19.143530952Z","close_reason":"Closed","labels":["integration-path-test"],"dependencies":[{"issue_id":"casg-de0.1","depends_on_id":"casg-de0","type":"parent-child","created_at":"2026-01-12T04:09:38.631506825Z","created_by":"cyou"}]}
{"id":"casg-de0.2","title":"Hook context types","description":"## Overview\nDefine hook-related types for all supported hook events. These types enable type-safe hook callbacks with context-specific data.\n\n## TDD Approach\n1. Define all context types for each hook event\n2. Define HookResult and PermissionResult enums\n3. Write tests that construct each context type\n\n## Types to Define\n\n### Hook Events\n```gleam\npub type HookEvent {\n  PreToolUse\n  PostToolUse\n  UserPromptSubmit\n  Stop\n  SubagentStop\n  PreCompact\n}\n```\n\n### Context Types (per event)\n```gleam\npub type PreToolUseContext {\n  PreToolUseContext(tool_name: String, tool_input: Dynamic, session_id: String)\n}\n\npub type PostToolUseContext {\n  PostToolUseContext(tool_name: String, tool_input: Dynamic, tool_output: Dynamic, session_id: String)\n}\n\npub type CanUseToolContext {\n  CanUseToolContext(tool_name: String, tool_input: Dynamic, session_id: String, permission_suggestions: List(String), blocked_path: Option(String))\n}\n\npub type UserPromptSubmitContext {\n  UserPromptSubmitContext(prompt: String, session_id: String)\n}\n\npub type StopContext {\n  StopContext(reason: String, session_id: String)\n}\n\npub type SubagentStopContext {\n  SubagentStopContext(subagent_id: String, reason: String, session_id: String)\n}\n\npub type PreCompactContext {\n  PreCompactContext(session_id: String)\n}\n```\n\n### Result Types\n```gleam\npub type HookResult {\n  Continue\n  Block(reason: String)\n  ModifyInput(new_input: Dynamic)\n}\n\npub type PermissionResult {\n  Allow\n  Deny(reason: String)\n}\n```\n\n### HookInput (for decoder, typed later)\n```gleam\npub type HookInput {\n  PreToolUseInput(PreToolUseContext)\n  PostToolUseInput(PostToolUseContext)\n  UserPromptSubmitInput(UserPromptSubmitContext)\n  StopInput(StopContext)\n  SubagentStopInput(SubagentStopContext)\n  PreCompactInput(PreCompactContext)\n}\n```\n\n## Files\n- src/claude_agent_sdk/hook.gleam - Type definitions\n- test/hook_types_test.gleam - Construction tests\n\n## Acceptance Criteria\n- All context types compile without errors\n- HookResult and PermissionResult are defined\n- HookEvent enum covers all supported events\n- Test file with construction tests for each type\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:11:28.341574015Z","created_by":"cyou","updated_at":"2026-01-12T05:02:52.311928046Z","closed_at":"2026-01-12T05:02:52.311928046Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-de0.2","depends_on_id":"casg-de0","type":"parent-child","created_at":"2026-01-12T04:11:28.342572203Z","created_by":"cyou"}]}
{"id":"casg-de0.3","title":"Control message encoder","description":"## Overview\nImplement JSON encoder for OutgoingControlRequest and OutgoingControlResponse types. Produces NDJSON format for wire transmission.\n\n## TDD Approach\n1. Write failing test: initialize request encodes to correct NDJSON\n2. Implement encoder for each OutgoingControlRequest variant\n3. Implement encoder for OutgoingControlResponse variants\n4. Test round-trip with decoder (in decoder task)\n\n## Wire Format\n\n### SDK → CLI: Control Requests\n```json\n// Initialize\n{\"type\":\"control_request\",\"request_id\":\"req_0\",\"request\":{\"subtype\":\"initialize\",\"hooks\":{\"PreToolUse\":[{\"matcher\":null,\"hookCallbackIds\":[\"hook_0\"]}]},\"mcp_servers\":[\"my-server\"],\"enable_file_checkpointing\":true}}\n\n// Interrupt\n{\"type\":\"control_request\",\"request_id\":\"req_1\",\"request\":{\"subtype\":\"interrupt\"}}\n\n// Set permission mode\n{\"type\":\"control_request\",\"request_id\":\"req_2\",\"request\":{\"subtype\":\"set_permission_mode\",\"mode\":\"acceptEdits\"}}\n\n// Set model\n{\"type\":\"control_request\",\"request_id\":\"req_3\",\"request\":{\"subtype\":\"set_model\",\"model\":\"sonnet\"}}\n\n// Rewind files\n{\"type\":\"control_request\",\"request_id\":\"req_4\",\"request\":{\"subtype\":\"rewind_files\",\"user_message_id\":\"msg_123\"}}\n```\n\n### SDK → CLI: Control Responses (to CLI-initiated requests)\n```json\n// Hook response (continue)\n{\"type\":\"control_response\",\"response\":{\"subtype\":\"success\",\"request_id\":\"cli_1\",\"response\":{\"continue\":true}}}\n\n// Hook response (block)\n{\"type\":\"control_response\",\"response\":{\"subtype\":\"success\",\"request_id\":\"cli_1\",\"response\":{\"continue\":false,\"stopReason\":\"Blocked by policy\"}}}\n\n// Hook response (modify input)\n{\"type\":\"control_response\",\"response\":{\"subtype\":\"success\",\"request_id\":\"cli_1\",\"response\":{\"continue\":true,\"hookSpecificOutput\":{\"hookEventName\":\"PreToolUse\",\"updatedInput\":{\"command\":\"ls -la\"}}}}}\n\n// Permission response\n{\"type\":\"control_response\",\"response\":{\"subtype\":\"success\",\"request_id\":\"cli_2\",\"response\":{\"behavior\":\"allow\"}}}\n{\"type\":\"control_response\",\"response\":{\"subtype\":\"success\",\"request_id\":\"cli_2\",\"response\":{\"behavior\":\"deny\",\"message\":\"Not permitted\"}}}\n\n// MCP response\n{\"type\":\"control_response\",\"response\":{\"subtype\":\"success\",\"request_id\":\"cli_3\",\"response\":{\"mcp_response\":{...}}}}\n```\n\n## Functions to Implement\n```gleam\n/// Encode outgoing control request to JSON string (no trailing newline)\npub fn encode_request(request: OutgoingControlRequest) -\u003e String\n\n/// Encode outgoing control response to JSON string (no trailing newline)\npub fn encode_response(response: OutgoingControlResponse) -\u003e String\n```\n\n## Files\n- src/claude_agent_sdk/internal/control_encoder.gleam - Encoder implementation\n- test/control_encoder_test.gleam - Encoding tests\n\n## Acceptance Criteria\n- encode_request handles all OutgoingControlRequest variants\n- encode_response handles all OutgoingControlResponse variants\n- Output is valid single-line JSON (no newlines within)\n- HookResult variants encode correctly (Continue, Block, ModifyInput)\n- PermissionResult variants encode correctly (Allow, Deny)\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:11:28.889283294Z","created_by":"cyou","updated_at":"2026-01-12T05:29:07.558850152Z","closed_at":"2026-01-12T05:29:07.558850152Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-de0.3","depends_on_id":"casg-de0","type":"parent-child","created_at":"2026-01-12T04:11:28.890024383Z","created_by":"cyou"},{"issue_id":"casg-de0.3","depends_on_id":"casg-de0.1","type":"blocks","created_at":"2026-01-12T04:11:38.249585699Z","created_by":"cyou"},{"issue_id":"casg-de0.3","depends_on_id":"casg-de0.2","type":"blocks","created_at":"2026-01-12T04:25:53.3156182Z","created_by":"cyou"}]}
{"id":"casg-de0.4","title":"Control message decoder","description":"## Overview\nImplement JSON decoder for all incoming messages from CLI. Produces unified IncomingMessage type with discrimination by message type.\n\n## TDD Approach\n1. Write failing test: decode control_request returns IncomingControlRequest\n2. Write failing test: decode control_response returns IncomingControlResponse\n3. Write failing test: decode regular message returns RegularMessage\n4. Implement decoder with proper type discrimination\n5. Test round-trip with encoder\n\n## Decoding Flow\n\n1. Parse JSON line\n2. Check top-level `type` field:\n   - `\"control_request\"` → parse `request.subtype` → IncomingControlRequest\n   - `\"control_response\"` → parse `response.subtype` → IncomingControlResponse\n   - `\"system\"` / `\"assistant\"` / `\"user\"` / `\"result\"` → RegularMessage\n\n### For control_request (CLI → SDK invocations)\nExtract `request.subtype`:\n- `\"hook_callback\"` → HookCallback(request_id, callback_id, input, tool_use_id)\n- `\"can_use_tool\"` → CanUseTool(request_id, tool_name, input, permission_suggestions, blocked_path)\n- `\"mcp_message\"` → McpMessage(request_id, server_name, message)\n\n### For control_response (CLI → SDK responses)\nExtract `response.subtype`:\n- `\"success\"` → Success(request_id, payload)\n- `\"error\"` → Error(request_id, message)\n\n## Tolerant Decoding\n- request_id may be at `response.request_id` OR top-level\n- Unknown fields should be ignored\n- Missing optional fields should default gracefully\n\n## Wire Format Examples\n```json\n// Hook callback\n{\"type\":\"control_request\",\"request_id\":\"cli_1\",\"request\":{\"subtype\":\"hook_callback\",\"callback_id\":\"hook_0\",\"input\":{\"hook_event_name\":\"PreToolUse\",\"session_id\":\"abc123\",\"tool_name\":\"Bash\",\"tool_input\":{\"command\":\"ls\"}},\"tool_use_id\":\"toolu_01ABC\"}}\n\n// Permission callback\n{\"type\":\"control_request\",\"request_id\":\"cli_2\",\"request\":{\"subtype\":\"can_use_tool\",\"tool_name\":\"Write\",\"input\":{\"file_path\":\"/etc/passwd\"},\"permission_suggestions\":[\"deny\"],\"blocked_path\":\"/etc\"}}\n\n// Success response\n{\"type\":\"control_response\",\"response\":{\"subtype\":\"success\",\"request_id\":\"req_0\",\"response\":{\"supported_commands\":[\"interrupt\"]}}}\n\n// Error response\n{\"type\":\"control_response\",\"response\":{\"subtype\":\"error\",\"request_id\":\"req_1\",\"error\":\"Operation not supported\"}}\n```\n\n## Functions to Implement\n```gleam\n/// Main entry point: decode NDJSON line → IncomingMessage\npub fn decode_line(json: String) -\u003e Result(IncomingMessage, DecodeError)\n\n/// Decode error type\npub type DecodeError {\n  JsonError(String)\n  MissingField(String)\n  InvalidType(String)\n  UnknownSubtype(String)\n}\n```\n\n## Files\n- src/claude_agent_sdk/internal/control_decoder.gleam - Decoder implementation\n- test/control_decoder_test.gleam - Decoding tests\n\n## Acceptance Criteria\n- decode_line handles all IncomingMessage variants\n- Tolerant decoding for request_id location\n- Unknown fields are ignored (forward compatibility)\n- Clear error messages for malformed JSON\n- Round-trip test with encoder passes\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:11:29.392485767Z","created_by":"cyou","updated_at":"2026-01-12T05:19:15.77384361Z","closed_at":"2026-01-12T05:19:15.77384361Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-de0.4","depends_on_id":"casg-de0","type":"parent-child","created_at":"2026-01-12T04:11:29.393109296Z","created_by":"cyou"},{"issue_id":"casg-de0.4","depends_on_id":"casg-de0.1","type":"blocks","created_at":"2026-01-12T04:11:38.74132386Z","created_by":"cyou"}]}
{"id":"casg-de0.5","title":"Request ID tracker","description":"## Overview\nImplement request ID generation and tracking for correlating SDK-initiated requests with CLI responses.\n\n## TDD Approach\n1. Write failing test: generate_id produces unique IDs\n2. Write failing test: add_pending stores request kind\n3. Write failing test: get_pending retrieves by ID\n4. Write failing test: remove_pending clears entry\n5. Implement tracker with proper state management\n\n## Request ID Format\n- Pattern: `req_\u003ccounter\u003e` (e.g., \"req_0\", \"req_1\", \"req_2\")\n- Counter starts at 0 and increments monotonically\n- IDs are unique within a session\n\n## Pending Request Tracking\nTrack what operation each request_id is waiting for:\n\n```gleam\npub type PendingRequestKind {\n  InitializeOp\n  InterruptOp\n  SetPermissionModeOp\n  SetModelOp\n  RewindFilesOp\n}\n\npub type RequestTracker {\n  RequestTracker(\n    next_id: Int,\n    pending: Dict(String, PendingRequestKind),\n  )\n}\n```\n\n## Functions to Implement\n```gleam\n/// Create a new request tracker\npub fn new() -\u003e RequestTracker\n\n/// Generate a new unique request ID\npub fn generate_id(tracker: RequestTracker) -\u003e #(RequestTracker, String)\n\n/// Add a pending request\npub fn add_pending(tracker: RequestTracker, request_id: String, kind: PendingRequestKind) -\u003e RequestTracker\n\n/// Get pending request kind by ID\npub fn get_pending(tracker: RequestTracker, request_id: String) -\u003e Option(PendingRequestKind)\n\n/// Remove pending request (after response received)\npub fn remove_pending(tracker: RequestTracker, request_id: String) -\u003e RequestTracker\n\n/// Check if any requests are pending\npub fn has_pending(tracker: RequestTracker) -\u003e Bool\n```\n\n## Usage Pattern\n```gleam\nlet tracker = request_tracker.new()\nlet #(tracker, id) = request_tracker.generate_id(tracker)\n// id = \"req_0\"\nlet tracker = request_tracker.add_pending(tracker, id, InitializeOp)\n// ... send request with id ...\n// ... receive response with id ...\nlet kind = request_tracker.get_pending(tracker, id)\n// kind = Some(InitializeOp)\nlet tracker = request_tracker.remove_pending(tracker, id)\n```\n\n## Files\n- src/claude_agent_sdk/internal/request_tracker.gleam - Tracker implementation\n- test/request_tracker_test.gleam - Tracker tests\n\n## Acceptance Criteria\n- generate_id produces sequential unique IDs\n- add_pending/get_pending round-trip works\n- remove_pending clears entry\n- has_pending returns correct status\n- Thread-safe for use with OTP actors\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:11:29.92413146Z","created_by":"cyou","updated_at":"2026-01-12T05:23:13.842032807Z","closed_at":"2026-01-12T05:23:13.842032807Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-de0.5","depends_on_id":"casg-de0","type":"parent-child","created_at":"2026-01-12T04:11:29.924799139Z","created_by":"cyou"},{"issue_id":"casg-de0.5","depends_on_id":"casg-de0.1","type":"blocks","created_at":"2026-01-12T04:11:44.135017838Z","created_by":"cyou"}]}
{"id":"casg-de0.6","title":"Hook input decoders","description":"## Overview\nImplement typed decoders for hook input payloads. The control_decoder produces Dynamic input; this module decodes it to typed context based on event type.\n\n## TDD Approach\n1. Write failing test: decode PreToolUse input to PreToolUseContext\n2. Write failing test: decode PostToolUse input to PostToolUseContext\n3. Implement decoder for each event type\n4. Test error handling for malformed input\n\n## Decoding Architecture\n\nThe flow is:\n1. `control_decoder.gleam` produces `IncomingControlRequest.HookCallback(request_id, callback_id, input: Dynamic, tool_use_id)`\n2. GenServer looks up callback_id → finds HookEvent type and user callback\n3. `hook.gleam` decodes `input: Dynamic` → typed context (e.g., PreToolUseContext)\n4. User callback receives typed context, returns HookResult\n\n## Wire Format for Hook Input\n```json\n// PreToolUse\n{\"hook_event_name\":\"PreToolUse\",\"session_id\":\"abc123\",\"tool_name\":\"Bash\",\"tool_input\":{\"command\":\"ls\"}}\n\n// PostToolUse\n{\"hook_event_name\":\"PostToolUse\",\"session_id\":\"abc123\",\"tool_name\":\"Bash\",\"tool_input\":{\"command\":\"ls\"},\"tool_result\":{\"output\":\"file1.txt\"}}\n\n// UserPromptSubmit\n{\"hook_event_name\":\"UserPromptSubmit\",\"session_id\":\"abc123\",\"prompt\":\"Hello Claude\"}\n\n// Stop\n{\"hook_event_name\":\"Stop\",\"session_id\":\"abc123\",\"reason\":\"task_complete\"}\n\n// SubagentStop\n{\"hook_event_name\":\"SubagentStop\",\"session_id\":\"abc123\",\"subagent_id\":\"sub_1\",\"reason\":\"finished\"}\n\n// PreCompact\n{\"hook_event_name\":\"PreCompact\",\"session_id\":\"abc123\"}\n```\n\n## Functions to Implement\n```gleam\n/// Decode hook input to typed context based on event type\npub fn decode_hook_input(event: HookEvent, input: Dynamic) -\u003e Result(HookInput, DecodeError)\n\n/// Individual decoders (internal, called by decode_hook_input)\nfn decode_pre_tool_use(input: Dynamic) -\u003e Result(PreToolUseContext, DecodeError)\nfn decode_post_tool_use(input: Dynamic) -\u003e Result(PostToolUseContext, DecodeError)\nfn decode_user_prompt_submit(input: Dynamic) -\u003e Result(UserPromptSubmitContext, DecodeError)\nfn decode_stop(input: Dynamic) -\u003e Result(StopContext, DecodeError)\nfn decode_subagent_stop(input: Dynamic) -\u003e Result(SubagentStopContext, DecodeError)\nfn decode_pre_compact(input: Dynamic) -\u003e Result(PreCompactContext, DecodeError)\n```\n\n## Error Handling\n```gleam\npub type HookDecodeError {\n  MissingField(field: String)\n  WrongType(field: String, expected: String)\n  UnknownEventName(name: String)\n}\n```\n\n## Files\n- src/claude_agent_sdk/hook.gleam - Extends with decode_hook_input\n- test/hook_decode_test.gleam - Decoder tests\n\n## Acceptance Criteria\n- decode_hook_input dispatches correctly based on HookEvent\n- Each context type decodes all required fields\n- Missing fields produce clear error messages\n- Unknown fields are ignored (forward compatibility)\n- tool_input and tool_output remain as Dynamic (user decodes as needed)\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:11:30.428264868Z","created_by":"cyou","updated_at":"2026-01-12T05:36:51.475534315Z","closed_at":"2026-01-12T05:36:51.475534315Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-de0.6","depends_on_id":"casg-de0","type":"parent-child","created_at":"2026-01-12T04:11:30.428880247Z","created_by":"cyou"},{"issue_id":"casg-de0.6","depends_on_id":"casg-de0.2","type":"blocks","created_at":"2026-01-12T04:11:39.819979865Z","created_by":"cyou"},{"issue_id":"casg-de0.6","depends_on_id":"casg-de0.4","type":"blocks","created_at":"2026-01-12T04:11:40.356460788Z","created_by":"cyou"}]}
{"id":"casg-de0.7","title":"[Review] 3 non-blocking findings from casg-de0.2","description":"## Review Findings\n\nThis issue consolidates 3 non-blocking findings from code review.\n\n**Source issue:** casg-de0.2\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Avoid duplicating incompatible `PermissionResult`/`HookResult` names\n\n**Priority:** P2\n**Reviewer:** codex\n**Location:** src/claude_agent_sdk/hook.gleam:151-185\n\n`src/claude_agent_sdk/hook.gleam` introduces `pub type HookResult` and `pub type PermissionResult` with different variants than the already-existing `claude_agent_sdk/control` module.\n\nConcrete failure/bug path: any code that imports both modules (or expects to pass a permission/hook result across the control protocol boundary) can easily end up with the wrong `PermissionResult`/`HookResult` type, since the names match but the shapes differ. For example, `claude_agent_sdk/control.PermissionResult` supports `AllowOnce`, `AllowAll`, and `Edit(modified_input: Dynamic)`, while `claude_agent_sdk/hook.PermissionResult` only has `Allow`/`Deny(reason: String)`. That mismatch makes it easy to accidentally construct or pattern-match the wrong type and not handle important cases.\n\nThis is especially risky because the new test file imports `type PermissionResult` unqualified from `claude_agent_sdk/hook`, which would mask `control.PermissionResult` if both are in scope.\n\n\n---\n\n### Finding 2: [P2] Add `CanUseToolContext` to typed `HookInput` union\n\n**Priority:** P2\n**Reviewer:** codex\n**Location:** src/claude_agent_sdk/hook.gleam:94-202\n\n`src/claude_agent_sdk/hook.gleam` defines `pub type CanUseToolContext`, but `pub type HookInput` has no variant that can carry this context.\n\nConcrete failure path: if the runtime/hook system emits a can-use-tool hook payload, any decoder built around `HookInput` cannot represent that event in the typed union, forcing either a decode failure or an untyped escape hatch. Given this module’s stated purpose (“typed hook input for decoding incoming hook callbacks”), the missing variant undermines type-safe handling of that supported hook context.\n\n\n---\n\n### Finding 3: [P3] Non-idiomatic dynamic conversion in tests\n\n**Priority:** P3\n**Reviewer:** gemini\n**Location:** test/hook_types_test.gleam:18-19\n\nThe test file defines a custom `to_dynamic` helper using an external Erlang binding (`@external(erlang, \"gleam_stdlib\", \"identity\")`). `gleam/dynamic` provides a standard, cross-platform `from` function (`dynamic.from`) that should be used instead.\n\n---\n\n\u003c!-- fp:d294fdf00485ed1d --\u003e\n\u003c!-- fp:65224698ea947d59 --\u003e\n\u003c!-- fp:bff856c758a09d7f --\u003e\n\u003c!-- review_finding:729ae6cfdf7c --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T05:02:52.520597268Z","created_by":"cyou","updated_at":"2026-01-12T05:09:46.278570774Z","closed_at":"2026-01-12T05:09:46.278570774Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-de0.2"],"dependencies":[{"issue_id":"casg-de0.7","depends_on_id":"casg-de0","type":"parent-child","created_at":"2026-01-12T05:02:52.521206535Z","created_by":"cyou"}]}
{"id":"casg-de0.8","title":"[Review] 1 non-blocking finding from casg-de0.6","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-de0.6\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Ensure UnknownEventName is reachable or remove it\n\n**Priority:** P2\n**Reviewer:** codex\n**Location:** src/claude_agent_sdk/hook.gleam:218-248\n\n`HookDecodeError.UnknownEventName` is defined/exported but no code path can currently return it: none of the decoders read `hook_event_name`, and `decode_errors_to_hook_error` only maps to `MissingField`/`WrongType`. This makes the error variant effectively dead and means event/type mismatches won’t be detected by this module.\n\nConcrete impact: a caller can pass `event = Stop` with a payload whose `hook_event_name` is something else; the error will be a missing field like `MissingField(\"reason\")` rather than a clearer event mismatch, and `UnknownEventName` will never be raised.\n\nIf you intend to keep `UnknownEventName`, add a check (in each decoder or in `decode_hook_input`) that reads `hook_event_name` and compares it to the expected name; otherwise, remove the variant and stop importing it in tests.\n\n---\n\n\u003c!-- fp:4afc18d86397f128 --\u003e\n\u003c!-- review_finding:f15f5f9dcd08 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T05:39:18.074413245Z","created_by":"cyou","updated_at":"2026-01-12T05:49:39.381918919Z","closed_at":"2026-01-12T05:49:39.381918919Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-de0.6"],"dependencies":[{"issue_id":"casg-de0.8","depends_on_id":"casg-de0","type":"parent-child","created_at":"2026-01-12T05:39:18.074923022Z","created_by":"cyou"}]}
{"id":"casg-de0.9","title":"[Review] 1 non-blocking finding from casg-de0.8","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-de0.8\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Handle type errors for hook_event_name\n\n**Priority:** P2\n**Reviewer:** gemini\n**Location:** src/claude_agent_sdk/hook.gleam:256\n\nThe current `Error(_) -\u003e Error(MissingField(\"hook_event_name\"))` catch-all conflates missing fields with type mismatches (e.g., if `hook_event_name` is a number). This is inconsistent with the rest of the module, which uses `WrongType` for type errors.\n\nUse the existing `decode_errors_to_hook_error` helper to correctly preserve error granularity:\n\n```gleam\ncase decode.run(input, name_decoder) {\n  Error(errs) -\u003e Error(decode_errors_to_hook_error(errs))\n  Ok(actual_name) -\u003e ...\n}\n```\n\n---\n\n\u003c!-- fp:f4ced1c5d592e7e4 --\u003e\n\u003c!-- review_finding:a47435aa5ee9 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T05:49:39.49729052Z","created_by":"cyou","updated_at":"2026-01-12T06:00:17.594155376Z","closed_at":"2026-01-12T06:00:17.594155376Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-de0.8"],"dependencies":[{"issue_id":"casg-de0.9","depends_on_id":"casg-de0","type":"parent-child","created_at":"2026-01-12T05:49:39.497785418Z","created_by":"cyou"}]}
{"id":"casg-g03","title":"Epic 5: Documentation \u0026 Polish","description":"## Overview\nComplete SDK documentation including module docs, README with examples, and polish items.\n\n## Scope\n1. **Module Documentation**:\n   - All public modules have doc comments\n   - API examples in doc comments\n   - Cross-references to related modules\n\n2. **README.md**:\n   - Installation instructions\n   - Quick start example\n   - API overview\n   - Process ownership documentation\n   - Cancellation recipe (gleam_otp example)\n   - Integration test setup instructions\n\n3. **Blocking Behavior Documentation**:\n   - next() blocks until data\n   - Cross-process use is undefined behavior\n   - OTP wrapper pattern for cancellation\n\n4. **Example Code** (inline in README):\n   - Basic query iteration\n   - with_stream usage\n   - Error handling patterns\n   - Session resume\n\n## Success Criteria\n- All public functions documented\n- README has complete getting started guide\n- Process ownership constraints clearly documented\n- Examples compile and run\n\n## Dependencies\n- Depends on Epic 2, 3, 4 (all features must be complete)\n\n## Plan References\n- Phase 4: Documentation\n- Process Ownership Contract (CRITICAL)\n- Cancellation Pattern Recipe","status":"closed","priority":3,"issue_type":"epic","created_at":"2026-01-10T23:19:45.514484408Z","created_by":"cyou","updated_at":"2026-01-11T04:08:35.007473319Z","closed_at":"2026-01-11T04:08:35.007473319Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-g03","depends_on_id":"casg-j37","type":"blocks","created_at":"2026-01-10T23:19:52.343119077Z","created_by":"cyou"},{"issue_id":"casg-g03","depends_on_id":"casg-tc3","type":"blocks","created_at":"2026-01-10T23:19:52.397471436Z","created_by":"cyou"},{"issue_id":"casg-g03","depends_on_id":"casg-axf","type":"blocks","created_at":"2026-01-10T23:19:52.452163173Z","created_by":"cyou"}]}
{"id":"casg-g03.1","title":"Add module documentation for all public APIs","description":"## Overview\nAdd comprehensive doc comments to all public modules, types, and functions in the SDK.\n\n## Deliverables\n\n### Public Modules to Document\n- `claude_agent_sdk` - Main entry point with `query()` and core re-exports\n- `claude_agent_sdk/options` - QueryOptions type + builder helpers\n- `claude_agent_sdk/stream` - Stream types (`QueryStream`, `StreamItem`, `next()`, `close()`)\n- `claude_agent_sdk/message` - Message types from Claude CLI\n- `claude_agent_sdk/content` - Content block types\n- `claude_agent_sdk/error` - QueryError, StreamError, Warning, ErrorDiagnostic\n- `claude_agent_sdk/runner` - `test_runner()` (test-only helper)\n\n### Documentation Standards\nEach public function/type needs:\n- Brief description (first line)\n- Parameters with expected values\n- Return value semantics\n- Example usage where helpful\n- Cross-references to related functions\n\n### Critical Warnings to Include\n- `QueryStream`: \"Single-process only. Use from the process that created it.\"\n- `next()`: \"Blocks until next message. Cannot be cancelled from another process.\"\n- `close()`: \"Only effective when called by the process that spawned the query.\"\n\n### Gleam Doc Comment Format\n```gleam\n/// Brief description of the function.\n///\n/// Longer description with details about behavior,\n/// edge cases, and important notes.\n///\n/// ## Example\n/// ```gleam\n/// let result = my_function(arg)\n/// ```\npub fn my_function(arg: Type) -\u003e ReturnType\n```\n\n## Acceptance Criteria\n- [ ] All public types have doc comments\n- [ ] All public functions have doc comments  \n- [ ] Process ownership warnings present on stream functions\n- [ ] `gleam docs build` succeeds without warnings\n- [ ] Generated docs are readable and complete\n","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-10T23:21:39.991194163Z","created_by":"cyou","updated_at":"2026-01-11T03:32:05.529611917Z","closed_at":"2026-01-11T03:32:05.529611917Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-g03.1","depends_on_id":"casg-g03","type":"parent-child","created_at":"2026-01-10T23:21:39.991805169Z","created_by":"cyou"}]}
{"id":"casg-g03.2","title":"Create comprehensive README.md","description":"## Overview\nCreate the main README.md with installation instructions, quick start guide, API overview, and critical usage warnings.\n\n## README Structure\n\n### 1. Header \u0026 Badges\n- Package name: `claude_agent_sdk`\n- Gleam version requirements\n- License badge\n\n### 2. Installation\n```bash\ngleam add claude_agent_sdk\n```\n\nPrerequisites:\n- Claude CLI installed and authenticated (`claude login` or `ANTHROPIC_API_KEY`)\n- Minimum CLI version requirement (if any)\n\n### 3. Quick Start Example\n```gleam\nimport claude_agent_sdk.{query}\nimport claude_agent_sdk/options.{default_options, with_max_turns}\nimport claude_agent_sdk/stream.{next, EndOfStream}\n\npub fn main() {\n  let options = default_options()\n    |\u003e with_max_turns(1)\n\n  case query(\"Hello, Claude!\", options) {\n    Ok(stream) -\u003e consume_stream(stream)\n    Error(e) -\u003e io.println(\"Error: \" \u003c\u003e error_to_string(e))\n  }\n}\n\nfn consume_stream(stream) {\n  case next(stream) {\n    #(Ok(EndOfStream), _) -\u003e io.println(\"Done!\")\n    #(Ok(item), new_stream) -\u003e {\n      handle_item(item)\n      consume_stream(new_stream)\n    }\n    #(Error(e), _) -\u003e io.println(\"Stream error: \" \u003c\u003e ...)\n  }\n}\n```\n\n### 4. API Overview\n- Core functions: `query()`, `next()`, `close()`\n- Types: `QueryOptions`, `QueryStream`, `StreamItem`, `Message`\n- Error handling: `QueryError`, `StreamError`\n- Helpers: `collect_messages()`, `collect_items()`\n\n### 5. Process Ownership (CRITICAL)\n**Must include these exact warnings from plan:**\n- \"QueryStream is not process-safe; use from the process that created it\"\n- \"close() is only effective when called by the process that spawned the query\"\n- \"Because next() blocks, cross-process cancellation requires an OTP wrapper\"\n- \"The SDK does not detect cross-process use; violating this contract results in undefined behavior (typically deadlock)\"\n\n### 6. Success Semantics in Automation\nDocument warning handling for CI pipelines (from plan lines 2827-2860).\n\n### 7. Troubleshooting\n- Empty stdout errors in CI/containers\n- Stderr capture guidance (`2\u003e/tmp/claude_stderr.log`)\n- Common causes table (auth, network, config)\n\n### 8. Integration Testing Setup\nHow to run integration tests with real CLI.\n\n## Acceptance Criteria\n- [ ] Installation instructions work\n- [ ] Quick start example is copy-paste runnable\n- [ ] All critical process ownership warnings included\n- [ ] Troubleshooting section covers common issues\n- [ ] Links to detailed docs (when available)\n","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-10T23:22:02.879898638Z","created_by":"cyou","updated_at":"2026-01-11T04:00:08.180329856Z","closed_at":"2026-01-11T04:00:08.180329856Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-g03.2","depends_on_id":"casg-g03","type":"parent-child","created_at":"2026-01-10T23:22:02.880619974Z","created_by":"cyou"},{"issue_id":"casg-g03.2","depends_on_id":"casg-g03.1","type":"blocks","created_at":"2026-01-10T23:23:12.248838127Z","created_by":"cyou"},{"issue_id":"casg-g03.2","depends_on_id":"casg-g03.4","type":"blocks","created_at":"2026-01-10T23:23:12.724092705Z","created_by":"cyou"}]}
{"id":"casg-g03.3","title":"Document process ownership contract in detail","description":"## Overview\nAdd detailed documentation about the process ownership contract - the most critical behavioral constraint of the SDK.\n\n## Why This Matters\nErlang ports deliver messages to the spawning process's mailbox. This creates fundamental constraints:\n- `next()` can only receive messages in the process that called `query()`\n- `close()` from another process closes the port but doesn't unblock a waiting `next()`\n- Cross-process use leads to deadlock or resource leaks\n\n## Documentation Locations\n\n### 1. Module Doc Comments (see T001)\nAdd to `stream.gleam` module header:\n```gleam\n//// ## Process Ownership Contract\n//// \n//// `QueryStream` is single-process. Behavior is UNDEFINED if:\n//// - `next()` is called from a different process than `query()`\n//// - `next()` is called from multiple processes concurrently\n//// - `close()` is called from a different process than `query()`\n////\n//// For cancellation patterns, see the Cancellation Recipe in README.\n```\n\n### 2. Function-Level Warnings\nOn `next()`:\n```gleam\n/// **Process Safety**: Must be called from the same process that called `query()`.\n/// Blocks until the next message arrives. Cannot be cancelled from another process.\n```\n\nOn `close()`:\n```gleam\n/// **Process Safety**: Only effective when called by the process that spawned the query.\n/// Calling from another process closes the port but does NOT unblock a waiting `next()`.\n```\n\n### 3. README Section (see T002)\nProminent \"Process Ownership\" section with:\n- The three undefined behaviors\n- Rationale (Erlang port semantics)\n- Link to cancellation recipe\n\n### 4. Mailbox Isolation Invariant\nDocument that every `receive` filters on the specific Port reference:\n```erlang\nreceive {Port, Msg} -\u003e ... end  % CORRECT\nreceive Msg -\u003e ... end          % WRONG - could get other port's messages\n```\n\n## Exact Phrases Required (from plan)\n- \"QueryStream is not process-safe; use from the process that created it\"\n- \"close() is only effective when called by the process that spawned the query\"\n- \"Because next() blocks, cross-process cancellation requires an OTP wrapper\"\n- \"The SDK does not detect cross-process use; violating this contract results in undefined behavior (typically deadlock)\"\n\n## Acceptance Criteria\n- [ ] Module-level doc comment in stream.gleam\n- [ ] Function-level warnings on next() and close()\n- [ ] All four exact phrases appear in docs\n- [ ] Mailbox isolation explained\n- [ ] Clear cross-references between module docs and README","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-10T23:22:20.220203227Z","created_by":"cyou","updated_at":"2026-01-11T03:36:02.880292443Z","closed_at":"2026-01-11T03:36:02.880292443Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-g03.3","depends_on_id":"casg-g03","type":"parent-child","created_at":"2026-01-10T23:22:20.220771004Z","created_by":"cyou"},{"issue_id":"casg-g03.3","depends_on_id":"casg-g03.1","type":"blocks","created_at":"2026-01-10T23:23:11.26677717Z","created_by":"cyou"}]}
{"id":"casg-g03.4","title":"Add cancellation recipe and advanced examples","description":"## Overview\nDocument the recommended pattern for cancellable queries using gleam_otp, plus other advanced usage examples.\n\n## Cancellation Recipe (from plan lines 2143-2239)\n\n### The Problem\n- `next()` blocks until the next message arrives\n- Single-threaded Gleam means you can't cancel a blocked call from the same process\n- Cross-process `close()` doesn't unblock the waiting `next()`\n\n### The Solution: OTP Task Wrapper\nSpawn a dedicated process to own the stream, communicate via subjects:\n\n```gleam\nimport gleam/erlang/process.{Subject}\nimport gleam/otp/task\n\n/// Run a query with cancellation support.\n/// Returns stream items via the result_subject.\n/// Send Cancel message to cancel_subject to abort.\npub fn query_with_cancellation(\n  prompt: String,\n  options: QueryOptions,\n  result_subject: Subject(Result(StreamItem, StreamError)),\n  cancel_subject: Subject(Cancel),\n) -\u003e task.Task(Nil) {\n  task.async(fn() {\n    // This process owns the stream\n    case query(prompt, options) {\n      Error(e) -\u003e {\n        process.send(result_subject, Error(QueryStartError(e)))\n      }\n      Ok(stream) -\u003e {\n        consume_with_cancellation(stream, result_subject, cancel_subject)\n      }\n    }\n  })\n}\n\nfn consume_with_cancellation(\n  stream: QueryStream,\n  result_subject: Subject(Result(StreamItem, StreamError)),\n  cancel_subject: Subject(Cancel),\n) {\n  // Check for cancellation before each blocking read\n  case process.receive(cancel_subject, 0) {\n    Ok(Cancel) -\u003e {\n      // Cancellation requested - close and exit\n      close(stream)\n      process.send(result_subject, Ok(EndOfStream))\n    }\n    Error(Nil) -\u003e {\n      // No cancellation - proceed with blocking read\n      case next(stream) {\n        #(Ok(EndOfStream), _) -\u003e {\n          process.send(result_subject, Ok(EndOfStream))\n        }\n        #(Ok(item), new_stream) -\u003e {\n          process.send(result_subject, Ok(item))\n          consume_with_cancellation(new_stream, result_subject, cancel_subject)\n        }\n        #(Error(e), _) -\u003e {\n          process.send(result_subject, Error(e))\n        }\n      }\n    }\n  }\n}\n\ntype Cancel { Cancel }\n```\n\n### Usage Example\n```gleam\nlet result_subject = process.new_subject()\nlet cancel_subject = process.new_subject()\n\nlet task = query_with_cancellation(\"prompt\", options, result_subject, cancel_subject)\n\n// To cancel:\nprocess.send(cancel_subject, Cancel)\n\n// To receive results with timeout:\ncase process.receive(result_subject, 30_000) {\n  Ok(Ok(item)) -\u003e handle_item(item)\n  Ok(Error(e)) -\u003e handle_error(e)\n  Error(Nil) -\u003e handle_timeout()\n}\n```\n\n### Key Points to Document\n1. The consuming process owns the stream (spawned via `task.async`)\n2. Parent process communicates via subjects (messages)\n3. Cancellation is checked between blocking `next()` calls\n4. `close()` is always called when cancelling (releases port resources)\n5. This pattern adds `gleam_otp` dependency but keeps SDK non-actor\n\n## Other Examples to Include\n\n### Basic Streaming\nSimple loop consuming all messages\n\n### Error Handling\nHandling recoverable vs terminal errors\n\n### CI/Automation\nStrict warning handling for pipelines\n\n## Placement\n- Full cancellation recipe in README.md \"Advanced Usage\" section\n- Summary reference in module docs with link to README\n\n## Acceptance Criteria\n- [ ] Full cancellation recipe in README\n- [ ] Key points explained clearly\n- [ ] Usage example is copy-paste runnable\n- [ ] Dependencies noted (gleam_otp)\n- [ ] Other helpful examples included","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-10T23:22:40.025864384Z","created_by":"cyou","updated_at":"2026-01-11T03:56:15.228243825Z","closed_at":"2026-01-11T03:56:15.228243825Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-g03.4","depends_on_id":"casg-g03","type":"parent-child","created_at":"2026-01-10T23:22:40.026857869Z","created_by":"cyou"},{"issue_id":"casg-g03.4","depends_on_id":"casg-g03.3","type":"blocks","created_at":"2026-01-10T23:23:11.765589194Z","created_by":"cyou"}]}
{"id":"casg-g03.5","title":"Document test fixtures and integration test setup","description":"## Overview\nCreate documentation for the test fixtures directory and integration test setup.\n\n## Deliverables\n\n### 1. test/fixtures/README.md\nDocument the test fixtures used for schema validation:\n\n```markdown\n# Test Fixtures\n\nThis directory contains JSON fixtures captured from the Claude CLI for testing.\n\n## CLI Version\n- **Version**: claude v1.x.x (exact version TBD during implementation)\n- **Capture Date**: 2026-01-XX\n- **Platform**: BEAM/Erlang\n\n## Fixture Files\n- `system_message.json` - System message example\n- `assistant_message.json` - Assistant message example\n- `result_success.json` - Result (success)\n- `result_error.json` - Result (error)\n- `unknown_message_type.json` - Forward-compat fixture\n- `unknown_content_block.json` - Forward-compat fixture\n- `cli_help_excerpt.txt` - `claude --help` excerpt showing required flags\n\n## Refreshing Fixtures\nTo update fixtures with a new CLI version:\n1. Run the fixture capture command\n2. Update version and date above\n3. Verify tests still pass\n\n## Note on Synthetic Fixtures\nSome fixtures may be synthetic (hand-crafted) rather than captured from CLI.\nThese are marked with a \"synthetic\" suffix or comment in the file.\n```\n\n### 2. Integration Test Documentation\nIn README.md or separate CONTRIBUTING.md:\n\n```markdown\n## Integration Testing\n\n### Prerequisites\n- Claude CLI installed and authenticated\n- ANTHROPIC_API_KEY or cached auth\n\n### Running Integration Tests\n```bash\n# Unit tests only (no CLI required)\ngleam test\n\n# Integration tests (requires CLI)\nCLAUDE_INTEGRATION_TEST=1 gleam test\n```\n\n### Phase 0 Validation\nPhase 0 tests validate the FFI layer against the real Erlang runtime:\n```bash\nPHASE0_RUNTIME=1 gleam test\n```\n\n### Test Categories\n- **Unit tests**: No external dependencies, always run\n- **Integration tests**: Require Claude CLI, opt-in via env var\n- **Phase 0 tests**: FFI validation, opt-in via env var\n```\n\n### 3. Environment Variables Reference\nDocument all environment variables the SDK uses:\n- `ANTHROPIC_API_KEY` - API key for authentication\n- `CLAUDE_INTEGRATION_TEST` - Enable integration tests\n- `CLAUDE_INTEGRATION_ALLOW_NONJSON` - Allow non-JSON preflight in integration tests\n- `PHASE0_RUNTIME` - Enable Phase 0 FFI validation\n\n## Acceptance Criteria\n- [ ] test/fixtures/README.md exists with version info\n- [ ] cli_help_excerpt.txt is captured and referenced\n- [ ] Integration test instructions in main README\n- [ ] All env vars documented\n- [ ] Clear distinction between test types\n","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-10T23:22:57.770789703Z","created_by":"cyou","updated_at":"2026-01-11T03:28:03.523867908Z","closed_at":"2026-01-11T03:28:03.523867908Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-g03.5","depends_on_id":"casg-g03","type":"parent-child","created_at":"2026-01-10T23:22:57.771934607Z","created_by":"cyou"}]}
{"id":"casg-g03.6","title":"Document scope divergence from MALA_SDK_REQUIREMENTS","description":"## Overview\nDocument the relationship between this CLI-based SDK plan and the separate `plans/MALA_SDK_REQUIREMENTS.md` document to avoid confusion for future contributors.\n\n## Context\n- The current SDK plan is CLI-based (Claude Code CLI subprocess)\n- `plans/MALA_SDK_REQUIREMENTS.md` calls for a direct, non-CLI SDK (\"No CLI hook dependence\")\n- This is an intentional scope boundary for this project phase\n\n## Deliverables\n- Add a short \"Scope \u0026 Non-Goals\" note in README or CONTRIBUTING:\n  - MALA requirements are **out of scope** for this CLI-based SDK version\n  - Provide a pointer to future work or separate project for direct API SDK\n\n## Acceptance Criteria\n- README or CONTRIBUTING contains explicit note about MALA requirements divergence\n- No implication that this SDK satisfies MALA's \"no CLI\" requirement\n","notes":"Quality gate failed: Interrupted: Interrupted by user\nLog: /home/cyou/.claude/projects/-home-cyou-claude-agent-sdk-gleam/03ec8438-1d2c-4135-ad9e-3160448e5cca.jsonl","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-10T23:37:31.401653109Z","created_by":"cyou","updated_at":"2026-01-11T04:06:18.610543577Z","closed_at":"2026-01-11T04:06:18.610543577Z","close_reason":"Closed","labels":["needs-followup"],"dependencies":[{"issue_id":"casg-g03.6","depends_on_id":"casg-g03","type":"parent-child","created_at":"2026-01-10T23:37:31.402236604Z","created_by":"cyou"},{"issue_id":"casg-g03.6","depends_on_id":"casg-g03.2","type":"blocks","created_at":"2026-01-10T23:43:22.441782856Z","created_by":"cyou"}]}
{"id":"casg-g03.7","title":"[Review] 1 non-blocking finding from casg-g03.3","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-g03.3\n**Highest priority:** P3\n\n---\n\n### Finding 1: [P3] Broken internal link to non-existent Cancellation Recipe section\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** README.md:39\n\nIn README.md:39, the documentation links to `[Cancellation Recipe](#cancellation-recipe)`, but this section does not exist in the README yet.\n\n**Current text:**\n```markdown\nSee the [Cancellation Recipe](#cancellation-recipe) for patterns to safely cancel from another process.\n```\n\n**Why this is low priority:**\n- According to the task dependencies in `.beads/issues.jsonl`, task `casg-g03.4` (\"Add cancellation recipe and advanced examples\") depends on this task (`casg-g03.3`) being completed first\n- The Cancellation Recipe section is planned to be added in a future task\n- The link will work correctly once `casg-g03.4` is completed\n- Users can still understand the process ownership constraints without the recipe\n\n**Recommendation:**\n- Either remove the link temporarily until the section exists\n- Or change it to reference the stream.gleam module docs: `See the \\`stream.gleam\\` module documentation and the Cancellation Recipe (coming soon) for patterns to safely cancel from another process.`\n- Or keep as-is and ensure casg-g03.4 adds the section with the correct anchor\n\n---\n\n\u003c!-- fp:9abd82416cbfa0d7 --\u003e\n\u003c!-- review_finding:7ac279b86ab9 --\u003e","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-11T03:36:03.069332501Z","created_by":"cyou","updated_at":"2026-01-11T03:37:51.887784685Z","closed_at":"2026-01-11T03:37:51.887784685Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-g03.3"],"dependencies":[{"issue_id":"casg-g03.7","depends_on_id":"casg-g03","type":"parent-child","created_at":"2026-01-11T03:36:03.069911697Z","created_by":"cyou"}]}
{"id":"casg-g03.8","title":"[Review] 1 non-blocking finding from casg-g03.4","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-g03.4\n**Highest priority:** P2\n\n---\n\n### Finding 1: Missing imports in cancellation recipe usage example\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** README.md:226-240\n\nThe cancellation recipe usage example (README.md:215-240) calls `default_options()` on line 226 without importing it, and references undefined placeholder functions `handle_item()`, `handle_error()`, and `handle_timeout()` on lines 236-238.\n\n**Current code:**\n```gleam\nimport gleam/erlang/process\nimport gleam/otp/task\n\npub fn main() {\n  let result_subject = process.new_subject()\n  let cancel_subject = process.new_subject()\n\n  let _task = query_with_cancellation(\n    \"What is 2 + 2?\",\n    default_options(),  // Not imported!\n    result_subject,\n    cancel_subject,\n  )\n\n  case process.receive(result_subject, 30_000) {\n    Ok(Ok(item)) -\u003e handle_item(item)      // Undefined!\n    Ok(Error(e)) -\u003e handle_error(e)        // Undefined!\n    Error(Nil) -\u003e handle_timeout()         // Undefined!\n  }\n}\n```\n\n**Impact:** The example won't compile as-is. Users copying this code will get compilation errors.\n\n**Fix:** Either:\n1. Add the missing import: `import claude_agent_sdk.{default_options}`\n2. Or replace with inline comment: `// Use your query_with_cancellation from above`\n3. Add placeholder implementations or comments for the handler functions:\n   ```gleam\n   fn handle_item(item) { todo }\n   fn handle_error(e) { todo }\n   fn handle_timeout() { todo }\n   ```\n\n**Recommendation:** Since this is a usage example showing how to *call* the cancellation recipe (not implement it), consider simplifying to just show the key calls with comments indicating where user logic goes, or make it explicitly a stub with `todo` implementations.\n\n---\n\n\u003c!-- fp:549a89afe210b19d --\u003e\n\u003c!-- review_finding:fc08a1e624a6 --\u003e","notes":"Quality gate failed: Interrupted: Interrupted by user\nLog: /home/cyou/.claude/projects/-home-cyou-claude-agent-sdk-gleam/c55f1fdf-0269-4c38-8e98-d26c928924a9.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T03:56:15.418426185Z","created_by":"cyou","updated_at":"2026-01-11T04:06:27.250149917Z","closed_at":"2026-01-11T04:06:27.250149917Z","close_reason":"Closed","labels":["auto_generated","needs-followup","review_finding","source:casg-g03.4"],"dependencies":[{"issue_id":"casg-g03.8","depends_on_id":"casg-g03","type":"parent-child","created_at":"2026-01-11T03:56:15.418930562Z","created_by":"cyou"}]}
{"id":"casg-g03.9","title":"[Review] 5 non-blocking findings from casg-g03.2","description":"## Review Findings\n\nThis issue consolidates 5 non-blocking findings from code review.\n\n**Source issue:** casg-g03.2\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Incorrect import path in Quick Start example\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** README.md:24-25\n\nThe Quick Start example uses:\n```gleam\nimport claude_agent_sdk.{query, default_options, with_max_turns, next, close}\nimport claude_agent_sdk/error.{EndOfStream, Message}\n```\n\nBut `EndOfStream` and `Message` are not constructors in `claude_agent_sdk/error` - they are variant constructors of the `StreamItem` type. According to the actual code:\n\n- `StreamItem` is defined in `claude_agent_sdk/error` as: `type StreamItem { Message(MessageEnvelope) | WarningEvent(Warning) | EndOfStream }`\n- To pattern match on these variants, you need to import the `error` module and use `error.Message(...)` and `error.EndOfStream`\n- The import statement `import claude_agent_sdk/error.{EndOfStream, Message}` suggests these can be imported directly as unqualified constructors, but Gleam's module system doesn't allow re-exporting variant constructors\n\nThe correct pattern matching should be:\n```gleam\nimport claude_agent_sdk/error\n\ncase next(stream) {\n  #(Ok(error.EndOfStream), _) -\u003e io.println(\"Done!\")\n  #(Ok(error.Message(envelope)), new_stream) -\u003e {\n    ...\n  }\n  ...\n}\n```\n\nOr alternatively, use type imports and qualified names throughout.\n\n---\n\n### Finding 2: [P2] Incomplete error handling in Quick Start example\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** README.md:33-45\n\nThe Quick Start example shows:\n```gleam\nError(e) -\u003e io.println(\"Error: \" \u003c\u003e claude_agent_sdk/error.error_to_string(e))\n```\n\nHowever, `error_to_string()` takes a `QueryError`, not a `StreamError`. According to the actual code in `claude_agent_sdk/error.gleam`, there are two separate functions:\n- `error_to_string(QueryError) -\u003e String` (line 276)\n- `stream_error_to_string(StreamError) -\u003e String` (line 296)\n\nThe path syntax `claude_agent_sdk/error.error_to_string(e)` is also incorrect Gleam syntax. It should be either:\n```gleam\nimport claude_agent_sdk/error\n...\nError(e) -\u003e io.println(\"Error: \" \u003c\u003e error.error_to_string(e))\n```\n\nAdditionally, the example doesn't show proper error handling for stream errors in `consume_stream()`. The stream error case just prints \"Stream error\" without using the diagnostic information available.\n\n---\n\n### Finding 3: [P2] Model name in API Overview doesn't match actual usage\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** README.md:83\n\nIn the \"Option Builders\" section, the example shows:\n```gleam\ndefault_options()\n  |\u003e with_model(\"claude-sonnet-4-20250514\")\n```\n\nThis appears to be a full model identifier, but according to the code documentation in `claude_agent_sdk/options.gleam` line 137-140, the `with_model` function's model parameter is described as \"Model identifier (e.g., \\\"opus\\\", \\\"sonnet\\\", \\\"haiku\\\")\" - suggesting short names are expected.\n\nWhile this may not be incorrect (the CLI might accept full model IDs), it's inconsistent with the inline documentation which suggests short identifiers. This could confuse users about what format to use.\n\nConsider either:\n1. Using a short identifier like `\"sonnet\"` to match the documentation pattern\n2. Adding a note explaining that both short names and full model IDs are accepted\n\n---\n\n### Finding 4: [P3] Typo: \"Acceptall\" should be \"AcceptEdits\"\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** README.md:88\n\nIn the Option Builders example:\n```gleam\n  |\u003e with_permission_mode(Acceptall)\n```\n\nAccording to `claude_agent_sdk/options.gleam` lines 49-58, the `PermissionMode` variants are:\n- `Default`\n- `AcceptEdits`\n- `BypassPermissions`\n- `Plan`\n\nThere is no `Acceptall` variant. This should likely be either `AcceptEdits` or `BypassPermissions` (probably `AcceptEdits` based on the name similarity).\n\n---\n\n### Finding 5: [P2] Incorrect PermissionMode import in automation example\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** README.md:428-447\n\nIn the \"Success Semantics in Automation\" section, the example shows:\n```gleam\nimport claude_agent_sdk/error.{NonZeroExitAfterResult}\n```\n\nThen later uses:\n```gleam\ncase w.code {\n  NonZeroExitAfterResult(_) -\u003e True\n  _ -\u003e False\n}\n```\n\nHowever, `NonZeroExitAfterResult` is a variant constructor of `WarningCode`, not a type that can be imported directly as an unqualified constructor. According to `claude_agent_sdk/error.gleam` lines 226-247, `WarningCode` is:\n```gleam\npub type WarningCode {\n  UnparseableCliVersion\n  CleanExitNoResult\n  NonZeroExitAfterResult(Int)\n  UnexpectedMessageAfterResult\n  IncompleteLastLine(String)\n  DeprecatedOption\n}\n```\n\nThe correct pattern matching should use the qualified name:\n```gleam\nimport claude_agent_sdk/error\n\ncase w.code {\n  error.NonZeroExitAfterResult(_) -\u003e True\n  _ -\u003e False\n}\n```\n\n---\n\n\u003c!-- fp:7c896a2ebf96b039 --\u003e\n\u003c!-- fp:eef0c75803dedc96 --\u003e\n\u003c!-- fp:b5e2a72c682a354c --\u003e\n\u003c!-- fp:a3c2736f16392b01 --\u003e\n\u003c!-- fp:fcaa65ddd792b586 --\u003e\n\u003c!-- review_finding:ef6b4dd8e5da --\u003e","notes":"Quality gate failed: Interrupted: Interrupted by user\nLog: /home/cyou/.claude/projects/-home-cyou-claude-agent-sdk-gleam/61cd55e2-b3a8-4ac9-bf5e-3dc1ddfc8cd4.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T04:00:08.369721971Z","created_by":"cyou","updated_at":"2026-01-11T04:06:34.572150728Z","closed_at":"2026-01-11T04:06:34.572150728Z","close_reason":"Closed","labels":["auto_generated","needs-followup","review_finding","source:casg-g03.2"],"dependencies":[{"issue_id":"casg-g03.9","depends_on_id":"casg-g03","type":"parent-child","created_at":"2026-01-11T04:00:08.370346977Z","created_by":"cyou"}]}
{"id":"casg-i99","title":"[Review] 2 non-blocking findings from casg-xjv.4","description":"## Review Findings\n\nThis issue consolidates 2 non-blocking findings from code review.\n\n**Source issue:** casg-xjv.4\n**Highest priority:** P3\n\n---\n\n### Finding 1: [P3] Coverage percentage inconsistency with baseline\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** plans/testing-gaps.md:10\n\nThe document reports `claude_agent_sdk` module coverage as 25.0% (12/48 lines) in line 10, but the baseline in `coverage-reporting.md` line 74 shows 22.9% (11/48 lines). This is a minor 1-line discrepancy that suggests either:\n1. The coverage numbers were updated between baseline capture and analysis\n2. There's an arithmetic error in one of the documents\n\n**Impact**: Low - doesn't affect the analysis conclusions, just a minor documentation inconsistency.\n\n**Recommendation**: Verify which coverage number is accurate and update accordingly, or note that coverage improved by 1 line between baseline and analysis.\n\n---\n\n### Finding 2: [P3] Priority assignment may be overstatedfor test coverage gaps\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** plans/testing-gaps.md:136-145\n\nThe document assigns P1 (Critical - Blocks release) priority to decoder functions and public stream API gaps (lines 136-145). However, these are test coverage gaps for *already implemented and working* functions, not missing functionality.\n\nThe decoder module has 56.1% coverage and the functions exist and are used. Similarly, `stream.next()` is implemented and functional. Missing *tests* for working code is typically P2 (Important - Quality) rather than P1 (Blocks release).\n\n**Context from policy**: The testing policy defines 95% line coverage as a target, not a hard blocker. P1 should be reserved for issues that would actually prevent a release (e.g., broken functionality, security issues, API breaks).\n\n**Recommendation**: Consider downgrading these to P2, or provide explicit justification for why test coverage gaps block release in this project's context.\n\n---\n\n\u003c!-- fp:da2369256b4da78d --\u003e\n\u003c!-- fp:11feef3fcf76156b --\u003e\n\u003c!-- review_finding:df19fa746004 --\u003e","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-11T05:19:12.357680903Z","created_by":"cyou","updated_at":"2026-01-11T05:26:23.697793823Z","closed_at":"2026-01-11T05:26:23.697793823Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-xjv.4"]}
{"id":"casg-j37","title":"Epic 2: Core Query \u0026 Streaming","description":"## Overview\nImplement the core query functionality including CLI argument building, version detection, and the QueryStream abstraction. This is the architectural foundation of the SDK.\n\n## Why This is Critical\n- QueryStream is the primary user-facing API\n- v1 uses port_ffi directly (not Runner abstraction) for production\n- Version detection prevents cryptic errors from incompatible CLIs\n- CLI arg building must handle conflicting options correctly\n\n## Scope\n1. **QueryOptions** (src/claude_agent_sdk/options.gleam):\n   - All CLI options (model, max_turns, budget, permissions, etc.)\n   - Builder functions (with_model, with_max_turns, etc.)\n   - test_mode and skip_version_check for unit tests\n\n2. **CLI Argument Building** (src/claude_agent_sdk/internal/cli.gleam):\n   - build_args() function\n   - Conflicting option resolution (resume vs continue, etc.)\n   - All --flag mappings\n\n3. **Version Detection** (src/claude_agent_sdk/internal/cli.gleam):\n   - find_executable() via FFI\n   - detect_cli_version() with timeout\n   - parse_version_string() and version_meets_minimum()\n   - CliVersion and UnknownVersion types\n\n4. **QueryStream** (src/claude_agent_sdk/internal/stream.gleam):\n   - Opaque QueryStream type\n   - Line reassembly from port bytes\n   - Buffer limit (10MB) protection\n   - State machine for exit_status/Result ordering\n\n5. **Main API** (src/claude_agent_sdk.gleam):\n   - query() function\n   - next() function returning #(Result, QueryStream)\n   - close() function with cleanup\n\n6. **Resource Safety Helpers**:\n   - with_stream() - guaranteed cleanup\n   - collect_items(), collect_messages()\n   - fold_stream()\n\n## Success Criteria\n- query() spawns CLI subprocess correctly\n- next() iterates through NDJSON messages\n- Version detection catches incompatible CLIs\n- Resource cleanup happens even on early return\n\n## Dependencies\n- Depends on Epic 0 (FFI must work)\n- Depends on Epic 1 (message types for decoding)\n\n## Plan References\n- v1 Production Path (Canonical)\n- Canonical Version Policy\n- QueryStream State Machine\n- Process Ownership Contract","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-10T23:19:43.946733304Z","created_by":"cyou","updated_at":"2026-01-11T02:05:05.340922227Z","closed_at":"2026-01-11T02:05:05.340922227Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-j37","depends_on_id":"casg-va1","type":"blocks","created_at":"2026-01-10T23:19:52.025063466Z","created_by":"cyou"},{"issue_id":"casg-j37","depends_on_id":"casg-k92","type":"blocks","created_at":"2026-01-10T23:19:52.077305157Z","created_by":"cyou"}]}
{"id":"casg-j37.1","title":"QueryOptions type skeleton + failing build_args test","description":"## Overview\nCreate the QueryOptions type and builder functions skeleton in src/claude_agent_sdk/options.gleam.\n\n## TDD Approach\nWrite failing test first in test/cli_args_test.gleam that calls build_args() and expects specific CLI arguments.\n\n## Deliverables\n- src/claude_agent_sdk/options.gleam with:\n  - QueryOptions type with all fields (model, max_turns, system_prompt, etc.)\n  - PermissionMode enum (Default, AcceptEdits, BypassPermissions, Plan)\n  - default_options() -\u003e QueryOptions\n  - Builder functions: with_model, with_max_turns, with_max_budget, with_system_prompt, with_append_system_prompt, with_allowed_tools, with_disallowed_tools, with_mcp_config, with_permission_mode, with_resume, with_continue, with_cwd\n  - SDK-only options: test_mode, test_runner, skip_version_check, permissive_version_check\n\n## Test File\ntest/cli_args_test.gleam with:\n- basic_args_test: verify fixed flags (--print, --output-format, stream-json, --verbose)\n- model_option_test: verify --model flag generation\n- Tests should FAIL initially (build_args not implemented yet)\n\n## Key Invariants from Plan\n- All Option fields default to None\n- Bool fields default to False\n- cwd handling: None = inherit, Some(\"\") treated as None, Some(path) = use path\n- See plan lines 4144-4214 for complete type definition","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:21:48.865156778Z","created_by":"cyou","updated_at":"2026-01-11T01:15:26.657085823Z","closed_at":"2026-01-11T01:15:26.657085823Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-j37.1","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:21:48.865791135Z","created_by":"cyou"}]}
{"id":"casg-j37.10","title":"query() function wiring (spawn, version check, return QueryStream)","description":"## Overview\nImplement the main query() function that ties everything together.\n\n## Signature\n```gleam\npub fn query(\n  prompt: String,\n  options: QueryOptions,\n) -\u003e Result(QueryStream, QueryError)\n```\n\n## Implementation Flow (from plan lines 1528-1576)\n1. Find CLI in PATH (returns CliNotFoundError if not found)\n2. Check version (unless skip_version_check=True)\n   - detect_cli_version() -\u003e check meets minimum\n   - Handle permissive_version_check for unknown versions\n3. Build args via build_cli_args(prompt, options)\n4. Spawn port based on test_mode:\n   - False: port_ffi.ffi_open_port(cli_path, args, cwd) [v1 production]\n   - True: test_runner_spawn(options.test_runner, ...) [test path]\n5. Return Ok(QueryStream(...))\n\n## QueryError Types\n- CliNotFoundError(message: String)\n- UnsupportedCliVersionError(detected_version, minimum_required, suggestion)\n- UnknownVersionError(raw, message)\n- VersionDetectionError(reason)\n- SpawnError(reason: String)\n\n## Key Invariants (from plan)\n- v1 uses port_ffi directly (NOT Runner) for production path\n- Version detection uses raw FFI with 5s timeout\n- test_mode enables test_runner() path for unit tests\n- cwd handling: None = inherit, Some(\"\") = inherit, Some(path) = use path\n\n## Test Strategy\n- Unit tests use with_test_mode() to provide test_runner\n- Integration tests (opt-in) test real CLI spawning\n- Version check can be skipped via with_skip_version_check()","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:23:38.169749Z","created_by":"cyou","updated_at":"2026-01-11T01:53:15.359590119Z","closed_at":"2026-01-11T01:53:15.359590119Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-j37.10","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:23:38.170379056Z","created_by":"cyou"},{"issue_id":"casg-j37.10","depends_on_id":"casg-j37.2","type":"blocks","created_at":"2026-01-10T23:24:24.852891558Z","created_by":"cyou"},{"issue_id":"casg-j37.10","depends_on_id":"casg-j37.4","type":"blocks","created_at":"2026-01-10T23:24:25.360130356Z","created_by":"cyou"},{"issue_id":"casg-j37.10","depends_on_id":"casg-j37.8","type":"blocks","created_at":"2026-01-10T23:24:30.831148563Z","created_by":"cyou"},{"issue_id":"casg-j37.10","depends_on_id":"casg-j37.9","type":"blocks","created_at":"2026-01-10T23:24:31.332181627Z","created_by":"cyou"},{"issue_id":"casg-j37.10","depends_on_id":"casg-j37.13","type":"blocks","created_at":"2026-01-10T23:42:36.74825903Z","created_by":"cyou"}]}
{"id":"casg-j37.11","title":"Resource helpers (with_stream, collect_items, collect_messages, fold_stream)","description":"## Overview\nImplement resource-safe helper functions that guarantee cleanup.\n\n## Deliverables\n\n### with_stream (from plan lines 3684-3687)\n```gleam\npub fn with_stream(\n  result: Result(QueryStream, QueryError),\n  f: fn(QueryStream) -\u003e a,\n) -\u003e Result(a, QueryError)\n```\nEnsures close() is called even on early return/panic.\n\n### collect_items (from plan lines 3701)\n```gleam\npub fn collect_items(stream: QueryStream) -\u003e CollectResult(StreamItem)\n```\nConsumes entire stream, collecting all items. Guarantees cleanup.\n\n### collect_messages (from plan lines 3707)\n```gleam\npub fn collect_messages(stream: QueryStream) -\u003e CollectResult(MessageEnvelope)\n```\nFilters to messages only; same semantics as collect_items.\n\n### fold_stream (from plan lines 3715)\n```gleam\npub fn fold_stream(\n  stream: QueryStream,\n  initial: a,\n  f: fn(a, Result(StreamItem, StreamError)) -\u003e FoldAction(a),\n) -\u003e #(a, Option(StreamError))\n```\nCustom accumulation with guaranteed cleanup.\n\n## CollectResult Type\n```gleam\npub type CollectResult(a) {\n  CollectResult(\n    items: List(a),\n    warnings: List(Warning),\n    non_terminal_errors: List(StreamError),\n    terminal_error: Option(StreamError),\n  )\n}\n```\n\n## Stability Promise (from plan lines 4354-4371)\nAll helpers are STABLE API - breaking changes require major version bump.\n\n## Unit Tests\n- with_stream closes port even on early return (from plan line 4705)\n- collect_items collects all items and closes port (from plan line 4706)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:23:48.781437985Z","created_by":"cyou","updated_at":"2026-01-11T01:52:16.462951651Z","closed_at":"2026-01-11T01:52:16.462951651Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-j37.11","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:23:48.782165871Z","created_by":"cyou"},{"issue_id":"casg-j37.11","depends_on_id":"casg-j37.8","type":"blocks","created_at":"2026-01-10T23:24:31.808582911Z","created_by":"cyou"},{"issue_id":"casg-j37.11","depends_on_id":"casg-j37.9","type":"blocks","created_at":"2026-01-10T23:24:32.297991541Z","created_by":"cyou"}]}
{"id":"casg-j37.12","title":"to_iterator() with documented leak risk","description":"## Overview\nImplement to_iterator() for gleam/iterator combinator interop.\n\n## Signature (from plan line 3742)\n```gleam\npub fn to_iterator(stream: QueryStream) -\u003e Iterator(Result(StreamItem, StreamError))\n```\n\n## Stability Status (from plan line 4362)\n**Stable but Advanced** - documented leak risk; prefer with_stream/collect_* alternatives.\n\n## Leak Risk\nUnlike collect_* helpers, to_iterator() does NOT guarantee cleanup if:\n- Iterator is not fully consumed\n- Exception during iteration\n- Early break from iteration\n\n## Implementation\nWrap next() in iterator.unfold() pattern:\n```gleam\npub fn to_iterator(stream: QueryStream) -\u003e Iterator(Result(StreamItem, StreamError)) {\n  iterator.unfold(stream, fn(s) {\n    case next(s) {\n      #(Ok(EndOfStream), _) -\u003e Done\n      #(result, new_stream) -\u003e Next(result, new_stream)\n    }\n  })\n}\n```\n\n## Documentation Requirements\nREADME/module docs must explicitly warn:\n- \"Prefer with_stream(), collect_items(), or fold_stream() for guaranteed cleanup\"\n- \"to_iterator() may leak port resources if not fully consumed\"\n- \"Use for gleam/iterator combinator interop when cleanup is handled externally\"\n\n## Unit Tests\n- Basic iteration produces all items\n- Early termination leaves port unclosed (demonstrating the risk)","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-10T23:23:58.600719245Z","created_by":"cyou","updated_at":"2026-01-11T02:01:40.211502971Z","closed_at":"2026-01-11T02:01:40.211502971Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-j37.12","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:23:58.601271252Z","created_by":"cyou"},{"issue_id":"casg-j37.12","depends_on_id":"casg-j37.8","type":"blocks","created_at":"2026-01-10T23:24:36.280358887Z","created_by":"cyou"}]}
{"id":"casg-j37.13","title":"Centralize stream/CLI constants (timeouts, limits)","description":"## Goal\nCentralize all timeouts, buffer limits, and decode error thresholds into a single internal module so the stream/CLI logic uses consistent values.\n\n## Context\nPlan reference: \"All timeout values (single source of truth)\" and multiple sections referencing 5s/100ms/50ms/10MB/5-errors.\n\n## Deliverables\n- `src/claude_agent_sdk/internal/constants.gleam` (internal only) with:\n  - `const version_check_timeout_ms = 5000`\n  - `const post_result_drain_timeout_ms = 100`\n  - `const post_exit_drain_timeout_ms = 50`\n  - `const close_drain_timeout_ms = 50`\n  - `const close_drain_max_messages = 100`\n  - `const post_exit_drain_max_iterations = 10`\n  - `const post_exit_drain_max_bytes = 1024`\n  - `const max_line_bytes = 10_000_000`\n  - `const max_consecutive_decode_errors = 5`\n\n## Usage\n- internal/cli.gleam (version detection)\n- internal/stream.gleam (timeouts, drain bounds, buffer overflow)\n- internal/port_ffi.gleam (if needed for constants)\n\n## Acceptance Criteria\n- All timeout/limit values are defined in one place\n- No hard-coded numeric literals in stream/cli modules for these values\n- Values match the plan’s canonical tables\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:36:17.765651333Z","created_by":"cyou","updated_at":"2026-01-11T01:13:52.495335051Z","closed_at":"2026-01-11T01:13:52.495335051Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-j37.13","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:36:17.766801277Z","created_by":"cyou"}]}
{"id":"casg-j37.14","title":"Create public stream module (claude_agent_sdk/stream)","description":"## Goal\nCreate the public stream module that exposes QueryStream operations and re-exports stream-related types without leaking internal implementation details.\n\n## Context\nPlan references public module paths under `src/claude_agent_sdk/*` and internal modules under `src/claude_agent_sdk/internal/*`.\n\n## Deliverables\n- `src/claude_agent_sdk/stream.gleam` with:\n  - public type aliases/re-exports for `QueryStream`, `StreamItem`, `Warning`, `WarningCode`, `StreamError`\n  - `pub fn next(stream: QueryStream) -\u003e #(Result(StreamItem, StreamError), QueryStream)`\n  - `pub fn close(stream: QueryStream) -\u003e Nil`\n  - optional helpers for pattern matching if needed\n- Ensure `claude_agent_sdk.gleam` re-exports `next`/`close` (if desired by API surface)\n\n## Boundaries\n- The implementation should delegate to `internal/stream.gleam`\n- No FFI or internal types exposed from this module\n\n## Acceptance Criteria\n- Public module compiles and re-exports only approved types\n- Users can `import claude_agent_sdk/stream.{next, close, QueryStream, StreamItem}`\n- Internal modules remain inaccessible from outside package\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:36:30.351415213Z","created_by":"cyou","updated_at":"2026-01-11T01:56:35.04051721Z","closed_at":"2026-01-11T01:56:35.04051721Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-j37.14","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:36:30.352206019Z","created_by":"cyou"},{"issue_id":"casg-j37.14","depends_on_id":"casg-j37.8","type":"blocks","created_at":"2026-01-10T23:42:41.829346428Z","created_by":"cyou"},{"issue_id":"casg-j37.14","depends_on_id":"casg-j37.9","type":"blocks","created_at":"2026-01-10T23:42:46.906595742Z","created_by":"cyou"}]}
{"id":"casg-j37.15","title":"[Review] 4 non-blocking findings from casg-j37.13","description":"## Review Findings\n\nThis issue consolidates 4 non-blocking findings from code review.\n\n**Source issue:** casg-j37.13\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] max_line_bytes value doesn't match plan specification\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/internal/constants.gleam:26\n\nThe implementation sets `max_line_bytes = 10_000_000` (10 million bytes), but the plan's canonical constants table (lines 2996-2997) specifies `max_line_size_bytes = 10_485_760` (10 MiB = 10 * 1024 * 1024).\n\nThe plan explicitly states this is a \"10MB\" limit, but using powers of 1024 is the standard for memory buffers. The implementation uses a rounded decimal value instead.\n\n**How to fix**: Change the value to `10_485_760` to match the plan:\n```gleam\npub const max_line_bytes = 10_485_760  // 10 MiB\n```\n\n---\n\n### Finding 2: [P2] Missing initial_buffer_size constant from plan\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/internal/constants.gleam:26\n\nThe plan's canonical constants table (line 2997) defines `initial_buffer_size = 65_536` for initial buffer allocation, but this constant is not present in the implementation.\n\nThis constant is intended for use in the stream implementation to set the initial buffer size for line reassembly.\n\n**How to fix**: Add the missing constant:\n```gleam\n// Initial buffer allocation size\npub const initial_buffer_size = 65_536  // 64 KiB\n```\n\n---\n\n### Finding 3: [P2] Missing post_result_drain_max_iterations constant\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/internal/constants.gleam:8\n\nThe plan's canonical constants table (line 3004) defines `post_result_drain_max_iterations = 10`, but this constant is not present in the implementation.\n\nThis constant is intended to cap the number of iterations when draining messages after receiving a Result.\n\n**How to fix**: Add the missing constant after `post_result_drain_timeout_ms`:\n```gleam\n// Post-result drain max iterations - cap on drain loop iterations after result\npub const post_result_drain_max_iterations = 10\n```\n\n---\n\n### Finding 4: [P3] Constant naming differs from plan specification\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/internal/constants.gleam:5-26\n\nSeveral constant names differ from those specified in the plan's canonical table (lines 2995-3012):\n\n- Implementation: `version_check_timeout_ms` → Plan: `version_detection_timeout_ms`\n- Implementation: `close_drain_timeout_ms` → Plan: `close_mailbox_drain_timeout_ms`\n- Implementation: `close_drain_max_messages` → Plan: `close_mailbox_drain_max_messages`\n- Implementation: `max_line_bytes` → Plan: `max_line_size_bytes`\n\nWhile the implementation names are reasonable, they don't match the plan's canonical naming. This could cause confusion when referencing the plan.\n\n**Note**: If the task description intentionally modified these names, this may be acceptable. However, the plan should then be updated to reflect the canonical names.\n\n---\n\n\u003c!-- fp:f549ffd93e2c6b54 --\u003e\n\u003c!-- fp:2c5a087e906e4a98 --\u003e\n\u003c!-- fp:6928b19c4429adc8 --\u003e\n\u003c!-- fp:8e523492dd0b3f9b --\u003e\n\u003c!-- review_finding:415a92b320f5 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T01:13:52.715045746Z","created_by":"cyou","updated_at":"2026-01-11T01:15:37.171556836Z","closed_at":"2026-01-11T01:15:37.171556836Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-j37.13"],"dependencies":[{"issue_id":"casg-j37.15","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-11T01:13:52.715569743Z","created_by":"cyou"}]}
{"id":"casg-j37.16","title":"[Review] 2 non-blocking findings from casg-j37.1","description":"## Review Findings\n\nThis issue consolidates 2 non-blocking findings from code review.\n\n**Source issue:** casg-j37.1\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Test assumes quoted prompt format not specified in requirements\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** test/cli_args_test.gleam:77-78\n\nThe `basic_args_test` (line 78) verifies that the prompt appears as `\"-- \\\"Hello Claude\\\"\"` in the argument string, assuming the prompt will be quoted. However:\n\n1. The task description doesn't specify whether prompts should be quoted\n2. The plan reference (lines 4144-4214) doesn't document prompt quoting behavior\n3. Shell argument quoting is typically handled by the process spawner, not the argument builder\n\nThis test assertion may fail even with a correct implementation if `build_args` returns `[\"--\", \"Hello Claude\"]` instead of `[\"--\", \"\\\"Hello Claude\\\"\"]`.\n\n**Recommendation**: Either:\n- Update the test to check for the unquoted prompt: `string.contains(args_str, \"-- Hello Claude\")`\n- Or clarify in the requirements that prompts must be pre-quoted\n- Or check the prompt as a separate list element rather than in the joined string\n\n---\n\n### Finding 2: [P3] TestRunner opaque constructor is unused (expected warning)\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/options.gleam:22-24\n\nThe Gleam compiler warns that the `TestRunner` constructor at line 23 is unused. This is expected since `TestRunner` is an opaque placeholder for future implementation (as documented in the comment at line 20-21).\n\nThis is not a bug—it's the correct TDD approach. The warning will disappear when `runner.gleam` is implemented in a future task.\n\n**No action needed**, but the warning could be suppressed by adding `@deprecated(\"Placeholder for future runner.gleam implementation\")` if desired.\n\n---\n\n\u003c!-- fp:a614c05e655f606f --\u003e\n\u003c!-- fp:c58522bd3fc21f5b --\u003e\n\u003c!-- review_finding:1189351dd5df --\u003e","notes":"Quality gate failed: Killed as deadlock victim (will retry after blocker completes)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T01:15:26.842443102Z","created_by":"cyou","updated_at":"2026-01-11T01:23:39.26833159Z","closed_at":"2026-01-11T01:23:39.26833159Z","close_reason":"Closed","labels":["auto_generated","needs-followup","review_finding","source:casg-j37.1"],"dependencies":[{"issue_id":"casg-j37.16","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-11T01:15:26.843124488Z","created_by":"cyou"},{"issue_id":"casg-j37.16","depends_on_id":"casg-j37.2","type":"blocks","created_at":"2026-01-11T01:20:16.704091031Z","created_by":"cyou"}]}
{"id":"casg-j37.17","title":"[Review] 1 non-blocking finding from casg-j37.15","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-j37.15\n**Highest priority:** P3\n\n---\n\n### Finding 1: [P3] Constant names still differ from plan specification\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/internal/constants.gleam:5-29\n\nThe commit fixes the P2 issues (values and missing constants) but does not address Finding 4 from the source issue. Several constant names in the implementation still differ from the plan's canonical names (lines 2996-3012):\n\n- `version_check_timeout_ms` should be `version_detection_timeout_ms`\n- `close_drain_timeout_ms` should be `close_mailbox_drain_timeout_ms`\n- `close_drain_max_messages` should be `close_mailbox_drain_max_messages`\n- `max_line_bytes` should be `max_line_size_bytes`\n\nWhile the implementation names are reasonable, they don't match the plan's canonical naming. This could cause confusion when cross-referencing the plan. If these names were intentionally modified, the plan should be updated to reflect the new canonical names.\n\n---\n\n\u003c!-- fp:2aa2d283fa1911d6 --\u003e\n\u003c!-- review_finding:b992f74eaa81 --\u003e","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-11T01:15:37.355320383Z","created_by":"cyou","updated_at":"2026-01-11T01:17:26.429024745Z","closed_at":"2026-01-11T01:17:26.429024745Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-j37.15"],"dependencies":[{"issue_id":"casg-j37.17","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-11T01:15:37.35585126Z","created_by":"cyou"}]}
{"id":"casg-j37.18","title":"[Review] 1 non-blocking finding from casg-j37.5","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-j37.5\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Incorrect state transition documentation in StreamState comment\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/internal/stream.gleam:20-24\n\nThe comment on line 22 states:\n```gleam\n/// - Streaming -\u003e PendingEndOfStream (on exit_status after Result)\n```\n\nThis is incorrect. According to the canonical state transition table (plan lines 3793-3808), you cannot be in `Streaming` state and receive an \"exit_status after Result\". Once a Result message is received, the state transitions to `ResultReceived`.\n\nThe correct transitions FROM Streaming state are:\n- `Streaming -\u003e ResultReceived` (on Result message)\n- `Streaming -\u003e PendingEndOfStream` (on ExitStatus code=0, when no Result was seen)\n- `Streaming -\u003e Closed` (on ExitStatus code≠0, when no Result was seen)\n- `Streaming -\u003e Streaming` (on other messages)\n\nThe comment should be updated to accurately reflect the state machine. For example:\n```gleam\n/// - Streaming -\u003e ResultReceived (on Result message)\n/// - Streaming -\u003e PendingEndOfStream (on clean exit without Result)\n/// - ResultReceived -\u003e PendingEndOfStream (on non-zero exit after Result)\n/// - ResultReceived -\u003e Closed (on clean exit after Result)\n/// - PendingEndOfStream -\u003e Closed (after yielding EndOfStream)\n```\n\nThis same error appears in the TODO comment on line 54.\n\n---\n\n\u003c!-- fp:da44b0ded779aae1 --\u003e\n\u003c!-- review_finding:b1dc54a36518 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T01:19:32.676210789Z","created_by":"cyou","updated_at":"2026-01-11T01:22:49.092344451Z","closed_at":"2026-01-11T01:22:49.092344451Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-j37.5"],"dependencies":[{"issue_id":"casg-j37.18","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-11T01:19:32.676818315Z","created_by":"cyou"}]}
{"id":"casg-j37.19","title":"[Review] 2 non-blocking findings from casg-j37.4","description":"## Review Findings\n\nThis issue consolidates 2 non-blocking findings from code review.\n\n**Source issue:** casg-j37.4\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Unsafe error conversion in open_port_safe can crash\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk_ffi.erl:41\n\nThe `atom_to_binary(Reason, utf8)` call on line 41 will crash with `badarg` if the exception reason is not an atom. While most Erlang port spawn failures return atom reasons like `enoent` or `eacces`, the Erlang specification doesn't guarantee this. If a non-atom reason is thrown, the FFI will crash instead of returning `{error, Reason}`.\n\n**Evidence**: Testing `atom_to_binary({some, complex, term}, utf8)` in Erlang produces `error:badarg`.\n\n**Fix**: Use a more robust conversion:\n```erlang\nerror:Reason -\u003e {error, list_to_binary(io_lib:format(\"~p\", [Reason]))}\n```\nThis safely converts any Erlang term to a string representation.\n\n---\n\n### Finding 2: [P3] Missing tests for detect_cli_version spawn failures\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n\nThe implementation adds `detect_cli_version` with `SpawnFailed` error handling, but no tests verify this code path works. The spec mentions \"opt-in integration tests\" but they don't exist in the test suite.\n\n**Recommendation**: Add a test that calls `detect_cli_version(\"/nonexistent/path\")` and asserts it returns `Error(SpawnFailed(_))` rather than crashing. This verifies the safe FFI wrapper works correctly.\n\n**Note**: This is lower priority since the implementer manually verified the behavior and the type system ensures some correctness, but automated tests would catch regressions.\n\n---\n\n\u003c!-- fp:bbb93760b071a75e --\u003e\n\u003c!-- fp:e79886b59579f164 --\u003e\n\u003c!-- review_finding:182da4b4f078 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T01:37:27.659475359Z","created_by":"cyou","updated_at":"2026-01-11T01:41:03.781900997Z","closed_at":"2026-01-11T01:41:03.781900997Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-j37.4"],"dependencies":[{"issue_id":"casg-j37.19","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-11T01:37:27.659982786Z","created_by":"cyou"}]}
{"id":"casg-j37.2","title":"Implement build_cli_args with precedence rules","description":"## Overview\nImplement the build_cli_args() function in src/claude_agent_sdk/internal/cli.gleam that converts QueryOptions to CLI argument list.\n\n## Deliverables\n- src/claude_agent_sdk/internal/cli.gleam with:\n  - build_cli_args(options: QueryOptions, prompt: String) -\u003e List(String)\n  - Generates correct CLI flags from QueryOptions fields\n\n## Fixed Arguments (always included)\n`--print --output-format stream-json --verbose -- \u003cprompt\u003e`\n\n## CLI Argument Mapping (from plan)\n| QueryOptions Field | CLI Argument(s) |\n|-------------------|-----------------|\n| model | --model \u003cvalue\u003e |\n| max_turns | --max-turns \u003cvalue\u003e |\n| max_budget_usd | --max-budget-usd \u003cvalue\u003e |\n| system_prompt | --system-prompt \u003cvalue\u003e |\n| append_system_prompt | --append-system-prompt \u003cvalue\u003e |\n| allowed_tools | --allowed-tools tool1,tool2 |\n| disallowed_tools | --disallowed-tools tool1,tool2 |\n| mcp_config_path | --mcp-config \u003cpath\u003e |\n| permission_mode = AcceptEdits | --permission-mode acceptEdits |\n| permission_mode = BypassPermissions | --dangerously-skip-permissions |\n| permission_mode = Plan | --permission-mode plan |\n| resume_session_id | --resume \u003cuuid\u003e |\n| continue_session = True | --continue |\n\n## Precedence Rules (CRITICAL)\n1. system_prompt wins over append_system_prompt\n2. allowed_tools wins over disallowed_tools\n3. resume_session_id wins over continue_session\n\n## Acceptance Tests (from plan lines 4666-4669)\n- Given model=Some(\"sonnet\"), args include --model sonnet\n- Given system_prompt AND append_system_prompt set, only --system-prompt emitted\n- Given allowed_tools AND disallowed_tools set, only --allowed-tools emitted\n- Given resume_session_id AND continue_session=True, only --resume emitted","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:21:59.410902624Z","created_by":"cyou","updated_at":"2026-01-11T01:21:25.331934166Z","closed_at":"2026-01-11T01:21:25.331934166Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-j37.2","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:21:59.4116213Z","created_by":"cyou"},{"issue_id":"casg-j37.2","depends_on_id":"casg-j37.1","type":"blocks","created_at":"2026-01-10T23:24:09.31439788Z","created_by":"cyou"}]}
{"id":"casg-j37.20","title":"[Review] 2 non-blocking findings from casg-j37.7","description":"## Review Findings\n\nThis issue consolidates 2 non-blocking findings from code review.\n\n**Source issue:** casg-j37.7\n**Highest priority:** P3\n\n---\n\n### Finding 1: [P3] Consider guarding mark_closed against already-closed state\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/internal/stream.gleam:388-391\n\nThe `mark_closed()` function (stream.gleam:388-391) unconditionally sets both `state: Closed` and `closed: True`, even if the stream is already closed.\n\nWhile this is not a correctness bug (setting the same values twice is harmless), it differs from the `close()` function's idempotent design pattern (stream.gleam:157-165), which explicitly checks `internal.closed` and returns early if already closed.\n\nFor consistency and to avoid unnecessary allocations when repeatedly marking a stream as closed, consider adding:\n\n```gleam\npub fn mark_closed(stream: QueryStream) -\u003e QueryStream {\n  let QueryStream(internal) = stream\n  case internal.closed {\n    True -\u003e stream\n    False -\u003e QueryStream(QueryStreamInternal(..internal, state: Closed, closed: True))\n  }\n}\n```\n\nThis is a minor optimization and consistency improvement rather than a bug.\n\n---\n\n### Finding 2: [P3] Unused parameter _last_error in increment_decode_errors\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/internal/stream.gleam:357-369\n\nThe `increment_decode_errors` function (stream.gleam:357-369) accepts a `_last_error: String` parameter but doesn't use it (indicated by the underscore prefix).\n\nAccording to the implementation context, this function should track consecutive decode errors and potentially use the error message for diagnostic purposes. Currently, the error message is discarded.\n\nWhile this doesn't affect the current implementation's correctness (the threshold checking works fine), consider either:\n1. Removing the unused parameter if it's truly not needed\n2. Storing the last error message in `QueryStreamInternal` for better diagnostics when the threshold is exceeded\n\nThis appears to be intentional for future extensibility, so it's a very minor issue.\n\n---\n\n\u003c!-- fp:5cd2377099b1ba5c --\u003e\n\u003c!-- fp:c16766d1c7fa4700 --\u003e\n\u003c!-- review_finding:c50fc2ed12fe --\u003e","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-11T01:37:48.287853931Z","created_by":"cyou","updated_at":"2026-01-11T01:40:20.107454737Z","closed_at":"2026-01-11T01:40:20.107454737Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-j37.7"],"dependencies":[{"issue_id":"casg-j37.20","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-11T01:37:48.289046074Z","created_by":"cyou"}]}
{"id":"casg-j37.21","title":"[Review] 2 non-blocking findings from casg-j37.8","description":"## Review Findings\n\nThis issue consolidates 2 non-blocking findings from code review.\n\n**Source issue:** casg-j37.8\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Timeout during drain skips PendingEndOfStream state\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/internal/stream.gleam:584-586\n\nIn `receive_from_port()` at lines 584-586, when a timeout occurs in the `ResultReceived` state, the code calls both `mark_pending_end_of_stream()` and `mark_closed()`, then immediately yields `EndOfStream`:\n\n```gleam\nlet updated = mark_pending_end_of_stream(stream)\nlet closed = mark_closed(updated)\n#(Ok(EndOfStream), closed)\n```\n\nThis violates the state machine design documented in the commit message and code comments. According to the state machine, `PendingEndOfStream` is an intermediate state where the next call to `next()` should yield `EndOfStream`. The `next_impl()` function at lines 478-481 correctly implements this: when state is `PendingEndOfStream`, it yields `EndOfStream` and closes.\n\nBy transitioning to `PendingEndOfStream` but then immediately closing and yielding `EndOfStream` in the same call, the code bypasses the state machine's design. This creates inconsistency: exit status handling (via `handle_exit_status`) transitions to `PendingEndOfStream` and yields on the *next* call, but timeout handling yields immediately.\n\n**Fix**: Remove the immediate yield and let the state machine handle it:\n```gleam\nResultReceived -\u003e {\n  let updated = mark_pending_end_of_stream(stream)\n  next_impl(updated)\n}\n```\n\nThis ensures timeout handling follows the same state transition path as exit status handling.\n\n---\n\n### Finding 2: [P3] Decode error count uses stale stream reference\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/internal/stream.gleam:677-678\n\nIn `process_line()` at lines 677 and 694, when the decode error threshold is exceeded, the error count is computed using the original `internal` reference rather than the updated stream:\n\n```gleam\nlet #(updated, exceeded) = increment_decode_errors(stream, msg)\ncase exceeded {\n  True -\u003e {\n    let closed = mark_closed(updated)\n    #(\n      Error(NextTooManyDecodeErrors(\n        internal.consecutive_decode_errors + 1,  // Uses stale reference\n        msg,\n      )),\n      closed,\n    )\n  }\n```\n\nThe `internal` variable is captured from `stream` at line 652, but `increment_decode_errors` returns an `updated` stream with the incremented counter. While both compute to the same value in this specific case, using the stale reference is a code smell that could lead to bugs if the code is refactored.\n\n**Fix**: Extract the count from the updated stream:\n```gleam\nlet closed = mark_closed(updated)\nlet count = get_consecutive_decode_errors(updated)\n#(\n  Error(NextTooManyDecodeErrors(count, msg)),\n  closed,\n)\n```\n\nNote: Line 514 also has an inconsistency where it uses `constants.max_consecutive_decode_errors` instead of the actual count, which should be addressed for consistency.\n\n---\n\n\u003c!-- fp:3533ae4dbdaf53e3 --\u003e\n\u003c!-- fp:bd987c91e0f1db42 --\u003e\n\u003c!-- review_finding:202382e2d29d --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T01:44:23.886761746Z","created_by":"cyou","updated_at":"2026-01-11T01:47:15.945043345Z","closed_at":"2026-01-11T01:47:15.945043345Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-j37.8"],"dependencies":[{"issue_id":"casg-j37.21","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-11T01:44:23.887545512Z","created_by":"cyou"}]}
{"id":"casg-j37.22","title":"[Review] 1 non-blocking finding from casg-j37.11","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-j37.11\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Resource helpers missing from public stream module\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/stream.gleam:0\n\nThe new resource helper functions (`with_stream`, `collect_items`, `collect_messages`, `fold_stream`) and types (`CollectResult`, `FoldAction`) are exported from the main `claude_agent_sdk` module but not from the public `claude_agent_sdk/stream` facade module.\n\n**Inconsistency**: Other stream operations like `next()` and `close()` are available from both:\n- `claude_agent_sdk.next` ✓\n- `claude_agent_sdk/stream.next` ✓\n\nBut the new helpers are only available from:\n- `claude_agent_sdk.with_stream` ✓  \n- `claude_agent_sdk/stream.with_stream` ✗\n\n**Location**: src/claude_agent_sdk.gleam:211 has a misleading comment claiming \"from claude_agent_sdk/stream.gleam\" but the functions are actually imported from `internal_stream`.\n\n**User Impact**: Users who import `claude_agent_sdk/stream` for stream operations will not have access to these STABLE API helpers, creating confusion and forcing them to import from the main module instead.\n\n**Fix**: Add re-exports to `src/claude_agent_sdk/stream.gleam`:\n```gleam\npub type CollectResult(a) = internal_stream.CollectResult(a)\npub type FoldAction(a) = internal_stream.FoldAction(a)\npub const with_stream = internal_stream.with_stream\npub const collect_items = internal_stream.collect_items\npub const collect_messages = internal_stream.collect_messages\npub const fold_stream = internal_stream.fold_stream\n```\n\n---\n\n\u003c!-- fp:5cca6b485fe6dc0c --\u003e\n\u003c!-- review_finding:69a9689bca46 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T01:52:16.656018302Z","created_by":"cyou","updated_at":"2026-01-11T01:56:56.329255895Z","closed_at":"2026-01-11T01:56:56.329255895Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-j37.11"],"dependencies":[{"issue_id":"casg-j37.22","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-11T01:52:16.656537709Z","created_by":"cyou"}]}
{"id":"casg-j37.3","title":"Version detection types and parse_version_string","description":"## Overview\nImplement pure version parsing functions that can be fully unit-tested without OS processes.\n\n## Deliverables\n- src/claude_agent_sdk/internal/cli.gleam additions:\n  - CliVersion type: CliVersion(major: Int, minor: Int, patch: Int, raw: String)\n  - UnknownVersion(raw: String) variant\n  - parse_version_string(output: String) -\u003e Result(CliVersion, Nil)\n  - version_meets_minimum(version: CliVersion, minimum: CliVersion) -\u003e Bool\n  - format_version_error(detected: CliVersion, required: CliVersion) -\u003e String\n  - minimum_cli_version constant (1, 0, 0)\n\n## Parse Version Rules (from plan)\nMust handle various formats:\n- \"claude v1.2.3\\n\" -\u003e Ok(CliVersion(1,2,3,\"1.2.3\"))\n- \"1.2.3\" -\u003e Ok(CliVersion(1,2,3,\"1.2.3\"))\n- \"v1.2.3\" -\u003e Ok(CliVersion(1,2,3,\"1.2.3\"))\n- \"Claude Code CLI 1.2.3-beta.1\" -\u003e Ok(CliVersion(1,2,3,\"1.2.3\"))\n- \"  1.2.3  \\n\" -\u003e Ok (whitespace tolerant)\n- \"garbage\" -\u003e Error\n- \"\" -\u003e Error\n\n## Version Comparison (semantic versioning)\n- version_meets_minimum(v0.9.0, v1.0.0) -\u003e False\n- version_meets_minimum(v1.0.0, v1.0.0) -\u003e True\n- version_meets_minimum(v1.0.0-beta.1, v1.0.0) -\u003e True (prerelease passes)\n\n## Unit Tests (test/version_test.gleam)\nAll acceptance criteria from plan lines 4670-4680","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:22:11.402418014Z","created_by":"cyou","updated_at":"2026-01-11T01:29:27.587558426Z","closed_at":"2026-01-11T01:29:27.587558426Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-j37.3","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:22:11.40302149Z","created_by":"cyou"},{"issue_id":"casg-j37.3","depends_on_id":"casg-j37.1","type":"blocks","created_at":"2026-01-10T23:24:09.803807719Z","created_by":"cyou"}]}
{"id":"casg-j37.4","title":"Version detection integration (detect_cli_version via FFI)","description":"## Overview\nImplement detect_cli_version() that spawns `claude --version` using port_ffi and parses output.\n\n## Deliverables\n- src/claude_agent_sdk/internal/cli.gleam additions:\n  - detect_cli_version(cli_path: String) -\u003e Result(CliVersion, VersionCheckError)\n  - VersionCheckError type (Timeout, SpawnFailed, ParseFailed)\n  - default_version_timeout_ms() -\u003e Int (5000ms)\n\n## Implementation Details\n- Uses port_ffi.ffi_open_port() directly (v1 canonical path)\n- Spawns: `cli_path --version`\n- Uses receive_timeout (5s) to avoid hanging\n- Reads all output until exit_status\n- Passes output to parse_version_string()\n\n## Key Invariants (from plan)\n- Version detection uses raw FFI, not Runner abstraction\n- Same port options as query() for consistency\n- 5-second timeout (same as all preflight checks)\n- This is INTEGRATION code - only tested in opt-in integration tests\n\n## Integration Tests (opt-in via CLAUDE_INTEGRATION_TEST=1)\n- Real `claude --version` returns parseable version\n- Port preflight receives data from echo command","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:22:21.635034991Z","created_by":"cyou","updated_at":"2026-01-11T01:37:27.473438168Z","closed_at":"2026-01-11T01:37:27.473438168Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-j37.4","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:22:21.635585478Z","created_by":"cyou"},{"issue_id":"casg-j37.4","depends_on_id":"casg-j37.3","type":"blocks","created_at":"2026-01-10T23:24:10.310309941Z","created_by":"cyou"},{"issue_id":"casg-j37.4","depends_on_id":"casg-j37.13","type":"blocks","created_at":"2026-01-10T23:42:31.673250319Z","created_by":"cyou"}]}
{"id":"casg-j37.5","title":"QueryStream skeleton + StreamState enum + failing tests","description":"## Overview\nCreate the QueryStream opaque type and StreamState state machine types with failing tests.\n\n## Deliverables\n- src/claude_agent_sdk/internal/stream.gleam with:\n  - pub opaque type QueryStream (contains port, buffer, state, closed flag)\n  - StreamState enum: Streaming, ResultReceived, PendingEndOfStream, Closed\n  - QueryStreamInternal record (port, buffer, state, counters)\n  - Placeholder next() and close() signatures (implement later)\n\n## QueryStream Internal Structure (from plan lines 1986-1992)\n```gleam\ntype QueryStreamInternal {\n  QueryStreamInternal(\n    port: Port,           // Direct BEAM port\n    buffer: BitArray,     // Line reassembly buffer\n    state: StreamState,\n    consecutive_decode_errors: Int,\n    drain_count: Int,\n    closed: Bool,\n  )\n}\n```\n\n## StreamState Transitions (from plan diagram lines 2727-2773)\n- Streaming -\u003e ResultReceived (on Result message)\n- Streaming -\u003e PendingEndOfStream (on exit_status after Result)\n- ResultReceived -\u003e PendingEndOfStream (on drain complete)\n- PendingEndOfStream -\u003e Closed (after yielding EndOfStream)\n\n## Failing Test\n- test/stream_test.gleam with a minimal test that asserts state transitions fail until implemented\n\n## Key Invariants\n- QueryStream is single-process (documented constraint)\n- result_seen flag determines error handling\n- Port handle is shared across copies; per-copy state is buffer/counters\n\n**Note**: StreamItem, Warning, and StreamError types live in src/claude_agent_sdk/error.gleam (not in stream.gleam). stream.gleam should import and use those types.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:22:32.172900953Z","created_by":"cyou","updated_at":"2026-01-11T01:19:32.480414433Z","closed_at":"2026-01-11T01:19:32.480414433Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-j37.5","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:22:32.173627539Z","created_by":"cyou"},{"issue_id":"casg-j37.5","depends_on_id":"casg-j37.1","type":"blocks","created_at":"2026-01-10T23:24:10.802331175Z","created_by":"cyou"}]}
{"id":"casg-j37.6","title":"Line buffer implementation (byte-level, CRLF normalization)","description":"## Overview\nImplement the line reassembly buffer that handles arbitrary byte chunks from the port.\n\n## Deliverables\n- src/claude_agent_sdk/internal/stream.gleam additions:\n  - read_line(state: ReaderState) -\u003e #(ReadLineResult, ReaderState)\n  - normalize_crlf(buffer: BitArray) -\u003e BitArray\n  - ReadLineResult type: CompleteLine(String) | PortClosed | ExitReceived(Int) | BufferOverflow | Error(String)\n  - max_buffer_bytes constant (10MB)\n\n## Byte-Level Processing Pipeline (from plan lines 3229-3242)\nPort Data -\u003e Buffer -\u003e CRLF Normalize -\u003e Newline Split -\u003e UTF-8 Decode -\u003e JSON Parse -\u003e Message\n\n## Buffer Rules (from plan)\n1. Accumulate bytes until newline (0x0A) found\n2. Replace CRLF (\\r\\n) with LF (\\n) for Windows compat\n3. Split on newline at BYTE level (not String.split)\n4. UTF-8 decode per complete line (not per chunk)\n5. Return BufferOverflow if line exceeds 10MB\n\n## Incomplete Line Handling at exit_status (CRITICAL, from plan)\n| Buffer State | Exit Code | Result |\n|--------------|-----------|--------|\n| Empty | 0 | WarningEvent(CleanExitNoResult) | \n| Empty | !=0 | ProcessError(code, stdout_was_empty=True) |\n| Incomplete line | 0 | WarningEvent(IncompleteLastLine), EndOfStream (DO NOT parse line) |\n| Incomplete line | !=0 | ProcessError with last_non_json_line populated |\n\n**Important**: When exit_status arrives and the buffer does NOT end with a newline, do NOT attempt to parse it as JSON. The SDK must emit a warning and discard (exit=0) or include it as diagnostic context (exit!=0).\n\n## Unit Tests\n- Chunk reassembly across multiple Data messages\n- CRLF normalization\n- BufferOverflow at 10MB boundary\n- Incomplete line handling at exit_status (warning vs ProcessError)\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:22:44.88741655Z","created_by":"cyou","updated_at":"2026-01-11T01:33:10.42771993Z","closed_at":"2026-01-11T01:33:10.42771993Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-j37.6","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:22:44.888183666Z","created_by":"cyou"},{"issue_id":"casg-j37.6","depends_on_id":"casg-j37.5","type":"blocks","created_at":"2026-01-10T23:24:16.825397319Z","created_by":"cyou"},{"issue_id":"casg-j37.6","depends_on_id":"casg-j37.13","type":"blocks","created_at":"2026-01-10T23:42:16.431087799Z","created_by":"cyou"}]}
{"id":"casg-j37.7","title":"StreamState machine (transitions and result_seen precedence)","description":"## Overview\nImplement the stream state machine that handles Result vs exit_status precedence.\n\n## State Machine (from plan diagram lines 2727-2773)\n```\nSTREAMING\n   |\n   +-- Result message -\u003e Yield Ok(Message(Result)), state = ResultReceived\n   |\n   +-- exit_status (result_seen=FALSE) \n   |      +-- code=0 -\u003e WarningEvent(CleanExitNoResult), EndOfStream\n   |      +-- code!=0 -\u003e ProcessError (TERMINAL)\n   |\n   +-- exit_status (result_seen=TRUE)\n   |      +-- ANY code -\u003e WarningEvent + EndOfStream (Result is authoritative)\n   |\n   +-- Eof -\u003e EndOfStream (warn if no Result)\n```\n\n## Result vs exit_status Precedence (CRITICAL - from plan lines 2775-2784)\n| Scenario | result_seen | exit_status | Outcome |\n|----------|-------------|-------------|---------|\n| exit_status before Result | FALSE | 0 | EndOfStream (warn: no Result) |\n| exit_status before Result | FALSE | !=0 | ProcessError (terminal) |\n| exit_status after Result | TRUE | 0 | EndOfStream (normal) |\n| exit_status after Result | TRUE | !=0 | Warning only + EndOfStream |\n\n**Crisp invariant**: If result_seen == TRUE, no subsequent exit_status can produce ProcessError.\n\n## Deliverables\n- StreamState transition logic in next()\n- result_seen tracking\n- Proper warning generation for anomalies\n- consecutive_decode_errors counter (reset on success, threshold=5)\n\n## Unit Tests (using test_runner)\n- exit_status before Result -\u003e ProcessError (from plan line 4697)\n- Result then exit_status=0 -\u003e Result, EndOfStream (from plan line 4698)\n- Result then exit_status!=0 -\u003e Result, WarningEvent, EndOfStream (from plan line 4699)\n- exit_status=0 before Result -\u003e WarningEvent(CleanExitNoResult), EndOfStream (from plan line 4700)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:22:57.919574224Z","created_by":"cyou","updated_at":"2026-01-11T01:37:48.106674503Z","closed_at":"2026-01-11T01:37:48.106674503Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-j37.7","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:22:57.92038274Z","created_by":"cyou"},{"issue_id":"casg-j37.7","depends_on_id":"casg-j37.5","type":"blocks","created_at":"2026-01-10T23:24:17.321699819Z","created_by":"cyou"},{"issue_id":"casg-j37.7","depends_on_id":"casg-j37.6","type":"blocks","created_at":"2026-01-10T23:24:17.801038656Z","created_by":"cyou"},{"issue_id":"casg-j37.7","depends_on_id":"casg-j37.13","type":"blocks","created_at":"2026-01-10T23:42:21.508248683Z","created_by":"cyou"}]}
{"id":"casg-j37.8","title":"next() implementation with state-based timeout behavior","description":"## Overview\nImplement the next() function with full state-dependent behavior.\n\n## Signature\n```gleam\npub fn next(stream: QueryStream) -\u003e #(Result(StreamItem, StreamError), QueryStream)\n```\n\n## Timeout Behavior by State (from plan lines 3622-3641)\n| Stream State | Timeout Behavior | Notes |\n|--------------|------------------|-------|\n| Streaming (before Result) | Blocks indefinitely | User controls via max_turns/max_budget |\n| ResultReceived (after Result) | 100ms timeout per call | Drain behavior |\n| Closed | Returns immediately | No I/O needed |\n\n## Return Value Classification\n**Ok variants**:\n- Ok(Message(envelope)) -\u003e call next() again\n- Ok(WarningEvent(warning)) -\u003e call next() again\n- Ok(EndOfStream) -\u003e stop iteration\n\n**Error variants**:\n- Error(JsonDecodeError(_)) -\u003e Non-terminal, call next() again\n- Error(UnexpectedMessageError(_)) -\u003e Non-terminal, call next() again\n- Error(ProcessError(_)) -\u003e Terminal, stop iteration\n- Error(BufferOverflow) -\u003e Terminal, stop iteration\n- Error(TooManyDecodeErrors(_)) -\u003e Terminal, stop iteration\n\n## Critical Contract (from plan lines 3532-3553)\n**Always use returned QueryStream** - old copies have stale buffer/counters.\n\n## Implementation\n1. Check closed flag -\u003e return Ok(EndOfStream) if true\n2. Check state for appropriate receive timeout\n3. Call port_ffi.receive_blocking() or receive_timeout()\n4. Process data through line buffer\n5. Parse JSON, update state machine\n6. Return (result, updated_stream)\n\n## Unit Tests (using test_runner)\n- All acceptance criteria from plan lines 4693-4701","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:23:09.780030412Z","created_by":"cyou","updated_at":"2026-01-11T01:44:23.694147893Z","closed_at":"2026-01-11T01:44:23.694147893Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-j37.8","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:23:09.781085056Z","created_by":"cyou"},{"issue_id":"casg-j37.8","depends_on_id":"casg-j37.6","type":"blocks","created_at":"2026-01-10T23:24:18.283731763Z","created_by":"cyou"},{"issue_id":"casg-j37.8","depends_on_id":"casg-j37.7","type":"blocks","created_at":"2026-01-10T23:24:23.869004528Z","created_by":"cyou"},{"issue_id":"casg-j37.8","depends_on_id":"casg-j37.13","type":"blocks","created_at":"2026-01-10T23:42:26.591790174Z","created_by":"cyou"}]}
{"id":"casg-j37.9","title":"close() with idempotent cleanup and mailbox drain","description":"## Overview\nImplement the close() function with proper cleanup semantics.\n\n## Signature\n```gleam\npub fn close(stream: QueryStream) -\u003e Nil\n```\n\n## Semantics (from plan lines 3658-3666)\n- **Idempotent**: Safe to call multiple times; subsequent calls are no-ops\n- **Bounded-blocking**: Closes port then drains mailbox (bounded)\n- **Auto-called**: Called automatically on terminal errors and EndOfStream\n- **Same-process**: MUST be called from same process that called query()\n\n## Implementation Notes\n- Use port_ffi.ffi_close_port(port) which performs a bounded mailbox drain (max 100 msgs, 50ms timeout per msg)\n- close() itself should not attempt semantic drain; explicit close is user abort\n- Must only drain messages **for this Port** (mailbox isolation)\n\n## Pseudocode\n```gleam\npub fn close(stream: QueryStream) -\u003e Nil {\n  case stream.closed {\n    True -\u003e Nil\n    False -\u003e port_ffi.ffi_close_port(stream.port)\n  }\n}\n```\n\n## Acceptance Criteria\n- Calling close() multiple times is safe and does not crash\n- close() always calls port_close + bounded drain once\n- close() does NOT parse/emit any remaining messages (user-initiated abort)\n- Mailbox drain filters on Port (no cross-contamination)\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:23:26.114000138Z","created_by":"cyou","updated_at":"2026-01-11T01:31:48.618241491Z","closed_at":"2026-01-11T01:31:48.618241491Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-j37.9","depends_on_id":"casg-j37","type":"parent-child","created_at":"2026-01-10T23:23:26.114637544Z","created_by":"cyou"},{"issue_id":"casg-j37.9","depends_on_id":"casg-j37.5","type":"blocks","created_at":"2026-01-10T23:24:24.364742411Z","created_by":"cyou"}]}
{"id":"casg-k92","title":"Epic 1: Foundation Types \u0026 Decoders","description":"## Overview\nDefine all message types and JSON decoders with forward compatibility. This establishes the data model that all streaming and query operations depend on.\n\n## Why This is Critical\n- Message schema assumptions affect all downstream streaming code\n- Wrong type definitions will cascade bugs through the entire SDK\n- Forward compatibility (UnknownBlock, raw_json preservation) prevents breaking on CLI updates\n\n## Scope\n1. **Message Types** (src/claude_agent_sdk/message.gleam):\n   - SystemMessage, AssistantMessage, UserMessage, ResultMessage\n   - Message union type with all variants\n   - Core vs Extra field classification\n\n2. **Content Block Types** (src/claude_agent_sdk/content.gleam):\n   - TextBlock, ToolUseBlock, ToolResultBlock\n   - UnknownBlock for forward compatibility\n   - ContentBlock union type\n\n3. **Error Types** (src/claude_agent_sdk/error.gleam):\n   - QueryError with all variants (CliNotFoundError, ProcessError, etc.)\n   - StreamError (JsonDecodeError, BufferOverflow, etc.)\n   - Terminal vs non-terminal error classification\n\n4. **JSON Decoders** (src/claude_agent_sdk/internal/decoder.gleam):\n   - Message decoder with type dispatch\n   - Content block decoders\n   - raw_json preservation contract\n\n5. **Test Fixtures** (test/fixtures/):\n   - system_message.json, assistant_message.json, result_*.json\n   - unknown_message_type.json, unknown_content_block.json\n   - README documenting CLI version used\n\n## Success Criteria\n- All message types compile with proper field classification\n- Decoders handle known and unknown types gracefully\n- raw_json is preserved exactly (no re-encoding)\n- Fixtures pass decode/encode roundtrip tests\n\n## Dependencies\n- Depends on Epic 0 (project setup must complete first)\n\n## Plan References\n- Message Schema sections\n- Content Block Type System\n- JSON Decode Contract\n- raw_json preservation contract","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-10T23:19:43.42464702Z","created_by":"cyou","updated_at":"2026-01-11T01:04:02.427719352Z","closed_at":"2026-01-11T01:04:02.427719352Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-k92","depends_on_id":"casg-va1","type":"blocks","created_at":"2026-01-10T23:19:51.971617021Z","created_by":"cyou"}]}
{"id":"casg-k92.1","title":"Create test fixtures and failing decode tests","description":"## Goal\nSet up JSON test fixtures and initial failing decode tests that will drive TDD implementation of all decoders.\n\n## Context\nSPEC: Schema Source and Forward Compatibility (lines 3131-3224)\nSPEC: Test Structure (lines 4743-4763)\n\n## Fixture Policy (from plan)\n- Unit tests must run without a real CLI installed\n- **Synthetic fixtures first** (spec-derived minimal JSON)\n- Real CLI fixtures are captured later and committed\n- Tests NEVER write fixtures at runtime\n\n## TDD Steps\n1. Create test/fixtures/ directory\n2. Create fixture files:\n   - system_message.json, system_message_minimal.json\n   - assistant_message.json, assistant_unknown_block.json\n   - user_message.json\n   - result_success.json, result_error.json\n   - unknown_message_type.json, unknown_content_block.json\n3. Create test/fixtures/README.md documenting CLI version and synthetic fixtures\n4. Create test/json_decode_test.gleam with failing tests\n5. Create skeleton src/claude_agent_sdk/internal/decoder.gleam (empty decoders that fail)\n\n## Files\n- test/fixtures/*.json — [New] — JSON fixtures (synthetic initially)\n- test/fixtures/README.md — [New] — CLI version documentation\n- test/json_decode_test.gleam — [New] — Failing decode tests\n- src/claude_agent_sdk/internal/decoder.gleam — [New] — Skeleton decoder module\n\n## Acceptance Criteria\n- All fixture files exist and contain valid JSON\n- test/json_decode_test.gleam compiles but tests fail (decoders not implemented)\n- gleam build passes, gleam test fails with expected decoder errors\n- README clearly marks synthetic fixtures\n\n## Verification\n- gleam build succeeds\n- gleam test shows failing tests for each fixture decode\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:21:59.859358604Z","created_by":"cyou","updated_at":"2026-01-11T00:25:30.788643187Z","closed_at":"2026-01-11T00:25:30.788643187Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-k92.1","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-10T23:21:59.85997814Z","created_by":"cyou"}]}
{"id":"casg-k92.10","title":"Create Phase 1 spec verification artifact","description":"## Goal\nCreate the Phase 1 spec verification artifact required by the plan: `test/phase1_spec_verification.gleam` with a comment block that records which spec headings were verified for required fields.\n\n## Context\nPlan reference: \"Required artifact (test/phase1_spec_verification.gleam comment block)\" in the Spec-Citation Verification Rules section.\n\nThis file is a **documentation-only artifact** (comments), used to preserve the reasoning behind required vs optional fields in decoders.\n\n## Deliverables\n- `test/phase1_spec_verification.gleam` with a comment block:\n```gleam\n// Spec Verification Results - Phase 1\n// Date: YYYY-MM-DD\n// Spec version: plans/CLAUDE_AGENT_SDK_SPEC.md (commit hash)\n//\n// Field: type (all messages)\n// Heading: SPEC: Message Schema\n// Verified: YES - \"type field MUST be present\"\n//\n// Field: session_id (SystemMessage)\n// Heading: SPEC: System Message (NOT FOUND - used \"System Init\")\n// Verified: NO - SHOULD language only, defaulted to Optional\n```\n\n## Procedure (from plan)\n1. Search spec for exact heading cited in plan\n2. If found: check for MUST/REQUIRED language\n3. If not found: update heading string and default field to Optional\n4. Record result in the comment block (≤25 words per field)\n\n## Acceptance Criteria\n- Comment block exists with date + spec commit hash\n- Each required field lists heading + verification result\n- Any heading mismatch is recorded and defaults to Optional\n- File contains no executable code (comments only)\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:36:03.64301621Z","created_by":"cyou","updated_at":"2026-01-11T00:22:56.911228421Z","closed_at":"2026-01-11T00:22:56.911228421Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-k92.10","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-10T23:36:03.643581867Z","created_by":"cyou"}]}
{"id":"casg-k92.11","title":"Capture real CLI fixtures and help excerpt","description":"## Goal\nCapture real CLI fixtures (follow-up to synthetic fixtures) and save the `claude --help` excerpt used for flag validation.\n\n## Context\nPlan reference: \"Real fixture capture (follow-up)\" and \"cli_help_excerpt.txt\" in fixtures policy.\n\n## Deliverables\n- `test/fixtures/*.json` captured from real CLI output:\n  - system_message.json\n  - assistant_message.json\n  - user_message.json\n  - result_success.json\n  - result_error.json\n- `test/fixtures/cli_help_excerpt.txt` captured from `claude --help`\n- Update `test/fixtures/README.md` with:\n  - CLI version\n  - capture date\n  - capture command(s)\n\n## Capture Commands\n```bash\nclaude --print --output-format stream-json --verbose -- \"hello\"\nclaude --help\n```\n\n## Acceptance Criteria\n- Fixtures reflect real CLI output (not synthetic)\n- README records exact CLI version and capture date\n- cli_help_excerpt.txt includes required flags: --print, --output-format, --verbose\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:37:18.765438822Z","created_by":"cyou","updated_at":"2026-01-11T00:33:31.469146577Z","closed_at":"2026-01-11T00:33:31.469146577Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-k92.11","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-10T23:37:18.766424934Z","created_by":"cyou"},{"issue_id":"casg-k92.11","depends_on_id":"casg-k92.1","type":"blocks","created_at":"2026-01-10T23:42:01.197734624Z","created_by":"cyou"}]}
{"id":"casg-k92.12","title":"[Review] 3 non-blocking findings from casg-k92.10","description":"## Review Findings\n\nThis issue consolidates 3 non-blocking findings from code review.\n\n**Source issue:** casg-k92.10\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Incomplete field verification - missing 3 required fields\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** test/phase1_spec_verification.gleam:1-23\n\nThe **Canonical decoder policy table** in the plan (lines 3158-3165) specifies 5 fields that need Phase 1 verification:\n\n1. All messages - `type` ✓ (verified)\n2. SystemMessage - `session_id` ✓ (verified)\n3. AssistantMessage - `message.content` ✗ (missing)\n4. UserMessage - `message.content` ✗ (missing)\n5. ResultMessage - `subtype` ✗ (missing)\n\nThe verification artifact only covers items 1-2 and additionally verifies `subtype` and `uuid` for SystemMessage (which weren't in the canonical table). The verification is incomplete as it doesn't check AssistantMessage.message.content, UserMessage.message.content, or ResultMessage.subtype.\n\n**Fix**: Add verification entries for the 3 missing fields from the canonical table.\n\n---\n\n### Finding 2: [P3] Incorrect spec commit hash reference\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** test/phase1_spec_verification.gleam:3\n\nLine 3 references commit `bfb17717657136334390902e97a9f20c669f913f` as the spec version, but this commit (\"bd-casg-va1.12: Remove stale reference to deleted confirmed_imports.gleam\") doesn't modify the spec file at all - it only changes .beads/issues.jsonl.\n\nThe actual spec file (plans/CLAUDE_AGENT_SDK_SPEC.md) has only been modified in commit `e28b490` (initial commit). The commit hash should reference the actual commit that contains the spec version being verified.\n\n**Fix**: Update line 3 to reference `e28b490` or use `git log -1 --format=%H plans/CLAUDE_AGENT_SDK_SPEC.md` to get the correct hash.\n\n---\n\n### Finding 3: [P3] Verification claim contradicts spec-citation rules\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** test/phase1_spec_verification.gleam:5-7\n\nLine 7 claims verification \"YES - 'All messages are JSON objects with a `type` field'\" but this doesn't follow the spec-citation verification rules.\n\nPer plan lines 20-21:\n- **Required**: Spec uses MUST/REQUIRED language under an EXACT heading match\n- **Optional**: Spec uses SHOULD/MAY, or field not mentioned, or heading not found\n\nThe spec statement \"All messages are JSON objects with a `type` field\" is a factual assertion but doesn't use MUST/REQUIRED keywords. The spec contains NO instances of MUST or REQUIRED anywhere (verified via grep).\n\n**According to the verification procedure**, this should be marked as Optional, not Required. However, `type` is semantically required for message dispatch, so the conclusion may be correct even if the reasoning is flawed.\n\n**Recommendation**: Either:\n1. Clarify that semantic requirements override keyword rules, OR\n2. Mark as \"NO - no MUST/REQUIRED keywords, but semantically required for dispatch\"\n\n---\n\n\u003c!-- fp:ecb19a30979b5de5 --\u003e\n\u003c!-- fp:6dfe721a5d035209 --\u003e\n\u003c!-- fp:7034b9db0e2cda9d --\u003e\n\u003c!-- review_finding:e33b1825bb75 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T00:22:57.09291335Z","created_by":"cyou","updated_at":"2026-01-11T00:25:54.954593012Z","closed_at":"2026-01-11T00:25:54.954593012Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-k92.10"],"dependencies":[{"issue_id":"casg-k92.12","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-11T00:22:57.093989962Z","created_by":"cyou"}]}
{"id":"casg-k92.13","title":"[Review] 1 non-blocking finding from casg-k92.2","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-k92.2\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] ToolResultBlock missing required fields from JSON schema\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/message.gleam:157-164\n\nThe `ToolResultBlock` type definition is incomplete compared to the actual JSON structure in test fixtures.\n\n**Current definition:**\n```gleam\npub type ToolResultBlock {\n  ToolResultBlock(\n    tool_use_id: String,\n    content: String,\n  )\n}\n```\n\n**Actual JSON structure** (from `test/fixtures/user_message.json`):\n```json\n{\n  \"tool_use_id\": \"toolu_01BeipFBP3sUY3EAwVg3qQnE\",\n  \"type\": \"tool_result\",\n  \"content\": \"...\",\n  \"is_error\": false\n}\n```\n\n**Missing fields:**\n- `type`: String field (always \"tool_result\") - may be needed for decoder discrimination\n- `is_error`: Boolean field indicating if the tool execution failed\n\n**Recommended fix:**\n```gleam\npub type ToolResultBlock {\n  ToolResultBlock(\n    tool_use_id: String,\n    block_type: Option(String),  // or hardcode as \"tool_result\"\n    content: String,\n    is_error: Option(Bool),\n  )\n}\n```\n\nThis mismatch will cause the decoder implementation to either fail or silently ignore these fields, potentially losing important error information.\n\n---\n\n\u003c!-- fp:d21e0652e431f399 --\u003e\n\u003c!-- review_finding:2a8dbde2dd11 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T00:28:57.535454663Z","created_by":"cyou","updated_at":"2026-01-11T00:31:48.541078721Z","closed_at":"2026-01-11T00:31:48.541078721Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-k92.2"],"dependencies":[{"issue_id":"casg-k92.13","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-11T00:28:57.53599831Z","created_by":"cyou"}]}
{"id":"casg-k92.14","title":"[Review] 1 non-blocking finding from casg-k92.3","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-k92.3\n**Highest priority:** P3\n\n---\n\n### Finding 1: [P3] ToolResultBlock missing is_error field from API spec\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/content.gleam:22-24\n\nThe `ToolResultBlock` type only captures `tool_use_id` and `content` fields, but the Anthropic Messages API specification includes an optional `is_error: boolean` field for tool_result blocks. The actual CLI output (test/fixtures/user_message.json:10) contains this field.\n\n**Current implementation:**\n```gleam\npub type ToolResultBlock {\n  ToolResultBlock(tool_use_id: String, content: String)\n}\n```\n\n**Suggestion:** Consider adding `is_error: Option(Bool)` to capture error state:\n```gleam\npub type ToolResultBlock {\n  ToolResultBlock(\n    tool_use_id: String,\n    content: String,\n    is_error: Option(Bool)\n  )\n}\n```\n\nThis field indicates whether a tool execution resulted in an error, which can be useful for error handling and debugging. While the decoder policy states that unmentioned fields should be ignored, capturing documented API fields improves type safety and developer experience.\n\n**Note:** This is marked P3 because the decoder will handle the missing field gracefully per the forward compatibility policy (unknown fields are silently ignored). However, capturing all documented API fields would make the SDK more complete and useful.\n\n---\n\n\u003c!-- fp:00e2301ed806604c --\u003e\n\u003c!-- review_finding:6319f310369c --\u003e","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-11T00:30:09.611363874Z","created_by":"cyou","updated_at":"2026-01-11T00:30:43.872135955Z","closed_at":"2026-01-11T00:30:43.872135955Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-k92.3"],"dependencies":[{"issue_id":"casg-k92.14","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-11T00:30:09.612021209Z","created_by":"cyou"}]}
{"id":"casg-k92.15","title":"[Review] 1 non-blocking finding from casg-k92.13","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-k92.13\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Duplicate ToolResultBlock type definitions may cause confusion\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/message.gleam:160-169\n\nThe commit adds `is_error: Option(Bool)` to `ToolResultBlock` in both `content.gleam` and `message.gleam`. However, this creates two separate type definitions with the same name and structure:\n\n**In content.gleam (lines 23-32)**:\n```gleam\npub type ToolResultBlock {\n  ToolResultBlock(\n    tool_use_id: String,\n    content: String,\n    is_error: Option(Bool),\n  )\n}\n```\n\n**In message.gleam (lines 160-169)**:\n```gleam\npub type ToolResultBlock {\n  ToolResultBlock(\n    tool_use_id: String,\n    content: String,\n    is_error: Option(Bool),\n  )\n}\n```\n\n**Issue**: Having two separate definitions with identical structure is confusing and error-prone. If one is updated and not the other, they will diverge. The `message.gleam` file doesn't import from `content.gleam`, suggesting these are meant to be independent, but this violates DRY principle.\n\n**Recommendation**: \n1. Define `ToolResultBlock` once in `content.gleam` (since it's a content block type)\n2. Import and re-export it from `message.gleam` if needed for API surface\n3. Or, document why two separate definitions are intentional\n\nThis issue was introduced by updating both definitions when adding the `is_error` field, but the duplication pre-existed this commit.\n\n---\n\n\u003c!-- fp:e6e57ddd7f39edd7 --\u003e\n\u003c!-- review_finding:01ee24bb1e52 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T00:31:48.763898009Z","created_by":"cyou","updated_at":"2026-01-11T00:34:21.763308992Z","closed_at":"2026-01-11T00:34:21.763308992Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-k92.13"],"dependencies":[{"issue_id":"casg-k92.15","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-11T00:31:48.765028092Z","created_by":"cyou"}]}
{"id":"casg-k92.16","title":"[Review] 2 non-blocking findings from casg-k92.11","description":"## Review Findings\n\nThis issue consolidates 2 non-blocking findings from code review.\n\n**Source issue:** casg-k92.11\n**Highest priority:** P3\n\n---\n\n### Finding 1: [P3] Inconsistent fixture status - result_error.json still synthetic\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** test/fixtures/README.md:25\n\nThe README.md states that `result_error.json` is \"Error result message (synthetic - matches CLI schema)\" (line 25), indicating it's still synthetic despite the commit claiming to replace all synthetic fixtures with real CLI output.\n\n**Context**: The commit message states \"Replace synthetic fixtures with real CLI output\" but `result_error.json` appears to have placeholder data:\n- `uuid: \"error-uuid-placeholder\"` suggests this is not real output\n- The commit description says \"result_error.json: Updated to match real CLI schema\" rather than \"captured from real CLI\"\n\n**Impact**: This is acceptable for now since error scenarios may be difficult to capture naturally. However, the documentation should be clearer that this is intentionally synthetic.\n\n**Recommendation**: Either capture a real error case or update the main README section (lines 3-15) to note that result_error.json is the only synthetic fixture for practical reasons.\n\n---\n\n### Finding 2: [P3] CLI help excerpt includes full output, not excerpt\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** test/fixtures/cli_help_excerpt.txt:1-57\n\nThe file is named `cli_help_excerpt.txt` but actually contains the full `claude --help` output (57 lines). The README describes it as \"Full `claude --help` output\" (line 26), which contradicts the filename.\n\n**Context**: The plan mentions \"cli_help_excerpt.txt\" should be used for flag validation (checking that required flags like --print, --output-format, --verbose exist). An excerpt would typically be just the relevant sections, not the complete help text.\n\n**Impact**: This is a minor naming inconsistency. The file serves its purpose (flag validation) correctly, but the filename suggests it should be partial content.\n\n**Recommendation**: Either:\n1. Rename to `cli_help.txt` to match the content, or\n2. Extract only the Options section to create a true excerpt\n\nOption 1 is simpler and the full output may be useful for future reference.\n\n---\n\n\u003c!-- fp:5ad54df866e083fb --\u003e\n\u003c!-- fp:6d2bd9a5ba71b339 --\u003e\n\u003c!-- review_finding:f5bb7bbdbc55 --\u003e","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-11T00:33:31.690574006Z","created_by":"cyou","updated_at":"2026-01-11T00:35:39.583450924Z","closed_at":"2026-01-11T00:35:39.583450924Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-k92.11"],"dependencies":[{"issue_id":"casg-k92.16","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-11T00:33:31.691174482Z","created_by":"cyou"}]}
{"id":"casg-k92.17","title":"[Review] 1 non-blocking finding from casg-k92.15","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-k92.15\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] ContentBlock duplication remains unaddressed\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/message.gleam:122-129\n\nWhile this commit successfully removes the duplicate `ToolResultBlock` definition, an identical duplication issue exists for `ContentBlock`:\n\n**Duplicate definitions:**\n- `content.gleam:11-19` - Original definition with TextBlock, ToolUseBlock, UnknownBlock\n- `message.gleam:122-129` - Duplicate definition with identical structure\n\n**Why this is a problem:**\nSame issue as with ToolResultBlock: having two separate definitions is confusing and error-prone. If one is updated without the other, they will diverge.\n\n**Recommendation:**\nApply the same fix pattern used for ToolResultBlock:\n1. Remove the ContentBlock definition from `message.gleam:122-129`\n2. Update the import at line 8 to include ContentBlock: `import claude_agent_sdk/content.{type ContentBlock, type ToolResultBlock}`\n3. The decoder already imports ContentBlock from content.gleam, so this change is safe\n\n**Note:** This duplication pre-existed the current commit and is not a regression introduced by this change.\n\n---\n\n\u003c!-- fp:c99543ba16704c4d --\u003e\n\u003c!-- review_finding:c08f097c84a2 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T00:34:21.962565963Z","created_by":"cyou","updated_at":"2026-01-11T00:37:39.07051203Z","closed_at":"2026-01-11T00:37:39.07051203Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-k92.15"],"dependencies":[{"issue_id":"casg-k92.17","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-11T00:34:21.963347378Z","created_by":"cyou"}]}
{"id":"casg-k92.18","title":"[Review] 1 non-blocking finding from casg-k92.16","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-k92.16\n**Highest priority:** P3\n\n---\n\n### Finding 1: [P3] Plan file still references old cli_help_excerpt.txt filename\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** plans/2026-01-10-gleam-agent-sdk-plan.md:1794\n\nThe plan file `plans/2026-01-10-gleam-agent-sdk-plan.md` still references the old filename `cli_help_excerpt.txt` at two locations:\n\n- Line 1794: In the verification artifact section\n- Line 4415: In the file catalog table\n\nThese should be updated to `cli_help.txt` to match the renamed file and be consistent with the updated `test/fixtures/README.md`.\n\n**Fix**: Update both references from `cli_help_excerpt.txt` to `cli_help.txt` in the plan file.\n\n---\n\n\u003c!-- fp:c311fa4e2e808036 --\u003e\n\u003c!-- review_finding:ce618a73acf3 --\u003e","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-11T00:35:39.76767437Z","created_by":"cyou","updated_at":"2026-01-11T00:37:00.742186974Z","closed_at":"2026-01-11T00:37:00.742186974Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-k92.16"],"dependencies":[{"issue_id":"casg-k92.18","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-11T00:35:39.768199137Z","created_by":"cyou"}]}
{"id":"casg-k92.19","title":"[Review] 2 non-blocking findings from casg-k92.5","description":"## Review Findings\n\nThis issue consolidates 2 non-blocking findings from code review.\n\n**Source issue:** casg-k92.5\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] decode_content_blocks always returns Ok even with decode errors\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/internal/decoder.gleam:61-72\n\nThe `decode_content_blocks` function (lines 61-72) maps over a list of Dynamic values and calls `decode_content_block` on each. However, `decode_content_block` has signature `Dynamic -\u003e ContentBlock` (line 77) and returns an `UnknownBlock` for any decode failures (lines 91, 104, 119).\n\n**Issue**: This means that if a content block has the correct type (e.g., \"text\") but is missing required fields (e.g., the \"text\" field), it will be silently converted to an `UnknownBlock` instead of propagating the decode error.\n\n**Example**: A JSON object `{\"type\": \"text\"}` (missing the required \"text\" field) will decode as `UnknownBlock` instead of failing the parent message decode.\n\n**Expected behavior per acceptance criteria**: \"Missing required fields (text for TextBlock, id/name for ToolUseBlock) yield decode error\"\n\n**Current behavior**: Missing required fields yield `UnknownBlock`, which succeeds but loses type information.\n\n**Impact**: This violates the acceptance criteria and could mask data quality issues. A malformed TextBlock that's missing its text content will be silently accepted as an unknown block.\n\n**Recommendation**: Consider whether `decode_content_block_inner` functions should return `UnknownBlock` only for genuinely unknown types, not for known types with missing fields. Alternatively, document this as intended behavior for robustness.\n\n---\n\n### Finding 2: [P3] Inconsistent error handling between decode_content_block variants\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/internal/decoder.gleam:77-169\n\nThere are two sets of content block decoders with different error handling:\n\n1. **Lenient decoders** (lines 77-121): `decode_content_block`, `decode_text_block_inner`, `decode_tool_use_block_inner` return `ContentBlock` and use `UnknownBlock` for any failures\n\n2. **Strict decoders** (lines 124-169): `decode_text_block`, `decode_tool_use_block` return `Result(ContentBlock, DecodeError)` and fail on missing fields\n\n**Issue**: It's unclear when to use each variant. The public API exports both, but their different behavior could confuse users.\n\n**Examples**:\n- `decode_content_blocks` (line 61) uses the lenient `decode_content_block`\n- There's no corresponding `decode_content_blocks_strict` that uses the strict variants\n\n**Recommendation**: \n1. Document the distinction clearly in the module-level docs\n2. Consider making the `_inner` functions private if they're only meant for internal use\n3. Clarify which variant should be used in which scenarios (e.g., \"Use strict decoders for validation, lenient for forward-compatible streaming\")\n\n---\n\n\u003c!-- fp:baad0deeb4671303 --\u003e\n\u003c!-- fp:b2d4a18e3c5889c9 --\u003e\n\u003c!-- review_finding:b6ad2d5c932c --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T00:35:41.796660624Z","created_by":"cyou","updated_at":"2026-01-11T00:39:34.755582826Z","closed_at":"2026-01-11T00:39:34.755582826Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-k92.5"],"dependencies":[{"issue_id":"casg-k92.19","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-11T00:35:41.79728248Z","created_by":"cyou"}]}
{"id":"casg-k92.2","title":"Define base message types in message.gleam","description":"## Goal\nImplement all message type definitions that will be populated by JSON decoders.\n\n## Context\nSPEC: Message Types (lines 3282-3494)\nSPEC: Message Field Classification (lines 3348-3494)\n\n## TDD Steps\n1. Read existing test/json_decode_test.gleam to understand expected types\n2. Create src/claude_agent_sdk/message.gleam with:\n   - Message (discriminated union: System, Assistant, User, Result)\n   - MessageEnvelope (message, raw_json, raw_bytes)\n   - SystemMessage with all Optional fields per decoder policy\n   - AssistantMessage with AssistantMessageContent\n   - UserMessage with UserMessageContent\n   - ResultMessage with ResultSubtype\n   - Usage, McpServerStatus, PermissionDenial supporting types\n3. Update tests to import and use types\n\n## Files\n- src/claude_agent_sdk/message.gleam — [New] — All message type definitions\n- test/json_decode_test.gleam — [Exists] — Update imports\n\n## Acceptance Criteria\n- All message types compile with proper Option wrapping\n- Message is discriminated union with System/Assistant/User/Result\n- ResultSubtype includes Success, ErrorMaxTurns, ErrorDuringExecution, ErrorMaxBudget, UnknownSubtype\n- Usage type has optional input_tokens, output_tokens, cache_* fields\n\n## Verification\n- gleam build succeeds\n- Types can be imported in test file","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:22:10.49035084Z","created_by":"cyou","updated_at":"2026-01-11T00:28:57.328337241Z","closed_at":"2026-01-11T00:28:57.328337241Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-k92.2","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-10T23:22:10.491474704Z","created_by":"cyou"},{"issue_id":"casg-k92.2","depends_on_id":"casg-k92.1","type":"blocks","created_at":"2026-01-10T23:23:39.129713415Z","created_by":"cyou"},{"issue_id":"casg-k92.2","depends_on_id":"casg-k92.10","type":"blocks","created_at":"2026-01-10T23:42:06.268254797Z","created_by":"cyou"}]}
{"id":"casg-k92.20","title":"[Review] 1 non-blocking finding from casg-k92.19","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-k92.19\n**Highest priority:** P3\n\n---\n\n### Finding 1: [P3] Comment at line 118 doesn't cover all cases handled\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/internal/decoder.gleam:118-119\n\nThe comment at line 118 states \"Missing type field - treat as unknown block\", but the `Error(_)` pattern also handles cases where:\n- The type field exists but is not a string (e.g., `{\"type\": 123}`)\n- The type field exists but the JSON structure is malformed in other ways\n\nWhile the behavior is correct (treating these as unknown blocks for forward compatibility), the comment could be more accurate.\n\n**Recommendation**: Update the comment to: \"Missing or malformed type field - treat as unknown block\" or \"Cannot decode type field - treat as unknown block\"\n\n---\n\n\u003c!-- fp:46d6fae047220fb4 --\u003e\n\u003c!-- review_finding:7862c260a0ae --\u003e","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-11T00:39:34.939282728Z","created_by":"cyou","updated_at":"2026-01-11T00:42:26.411907806Z","closed_at":"2026-01-11T00:42:26.411907806Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-k92.19"],"dependencies":[{"issue_id":"casg-k92.20","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-11T00:39:34.939773064Z","created_by":"cyou"}]}
{"id":"casg-k92.21","title":"[Review] 1 non-blocking finding from casg-k92.9","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-k92.9\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Missing TextBlock, ToolUseBlock, UnknownBlock re-exports\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk.gleam:54-58\n\nThe specification (line 4340) requires re-exporting the ContentBlock constructors individually:\n\n```\npub { ContentBlock, TextBlock, ToolUseBlock, UnknownBlock }\n```\n\nHowever, the implementation at src/claude_agent_sdk.gleam:54-58 only re-exports the type alias:\n\n```gleam\npub type ContentBlock =\n  content.ContentBlock\n\npub type ToolResultBlock =\n  content.ToolResultBlock\n```\n\nThis means users cannot access `TextBlock`, `ToolUseBlock`, or `UnknownBlock` directly from the main module. They would need to either:\n1. Import from `claude_agent_sdk/content` separately, or\n2. Use qualified names like `content.TextBlock`\n\nBoth options defeat the purpose of the main module re-export convenience.\n\n**How to fix**: Since ContentBlock is a discriminated union type (not a record), Gleam requires importing the type AND its constructors separately. The fix is to add:\n\n```gleam\nimport claude_agent_sdk/content.{\n  type ContentBlock, TextBlock, ToolUseBlock, UnknownBlock,\n  type ToolResultBlock, ToolResultBlock as ToolResultBlockConstructor\n}\n\npub type ContentBlock = content.ContentBlock\npub const TextBlock = content.TextBlock\npub const ToolUseBlock = content.ToolUseBlock  \npub const UnknownBlock = content.UnknownBlock\n```\n\nOr more idiomatically, directly re-export the constructors in the public module exports section.\n\nNote: The test file (test/api_surface_test.gleam:98) imports constructors from `content` module directly, so tests pass, but this masks the API surface issue for end users who expect to import everything from the main module.\n\n---\n\n\u003c!-- fp:171f346cc7886916 --\u003e\n\u003c!-- review_finding:e27ca23e507a --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T01:04:02.526563009Z","created_by":"cyou","updated_at":"2026-01-11T01:08:14.117320342Z","closed_at":"2026-01-11T01:08:14.117320342Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-k92.9"],"dependencies":[{"issue_id":"casg-k92.21","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-11T01:04:02.527256646Z","created_by":"cyou"}]}
{"id":"casg-k92.22","title":"[Review] 1 non-blocking finding from casg-k92.21","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-k92.21\n**Highest priority:** P3\n\n---\n\n### Finding 1: [P3] Factory functions don't enable pattern matching from main module\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk.gleam:55-89\n\nThe commit adds factory functions (`text_block`, `tool_use_block`, `unknown_block`) to create ContentBlock instances from the main module, addressing constructor access. However, users still cannot pattern match using the main module:\n\n**Cannot do:**\n```gleam\nimport claude_agent_sdk.{type ContentBlock}\ncase block {\n  claude_agent_sdk.TextBlock(text) -\u003e ... // Error: TextBlock not exported\n}\n```\n\n**Must do:**\n```gleam\nimport claude_agent_sdk.{type ContentBlock}\nimport claude_agent_sdk/content  // Additional import required\ncase block {\n  content.TextBlock(text) -\u003e ...\n}\n```\n\nThe commit message acknowledges \"Gleam does not support re-exporting variant constructors\" and provides factory functions as a workaround. This is a language limitation, not a bug.\n\n**Impact:** Minor ergonomics issue. Users need one additional import line for pattern matching. Factory functions handle construction, but pattern matching requires the `content` module import.\n\n**Recommendation:** Consider documenting this in module-level docs or the README to set user expectations. The current implementation is correct given Gleam's limitations.\n\n---\n\n\u003c!-- fp:3a056475d1768bd9 --\u003e\n\u003c!-- review_finding:042085c5acb2 --\u003e","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-11T01:08:14.216518563Z","created_by":"cyou","updated_at":"2026-01-11T01:10:54.27332143Z","closed_at":"2026-01-11T01:10:54.27332143Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-k92.21"],"dependencies":[{"issue_id":"casg-k92.22","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-11T01:08:14.21707953Z","created_by":"cyou"}]}
{"id":"casg-k92.3","title":"Define content block types in content.gleam","description":"## Goal\nImplement content block type definitions for assistant and user message content.\n\n## Context\nSPEC: Content block types (lines 3407-3442)\nSPEC: Forward compatibility (lines 3146-3147)\n\n## TDD Steps\n1. Create src/claude_agent_sdk/content.gleam with:\n   - ContentBlock discriminated union (TextBlock, ToolUseBlock, UnknownBlock)\n   - TextBlock(text: String)\n   - ToolUseBlock(id: String, name: String, input: Dynamic)\n   - UnknownBlock(raw: Dynamic) for forward compatibility\n   - ToolResultBlock(tool_use_id: String, content: String)\n2. Update message.gleam imports if needed\n3. Update tests to verify types compile\n\n## Files\n- src/claude_agent_sdk/content.gleam — [New] — Content block type definitions\n- src/claude_agent_sdk/message.gleam — [Exists] — May need to import content types\n\n## Acceptance Criteria\n- ContentBlock is discriminated union with TextBlock, ToolUseBlock, UnknownBlock\n- UnknownBlock preserves raw Dynamic for forward compatibility\n- ToolUseBlock.input is Dynamic (not decoded further)\n- ToolResultBlock separate type for user message content\n\n## Verification\n- gleam build succeeds\n- Content types can be used in message.gleam","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:22:20.057771515Z","created_by":"cyou","updated_at":"2026-01-11T00:30:09.386919519Z","closed_at":"2026-01-11T00:30:09.386919519Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-k92.3","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-10T23:22:20.058417461Z","created_by":"cyou"},{"issue_id":"casg-k92.3","depends_on_id":"casg-k92.1","type":"blocks","created_at":"2026-01-10T23:23:39.19005098Z","created_by":"cyou"},{"issue_id":"casg-k92.3","depends_on_id":"casg-k92.10","type":"blocks","created_at":"2026-01-10T23:42:11.348511695Z","created_by":"cyou"}]}
{"id":"casg-k92.4","title":"Define error types in error.gleam","description":"## Goal\nImplement all error, warning, and stream item types used for SDK error handling.\n\n## Context\nSPEC: StreamError Type (lines 3867-3959)\nSPEC: QueryError Type (lines 4111-4139)\nSPEC: Warning Type (lines 4025-4042)\nSPEC: Error Taxonomy (lines 4090-4107)\n\n## TDD Steps\n1. Create src/claude_agent_sdk/error.gleam with:\n   - StreamError variants: ProcessError, BufferOverflow, TooManyDecodeErrors, JsonDecodeError, UnexpectedMessageError\n   - QueryError variants: CliNotFoundError, UnsupportedCliVersionError, UnknownVersionError, VersionDetectionError, SpawnError\n   - ErrorDiagnostic for ProcessError context\n   - Warning and WarningCode types\n   - StreamItem discriminated union (Message, WarningEvent, EndOfStream)\n   - is_terminal(StreamError) -\u003e Bool function\n   - error_to_string and stream_error_to_string functions\n2. Write tests for is_terminal() behavior\n\n## Files\n- src/claude_agent_sdk/error.gleam — [New] — All error type definitions\n- test/error_test.gleam — [New] — Tests for is_terminal()\n\n## Acceptance Criteria\n- ProcessError, BufferOverflow, TooManyDecodeErrors are terminal (is_terminal returns True)\n- JsonDecodeError, UnexpectedMessageError are non-terminal (is_terminal returns False)\n- ErrorDiagnostic includes last_non_json_line, stdout_was_empty, exit_code_hint, troubleshooting\n- WarningCode includes CleanExitNoResult, NonZeroExitAfterResult, UnexpectedMessageAfterResult, UnparseableCliVersion\n\n## Verification\n- gleam build succeeds\n- gleam test error_test.gleam passes","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:22:32.817457245Z","created_by":"cyou","updated_at":"2026-01-11T00:32:38.218545201Z","closed_at":"2026-01-11T00:32:38.218545201Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-k92.4","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-10T23:22:32.818072181Z","created_by":"cyou"},{"issue_id":"casg-k92.4","depends_on_id":"casg-k92.1","type":"blocks","created_at":"2026-01-10T23:23:39.249358672Z","created_by":"cyou"}]}
{"id":"casg-k92.5","title":"Implement content block JSON decoders","description":"## Goal\nImplement JSON decoders for ContentBlock and ToolResultBlock with UnknownBlock fallback for forward compatibility.\n\n## Context\nSPEC: JSON Decoding Strategy (lines 3496-3502)\nSPEC: Content block types (lines 3407-3442)\nSPEC: Forward compatibility (lines 3146-3147)\n\n## TDD Steps\n1. Update src/claude_agent_sdk/internal/decoder.gleam with:\n   - decode_content_block(Dynamic) -\u003e Result(ContentBlock, DecodeErrors)\n   - decode_text_block(Dynamic) -\u003e Result(TextBlock, DecodeErrors)\n   - decode_tool_use_block(Dynamic) -\u003e Result(ToolUseBlock, DecodeErrors)\n   - decode_tool_result_block(Dynamic) -\u003e Result(ToolResultBlock, DecodeErrors)\n2. Implement type-dispatch logic: check type field, route to appropriate decoder\n3. Unknown type field values yield UnknownBlock(raw) instead of decode error\n4. Run tests against unknown_content_block.json fixture\n\n## Files\n- src/claude_agent_sdk/internal/decoder.gleam — [Exists] — Add content block decoders\n- test/json_decode_test.gleam — [Exists] — Verify content block decode tests pass\n\n## Acceptance Criteria\n- TextBlock decodes {\"type\":\"text\",\"text\":\"hello\"} correctly\n- ToolUseBlock decodes id, name, input fields\n- Unknown block type yields UnknownBlock(raw) with original Dynamic\n- Missing required fields (text for TextBlock, id/name for ToolUseBlock) yield decode error\n\n## Verification\n- gleam test test/json_decode_test.gleam passes for content block fixtures","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:22:44.224585433Z","created_by":"cyou","updated_at":"2026-01-11T00:35:41.607661269Z","closed_at":"2026-01-11T00:35:41.607661269Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-k92.5","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-10T23:22:44.225155799Z","created_by":"cyou"},{"issue_id":"casg-k92.5","depends_on_id":"casg-k92.3","type":"blocks","created_at":"2026-01-10T23:23:42.878265074Z","created_by":"cyou"}]}
{"id":"casg-k92.6","title":"Implement message type JSON decoders","description":"## Goal\nImplement JSON decoders for all message types with proper Optional field handling per decoder policy.\n\n## Context\nSPEC: Message Types (lines 3282-3494)\nSPEC: Canonical Decoder Policy Table (lines 3154-3213)\nSPEC: Decode Failure Semantics (lines 3172-3183)\n\n## TDD Steps\n1. Update src/claude_agent_sdk/internal/decoder.gleam with:\n   - decode_system_message(Dynamic) -\u003e Result(SystemMessage, DecodeErrors)\n   - decode_assistant_message(Dynamic) -\u003e Result(AssistantMessage, DecodeErrors)\n   - decode_user_message(Dynamic) -\u003e Result(UserMessage, DecodeErrors)\n   - decode_result_message(Dynamic) -\u003e Result(ResultMessage, DecodeErrors)\n   - decode_message(Dynamic) -\u003e Result(Message, DecodeErrors) (top-level dispatcher)\n2. Only `type` field is required; all others use optional_field\n3. Dispatch based on type field: system, assistant, user, result\n4. Unknown type field yields appropriate error for UnexpectedMessageError\n\n## Files\n- src/claude_agent_sdk/internal/decoder.gleam — [Exists] — Add message decoders\n- test/json_decode_test.gleam — [Exists] — Verify message decode tests pass\n\n## Acceptance Criteria\n- System message decodes with all Optional fields (session_id, uuid, cwd, model, tools, etc.)\n- Assistant message decodes with Optional message.content containing List(ContentBlock)\n- User message decodes with Optional message.content containing List(ToolResultBlock)\n- Result message decodes with Optional subtype (Success, ErrorMaxTurns, etc.)\n- Unknown message type returns error (will become UnexpectedMessageError in stream layer)\n- Minimal fixtures (only type field) decode successfully\n\n## Verification\n- gleam test test/json_decode_test.gleam passes for all message fixtures\n- system_message_minimal.json decodes to SystemMessage with all None fields","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:22:56.194434878Z","created_by":"cyou","updated_at":"2026-01-11T00:41:38.174139595Z","closed_at":"2026-01-11T00:41:38.174139595Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-k92.6","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-10T23:22:56.194988655Z","created_by":"cyou"},{"issue_id":"casg-k92.6","depends_on_id":"casg-k92.2","type":"blocks","created_at":"2026-01-10T23:23:46.828157975Z","created_by":"cyou"},{"issue_id":"casg-k92.6","depends_on_id":"casg-k92.5","type":"blocks","created_at":"2026-01-10T23:23:46.885895816Z","created_by":"cyou"},{"issue_id":"casg-k92.6","depends_on_id":"casg-k92.8","type":"blocks","created_at":"2026-01-10T23:23:46.945865024Z","created_by":"cyou"}]}
{"id":"casg-k92.7","title":"Implement MessageEnvelope decoder with raw_json preservation","description":"## Goal\nImplement MessageEnvelope decoder that preserves raw_json byte-for-byte per the preservation contract.\n\n## Context\nSPEC: raw_json preservation contract (lines 3302-3345)\nSPEC: MessageEnvelope type (lines 3294-3300)\n\n## TDD Steps\n1. Update src/claude_agent_sdk/internal/decoder.gleam with:\n   - decode_message_envelope(json_string: String, raw_bytes: BitArray) -\u003e Result(MessageEnvelope, DecodeError)\n2. Implementation:\n   a. Store raw_json = json_string (exact UTF-8 string)\n   b. Store raw_bytes = raw_bytes (exact bytes)\n   c. Parse JSON with gleam_json\n   d. Decode Message using decode_message\n   e. Return MessageEnvelope(message, raw_json, raw_bytes)\n3. Add test verifying raw_json == fixture content byte-for-byte\n4. Add test verifying raw_bytes matches original input\n\n## Files\n- src/claude_agent_sdk/internal/decoder.gleam — [Exists] — Add envelope decoder\n- test/json_decode_test.gleam — [Exists] — Add raw preservation tests\n\n## Acceptance Criteria\n- raw_json field contains exact input string, not re-encoded JSON\n- raw_bytes field contains exact input BitArray\n- Decode errors include the raw_json for debugging\n- MessageEnvelope.message contains fully decoded Message\n\n## Verification\n- gleam test verifies raw_json byte-for-byte matches fixture file\n- gleam test verifies raw_bytes matches bit_array.from_string(fixture)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:23:07.650539252Z","created_by":"cyou","updated_at":"2026-01-11T00:45:28.869932342Z","closed_at":"2026-01-11T00:45:28.869932342Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-k92.7","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-10T23:23:07.651112878Z","created_by":"cyou"},{"issue_id":"casg-k92.7","depends_on_id":"casg-k92.6","type":"blocks","created_at":"2026-01-10T23:23:50.957716833Z","created_by":"cyou"}]}
{"id":"casg-k92.8","title":"Implement supporting type decoders (Usage, ResultSubtype, McpServerStatus)","description":"## Goal\nImplement JSON decoders for supporting types used within message structures.\n\n## Context\nSPEC: Usage type (lines 3474-3481)\nSPEC: ResultSubtype (lines 3466-3472)\nSPEC: McpServerStatus (lines 3483-3485)\nSPEC: PermissionDenial (lines 3487-3493)\n\n## TDD Steps\n1. Update src/claude_agent_sdk/internal/decoder.gleam with:\n   - decode_usage(Dynamic) -\u003e Result(Usage, DecodeErrors)\n   - decode_result_subtype(String) -\u003e ResultSubtype\n   - decode_mcp_server_status(Dynamic) -\u003e Result(McpServerStatus, DecodeErrors)\n   - decode_permission_denial(Dynamic) -\u003e Result(PermissionDenial, DecodeErrors)\n2. ResultSubtype dispatch:\n   - \"success\" -\u003e Success\n   - \"error_max_turns\" -\u003e ErrorMaxTurns\n   - \"error_during_execution\" -\u003e ErrorDuringExecution\n   - \"error_max_budget\" -\u003e ErrorMaxBudget\n   - unknown -\u003e UnknownSubtype(raw_string)\n3. All Usage fields are optional (may be absent in older CLI versions)\n\n## Files\n- src/claude_agent_sdk/internal/decoder.gleam — [Exists] — Add supporting type decoders\n- test/json_decode_test.gleam — [Exists] — Add tests for edge cases\n\n## Acceptance Criteria\n- Usage decodes with all Optional Int fields\n- ResultSubtype handles unknown values via UnknownSubtype(String)\n- McpServerStatus decodes name and status fields\n- PermissionDenial decodes tool_name, tool_use_id, tool_input\n\n## Verification\n- gleam test passes for result_success.json and result_error.json fixtures\n- Unknown subtype string yields UnknownSubtype rather than decode error","notes":"Quality gate failed: Killed as deadlock victim (will retry after blocker completes)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:23:19.341451233Z","created_by":"cyou","updated_at":"2026-01-11T00:37:37.627096068Z","closed_at":"2026-01-11T00:37:37.627096068Z","close_reason":"Closed","labels":["needs-followup"],"dependencies":[{"issue_id":"casg-k92.8","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-10T23:23:19.34204528Z","created_by":"cyou"},{"issue_id":"casg-k92.8","depends_on_id":"casg-k92.2","type":"blocks","created_at":"2026-01-10T23:23:42.932051107Z","created_by":"cyou"},{"issue_id":"casg-k92.8","depends_on_id":"casg-k92.11","type":"blocks","created_at":"2026-01-11T00:30:41.030569744Z","created_by":"cyou"}]}
{"id":"casg-k92.9","title":"Wire up public API re-exports for Epic 1 types","description":"## Goal\nConfigure public module exports so Epic 1 types are accessible via the main SDK module.\n\n## Context\nSPEC: Main module re-exports (lines 4335-4345)\nSPEC: Module paths (lines 51-57)\n\n## TDD Steps\n1. Update src/claude_agent_sdk.gleam to re-export:\n   - From message.gleam: Message, MessageEnvelope, SystemMessage, AssistantMessage, UserMessage, ResultMessage\n   - From content.gleam: ContentBlock, TextBlock, ToolUseBlock, UnknownBlock\n   - From error.gleam: QueryError, StreamError, ErrorDiagnostic, is_terminal, StreamItem, Warning, WarningCode\n   - Supporting types: ResultSubtype, Usage, McpServerStatus, PermissionDenial\n2. Verify internal decoder module is NOT exported (internal only)\n3. Add example imports to test that validates API surface\n\n## Files\n- src/claude_agent_sdk.gleam — [Exists] — Add re-exports\n- test/api_surface_test.gleam — [New] — Verify public imports work\n\n## Acceptance Criteria\n- Users can import types via: import claude_agent_sdk.{Message, SystemMessage, ...}\n- Internal decoder module not accessible from outside package\n- All Epic 1 types importable from main module\n\n## Verification\n- gleam build succeeds\n- test/api_surface_test.gleam compiles and passes\n- gleam docs generates documentation for all public types","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:23:30.289225131Z","created_by":"cyou","updated_at":"2026-01-11T00:51:22.062397594Z","closed_at":"2026-01-11T00:51:22.062397594Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-k92.9","depends_on_id":"casg-k92","type":"parent-child","created_at":"2026-01-10T23:23:30.290184975Z","created_by":"cyou"},{"issue_id":"casg-k92.9","depends_on_id":"casg-k92.2","type":"blocks","created_at":"2026-01-10T23:23:54.91926884Z","created_by":"cyou"},{"issue_id":"casg-k92.9","depends_on_id":"casg-k92.3","type":"blocks","created_at":"2026-01-10T23:23:54.974472825Z","created_by":"cyou"},{"issue_id":"casg-k92.9","depends_on_id":"casg-k92.4","type":"blocks","created_at":"2026-01-10T23:23:55.031348591Z","created_by":"cyou"},{"issue_id":"casg-k92.9","depends_on_id":"casg-k92.7","type":"blocks","created_at":"2026-01-10T23:23:55.086289268Z","created_by":"cyou"}]}
{"id":"casg-lde","title":"Epic: Bidirectional Protocol - BidirRunner \u0026 Port IO","description":"## Overview\nCreate the internal BidirRunner type for push-based IO. This is the core IO layer that bidir mode depends on.\n\n## Source Plan\n`plans/2026-01-12-bidir-protocol-plan.md` - \"Port Message Protocol\" section\n\n## Key Principle\n**Public Runner (runner.gleam) is NOT modified.** We add a NEW internal BidirRunner.\n\n## Key Deliverables\n- internal/bidir_runner.gleam: BidirRunner type with port, write, close\n- Port spawning with spawn_executable + stderr_to_stdout\n- Native port message handling: {Port, {data, Binary}}, {Port, {exit_status, Code}}\n- Line buffering in stream parser (no {line, N} - manual buffering)\n\n## Port Configuration\n\\`\\`\\`erlang\nopen_port({spawn_executable, ClaudePath}, [\n  {args, [\"--output-format\", \"stream-json\", \"--input-format\", \"stream-json\"]},\n  binary, {packet, 0}, exit_status, use_stdio, stderr_to_stdout\n]).\n\\`\\`\\`\n\n## TDD Focus\n- Port message decode test: {Port, {data, Binary}} -\u003e PortData\n- Port ownership invariant: must be created inside GenServer init\n- Partial line buffering tests\n- Max line size (16MB) safety limit\n\n## Files\n- src/claude_agent_sdk/internal/bidir_runner.gleam (New)\n- src/claude_agent_sdk/internal/stream.gleam (Exists - extend for line buffering)\n- test/bidir_runner_test.gleam (New)\n- test/stream_buffer_test.gleam (New)","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-12T04:06:50.053945224Z","created_by":"cyou","updated_at":"2026-01-12T06:00:17.082432171Z","closed_at":"2026-01-12T06:00:17.082432171Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-lde","depends_on_id":"casg-4re","type":"blocks","created_at":"2026-01-12T04:07:43.667413952Z","created_by":"cyou"}]}
{"id":"casg-lde.2","title":"BidirRunner type skeleton","description":"## Overview\nCreate the internal BidirRunner type foundation for push-based bidirectional IO in bidir mode. This is the core abstraction that wraps an Erlang port for the GenServer to use.\n\n## Key Principle\n**Public runner.gleam is NOT modified.** BidirRunner is internal only, used by start_session() path.\n\n## TDD Approach\n1. Create skeleton type that compiles\n2. Write failing integration test that attempts to start a BidirRunner\n3. Implement start() in subsequent task\n\n## Type Definition (from plan)\n```gleam\n/// Push-based runner for start_session() (bidir mode only)\n/// This is INTERNAL — not exported from the public API\npub type BidirRunner {\n  BidirRunner(\n    port: Port,  // Exposed for GenServer to match on native messages\n    write: fn(String) -\u003e Result(Nil, WriteError),\n    close: fn() -\u003e Nil,\n  )\n}\n```\n\n## Files to Create/Modify\n- src/claude_agent_sdk/internal/bidir_runner.gleam (NEW)\n- test/bidir_runner_test.gleam (NEW)\n\n## Acceptance Criteria\n- [ ] BidirRunner type defined with port, write, close fields\n- [ ] WriteError type defined\n- [ ] start() function stub that returns Error (not implemented yet)\n- [ ] Failing test: BidirRunner.start([]) returns Error (placeholder)\n- [ ] Code compiles: gleam build succeeds\n\n## Test Sketch\n```gleam\n// test/bidir_runner_test.gleam\npub fn bidir_runner_start_not_implemented_test() {\n  // This test will FAIL initially (start returns Error placeholder)\n  // T3 will make it pass\n  let result = bidir_runner.start([])\n  should.be_error(result)\n}\n```\n\n## Notes\n- Port type comes from gleam_erlang\n- WriteError should be simple for now (just Closed variant)\n- This is foundation work - actual implementation in T3","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:09:49.924923958Z","created_by":"cyou","updated_at":"2026-01-12T05:01:23.543818244Z","closed_at":"2026-01-12T05:01:23.543818244Z","close_reason":"Closed","labels":["gleam","integration-path-test","tdd"],"dependencies":[{"issue_id":"casg-lde.2","depends_on_id":"casg-lde","type":"parent-child","created_at":"2026-01-12T04:09:49.925483397Z","created_by":"cyou"}]}
{"id":"casg-lde.3","title":"Port message decoder","description":"## Overview\nImplement decode_port_message to decode native Erlang port tuples into typed Gleam values. The GenServer receives these raw tuples in handle_info and needs to pattern match them.\n\n## Port Message Shapes (from plan)\n| Message | Shape | When |\n|---------|-------|------|\n| Data received | `{Port, {data, Binary}}` | CLI writes to stdout |\n| Process exited | `{Port, {exit_status, ExitCode}}` | CLI process terminates |\n\n## TDD Approach\n1. Define PortMessage type (PortData, PortExitStatus variants)\n2. Write tests that decode exact message shapes\n3. Implement decode_port_message using dynamic decoding\n\n## Implementation (from plan)\n```gleam\npub type PortMessage {\n  PortData(BitArray)\n  PortExitStatus(Int)\n}\n\n/// Decode native Erlang port tuples\npub fn decode_port_message(msg: Dynamic, port: Port) -\u003e Result(PortMessage, Nil) {\n  // Match {Port, {data, Binary}}\n  case dynamic.tuple2(dynamic.dynamic, dynamic.dynamic)(msg) {\n    Ok(#(msg_port, payload)) if msg_port == port -\u003e\n      case dynamic.tuple2(atom, dynamic.bit_array)(payload) {\n        Ok(#(data_atom, binary)) if data_atom == atom.create(\"data\") -\u003e\n          Ok(PortData(binary))\n        Ok(#(exit_status_atom, code)) if exit_status_atom == atom.create(\"exit_status\") -\u003e\n          Ok(PortExitStatus(dynamic.int(code)))\n        _ -\u003e Error(Nil)\n      }\n    _ -\u003e Error(Nil)\n  }\n}\n```\n\n## Files to Create/Modify\n- src/claude_agent_sdk/internal/bidir_runner.gleam (add PortMessage, decode_port_message)\n- test/port_message_test.gleam (NEW)\n\n## Acceptance Criteria\n- [ ] PortMessage type with PortData(BitArray) and PortExitStatus(Int)\n- [ ] decode_port_message correctly decodes {Port, {data, Binary}}\n- [ ] decode_port_message correctly decodes {Port, {exit_status, Code}}\n- [ ] Returns Error(Nil) for non-matching port\n- [ ] Returns Error(Nil) for unknown message shapes\n- [ ] All tests pass\n\n## Test Sketch (from plan)\n```gleam\n// test/port_message_test.gleam\npub fn port_message_decode_data_test() {\n  let mock_port = create_mock_port()\n  let data_msg = #(mock_port, #(atom.create(\"data\"), \u003c\u003c\"hello\\n\"\u003e\u003e))\n  let result = decode_port_message(dynamic.from(data_msg), mock_port)\n  should.equal(result, Ok(PortData(\u003c\u003c\"hello\\n\"\u003e\u003e)))\n}\n\npub fn port_message_decode_exit_status_test() {\n  let mock_port = create_mock_port()\n  let exit_msg = #(mock_port, #(atom.create(\"exit_status\"), 0))\n  let result = decode_port_message(dynamic.from(exit_msg), mock_port)\n  should.equal(result, Ok(PortExitStatus(0)))\n}\n\npub fn port_message_wrong_port_test() {\n  let mock_port = create_mock_port()\n  let other_port = create_mock_port()\n  let wrong_port_msg = #(other_port, #(atom.create(\"data\"), \u003c\u003c\"x\"\u003e\u003e))\n  let result = decode_port_message(dynamic.from(wrong_port_msg), mock_port)\n  should.equal(result, Error(Nil))\n}\n```\n\n## Notes\n- Need to create mock port for testing (or use FFI helper)\n- Uses gleam/dynamic for decoding\n- Uses gleam_erlang/atom for atom matching","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:11:35.430866842Z","created_by":"cyou","updated_at":"2026-01-12T05:20:26.337163778Z","closed_at":"2026-01-12T05:20:26.337163778Z","close_reason":"Closed","labels":["gleam","tdd"],"dependencies":[{"issue_id":"casg-lde.3","depends_on_id":"casg-lde","type":"parent-child","created_at":"2026-01-12T04:11:35.431545421Z","created_by":"cyou"},{"issue_id":"casg-lde.3","depends_on_id":"casg-lde.2","type":"blocks","created_at":"2026-01-12T04:11:49.537453995Z","created_by":"cyou"}]}
{"id":"casg-lde.4","title":"Implement BidirRunner.start","description":"## Overview\nImplement BidirRunner.start() to spawn the Claude CLI as an Erlang port with the correct options for bidirectional communication.\n\n## Port Configuration (from plan)\n```erlang\nopen_port({spawn_executable, ClaudePath}, [\n  {args, [\"--output-format\", \"stream-json\", \"--input-format\", \"stream-json\" | ExtraArgs]},\n  binary,           % Receive data as binary, not list\n  {packet, 0},      % Raw binary mode, no framing\n  exit_status,      % Receive {Port, {exit_status, Code}} on process exit\n  use_stdio,        % Communicate via stdin/stdout\n  stderr_to_stdout  % Merge stderr into stdout\n]).\n```\n\n## TDD Approach\n1. Write test for start() creating port with correct options\n2. Implement start() using port_ffi or new FFI\n3. Verify port is created and returns Ok(BidirRunner)\n\n## Implementation Sketch\n```gleam\npub fn start(cli_args: List(String)) -\u003e Result(BidirRunner, SpawnError) {\n  let claude_path = find_claude_executable()\n  let args = [\"--output-format\", \"stream-json\", \"--input-format\", \"stream-json\", ..cli_args]\n\n  case open_port_executable(claude_path, args) {\n    Ok(port) -\u003e {\n      let write_fn = fn(data) { port_command(port, data) }\n      let close_fn = fn() { close_port(port) }\n      Ok(BidirRunner(port: port, write: write_fn, close: close_fn))\n    }\n    Error(reason) -\u003e Error(SpawnError(reason))\n  }\n}\n```\n\n## Files to Create/Modify\n- src/claude_agent_sdk/internal/bidir_runner.gleam (implement start)\n- src/claude_agent_sdk_ffi.erl (add spawn_executable FFI if needed)\n- test/bidir_runner_test.gleam (add integration tests)\n\n## Acceptance Criteria\n- [ ] start() spawns Claude CLI with spawn_executable\n- [ ] Port options include: binary, {packet, 0}, exit_status, use_stdio, stderr_to_stdout\n- [ ] Args include --output-format stream-json --input-format stream-json\n- [ ] Returns Ok(BidirRunner) on success\n- [ ] Returns Error(SpawnError) on failure\n- [ ] write() function sends data to port\n- [ ] close() function closes the port\n- [ ] Integration test verifies port creation\n\n## Port Ownership Invariant\n**CRITICAL**: The port MUST be owned by the GenServer process.\n- start() is designed to be called inside actor.init callback\n- This ensures port is owned by GenServer, not caller\n- Port messages will be delivered to GenServer mailbox\n\n## Notes\n- May need to extend port_ffi.erl for spawn_executable\n- Consider using which/1 or os:find_executable/1 for claude path\n- SpawnError type needs to be defined","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:11:36.961221201Z","created_by":"cyou","updated_at":"2026-01-12T05:48:32.806263411Z","closed_at":"2026-01-12T05:48:32.806263411Z","close_reason":"Closed","labels":["gleam","tdd"],"dependencies":[{"issue_id":"casg-lde.4","depends_on_id":"casg-lde","type":"parent-child","created_at":"2026-01-12T04:11:36.96191004Z","created_by":"cyou"},{"issue_id":"casg-lde.4","depends_on_id":"casg-lde.3","type":"blocks","created_at":"2026-01-12T04:11:49.613057413Z","created_by":"cyou"}]}
{"id":"casg-lde.5","title":"Line buffering in stream parser","description":"## Overview\nExtend internal/stream.gleam with handle_port_data for push-based line buffering. The existing QueryStream uses pull-based buffering; we need a stateless function for the GenServer to use.\n\n## Why Not Reuse QueryStream?\n- QueryStream is pull-based (calls receive internally)\n- BidirRunner is push-based (GenServer receives messages)\n- Need a stateless buffer function that GenServer can call\n\n## Design\n```gleam\n/// Buffer state for line accumulation\npub type LineBuffer {\n  LineBuffer(buffer: BitArray)\n}\n\n/// Result of handling port data\npub type HandlePortDataResult {\n  /// Complete lines extracted, with remaining buffer\n  Lines(lines: List(String), new_buffer: LineBuffer)\n  /// Buffer overflow - line too long\n  BufferOverflow\n}\n\n/// Handle incoming port data, extract complete lines\npub fn handle_port_data(\n  buffer: LineBuffer,\n  data: BitArray,\n) -\u003e HandlePortDataResult\n```\n\n## TDD Approach\n1. Write tests for partial line delivery\n2. Write tests for multiple lines in single chunk\n3. Write tests for oversized line rejection\n4. Implement handle_port_data\n\n## Existing Code to Leverage\nThe existing stream.gleam has:\n- `append_to_buffer` - checks overflow\n- `read_line` - extracts one line\n- `normalize_crlf` - handles Windows line endings\n- `constants.max_line_size_bytes` - 16 MB limit\n\nWe can reuse these, just wrap in a push-friendly API.\n\n## Files to Create/Modify\n- src/claude_agent_sdk/internal/stream.gleam (add LineBuffer, handle_port_data)\n- test/stream_buffer_test.gleam (NEW - push-based tests)\n\n## Acceptance Criteria\n- [ ] LineBuffer type for stateful buffering\n- [ ] handle_port_data extracts all complete lines from buffer + new data\n- [ ] Handles partial line delivery (returns incomplete in new buffer)\n- [ ] Handles multiple lines in single chunk\n- [ ] Rejects lines exceeding max_line_size_bytes (16 MB)\n- [ ] Handles CRLF normalization\n- [ ] All tests pass\n\n## Test Cases\n```gleam\npub fn partial_line_delivery_test() {\n  let buf = LineBuffer(\u003c\u003c\u003e\u003e)\n  // Receive \"hel\"\n  let result1 = handle_port_data(buf, \u003c\u003c\"hel\"\u003e\u003e)\n  should.equal(result1, Lines(lines: [], new_buffer: LineBuffer(\u003c\u003c\"hel\"\u003e\u003e)))\n\n  // Receive \"lo\\n\"\n  let Lines(_, buf2) = result1\n  let result2 = handle_port_data(buf2, \u003c\u003c\"lo\\n\"\u003e\u003e)\n  should.equal(result2, Lines(lines: [\"hello\"], new_buffer: LineBuffer(\u003c\u003c\u003e\u003e)))\n}\n\npub fn multiple_lines_in_chunk_test() {\n  let buf = LineBuffer(\u003c\u003c\u003e\u003e)\n  let result = handle_port_data(buf, \u003c\u003c\"line1\\nline2\\nline3\\n\"\u003e\u003e)\n  should.equal(result, Lines(\n    lines: [\"line1\", \"line2\", \"line3\"],\n    new_buffer: LineBuffer(\u003c\u003c\u003e\u003e)\n  ))\n}\n\npub fn oversized_line_rejection_test() {\n  let buf = LineBuffer(\u003c\u003c\u003e\u003e)\n  let huge = string.repeat(\"x\", 17_000_000) // \u003e 16 MB\n  let result = handle_port_data(buf, bit_array.from_string(huge))\n  should.equal(result, BufferOverflow)\n}\n```\n\n## Notes\n- Reuse existing buffer functions where possible\n- Keep the function pure/stateless (takes buffer, returns new buffer)\n- GenServer will store LineBuffer in its state","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:11:37.930802335Z","created_by":"cyou","updated_at":"2026-01-12T05:10:37.511964281Z","closed_at":"2026-01-12T05:10:37.511964281Z","close_reason":"Closed","labels":["gleam","tdd"],"dependencies":[{"issue_id":"casg-lde.5","depends_on_id":"casg-lde","type":"parent-child","created_at":"2026-01-12T04:11:37.931533704Z","created_by":"cyou"},{"issue_id":"casg-lde.5","depends_on_id":"casg-lde.2","type":"blocks","created_at":"2026-01-12T04:11:49.692299074Z","created_by":"cyou"}]}
{"id":"casg-lde.6","title":"Mock BidirRunner for testing","description":"## Overview\nAdd bidir_runner.mock() for testing bidir mode without spawning real Claude CLI. This allows unit testing the GenServer logic in isolation.\n\n## Design (from plan)\n```gleam\n/// For testing: create a mock BidirRunner\npub fn mock(\n  on_write: fn(String) -\u003e Result(Nil, WriteError),\n  on_close: fn() -\u003e Nil,\n) -\u003e BidirRunner\n```\n\n## Mock Capabilities\n1. Capture all write() calls for assertions\n2. Inject messages into the \"port\" (simulating CLI output)\n3. Simulate port closure and exit status\n\n## Challenge: Port Reference\nBidirRunner.port field is used by GenServer to match incoming messages:\n```gleam\ncase decode_port_message(msg, state.runner.port) { ... }\n```\n\nFor mocks, we need a fake port that can still be pattern matched. Options:\n1. Use a real port (to /dev/null or similar)\n2. Use a special \"mock port\" atom/reference\n3. Create a dummy port via FFI\n\n## TDD Approach\n1. Write test that creates mock BidirRunner\n2. Write test that verifies write() calls on_write callback\n3. Write test that verifies close() calls on_close callback\n4. Implement mock()\n\n## Files to Create/Modify\n- src/claude_agent_sdk/internal/bidir_runner.gleam (add mock function)\n- test/support/mock_bidir_runner.gleam (NEW - test helpers)\n- test/bidir_runner_test.gleam (add mock tests)\n\n## Acceptance Criteria\n- [ ] mock() returns BidirRunner with functional write/close\n- [ ] write() calls the on_write callback with data\n- [ ] close() calls the on_close callback\n- [ ] Port field is usable for pattern matching (even if dummy)\n- [ ] Helper to inject messages for testing\n- [ ] All tests pass\n\n## Test Sketch\n```gleam\n// test/bidir_runner_test.gleam\npub fn mock_captures_writes_test() {\n  let writes = process.new_subject()\n\n  let runner = bidir_runner.mock(\n    on_write: fn(data) {\n      process.send(writes, data)\n      Ok(Nil)\n    },\n    on_close: fn() { Nil },\n  )\n\n  let assert Ok(Nil) = bidir_runner.write(runner, \"hello\")\n  let assert Ok(\"hello\") = process.receive(writes, 100)\n}\n\npub fn mock_close_callback_test() {\n  let closed = process.new_subject()\n\n  let runner = bidir_runner.mock(\n    on_write: fn(_) { Ok(Nil) },\n    on_close: fn() { process.send(closed, True) },\n  )\n\n  bidir_runner.close(runner)\n  let assert Ok(True) = process.receive(closed, 100)\n}\n```\n\n## Message Injection Helper\n```gleam\n// test/support/mock_bidir_runner.gleam\n\n/// Create a mock runner with message injection capability\npub fn with_injection() -\u003e #(BidirRunner, Subject(BitArray)) {\n  let inject_subject = process.new_subject()\n  // ... setup that allows sending to inject_subject\n  // GenServer can receive from inject_subject as if from port\n}\n```\n\n## Notes\n- The mock port challenge needs investigation during implementation\n- May need FFI to create a dummy port reference\n- Consider using erlang:make_ref() wrapped as pseudo-port","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:11:39.28814101Z","created_by":"cyou","updated_at":"2026-01-12T05:56:28.570296412Z","closed_at":"2026-01-12T05:56:28.570296412Z","close_reason":"Closed","labels":["gleam","tdd"],"dependencies":[{"issue_id":"casg-lde.6","depends_on_id":"casg-lde","type":"parent-child","created_at":"2026-01-12T04:11:39.288849008Z","created_by":"cyou"},{"issue_id":"casg-lde.6","depends_on_id":"casg-lde.4","type":"blocks","created_at":"2026-01-12T04:11:49.764999397Z","created_by":"cyou"}]}
{"id":"casg-lde.7","title":"[Review] 1 non-blocking finding from casg-lde.3","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-lde.3\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Avoid leaking ports on panic in port_message tests\n\n**Priority:** P2\n**Reviewer:** codex\n**Location:** test/port_message_test.gleam:34-57\n\nThe tests manually close ports after decoding, but they close *after* assertions that can `panic`. If `decode_port_message` ever returns an unexpected value, the `panic` path skips `ffi_close_port`, leaking an Erlang port (and potentially a spawned process). This can make later tests flaky due to resource exhaustion.\n\nConcrete path: in `decode_port_data_test`, an unexpected `result` hits `panic`, and `port_ffi.ffi_close_port(mock_port)` is never reached.\n\nSuggested fix: wrap the body in `port_ffi.rescue` (or equivalent) and close ports in a finally-style path, or structure the test so cleanup happens before any `panic` (e.g., compute/close, then assert on captured `result`).\n\n---\n\n\u003c!-- fp:069e7a08af3daafc --\u003e\n\u003c!-- review_finding:d3266be6f436 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T05:20:26.582006334Z","created_by":"cyou","updated_at":"2026-01-12T05:21:20.144247517Z","closed_at":"2026-01-12T05:21:20.144247517Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-lde.3"],"dependencies":[{"issue_id":"casg-lde.7","depends_on_id":"casg-lde","type":"parent-child","created_at":"2026-01-12T05:20:26.58258034Z","created_by":"cyou"}]}
{"id":"casg-lde.8","title":"[Review] 4 non-blocking findings from casg-lde.6","description":"## Review Findings\n\nThis issue consolidates 4 non-blocking findings from code review.\n\n**Source issue:** casg-lde.6\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] MockRunner.inject subject is non-functional despite documentation\n\n**Priority:** P2\n**Reviewer:** claude\n**Location:** test/support/mock_bidir_runner.gleam:39-52\n\nThe `inject` field is documented as \"Subject for injecting BitArray data (simulating port output)\" with an example showing `process.send(mock.inject, \u003c\u003c\"hello\":utf8\u003e\u003e)`. However, the subject is created but never connected to any receiving mechanism. Messages sent to `inject` are never received by anything - no process consumes from it, and it's not linked to the BidirRunner in a way that would make injected messages appear as port output to a GenServer. This differs from `writes` and `closed` which are properly wired to callbacks. Developers following the documented example would find injection silently does nothing.\n\n---\n\n### Finding 2: [P2] Fix MockRunner helper: missing imports/types and unused injection\n\n**Priority:** P2\n**Reviewer:** codex\n**Location:** test/support/mock_bidir_runner.gleam:1-53\n\n`test/support/mock_bidir_runner.gleam` declares fields using `BitArray`, `Bool`, and calls `process.new_subject()` / `process.send(...)`, but the module only imports `gleam/erlang/process.{type Subject}`. In addition, `inject` is created and exposed but never connected to any runner/GenServer message path, so it cannot actually “simulate port output” as the docstring claims.\n\nConcrete failure/impact:\n- The `inject: Subject(BitArray)` field is currently just a standalone subject; sending to it won’t produce messages shaped like `{Port, {data, Binary}}` that `bidir_runner.decode_port_message` expects.\n- The helper’s public API promises injection that doesn’t work, so tests written against it will silently test the wrong thing.\n\n```gleam\ninject: Subject(BitArray)\nprocess.send(closed, True)\n```\n\n---\n\n### Finding 3: [P3] Replace tautological assertion in mock_port_is_usable_test\n\n**Priority:** P3\n**Reviewer:** codex\n**Location:** test/bidir_runner_test.gleam:250-259\n\n`mock_port_is_usable_test` asserts `port_dynamic != port_dynamic || port_dynamic == port_dynamic`, which is a tautology and cannot fail. This test does not validate that the mock port can be used for pattern matching with `decode_port_message` (the stated goal).\n\n```gleam\nshould.be_true(port_dynamic != port_dynamic || port_dynamic == port_dynamic)\n```\n\n---\n\n### Finding 4: [P2] MockRunner.inject is disconnected and non-functional\n\n**Priority:** P2\n**Reviewer:** gemini\n**Location:** test/support/mock_bidir_runner.gleam:39-52\n\nThe `inject` subject receives messages but does not forward them to any consumer. Sending to `mock.inject` (as suggested in the docs at lines 33-34) puts messages in a mailbox that is never read or forwarded to the system under test. To properly simulate port messages, the helper must send `{port_ref, payload}` tuples to the target process, or `inject` must be wired to a forwarding mechanism.\n\n---\n\n\u003c!-- fp:4f23b69161a39869 --\u003e\n\u003c!-- fp:d69ed6b04e480c24 --\u003e\n\u003c!-- fp:4441f55cb4e9cd50 --\u003e\n\u003c!-- fp:5be08411dda5ed43 --\u003e\n\u003c!-- review_finding:e714e00ac138 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T06:00:17.190843332Z","created_by":"cyou","updated_at":"2026-01-12T06:06:28.843585998Z","closed_at":"2026-01-12T06:06:28.843585998Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-lde.6"],"dependencies":[{"issue_id":"casg-lde.8","depends_on_id":"casg-lde","type":"parent-child","created_at":"2026-01-12T06:00:17.191397779Z","created_by":"cyou"}]}
{"id":"casg-lde.9","title":"[Review] 3 non-blocking findings from casg-lde.8","description":"## Review Findings\n\nThis issue consolidates 3 non-blocking findings from code review.\n\n**Source issue:** casg-lde.8\n**Highest priority:** P3\n\n---\n\n### Finding 1: [P3] Module docstring still mentions removed inject capability\n\n**Priority:** P3\n**Reviewer:** claude\n**Location:** test/support/mock_bidir_runner.gleam:2\n\nLine 2 states \"Provides utilities for injecting messages and capturing writes in tests\" but this diff removed the inject capability. The docstring should be updated to reflect that MockRunner now only provides capture capabilities, not injection. This could confuse developers who read the module docstring and expect an injection feature.\n\n---\n\n### Finding 2: [P3] Update mock_bidir_runner module docstring after removing inject\n\n**Priority:** P3\n**Reviewer:** codex\n**Location:** test/support/mock_bidir_runner.gleam:1-3\n\nThe module header still says it “Provides utilities for injecting messages” even though this diff removes the `inject` subject from `MockRunner` and removes the injection example from the docs. This is misleading for test authors and contradicts the public API now exposed by the helper.\n\nConcrete mismatch:\n```gleam\n/// Provides utilities for injecting messages\n```\nbut `MockRunner` now only has `runner`, `writes`, and `closed`.\n\n---\n\n### Finding 3: [P3] Test doc claims decode_port_message coverage but only checks inequality\n\n**Priority:** P3\n**Reviewer:** codex\n**Location:** test/bidir_runner_test.gleam:247-265\n\n`mock_port_is_usable_test`’s doc comment says it validates pattern matching “with decode_port_message”, but the test does not call `decode_port_message` or build a port-shaped message. It only asserts that two mock ports produce distinct dynamics.\n\nThis reduces the value of the test because the stated goal (compatibility with `decode_port_message`) isn’t actually exercised.\n\n---\n\n\u003c!-- fp:3864ea9723c9687b --\u003e\n\u003c!-- fp:3c82a5846d2c928d --\u003e\n\u003c!-- fp:7f1d949f04f8f363 --\u003e\n\u003c!-- review_finding:6389e5517e83 --\u003e","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-12T06:06:28.955370325Z","created_by":"cyou","updated_at":"2026-01-12T06:08:29.840568976Z","closed_at":"2026-01-12T06:08:29.840568976Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-lde.8"],"dependencies":[{"issue_id":"casg-lde.9","depends_on_id":"casg-lde","type":"parent-child","created_at":"2026-01-12T06:06:28.955981141Z","created_by":"cyou"}]}
{"id":"casg-lqg","title":"Epic: Bidirectional Protocol - Control Operations","description":"## Overview\nImplement SDK-initiated control operations: interrupt, set_permission_mode, set_model, rewind_files.\n\n## Source Plan\n`plans/2026-01-12-bidir-protocol-plan.md` - \"SDK-Initiated Operation Timeout Strategy\" section\n\n## Key Deliverables\n- interrupt(): send interrupt control_request, await response\n- set_permission_mode(): mode in {default, acceptEdits, bypassPermissions}\n- set_model(): change model mid-session\n- rewind_files(): restore file state (requires checkpointing enabled)\n- Per-request timeout management\n\n## Timeout Values\n| Operation | Default Timeout |\n|-----------|-----------------|\n| Initialize | 10,000 ms |\n| Interrupt | 5,000 ms |\n| SetPermissionMode | 5,000 ms |\n| SetModel | 5,000 ms |\n| RewindFiles | 30,000 ms |\n\n## Error Types\n- Timeout(kind, request_id)\n- CliError(kind, message)\n- SessionStopped\n- TooManyPendingRequests\n- CheckpointingNotEnabled (for rewind_files)\n\n## TDD Focus\n- Each operation sends correct wire format\n- Timeout handling (first-event-wins)\n- Late response handling (drop, don't crash)\n- Session stop clears all pending requests\n\n## Files\n- src/claude_agent_sdk/internal/bidir.gleam (Extends Epic 4)\n- test/control_ops_test.gleam (New)","status":"open","priority":1,"issue_type":"epic","created_at":"2026-01-12T04:07:31.129841272Z","created_by":"cyou","updated_at":"2026-01-12T04:07:31.129841272Z","dependencies":[{"issue_id":"casg-lqg","depends_on_id":"casg-4jq","type":"blocks","created_at":"2026-01-12T04:07:43.917533226Z","created_by":"cyou"}]}
{"id":"casg-lqg.2","title":"T1: Control operation infrastructure","description":"## Overview\nCreate the foundational infrastructure for SDK-initiated control operations (interrupt, set_permission_mode, set_model, rewind_files). This establishes the request/response pattern with timeout management that all control operations will use.\n\n## TDD Approach\n1. Create skeleton types and stub functions first\n2. Write failing integration test that exercises the full path\n3. Implementation will be done in dependent tasks\n\n## Tasks\n\n### 1. Add control operation types to bidir.gleam\n- Add ControlOperation type: Interrupt | SetPermissionMode(String) | SetModel(String) | RewindFiles(String)\n- Add ControlResult type: Ok | Error(ControlError)\n- Add PendingRequest record with fields:\n  - request_id: String\n  - kind: ControlOperation  \n  - reply_to: Subject(ControlResult)\n  - timer_ref: TimerRef (from erlang:send_after)\n\n### 2. Add handle_call for send_control_request\n- Accept ControlOperation from caller\n- Generate request_id using counter from state\n- Create timer via erlang:send_after(timeout_ms, self(), {op_timeout, request_id})\n- Store PendingRequest in state.pending_requests map\n- Encode and send control_request JSON to CLI via runner.write()\n- Return caller's Subject for async result\n\n### 3. Add handle_info for control_response\n- Match on ControlResponse from decoder\n- Look up pending_requests by request_id\n- If found: cancel timer, send result to reply_to, remove from map\n- If not found: log debug \"Late response for {request_id}, discarding\"\n\n### 4. Add handle_info for op_timeout\n- Match on {op_timeout, request_id} message\n- Look up pending_requests by request_id\n- If found: send Timeout error to reply_to, remove from map\n- If not found: ignore (response already handled)\n\n### 5. Write failing integration test\nTest file: test/control_op_infra_test.gleam\n\n```gleam\n// Test: control operation sends request and receives response\npub fn control_op_sends_request_receives_response_test() {\n  // Arrange: start session with mock runner\n  // Act: call send_control_request(Interrupt)\n  // Assert: mock runner received control_request JSON\n  // Assert: simulate response, verify caller receives Ok result\n}\n```\n\n## Wire Format Reference\n\nSDK sends:\n```json\n{\"type\":\"control_request\",\"request_id\":\"req_1\",\"request\":{\"subtype\":\"interrupt\"}}\n```\n\nCLI responds:\n```json\n{\"type\":\"control_response\",\"response\":{\"subtype\":\"success\",\"request_id\":\"req_1\"}}\n```\n\n## Files\n- src/claude_agent_sdk/internal/bidir.gleam (modify)\n- test/control_op_infra_test.gleam (new)\n\n## Acceptance Criteria\n- [ ] ControlOperation and ControlResult types defined\n- [ ] PendingRequest record with timer management\n- [ ] handle_call encodes and sends control_request\n- [ ] handle_info processes control_response\n- [ ] handle_info handles op_timeout\n- [ ] Failing integration test exists (test will pass after T2-T5)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:10:57.017407494Z","created_by":"cyou","updated_at":"2026-01-12T16:05:06.591704642Z","closed_at":"2026-01-12T16:05:06.591704642Z","close_reason":"Closed","labels":["integration-path-test","tdd"],"dependencies":[{"issue_id":"casg-lqg.2","depends_on_id":"casg-lqg","type":"parent-child","created_at":"2026-01-12T04:10:57.018221193Z","created_by":"cyou"}]}
{"id":"casg-lqg.3","title":"T2: Implement interrupt operation","description":"## Overview\nImplement the interrupt control operation that signals the CLI to stop current processing.\n\n## Timeout\n- 5,000 ms (interrupt should complete quickly)\n\n## TDD Approach\n1. Write failing test first\n2. Implement encoder for interrupt control_request\n3. Wire up public API function\n\n## Tasks\n\n### 1. Add interrupt encoder\nIn bidir.gleam or control.gleam, add function to encode interrupt request:\n```gleam\nfn encode_interrupt(request_id: String) -\u003e String {\n  json.object([\n    #(\"type\", json.string(\"control_request\")),\n    #(\"request_id\", json.string(request_id)),\n    #(\"request\", json.object([\n      #(\"subtype\", json.string(\"interrupt\"))\n    ]))\n  ])\n  |\u003e json.to_string\n}\n```\n\n### 2. Add public interrupt() function\n```gleam\n/// Interrupt the current operation\n/// Returns Ok on success, Error(ControlError) on failure\n/// Timeout: 5000ms\npub fn interrupt(session: Session) -\u003e Result(Nil, ControlError)\n```\n\n### 3. Wire to handle_call\n- Match on Interrupt variant\n- Use 5000ms timeout\n- Call infrastructure from T1\n\n### 4. Write tests\nTest file: test/interrupt_test.gleam\n\n```gleam\npub fn interrupt_sends_correct_wire_format_test() {\n  // Arrange: session with mock runner\n  // Act: call interrupt(session)\n  // Assert: mock received: {\"type\":\"control_request\",\"request_id\":\"req_X\",\"request\":{\"subtype\":\"interrupt\"}}\n}\n\npub fn interrupt_receives_success_response_test() {\n  // Arrange: session with mock runner that responds with success\n  // Act: call interrupt(session)\n  // Assert: returns Ok(Nil)\n}\n\npub fn interrupt_receives_error_response_test() {\n  // Arrange: session with mock runner that responds with error\n  // Act: call interrupt(session)\n  // Assert: returns Error(CliError(...))\n}\n```\n\n## Wire Format\n\nSDK sends:\n```json\n{\"type\":\"control_request\",\"request_id\":\"req_1\",\"request\":{\"subtype\":\"interrupt\"}}\n```\n\nCLI responds (success):\n```json\n{\"type\":\"control_response\",\"response\":{\"subtype\":\"success\",\"request_id\":\"req_1\"}}\n```\n\nCLI responds (error):\n```json\n{\"type\":\"control_response\",\"response\":{\"subtype\":\"error\",\"request_id\":\"req_1\",\"error\":\"No operation to interrupt\"}}\n```\n\n## Files\n- src/claude_agent_sdk/internal/bidir.gleam (modify)\n- test/interrupt_test.gleam (new)\n\n## Acceptance Criteria\n- [ ] interrupt() public function implemented\n- [ ] Sends correct wire format (verified by test)\n- [ ] Handles success response\n- [ ] Handles error response\n- [ ] Uses 5000ms timeout","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:11:28.345267909Z","created_by":"cyou","updated_at":"2026-01-12T16:54:25.268730374Z","closed_at":"2026-01-12T16:54:25.268730374Z","close_reason":"Closed","labels":["tdd"],"dependencies":[{"issue_id":"casg-lqg.3","depends_on_id":"casg-lqg","type":"parent-child","created_at":"2026-01-12T04:11:28.346101257Z","created_by":"cyou"},{"issue_id":"casg-lqg.3","depends_on_id":"casg-lqg.2","type":"blocks","created_at":"2026-01-12T04:12:47.788517557Z","created_by":"cyou"}]}
{"id":"casg-lqg.4","title":"T3: Implement set_permission_mode operation","description":"## Overview\nImplement the set_permission_mode control operation that changes how the CLI handles permission requests.\n\n## Permission Modes\n- `default` - Normal permission prompting behavior\n- `acceptEdits` - Auto-accept file edits\n- `bypassPermissions` - Bypass all permission checks\n\n## Timeout\n- 5,000 ms (configuration change should be fast)\n\n## TDD Approach\n1. Write failing test first\n2. Implement encoder for set_permission_mode control_request\n3. Wire up public API function\n\n## Tasks\n\n### 1. Add PermissionMode type\n```gleam\npub type PermissionMode {\n  Default\n  AcceptEdits\n  BypassPermissions\n}\n\nfn permission_mode_to_string(mode: PermissionMode) -\u003e String {\n  case mode {\n    Default -\u003e \"default\"\n    AcceptEdits -\u003e \"acceptEdits\"\n    BypassPermissions -\u003e \"bypassPermissions\"\n  }\n}\n```\n\n### 2. Add set_permission_mode encoder\n```gleam\nfn encode_set_permission_mode(request_id: String, mode: String) -\u003e String {\n  json.object([\n    #(\"type\", json.string(\"control_request\")),\n    #(\"request_id\", json.string(request_id)),\n    #(\"request\", json.object([\n      #(\"subtype\", json.string(\"set_permission_mode\")),\n      #(\"mode\", json.string(mode))\n    ]))\n  ])\n  |\u003e json.to_string\n}\n```\n\n### 3. Add public set_permission_mode() function\n```gleam\n/// Set the permission mode for the session\n/// Timeout: 5000ms\npub fn set_permission_mode(session: Session, mode: PermissionMode) -\u003e Result(Nil, ControlError)\n```\n\n### 4. Write tests\nTest file: test/set_permission_mode_test.gleam\n\n```gleam\npub fn set_permission_mode_default_wire_format_test() {\n  // Assert sends: {\"type\":\"control_request\",\"request_id\":\"req_X\",\"request\":{\"subtype\":\"set_permission_mode\",\"mode\":\"default\"}}\n}\n\npub fn set_permission_mode_accept_edits_wire_format_test() {\n  // Assert sends: {\"request\":{\"subtype\":\"set_permission_mode\",\"mode\":\"acceptEdits\"}}\n}\n\npub fn set_permission_mode_bypass_permissions_wire_format_test() {\n  // Assert sends: {\"request\":{\"subtype\":\"set_permission_mode\",\"mode\":\"bypassPermissions\"}}\n}\n\npub fn set_permission_mode_receives_success_test() {\n  // Assert: returns Ok(Nil) on success response\n}\n```\n\n## Wire Format\n\nSDK sends:\n```json\n{\"type\":\"control_request\",\"request_id\":\"req_2\",\"request\":{\"subtype\":\"set_permission_mode\",\"mode\":\"acceptEdits\"}}\n```\n\nCLI responds:\n```json\n{\"type\":\"control_response\",\"response\":{\"subtype\":\"success\",\"request_id\":\"req_2\"}}\n```\n\n## Files\n- src/claude_agent_sdk/internal/bidir.gleam (modify)\n- test/set_permission_mode_test.gleam (new)\n\n## Acceptance Criteria\n- [ ] PermissionMode type with all three variants\n- [ ] set_permission_mode() public function implemented\n- [ ] Sends correct wire format for each mode\n- [ ] Handles success response\n- [ ] Uses 5000ms timeout","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:11:39.287309751Z","created_by":"cyou","updated_at":"2026-01-12T17:02:53.222817062Z","closed_at":"2026-01-12T17:02:53.222817062Z","close_reason":"Closed","labels":["tdd"],"dependencies":[{"issue_id":"casg-lqg.4","depends_on_id":"casg-lqg.2","type":"blocks","created_at":"2026-01-12T04:12:48.288384464Z","created_by":"cyou"},{"issue_id":"casg-lqg.4","depends_on_id":"casg-lqg","type":"parent-child","created_at":"2026-01-12T04:13:09.550667206Z","created_by":"cyou"}]}
{"id":"casg-lqg.5","title":"T4: Implement set_model operation","description":"## Overview\nImplement the set_model control operation that changes the model used by the CLI.\n\n## Timeout\n- 5,000 ms (configuration change should be fast)\n\n## TDD Approach\n1. Write failing test first\n2. Implement encoder for set_model control_request\n3. Wire up public API function\n\n## Tasks\n\n### 1. Add set_model encoder\n```gleam\nfn encode_set_model(request_id: String, model: String) -\u003e String {\n  json.object([\n    #(\"type\", json.string(\"control_request\")),\n    #(\"request_id\", json.string(request_id)),\n    #(\"request\", json.object([\n      #(\"subtype\", json.string(\"set_model\")),\n      #(\"model\", json.string(model))\n    ]))\n  ])\n  |\u003e json.to_string\n}\n```\n\n### 2. Add public set_model() function\n```gleam\n/// Set the model for the session\n/// Common values: \"sonnet\", \"opus\", \"haiku\", or full model IDs\n/// Timeout: 5000ms\npub fn set_model(session: Session, model: String) -\u003e Result(Nil, ControlError)\n```\n\n### 3. Wire to handle_call\n- Match on SetModel(model) variant\n- Use 5000ms timeout\n- Call infrastructure from T1\n\n### 4. Write tests\nTest file: test/set_model_test.gleam\n\n```gleam\npub fn set_model_sends_correct_wire_format_test() {\n  // Arrange: session with mock runner\n  // Act: call set_model(session, \"sonnet\")\n  // Assert: mock received: {\"type\":\"control_request\",\"request_id\":\"req_X\",\"request\":{\"subtype\":\"set_model\",\"model\":\"sonnet\"}}\n}\n\npub fn set_model_with_full_model_id_test() {\n  // Act: call set_model(session, \"claude-3-5-sonnet-20241022\")\n  // Assert: model field contains full ID\n}\n\npub fn set_model_receives_success_response_test() {\n  // Arrange: mock responds with success\n  // Act: call set_model(session, \"opus\")\n  // Assert: returns Ok(Nil)\n}\n\npub fn set_model_receives_error_for_invalid_model_test() {\n  // Arrange: mock responds with error \"Invalid model\"\n  // Act: call set_model(session, \"invalid-model\")\n  // Assert: returns Error(CliError(\"Invalid model\"))\n}\n```\n\n## Wire Format\n\nSDK sends:\n```json\n{\"type\":\"control_request\",\"request_id\":\"req_3\",\"request\":{\"subtype\":\"set_model\",\"model\":\"sonnet\"}}\n```\n\nCLI responds (success):\n```json\n{\"type\":\"control_response\",\"response\":{\"subtype\":\"success\",\"request_id\":\"req_3\"}}\n```\n\nCLI responds (error):\n```json\n{\"type\":\"control_response\",\"response\":{\"subtype\":\"error\",\"request_id\":\"req_3\",\"error\":\"Invalid model: invalid-model\"}}\n```\n\n## Files\n- src/claude_agent_sdk/internal/bidir.gleam (modify)\n- test/set_model_test.gleam (new)\n\n## Acceptance Criteria\n- [ ] set_model() public function implemented\n- [ ] Sends correct wire format\n- [ ] Handles success response\n- [ ] Handles error response for invalid model\n- [ ] Uses 5000ms timeout","notes":"Quality gate failed: Killed as deadlock victim (will retry after blocker completes)\nLog: /home/cyou/.claude/projects/-home-cyou-claude-agent-sdk-gleam/b44fe084-47b4-464e-bf04-e30834fe6c03.jsonl","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-12T04:11:51.473803583Z","created_by":"cyou","updated_at":"2026-01-12T17:01:58.729308334Z","labels":["needs-followup","tdd"],"dependencies":[{"issue_id":"casg-lqg.5","depends_on_id":"casg-lqg","type":"parent-child","created_at":"2026-01-12T04:11:51.474441982Z","created_by":"cyou"},{"issue_id":"casg-lqg.5","depends_on_id":"casg-lqg.2","type":"blocks","created_at":"2026-01-12T04:12:48.789077738Z","created_by":"cyou"},{"issue_id":"casg-lqg.5","depends_on_id":"casg-lqg.6","type":"blocks","created_at":"2026-01-12T17:01:56.529178877Z","created_by":"cyou"}]}
{"id":"casg-lqg.6","title":"T5: Implement rewind_files operation","description":"## Overview\nImplement the rewind_files control operation that reverts files to a checkpoint state. This operation requires checkpointing to be enabled during session initialization.\n\n## Timeout\n- 30,000 ms (may involve disk I/O for checkpoint restoration)\n\n## Prerequisites\n- File checkpointing must be enabled in session config\n- If not enabled, return CheckpointingNotEnabled error immediately (do not send request)\n\n## TDD Approach\n1. Write failing test first\n2. Implement encoder for rewind_files control_request\n3. Add checkpointing check\n4. Wire up public API function\n\n## Tasks\n\n### 1. Add CheckpointingNotEnabled to ControlError\n```gleam\npub type ControlError {\n  Timeout(kind: PendingRequestKind, request_id: String)\n  CliError(kind: PendingRequestKind, message: String)\n  SessionStopped\n  TooManyPendingRequests\n  CheckpointingNotEnabled  // NEW - for rewind_files when checkpointing disabled\n}\n```\n\n### 2. Add rewind_files encoder\n```gleam\nfn encode_rewind_files(request_id: String, user_message_id: String) -\u003e String {\n  json.object([\n    #(\"type\", json.string(\"control_request\")),\n    #(\"request_id\", json.string(request_id)),\n    #(\"request\", json.object([\n      #(\"subtype\", json.string(\"rewind_files\")),\n      #(\"user_message_id\", json.string(user_message_id))\n    ]))\n  ])\n  |\u003e json.to_string\n}\n```\n\n### 3. Add public rewind_files() function\n```gleam\n/// Rewind files to the state at a given user message checkpoint\n/// Requires enable_file_checkpointing: True in session config\n/// Returns Error(CheckpointingNotEnabled) if checkpointing was not enabled\n/// Timeout: 30000ms (longer due to disk I/O)\npub fn rewind_files(session: Session, user_message_id: String) -\u003e Result(Nil, ControlError)\n```\n\n### 4. Add checkpointing state check\n- Session state must track whether checkpointing was enabled at init\n- rewind_files checks this state first before sending request\n\n### 5. Write tests\nTest file: test/rewind_files_test.gleam\n\n```gleam\npub fn rewind_files_sends_correct_wire_format_test() {\n  // Arrange: session with checkpointing enabled, mock runner\n  // Act: call rewind_files(session, \"msg_123\")\n  // Assert: mock received: {\"type\":\"control_request\",\"request_id\":\"req_X\",\"request\":{\"subtype\":\"rewind_files\",\"user_message_id\":\"msg_123\"}}\n}\n\npub fn rewind_files_fails_without_checkpointing_test() {\n  // Arrange: session with checkpointing DISABLED\n  // Act: call rewind_files(session, \"msg_123\")\n  // Assert: returns Error(CheckpointingNotEnabled)\n  // Assert: NO request sent to mock runner\n}\n\npub fn rewind_files_receives_success_response_test() {\n  // Arrange: session with checkpointing, mock responds with success\n  // Act: call rewind_files(session, \"msg_123\")\n  // Assert: returns Ok(Nil)\n}\n\npub fn rewind_files_receives_error_response_test() {\n  // Arrange: mock responds with error \"Checkpoint not found\"\n  // Act: call rewind_files(session, \"invalid_id\")\n  // Assert: returns Error(CliError(\"Checkpoint not found\"))\n}\n\npub fn rewind_files_uses_30s_timeout_test() {\n  // Arrange: mock that never responds\n  // Act: call rewind_files with 30s+ wait\n  // Assert: returns Error(Timeout) after 30s (not 5s)\n}\n```\n\n## Wire Format\n\nSDK sends:\n```json\n{\"type\":\"control_request\",\"request_id\":\"req_4\",\"request\":{\"subtype\":\"rewind_files\",\"user_message_id\":\"msg_123\"}}\n```\n\nCLI responds (success):\n```json\n{\"type\":\"control_response\",\"response\":{\"subtype\":\"success\",\"request_id\":\"req_4\"}}\n```\n\nCLI responds (error):\n```json\n{\"type\":\"control_response\",\"response\":{\"subtype\":\"error\",\"request_id\":\"req_4\",\"error\":\"Checkpoint not found: msg_123\"}}\n```\n\n## Files\n- src/claude_agent_sdk/internal/bidir.gleam (modify)\n- test/rewind_files_test.gleam (new)\n\n## Acceptance Criteria\n- [ ] rewind_files() public function implemented\n- [ ] Returns CheckpointingNotEnabled if not enabled\n- [ ] Sends correct wire format with user_message_id\n- [ ] Handles success response\n- [ ] Handles error response\n- [ ] Uses 30000ms timeout (longer than other operations)","notes":"Quality gate failed: Timeout after 60 minutes\nLog: /home/cyou/.claude/projects/-home-cyou-claude-agent-sdk-gleam/d32c1dba-a762-45d8-aaeb-c21b4c3b5842.jsonl","status":"in_progress","priority":2,"issue_type":"task","created_at":"2026-01-12T04:12:07.903234278Z","created_by":"cyou","updated_at":"2026-01-12T17:05:07.105298897Z","labels":["needs-followup","tdd"],"dependencies":[{"issue_id":"casg-lqg.6","depends_on_id":"casg-lqg","type":"parent-child","created_at":"2026-01-12T04:12:07.904404786Z","created_by":"cyou"},{"issue_id":"casg-lqg.6","depends_on_id":"casg-lqg.2","type":"blocks","created_at":"2026-01-12T04:12:49.293256512Z","created_by":"cyou"}]}
{"id":"casg-lqg.7","title":"T6: Operation timeout and error handling","description":"## Overview\nImplement robust timeout and error handling for all control operations. This ensures the system remains stable under adverse conditions (slow responses, network issues, session stops).\n\n## Key Behaviors\n\n### First-Event-Wins Pattern\nWhen a pending request exists, exactly ONE of these events will resolve it:\n1. Response arrives -\u003e success/error result\n2. Timer fires -\u003e Timeout error\n3. Session stops -\u003e SessionStopped error\n\nWhichever happens first wins. The others are ignored.\n\n### Late Response Handling\nIf a response arrives for a request_id not in pending_requests:\n- Log at DEBUG: \"Late response for {request_id}, discarding\"\n- Drop silently (do NOT crash)\n- This happens when timeout fired before response arrived\n\n## TDD Approach\n1. Write failing tests for edge cases first\n2. Implement late response handling\n3. Implement session stop cleanup\n4. Add backpressure limit\n\n## Tasks\n\n### 1. Implement late response handling in handle_info\n```gleam\n// In handle_info for ControlResponse\ncase dict.get(state.pending_requests, request_id) {\n  Ok(pending) -\u003e {\n    // Cancel timer, send result, remove from map\n    cancel_timer(pending.timer_ref)\n    process.send(pending.reply_to, result)\n    State(..state, pending_requests: dict.delete(state.pending_requests, request_id))\n  }\n  Error(Nil) -\u003e {\n    // Late response - request already completed via timeout\n    log.debug(\"Late response for \" \u003c\u003e request_id \u003c\u003e \", discarding\")\n    state  // Return unchanged state, do not crash\n  }\n}\n```\n\n### 2. Implement session stop cleanup\nWhen session stops (port closes, stop() called):\n```gleam\nfn cleanup_pending_requests(pending_requests: Dict(String, PendingRequest)) {\n  dict.each(pending_requests, fn(_, pending) {\n    cancel_timer(pending.timer_ref)\n    process.send(pending.reply_to, Error(SessionStopped))\n  })\n}\n```\n\n### 3. Add TooManyPendingRequests backpressure\n```gleam\nconst max_pending_requests = 32\n\nfn send_control_request(state, op) {\n  case dict.size(state.pending_requests) \u003e= max_pending_requests {\n    True -\u003e Error(TooManyPendingRequests)\n    False -\u003e // proceed with request\n  }\n}\n```\n\n### 4. Write tests\nTest file: test/op_timeout_test.gleam\n\n```gleam\npub fn timeout_returns_error_test() {\n  // Arrange: session with mock that never responds\n  // Act: call interrupt() with 5s timeout\n  // Assert: returns Error(Timeout(Interrupt, \"req_X\")) after 5s\n}\n\npub fn late_response_is_dropped_test() {\n  // Arrange: session with mock that responds slowly (after timeout)\n  // Act: call interrupt(), wait for timeout\n  // Assert: timeout error returned\n  // Then: simulate late response arriving\n  // Assert: no crash, response dropped silently\n}\n\npub fn session_stop_cancels_pending_requests_test() {\n  // Arrange: session with pending interrupt request\n  // Act: call stop(session)\n  // Assert: pending interrupt returns Error(SessionStopped)\n}\n\npub fn too_many_pending_requests_returns_error_test() {\n  // Arrange: session with 32 pending requests\n  // Act: call interrupt()\n  // Assert: returns Error(TooManyPendingRequests) immediately (no wait)\n}\n\npub fn response_before_timeout_cancels_timer_test() {\n  // Arrange: session with mock that responds quickly\n  // Act: call interrupt()\n  // Assert: returns Ok(Nil) before timeout\n  // Assert: timeout message does not crash after response\n}\n\npub fn error_response_returns_cli_error_test() {\n  // Arrange: mock responds with {\"subtype\":\"error\",\"error\":\"Something wrong\"}\n  // Act: call interrupt()\n  // Assert: returns Error(CliError(Interrupt, \"Something wrong\"))\n}\n```\n\n## ControlError Types Summary\n\n```gleam\npub type ControlError {\n  /// Operation timed out waiting for CLI response\n  Timeout(kind: PendingRequestKind, request_id: String)\n  \n  /// CLI returned an error response\n  CliError(kind: PendingRequestKind, message: String)\n  \n  /// Session was stopped before operation completed\n  SessionStopped\n  \n  /// Too many concurrent operations (backpressure limit: 32)\n  TooManyPendingRequests\n  \n  /// rewind_files called without checkpointing enabled (from T5)\n  CheckpointingNotEnabled\n}\n```\n\n## Files\n- src/claude_agent_sdk/internal/bidir.gleam (modify)\n- test/op_timeout_test.gleam (new)\n\n## Acceptance Criteria\n- [ ] Late responses logged and dropped (no crash)\n- [ ] Session stop cancels all timers and sends SessionStopped\n- [ ] TooManyPendingRequests returned when limit hit\n- [ ] Timer cancelled when response arrives first\n- [ ] CliError returned when CLI sends error response\n- [ ] All edge cases covered by tests","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-12T04:12:33.992197405Z","created_by":"cyou","updated_at":"2026-01-12T04:12:33.992197405Z","labels":["tdd"],"dependencies":[{"issue_id":"casg-lqg.7","depends_on_id":"casg-lqg","type":"parent-child","created_at":"2026-01-12T04:12:33.993109043Z","created_by":"cyou"},{"issue_id":"casg-lqg.7","depends_on_id":"casg-lqg.3","type":"blocks","created_at":"2026-01-12T04:12:54.095116961Z","created_by":"cyou"},{"issue_id":"casg-lqg.7","depends_on_id":"casg-lqg.4","type":"blocks","created_at":"2026-01-12T04:12:54.595260237Z","created_by":"cyou"},{"issue_id":"casg-lqg.7","depends_on_id":"casg-lqg.5","type":"blocks","created_at":"2026-01-12T04:12:55.129984943Z","created_by":"cyou"},{"issue_id":"casg-lqg.7","depends_on_id":"casg-lqg.6","type":"blocks","created_at":"2026-01-12T04:12:55.638945787Z","created_by":"cyou"}]}
{"id":"casg-lqg.8","title":"[Review] 1 non-blocking finding from casg-lqg.4","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-lqg.4\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Cancel-on-client-timeout test does not validate cancellation behavior\n\n**Priority:** P2\n**Reviewer:** codex\n**Location:** test/set_permission_mode_test.gleam:299-340\n\nThe new test `set_permission_mode_cancels_pending_on_client_timeout_test` only calls `bidir.cancel_pending_request(session, \"req_cancel_test\")` directly and then asserts the actor is still `Running`. This does not verify the bug fix’s intended behavior: preventing a later scheduled actor `RequestTimeout` from being sent to the original `reply_to` subject.\n\nConcrete gap: the test never waits long enough for an actor timeout to fire and never asserts that `result_subject` remains empty (or does not receive `RequestTimeout`) after cancellation. As written, it would pass even if `handle_cancel_pending_request` failed to cancel the timer or failed to remove the pending request.\n\nA stronger assertion would be: create a config where `default_timeout_ms` is small-but-nonzero (e.g. 50ms), cancel immediately, then `process.receive(result_subject, 200)` should return `Error(Nil)` (no timeout delivered).\n\n---\n\n\u003c!-- fp:fd8e5ea06e1c7f61 --\u003e\n\u003c!-- review_finding:4a6ad4d71883 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T17:02:53.425966947Z","created_by":"cyou","updated_at":"2026-01-12T17:06:22.479643162Z","closed_at":"2026-01-12T17:06:22.479643162Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-lqg.4"],"dependencies":[{"issue_id":"casg-lqg.8","depends_on_id":"casg-lqg","type":"parent-child","created_at":"2026-01-12T17:02:53.426550632Z","created_by":"cyou"}]}
{"id":"casg-m2h","title":"Align content block decoding: known type missing required fields should error (not UnknownBlock)","notes":"SELF-DOC UPDATE (2026-01-11)\nCONTEXT:\n- Decoder policy: unknown content block types should map to UnknownBlock for forward compatibility.\n- Known content block types missing required fields should error (not be treated as UnknownBlock).\n\nGOAL / OUTCOME:\n- Enforce strictness for known types with missing required fields.\n- Preserve UnknownBlock only for truly unknown type values.\n\nSUBTASKS:\n- Review `decode_content_block` and related decoders in `src/claude_agent_sdk/internal/decoder.gleam`.\n- Adjust logic so missing required fields for known types return an error.\n- Add/adjust fixtures and tests to validate negative cases.\n\nFILES (planned):\n- `src/claude_agent_sdk/internal/decoder.gleam` (decoder behavior).\n- `test/json_decode_test.gleam` (tests for missing required fields).\n- `test/fixtures/*.json` and `test/fixtures/README.md` (negative fixtures documentation).\n\nDEPENDENCIES:\n- casg-xjv.9 depends on this because both touch decoder tests and fixtures.\n\nCONSIDERATIONS:\n- Keep forward compatibility for unknown types; only tighten known-type validation.\n- Ensure error messages are actionable for test debugging.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T04:21:07.217464377Z","created_by":"cyou","updated_at":"2026-01-11T05:05:26.906786774Z","closed_at":"2026-01-11T05:05:26.906786774Z","close_reason":"Closed"}
{"id":"casg-pl6","title":"[Review] 1 non-blocking finding from casg-5ar","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-5ar\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Enforce max_pending_requests when flushing queued ops\n\n**Priority:** P2\n**Reviewer:** codex\n**Location:** src/claude_agent_sdk/internal/bidir.gleam:998-1025\n\n`flush_queued_ops/1` inserts directly into `state.pending_requests` via `dict.insert`, bypassing the backpressure check in `add_pending_request/3`.\n\nConcrete failure path: if `state.pending_requests` is already near capacity (e.g., 60 entries) when init completes, and there are up to 16 queued ops (`max_queued_ops`), flushing can grow `pending_requests` to 76. This violates the stated max (64) and can cause memory/queue pressure and inconsistent behavior vs. requests added through the normal path.\n\nSuggested fix: use `add_pending_request/3` inside `flush_queued_ops/1` and on overflow either (a) stop flushing remaining ops and reply `RequestError`/`RequestSessionStopped`, or (b) send the request but immediately reply an error and avoid inserting a pending entry (to prevent callers waiting forever).\n\n---\n\n\u003c!-- fp:0cc32603f6f3d54f --\u003e\n\u003c!-- review_finding:e2ce8ef26b62 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T15:37:37.282294035Z","created_by":"cyou","updated_at":"2026-01-12T15:42:53.848766749Z","closed_at":"2026-01-12T15:42:53.848766749Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-5ar"]}
{"id":"casg-poj","title":"[Review] 2 non-blocking findings from casg-pl6","description":"## Review Findings\n\nThis issue consolidates 2 non-blocking findings from code review.\n\n**Source issue:** casg-pl6\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Avoid making flush_queued_ops public unless required\n\n**Priority:** P2\n**Reviewer:** codex\n**Location:** src/claude_agent_sdk/internal/bidir.gleam:998\n\nThis diff changes `flush_queued_ops` from private to public (`pub fn`). That expands the module’s public API surface and may commit you to supporting this function externally, even though it appears to be an internal lifecycle helper (called during init success).\n\nConcrete impact: external callers can now invoke `flush_queued_ops/1` at arbitrary times, bypassing any intended sequencing around init completion and request sending.\n\nIf you only need it for tests, prefer keeping it private and testing via public entrypoints, or use an internal test module approach (if Gleam supports the pattern used in this repo).\n\n---\n\n### Finding 2: [P2] Use consistent error type for pending_requests overflow\n\n**Priority:** P2\n**Reviewer:** codex\n**Location:** src/claude_agent_sdk/internal/bidir.gleam:1011-1018\n\nWhen at capacity, `flush_queued_ops/1` sends `RequestError(\"Too many pending control requests (max 64)\")` to the caller. Elsewhere, the dedicated backpressure path uses `TooManyPendingRequests` (see the existing tests around `add_pending_request`).\n\nConcrete impact: callers that pattern-match on `TooManyPendingRequests` for this condition won’t see it during init-flush overflow, and may handle this as a generic error instead of a backpressure signal.\n\nIf the intent is “same condition, same semantics”, consider reusing `TooManyPendingRequests` (or document why init-flush overflows are intentionally surfaced as `RequestError`).\n\n---\n\n\u003c!-- fp:7824155fce92cf01 --\u003e\n\u003c!-- fp:43a6b24b0cb89abc --\u003e\n\u003c!-- review_finding:0847bc0509ff --\u003e","notes":"Quality gate failed: Killed as deadlock victim (will retry after blocker completes)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T15:42:53.958547987Z","created_by":"cyou","updated_at":"2026-01-12T17:33:32.85847478Z","closed_at":"2026-01-12T17:33:32.85847478Z","close_reason":"Closed","labels":["auto_generated","needs-followup","review_finding","source:casg-pl6"],"dependencies":[{"issue_id":"casg-poj","depends_on_id":"casg-lqg.2","type":"blocks","created_at":"2026-01-12T15:50:22.413559235Z","created_by":"cyou"},{"issue_id":"casg-poj","depends_on_id":"casg-red.2","type":"blocks","created_at":"2026-01-12T16:08:57.018661843Z","created_by":"cyou"},{"issue_id":"casg-poj","depends_on_id":"casg-red.3","type":"blocks","created_at":"2026-01-12T16:30:56.451166238Z","created_by":"cyou"}]}
{"id":"casg-pqw","title":"[Review] 1 non-blocking finding from casg-xjv.2","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-xjv.2\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] File handle leak if file:open fails\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** scripts/coverage.escript:133-136\n\nIn `run_tests/2` at lines 133-136, when `Quiet=true`, the code unconditionally opens `/dev/null` with:\n\n```erlang\n{ok, ND} = file:open(\"/dev/null\", [write]),\n```\n\nThis pattern match assumes `file:open` will always succeed. If `/dev/null` is missing (rare but possible in restricted environments like some containers), this will crash with `badmatch` and the script will exit without any cleanup or helpful error message.\n\n**Impact**: In restricted environments where `/dev/null` is unavailable, the script crashes instead of falling back gracefully or providing a clear error.\n\n**Fix**: Handle the error case explicitly:\n\n```erlang\nNullHandle = case Quiet of\n    true -\u003e\n        case file:open(\"/dev/null\", [write]) of\n            {ok, ND} -\u003e\n                erlang:group_leader(ND, self()),\n                ND;\n            {error, Reason} -\u003e\n                io:format(standard_error, \"Warning: Could not open /dev/null: ~p~n\", [Reason]),\n                io:format(standard_error, \"Test output may pollute JSON output~n\", []),\n                undefined\n        end;\n    false -\u003e\n        undefined\nend,\n```\n\nAlternatively, fail fast with a clear error if this is considered a critical requirement for JSON mode.\n\n---\n\n\u003c!-- fp:29d05cf1074ba91e --\u003e\n\u003c!-- review_finding:6b556a3895a1 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T05:14:48.458371034Z","created_by":"cyou","updated_at":"2026-01-11T05:16:24.60169609Z","closed_at":"2026-01-11T05:16:24.60169609Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-xjv.2"]}
{"id":"casg-r0x","title":"[Review] 1 non-blocking finding from casg-xjv.7","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-xjv.7\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Shell injection vulnerability in test shell command construction\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** test/resource_test.gleam:45\n\nThe tests construct shell commands by concatenating JSON strings directly into shell commands wrapped in single quotes:\n\n```gleam\n\"echo '\" \u003c\u003e valid_system_json \u003c\u003e \"'; echo '\" \u003c\u003e valid_result_json \u003c\u003e \"'\"\n```\n\nIf any JSON string ever contains a single quote character (e.g., in error messages, user data, or test fixtures like `{\"error\":\"User's input invalid\"}`), this will cause shell syntax errors or potential command injection.\n\n**Current risk:** Low - existing JSON constants don't contain single quotes\n\n**Future risk:** Medium - any test adding JSON with single quotes will break or create injection vulnerability\n\n**Recommendation:** Use proper shell escaping or switch to a safer approach:\n1. Use `printf '%s\\n'` with properly escaped arguments\n2. Write JSON to temp files and cat them\n3. Use Gleam string literals that are properly escaped when passed to shell\n\n**Example fix for one instance:**\n```gleam\n// Instead of:\n\"echo '\" \u003c\u003e valid_system_json \u003c\u003e \"'\"\n\n// Use:\n\"printf '%s\\n' \" \u003c\u003e shell_escape(valid_system_json)\n// Or write to file:\n\"cat /tmp/test.json\"  // after writing JSON to file\n```\n\nThis affects 14 locations in the file where `echo '` is used with string concatenation.\n\n---\n\n\u003c!-- fp:da8ffdf6021386f9 --\u003e\n\u003c!-- review_finding:df499a9aac73 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T05:06:25.92221983Z","created_by":"cyou","updated_at":"2026-01-11T05:08:55.460019268Z","closed_at":"2026-01-11T05:08:55.460019268Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-xjv.7"]}
{"id":"casg-red","title":"Epic: Bidirectional Protocol - Hook Dispatch","description":"## Overview\nImplement hook callback execution in spawned OTP tasks with timeout supervision.\n\n## Source Plan\n`plans/2026-01-12-bidir-protocol-plan.md` - \"Hook Task Lifecycle and Supervision\" section\n\n## Key Deliverables\n- Hook dispatch in GenServer (callback_id lookup, task spawn)\n- OTP task spawning with spawn_link + monitor\n- Timeout management with erlang:send_after\n- First-event-wins protocol (task done vs timeout vs crash)\n- Fail-open for hooks, fail-deny for permissions\n\n## Task Lifecycle\n1. spawn_link + monitor task\n2. set timer: {hook_timeout, request_id}\n3. First event wins: hook_done, hook_timeout, or DOWN\n4. Cleanup: cancel timer, demonitor, remove from pending_hooks\n\n## TDD Focus\n- Hook callback invoked with correct typed context\n- Timeout fires → fail-open response sent\n- Task crash → fail-open/deny response\n- Cleanup invariants (no leaked timers/monitors)\n\n## Files\n- src/claude_agent_sdk/internal/bidir.gleam (Extends Epic 4)\n- src/claude_agent_sdk/hook.gleam (Extends Epic 2)\n- test/hook_dispatch_test.gleam (New)\n- test/hook_timeout_test.gleam (New)","status":"open","priority":1,"issue_type":"epic","created_at":"2026-01-12T04:07:30.631853142Z","created_by":"cyou","updated_at":"2026-01-12T04:07:30.631853142Z","dependencies":[{"issue_id":"casg-red","depends_on_id":"casg-4jq","type":"blocks","created_at":"2026-01-12T04:07:43.852603817Z","created_by":"cyou"}]}
{"id":"casg-red.1","title":"Hook dispatch skeleton - route control_request to callbacks","description":"## Goal\nExtend bidir.gleam GenServer to handle incoming hook_callback control_request messages by looking up the callback_id in HookConfig and dispatching to the registered callback. This establishes the basic hook routing without task spawning (callbacks run inline in GenServer for now).\n\n## Context\nFrom the bidirectional protocol plan, the GenServer receives control_request messages with type \"hook_callback\" from the CLI when hook events occur (PreToolUse, PostToolUse, etc.). The GenServer must:\n1. Parse the control_request and extract callback_id\n2. Look up callback in HookConfig (populated during session creation)\n3. Invoke the callback with appropriate context\n4. Send control_response back to CLI\n\nThis task implements steps 1-4 in a simple inline fashion. Task spawning and timeout supervision are added in subsequent tasks.\n\n## Files to Modify\n- `src/claude_agent_sdk/internal/bidir.gleam` - Add handle_info clause for control_request routing\n- `test/hook_dispatch_test.gleam` - New test file for hook dispatch\n\n## TDD Approach\n1. **Skeleton phase**: Add pattern match for ControlRequest(HookCallback) in handle_info, stub returns hardcoded response\n2. **Failing test**: Write test that:\n   - Creates session with PreToolUse hook registered\n   - Mock runner sends hook_callback control_request\n   - Verify callback receives expected HookContext (tool_name, input, etc.)\n   - Verify control_response sent back to CLI\n3. **Implementation**: Complete lookup and dispatch logic\n\n## Technical Details\n\n### HookConfig Lookup\n```gleam\n// In SessionState\nhooks: HookConfig  // Map(String, HookCallback) keyed by callback_id\n\n// Lookup logic\ncase map.get(state.hooks, callback_id) {\n  Ok(callback) -\u003e invoke_callback(callback, context)\n  Error(Nil) -\u003e log_warning(\"Unknown callback_id: \" \u003c\u003e callback_id)\n}\n```\n\n### Control Request Pattern\n```gleam\n// handle_info pattern match\nControlRequest(request_id, HookCallback(callback_id, context)) -\u003e {\n  // Look up callback, invoke, send response\n}\n```\n\n### Response Format\nPer spec, hook callbacks return HookResponse which maps to:\n```json\n{\"type\": \"control_response\", \"request_id\": \"...\", \"result\": {\"continue\": true}}\n```\n\n## Acceptance Criteria\n- [ ] handle_info matches ControlRequest(HookCallback(...)) messages\n- [ ] Callback looked up in HookConfig by callback_id\n- [ ] Callback receives correctly typed HookContext\n- [ ] control_response sent via BidirRunner.write()\n- [ ] Unknown callback_id logged and ignored (fail-open)\n- [ ] Test verifies callback invocation with correct context\n- [ ] Test verifies response JSON structure\n\n## Notes\n- This task does NOT implement task spawning - callbacks run inline\n- This task does NOT implement timeout handling\n- Assume HookConfig is already populated by session initialization (from Epic 4)\n- Focus on the happy path; error handling for malformed requests can be minimal","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:11:10.443066831Z","created_by":"cyou","updated_at":"2026-01-12T16:03:54.713317625Z","closed_at":"2026-01-12T16:03:54.713317625Z","close_reason":"Closed","labels":["gleam","integration-path-test","tdd"],"dependencies":[{"issue_id":"casg-red.1","depends_on_id":"casg-red","type":"parent-child","created_at":"2026-01-12T04:11:10.44368571Z","created_by":"cyou"}]}
{"id":"casg-red.2","title":"OTP task spawning for hook callbacks","description":"## Goal\nMove hook callback execution from inline GenServer execution to spawned OTP tasks. This enables non-blocking callback execution and prepares for timeout supervision (added in next task).\n\n## Context\nFrom the Hook Task Lifecycle section of the plan:\n```\nGenServer (bidir.gleam)                          Spawned Task\n        │                                              │\n        │  spawn_link + monitor                        │\n        ├─────────────────────────────────────────────►│\n        │                                              │\n        │                                              │ execute callback\n        │                                              │\n        │                              {hook_done, request_id, result}\n        │◄─────────────────────────────────────────────┤\n```\n\nThe GenServer must:\n1. Spawn a task (using gleam_otp/task or raw Erlang spawn_link)\n2. Monitor the task for crash detection\n3. Task executes callback and sends `{hook_done, request_id, result}` back to GenServer\n4. GenServer receives hook_done message in handle_info\n\n## Files to Modify\n- `src/claude_agent_sdk/internal/bidir.gleam` - Add task spawning and hook_done handling\n- `test/hook_task_test.gleam` - New test file for task spawning behavior\n\n## TDD Approach\n1. **Skeleton phase**: Add PendingHook record with task_pid, monitor_ref fields. Stub spawn_link.\n2. **Failing test**: Write test that:\n   - Registers a hook callback that sleeps briefly then returns\n   - Sends hook_callback control_request\n   - Verifies callback executes in a different process (not the GenServer)\n   - Verifies hook_done message triggers response\n3. **Implementation**: Complete spawn_link, monitor, and hook_done handling\n\n## Technical Details\n\n### PendingHook Record\n```gleam\ntype PendingHook {\n  PendingHook(\n    task_pid: Pid,\n    monitor_ref: Reference,\n    callback_id: String,\n    request_id: String,\n  )\n}\n```\n\n### State Changes\n```gleam\n// Add to SessionState\npending_hooks: Map(String, PendingHook)  // keyed by request_id\n```\n\n### Task Spawning\n```gleam\n// Pseudo-code for spawning\nlet task_pid = process.spawn_link(fn() {\n  let result = callback.invoke(context)\n  process.send(parent, HookDone(request_id, result))\n})\nlet monitor_ref = process.monitor(task_pid)\n```\n\n### hook_done Handling\n```gleam\n// handle_info pattern\nHookDone(request_id, result) -\u003e {\n  case map.get(state.pending_hooks, request_id) {\n    Ok(pending) -\u003e {\n      // Demonitor (cleanup in later task)\n      // Send control_response\n      // Remove from pending_hooks\n    }\n    Error(Nil) -\u003e {\n      // Already handled (timeout won), ignore\n    }\n  }\n}\n```\n\n## Acceptance Criteria\n- [ ] PendingHook type defined with task_pid, monitor_ref\n- [ ] pending_hooks map added to SessionState\n- [ ] Hook callback spawned via spawn_link + monitor\n- [ ] Task sends HookDone message on completion\n- [ ] GenServer handle_info receives HookDone\n- [ ] control_response sent after HookDone received\n- [ ] pending_hooks entry removed after processing\n- [ ] Test verifies callback runs in separate process (pid differs)\n- [ ] Test verifies response only sent after callback completes\n\n## Notes\n- This task does NOT implement timeout handling (next task)\n- This task does NOT implement crash handling (fail-open in later task)\n- Monitor reference stored but not used yet\n- Timer reference added in next task","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:11:32.644494171Z","created_by":"cyou","updated_at":"2026-01-12T16:24:25.584813719Z","closed_at":"2026-01-12T16:24:25.584813719Z","close_reason":"Closed","labels":["gleam","otp","tdd"],"dependencies":[{"issue_id":"casg-red.2","depends_on_id":"casg-red","type":"parent-child","created_at":"2026-01-12T04:11:32.64529961Z","created_by":"cyou"},{"issue_id":"casg-red.2","depends_on_id":"casg-red.1","type":"blocks","created_at":"2026-01-12T04:13:37.482033122Z","created_by":"cyou"}]}
{"id":"casg-red.3","title":"Hook timeout management with first-event-wins protocol","description":"## Goal\nImplement timeout supervision for hook callbacks using erlang:send_after. Establish the first-event-wins protocol where either hook_done or hook_timeout triggers response, and the loser is ignored.\n\n## Context\nFrom the First-Event-Wins Protocol section of the plan:\n\n1. **Task completes normally**: GenServer receives hook_done\n   - Cancel pending timer\n   - Send control_response\n   - Remove from pending_hooks\n\n2. **Timer fires first (timeout)**: GenServer receives hook_timeout\n   - Check pending_hooks — if not present, ignore\n   - Send fail-open response\n   - Kill task\n   - Remove from pending_hooks\n\nThis task focuses on the timer mechanics; the actual fail-open response is implemented in the next task.\n\n## Files to Modify\n- `src/claude_agent_sdk/internal/bidir.gleam` - Add timer management\n- `test/hook_timeout_test.gleam` - New test file for timeout behavior\n\n## TDD Approach\n1. **Skeleton phase**: Add timer_ref to PendingHook. Stub send_after.\n2. **Failing test**: Write test that:\n   - Registers a hook callback with 100ms timeout\n   - Sends hook_callback control_request\n   - Callback sleeps for 200ms (will timeout)\n   - Verifies hook_timeout message received before hook_done\n3. **Implementation**: Complete send_after, cancel_timer, timeout handling\n\n## Technical Details\n\n### Extended PendingHook\n```gleam\ntype PendingHook {\n  PendingHook(\n    task_pid: Pid,\n    monitor_ref: Reference,\n    timer_ref: Reference,  // NEW\n    callback_id: String,\n    request_id: String,\n    hook_type: HookType,   // For fail-open vs fail-deny\n  )\n}\n```\n\n### Timer Setup\n```gleam\n// After spawning task\nlet timer_ref = erlang.send_after(\n  timeout_ms,\n  self(),\n  HookTimeout(request_id, timer_ref)\n)\n```\n\n### Timer Cancellation (on hook_done)\n```gleam\nHookDone(request_id, result) -\u003e {\n  case map.get(state.pending_hooks, request_id) {\n    Ok(pending) -\u003e {\n      erlang.cancel_timer(pending.timer_ref)\n      process.demonitor(pending.monitor_ref)\n      // Send response, remove from pending_hooks\n    }\n    Error(Nil) -\u003e actor.continue(state)  // Already timed out\n  }\n}\n```\n\n### Timeout Handling\n```gleam\nHookTimeout(request_id, timer_ref) -\u003e {\n  case map.get(state.pending_hooks, request_id) {\n    Ok(pending) if pending.timer_ref == timer_ref -\u003e {\n      // Timer matches, this is authoritative\n      process.demonitor(pending.monitor_ref, [Flush])\n      process.kill(pending.task_pid, Kill)\n      // Send fail-open response (next task)\n      // Remove from pending_hooks\n    }\n    _ -\u003e actor.continue(state)  // Already handled or stale timer\n  }\n}\n```\n\n### Timer Reference Verification\nThe timer_ref check prevents stale timeouts from a previous request with same request_id (edge case but important for correctness).\n\n## Acceptance Criteria\n- [ ] timer_ref added to PendingHook\n- [ ] erlang:send_after called with configured timeout\n- [ ] HookTimeout message pattern added to handle_info\n- [ ] Timer cancelled when hook_done received first\n- [ ] Task killed when timeout fires first\n- [ ] Late hook_done messages ignored (no entry in pending_hooks)\n- [ ] Late timeout messages ignored (timer_ref mismatch or missing entry)\n- [ ] Test with fast callback verifies timer cancelled\n- [ ] Test with slow callback verifies timeout fires\n\n## Notes\n- Timeout value comes from HookConfig (default 30s, configurable per hook type)\n- This task stubs the response sending; actual fail-open logic in next task\n- Process.kill uses :kill reason for immediate termination\n- Demonitor with :flush clears any queued DOWN messages","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:11:57.280241455Z","created_by":"cyou","updated_at":"2026-01-12T17:20:00.656908349Z","closed_at":"2026-01-12T17:20:00.656908349Z","close_reason":"Closed","labels":["gleam","tdd","timeout"],"dependencies":[{"issue_id":"casg-red.3","depends_on_id":"casg-red","type":"parent-child","created_at":"2026-01-12T04:11:57.281062574Z","created_by":"cyou"},{"issue_id":"casg-red.3","depends_on_id":"casg-red.2","type":"blocks","created_at":"2026-01-12T04:13:37.99926043Z","created_by":"cyou"}]}
{"id":"casg-red.4","title":"Fail-open behavior for hook timeouts and crashes","description":"## Goal\nImplement fail-open behavior for hook callbacks (PreToolUse, PostToolUse, etc.). When a hook times out or crashes, send a continue: true response so the CLI proceeds with the operation.\n\n## Context\nFrom the spec, hooks use fail-open semantics:\n- **Timeout**: Log warning, send continue: true\n- **Crash**: Log error, send continue: true\n\nThis ensures that misbehaving hooks don't block Claude's operations. The SDK prioritizes availability over strict hook enforcement.\n\n## Files to Modify\n- `src/claude_agent_sdk/internal/bidir.gleam` - Implement fail-open responses\n- `test/fail_open_test.gleam` - New test file for fail-open behavior\n\n## TDD Approach\n1. **Skeleton phase**: Add helper function `send_fail_open_response(request_id)`\n2. **Failing test**: Write tests for:\n   - Hook timeout returns continue: true\n   - Hook crash (callback raises exception) returns continue: true\n   - Warning/error logged with timing details\n3. **Implementation**: Complete fail-open logic in timeout and DOWN handlers\n\n## Technical Details\n\n### Fail-Open Response Format\n```json\n{\n  \"type\": \"control_response\",\n  \"request_id\": \"hook_callback_123\",\n  \"result\": {\n    \"continue\": true\n  }\n}\n```\n\n### Timeout Handler\n```gleam\nHookTimeout(request_id, timer_ref) -\u003e {\n  case map.get(state.pending_hooks, request_id) {\n    Ok(pending) if pending.timer_ref == timer_ref -\u003e {\n      // Log warning\n      io.println_error(\n        \"Hook callback timed out after \" \u003c\u003e int.to_string(timeout_ms) \u003c\u003e \n        \"ms for \" \u003c\u003e pending.callback_id\n      )\n      \n      // Kill task, cleanup\n      process.demonitor(pending.monitor_ref, [Flush])\n      process.kill(pending.task_pid, Kill)\n      \n      // Send fail-open response\n      let response = encode_control_response(\n        request_id,\n        HookResult(continue: True, reason: Some(\"timeout\"))\n      )\n      bidir_runner.write(state.runner, response)\n      \n      // Remove from pending\n      let new_pending = map.delete(state.pending_hooks, request_id)\n      actor.continue(SessionState(..state, pending_hooks: new_pending))\n    }\n    _ -\u003e actor.continue(state)\n  }\n}\n```\n\n### Crash Handler (DOWN message)\n```gleam\nDown(monitor_ref, _process, _pid, reason) -\u003e {\n  // Look up by monitor_ref (need reverse mapping or iteration)\n  case find_pending_by_monitor(state.pending_hooks, monitor_ref) {\n    Ok(#(request_id, pending)) -\u003e {\n      // Log error\n      io.println_error(\n        \"Hook callback crashed: \" \u003c\u003e reason_to_string(reason) \u003c\u003e\n        \" for \" \u003c\u003e pending.callback_id\n      )\n      \n      // Cancel timer\n      erlang.cancel_timer(pending.timer_ref)\n      \n      // Send fail-open response\n      let response = encode_control_response(\n        request_id,\n        HookResult(continue: True, reason: Some(\"crash\"))\n      )\n      bidir_runner.write(state.runner, response)\n      \n      // Remove from pending\n      let new_pending = map.delete(state.pending_hooks, request_id)\n      actor.continue(SessionState(..state, pending_hooks: new_pending))\n    }\n    Error(Nil) -\u003e actor.continue(state)  // Already handled\n  }\n}\n```\n\n### Monitor Reference Lookup\nNeed a way to find request_id from monitor_ref. Options:\n1. Iterate pending_hooks map (O(n) but simple)\n2. Add reverse map: monitor_to_request: Map(Reference, String)\n\nFor MVP, iteration is acceptable given low hook concurrency.\n\n## Acceptance Criteria\n- [ ] Timeout triggers continue: true response\n- [ ] Crash triggers continue: true response\n- [ ] Response includes optional reason field (\"timeout\" or \"crash\")\n- [ ] Warning logged on timeout with duration and callback_id\n- [ ] Error logged on crash with reason and callback_id\n- [ ] Task killed on timeout (already done in T3)\n- [ ] Timer cancelled on crash\n- [ ] Test: slow callback -\u003e timeout -\u003e continue: true\n- [ ] Test: crashing callback -\u003e DOWN -\u003e continue: true\n- [ ] Test: verify logging output contains expected details\n\n## Notes\n- reason field in response is for debugging, not required by spec\n- Logging uses io.println_error for now; structured logging is future enhancement\n- This task only covers hooks (PreToolUse, PostToolUse, etc.)\n- Permission callbacks (can_use_tool) use fail-deny, covered in next task","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T04:12:24.708084999Z","created_by":"cyou","updated_at":"2026-01-12T17:42:20.662949427Z","closed_at":"2026-01-12T17:42:20.662949427Z","close_reason":"Closed","labels":["error-handling","gleam","tdd"],"dependencies":[{"issue_id":"casg-red.4","depends_on_id":"casg-red","type":"parent-child","created_at":"2026-01-12T04:12:24.708971777Z","created_by":"cyou"},{"issue_id":"casg-red.4","depends_on_id":"casg-red.3","type":"blocks","created_at":"2026-01-12T04:13:38.487303199Z","created_by":"cyou"}]}
{"id":"casg-red.5","title":"Fail-deny behavior for permission callback errors","description":"## Goal\nImplement fail-deny behavior for permission callbacks (can_use_tool). Unlike hooks which fail-open, permission errors must deny the operation to maintain security guarantees.\n\n## Context\nFrom the spec, permission callbacks use fail-deny semantics:\n- **Timeout**: Send behavior: \"deny\", updatedInput: null\n- **Crash**: Send behavior: \"deny\", updatedInput: null\n\nThis ensures that permission system failures result in denied operations rather than allowed operations, maintaining security invariants.\n\n## Files to Modify\n- `src/claude_agent_sdk/internal/bidir.gleam` - Add fail-deny logic for permission callbacks\n- `test/fail_deny_test.gleam` - New test file for fail-deny behavior\n\n## TDD Approach\n1. **Skeleton phase**: Add helper function `send_fail_deny_response(request_id)`\n2. **Failing test**: Write tests for:\n   - Permission timeout returns behavior: \"deny\"\n   - Permission crash returns behavior: \"deny\"\n   - Log includes security-relevant warning\n3. **Implementation**: Branch timeout/crash handlers by callback type\n\n## Technical Details\n\n### Callback Type Discrimination\n```gleam\ntype CallbackType {\n  HookCallback    // PreToolUse, PostToolUse, etc. -\u003e fail-open\n  PermissionCallback  // can_use_tool -\u003e fail-deny\n}\n\n// In PendingHook\ntype PendingHook {\n  PendingHook(\n    ...\n    callback_type: CallbackType,  // Determines fail-open vs fail-deny\n  )\n}\n```\n\n### Fail-Deny Response Format\n```json\n{\n  \"type\": \"control_response\",\n  \"request_id\": \"permission_callback_456\",\n  \"result\": {\n    \"behavior\": \"deny\",\n    \"updatedInput\": null,\n    \"message\": \"Permission callback timed out\"\n  }\n}\n```\n\n### Branching in Timeout Handler\n```gleam\nHookTimeout(request_id, timer_ref) -\u003e {\n  case map.get(state.pending_hooks, request_id) {\n    Ok(pending) if pending.timer_ref == timer_ref -\u003e {\n      case pending.callback_type {\n        HookCallback -\u003e send_fail_open_response(state, request_id, pending, \"timeout\")\n        PermissionCallback -\u003e send_fail_deny_response(state, request_id, pending, \"timeout\")\n      }\n    }\n    _ -\u003e actor.continue(state)\n  }\n}\n```\n\n### Fail-Deny Implementation\n```gleam\nfn send_fail_deny_response(\n  state: SessionState,\n  request_id: String,\n  pending: PendingHook,\n  reason: String\n) -\u003e actor.Next(Message, SessionState) {\n  // Log security warning\n  io.println_error(\n    \"SECURITY: Permission callback \" \u003c\u003e reason \u003c\u003e \" for \" \u003c\u003e \n    pending.callback_id \u003c\u003e \" - denying tool use\"\n  )\n  \n  // Kill task, cleanup\n  process.demonitor(pending.monitor_ref, [Flush])\n  process.kill(pending.task_pid, Kill)\n  \n  // Send deny response\n  let response = encode_control_response(\n    request_id,\n    PermissionResult(\n      behavior: Deny,\n      updated_input: option.None,\n      message: Some(\"Permission callback \" \u003c\u003e reason)\n    )\n  )\n  bidir_runner.write(state.runner, response)\n  \n  // Remove from pending\n  let new_pending = map.delete(state.pending_hooks, request_id)\n  actor.continue(SessionState(..state, pending_hooks: new_pending))\n}\n```\n\n### Security Logging\nPermission denials should be logged at a higher visibility level than normal hook failures because they have security implications.\n\n## Acceptance Criteria\n- [ ] CallbackType discriminates between hooks and permissions\n- [ ] Permission timeout returns behavior: \"deny\"\n- [ ] Permission crash returns behavior: \"deny\"\n- [ ] updatedInput is null/None on failure (no partial data)\n- [ ] Security warning logged with \"SECURITY:\" prefix\n- [ ] Hook failures still use fail-open (regression test)\n- [ ] Test: permission timeout -\u003e deny\n- [ ] Test: permission crash -\u003e deny\n- [ ] Test: hook timeout still -\u003e continue (regression)\n\n## Notes\n- message field in deny response explains the failure\n- updatedInput must be null, not the last known value\n- Security logging prefix enables log filtering for security events\n- Permission callbacks are registered via with_can_use_tool(callback)","status":"in_progress","priority":2,"issue_type":"task","created_at":"2026-01-12T04:12:50.340104298Z","created_by":"cyou","updated_at":"2026-01-12T17:42:20.943764185Z","labels":["error-handling","gleam","permissions","tdd"],"dependencies":[{"issue_id":"casg-red.5","depends_on_id":"casg-red","type":"parent-child","created_at":"2026-01-12T04:12:50.340668936Z","created_by":"cyou"},{"issue_id":"casg-red.5","depends_on_id":"casg-red.4","type":"blocks","created_at":"2026-01-12T04:13:38.99805075Z","created_by":"cyou"}]}
{"id":"casg-red.6","title":"Hook cleanup invariants - atomic resource cleanup","description":"## Goal\nEnsure hook cleanup removes task_pid, monitor_ref, and timer_ref atomically with no resource leaks. Verify cleanup occurs correctly after normal completion, timeout, and crash scenarios.\n\n## Context\nFrom the State Cleanup Invariants section of the plan:\n- pending_hooks: Map(RequestId, PendingHook) with TaskPid, MonitorRef, TimerRef\n- Every entry has exactly one task, one monitor, one timer\n- Cleanup always removes all three atomically\n- Double-response impossible: first event removes entry, subsequent events find nothing\n\nThis task consolidates cleanup logic and adds verification tests.\n\n## Files to Modify\n- `src/claude_agent_sdk/internal/bidir.gleam` - Consolidate cleanup into single function\n- `test/hook_cleanup_test.gleam` - New test file for cleanup verification\n\n## TDD Approach\n1. **Skeleton phase**: Extract cleanup logic into `cleanup_pending_hook(state, request_id, pending)` function\n2. **Failing test**: Write tests that verify:\n   - After normal completion: no leaked timers, monitors, or zombie processes\n   - After timeout: no leaked timers, monitors, or zombie processes\n   - After crash: no leaked timers, monitors, or zombie processes\n3. **Implementation**: Consolidate all cleanup paths to use single function\n\n## Technical Details\n\n### Cleanup Function\n```gleam\nfn cleanup_pending_hook(\n  state: SessionState,\n  request_id: String,\n  pending: PendingHook,\n  source: CleanupSource,  // NormalCompletion | Timeout | Crash\n) -\u003e SessionState {\n  // Cancel timer (if not already fired)\n  erlang.cancel_timer(pending.timer_ref)\n  \n  // Demonitor with flush (clears any queued DOWN)\n  process.demonitor(pending.monitor_ref, [Flush])\n  \n  // Kill task (if still running - may already be dead)\n  case source {\n    NormalCompletion -\u003e Nil  // Task exited naturally\n    Timeout | Crash -\u003e process.kill(pending.task_pid, Kill)\n  }\n  \n  // Remove from pending_hooks map\n  SessionState(\n    ..state,\n    pending_hooks: map.delete(state.pending_hooks, request_id)\n  )\n}\n```\n\n### Usage in Handlers\n```gleam\n// HookDone handler\nHookDone(request_id, result) -\u003e {\n  case map.get(state.pending_hooks, request_id) {\n    Ok(pending) -\u003e {\n      let new_state = cleanup_pending_hook(state, request_id, pending, NormalCompletion)\n      send_hook_response(new_state, request_id, result)\n    }\n    Error(Nil) -\u003e actor.continue(state)\n  }\n}\n\n// Similar for Timeout and Crash handlers\n```\n\n### Verification Test Strategy\n1. **Timer leak detection**: After cleanup, attempt to cancel timer - should return False (already cancelled)\n2. **Monitor leak detection**: After cleanup, attempt to demonitor - should be no-op\n3. **Process leak detection**: After cleanup, verify task_pid is not alive\n\n```gleam\n// Test helper\nfn verify_no_leaks(pending: PendingHook) {\n  // Timer should be cancelled\n  assert erlang.cancel_timer(pending.timer_ref) == False\n  \n  // Process should not be alive\n  assert process.is_alive(pending.task_pid) == False\n}\n```\n\n### Session Termination Cleanup\nWhen session stops, cleanup ALL pending hooks:\n```gleam\nfn cleanup_all_pending_hooks(state: SessionState) -\u003e SessionState {\n  map.fold(state.pending_hooks, state, fn(state, request_id, pending) {\n    cleanup_pending_hook(state, request_id, pending, SessionStopping)\n  })\n}\n```\n\n## Acceptance Criteria\n- [ ] cleanup_pending_hook function extracts common cleanup logic\n- [ ] All cleanup paths use cleanup_pending_hook (no duplicated cleanup)\n- [ ] cancel_timer called on all paths (safe to call on already-fired timer)\n- [ ] demonitor with :flush called on all paths\n- [ ] Task killed on timeout/crash paths\n- [ ] pending_hooks entry removed on all paths\n- [ ] Test: normal completion leaves no leaked resources\n- [ ] Test: timeout leaves no leaked resources\n- [ ] Test: crash leaves no leaked resources\n- [ ] Test: session termination cleans up all pending hooks\n- [ ] Double-cleanup is safe (idempotent)\n\n## Notes\n- erlang:cancel_timer returns False if timer already fired (safe)\n- demonitor with :flush is idempotent\n- process:kill on dead process is safe\n- Cleanup source enum enables different behavior (e.g., don't kill on normal completion)\n- This is the final task in the Hook Dispatch epic","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-12T04:13:18.410812304Z","created_by":"cyou","updated_at":"2026-01-12T04:13:18.410812304Z","labels":["cleanup","gleam","invariants","tdd"],"dependencies":[{"issue_id":"casg-red.6","depends_on_id":"casg-red","type":"parent-child","created_at":"2026-01-12T04:13:18.411467963Z","created_by":"cyou"},{"issue_id":"casg-red.6","depends_on_id":"casg-red.5","type":"blocks","created_at":"2026-01-12T04:13:39.526841762Z","created_by":"cyou"}]}
{"id":"casg-red.7","title":"[Review] 2 non-blocking findings from casg-red.1","description":"## Review Findings\n\nThis issue consolidates 2 non-blocking findings from code review.\n\n**Source issue:** casg-red.1\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Fix missing module import for `dynamic.classify`\n\n**Priority:** P2\n**Reviewer:** codex\n**Location:** test/hook_dispatch_test.gleam:9-76\n\n`test/hook_dispatch_test.gleam` imports `gleam/dynamic.{type Dynamic}` (type-only), but later calls `dynamic.classify(received_input)`. That requires importing the `gleam/dynamic` module (e.g., `import gleam/dynamic as dynamic` or `import gleam/dynamic`). As written, this test should fail to compile.\n\nConcrete failure: running tests will error at the first reference to `dynamic.classify` due to `dynamic` being undefined.\n\n---\n\n### Finding 2: [P2] Consume init write before asserting hook responses in tests\n\n**Priority:** P2\n**Reviewer:** codex\n**Location:** test/hook_dispatch_test.gleam:81-183\n\nThe actor writes an init control request immediately on startup. In `hook_callback_unknown_callback_id_ignored_test` and `hook_callback_response_has_correct_structure_test`, the code reads exactly one message from `mock.writes` and assumes it is the hook `control_response`, but the first queued message is typically the init request.\n\nConcrete failure path: `process.receive(mock.writes, 500)` returns the init JSON; assertions like `string.contains(response_json, \"cli_99\")` / `\"request_id\":\"cli_2\"` will fail or flake depending on scheduling.\n\nThe earlier test does consume the init message correctly (`let assert Ok(_init_msg) = process.receive(mock.writes, 500)`); these two should do the same (or otherwise drain until the expected request_id appears).\n\n---\n\n\u003c!-- fp:464b3e9d62e0f06f --\u003e\n\u003c!-- fp:68bb71904a702e4e --\u003e\n\u003c!-- review_finding:3b5b462dc950 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T16:03:54.920762332Z","created_by":"cyou","updated_at":"2026-01-12T16:10:52.687156259Z","closed_at":"2026-01-12T16:10:52.687156259Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-red.1"],"dependencies":[{"issue_id":"casg-red.7","depends_on_id":"casg-red","type":"parent-child","created_at":"2026-01-12T16:03:54.921303436Z","created_by":"cyou"}]}
{"id":"casg-sel","title":"[Review] 1 non-blocking finding from casg-m2h","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-m2h\n**Highest priority:** P3\n\n---\n\n### Finding 1: [P3] Inconsistent dummy values in decode.failure() calls\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/internal/decoder.gleam:534\n\nAt line 515, `text_block_inner_decoder()` uses `TextBlock(\"\")` as the dummy value for `decode.failure()`, while at line 534, `tool_use_block_inner_decoder()` uses `ToolUseBlock(id: \"\", name: \"\", input: raw)` which preserves the raw dynamic value.\n\nWhile these dummy values are never exposed to users (they're only used for type inference in `decode.failure()`), the inconsistency could confuse future maintainers. For consistency and clarity, both should use the same pattern - either both use minimal dummy values (empty strings) or both preserve `raw`.\n\n**Recommendation**: Change line 534 to use a simpler dummy value like `ToolUseBlock(id: \"\", name: \"\", input: dynamic.from(Nil))` for consistency with line 515.\n\n**Note**: This is cosmetic only - it doesn't affect runtime behavior since `decode.failure()` dummy values are never observable.\n\n---\n\n\u003c!-- fp:169ed8abae10796b --\u003e\n\u003c!-- review_finding:e7012c8399ab --\u003e","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-11T05:05:27.008866369Z","created_by":"cyou","updated_at":"2026-01-11T05:08:10.231838367Z","closed_at":"2026-01-11T05:08:10.231838367Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-m2h"]}
{"id":"casg-t4k","title":"[Advisory] Round-trip encode/decode tests for ALL message types","description":"## Context\nThis issue was auto-created by epic verification for epic `casg-de0`.\n\n## Epic Description / Acceptance Criteria\nTitle: Epic: Bidirectional Protocol - Control Types \u0026 Protocol\n\n## Overview\nDefine control message types, wire format encoders/decoders, request ID tracking, and hook types. This defines the interfaces everything else uses.\n\n## Source Plan\n`plans/2026-01-12-bidir-protocol-plan.md` - \"Data Model\" and \"Control Message Wire Format\" sections\n\n## Key Deliverables\n- control.gleam: OutgoingControlRequest, IncomingMessage, IncomingControlRequest, IncomingControlResponse types\n- hook.gleam: HookEvent, context types (PreToolUseContext, etc.), HookResult, PermissionResult\n- internal/control_decoder.gleam: JSON decoders for control_request/control_response\n- internal/control_encoder.gleam: JSON encoders for outgoing messages\n- internal/request_tracker.gleam: Request ID generation, correlation\n\n## Wire Format (NDJSON)\nSDK→CLI: `{\"type\":\"control_request\",\"request_id\":\"req_N\",\"request\":{\"subtype\":\"...\"}}`\nCLI→SDK: `{\"type\":\"control_response\",\"response\":{\"subtype\":\"success|error\",\"request_id\":\"...\"}}`\n\n## TDD Focus\n- Round-trip encode/decode tests for ALL message types\n- Tolerant decoding (request_id at response.request_id OR top-level)\n- Exact enum/string values per spec\n\n## Files\n- src/claude_agent_sdk/control.gleam (New)\n- src/claude_agent_sdk/hook.gleam (New)\n- src/claude_agent_sdk/internal/control_decoder.gleam (New)\n- src/claude_agent_sdk/internal/control_encoder.gleam (New)\n- src/claude_agent_sdk/internal/request_tracker.gleam (New)\n- test/control_test.gleam (New)\n- test/hook_test.gleam (New)\n\n## Commit Scope\n- Range hint: 2b32998769badc3f4cebe3be4e96573842df7c2e^..6f764198f4b2fcd699efa45d8e017f03a967dad9\n- Commits:\n- 6f764198f4b2fcd699efa45d8e017f03a967dad9 bd-casg-de0.6: Make permission_suggestions optional per spec\n- a6c12dd3ea8222e45cf104754d42a941affdefd0 bd-casg-de0.6: Fix blocked_path decoder to avoid nested Option\n- 0e0a29b340ee2f700827bb1422191205e9e6816a bd-casg-de0.6: Distinguish WrongType from MissingField errors\n- e929fc9b822f4f368095d031d820deed51088929 bd-casg-de0.3: Fix empty list encoding ([] not {}), add tuple fallback handler, fix request_tracker_test import\n- 74c6f398200da76779c9768c3180ffc79e638305 bd-casg-de0.6: Implement hook input decoders\n- e7aea2085881e94d126ee0e09e2518db09d6442c bd-casg-de0.5: Fix request_tracker test module import\n- 6e90eeba99c7d5a57d452bb3165ff7d7389667a1 bd-casg-de0.3: Fix wire format - hooks as event-keyed object, HookSkip as blocking response, FFI booleans/null\n- 1b078a5053a6753042e327353552033b6ef65cdb bd-casg-de0.4: Add tolerant error message decoding (error/message fields)\n- e1baa7d598428fbcb3c1513573d71ace30226ece bd-casg-de0.3: Add control message encoder for OutgoingControlRequest and OutgoingControlResponse\n- 6b012ec7972d4aa3acec76010c723b6205386ca0 bd-casg-de0.4: Add control message decoder for bidirectional protocol\n- a56485a50cf294636b952cdfeac72e419984a504 bd-casg-de0.5: Add request ID tracker for bidirectional protocol\n- 498005c6923bf61d9e1eff10fcc854204f77739b bd-casg-de0.7: Rename conflicting types and add CanUseToolInput variant\n- fd5fffb464ca4f1d18cb467c10c08149c84699e5 bd-casg-de0.1: Fix HookRegistration tests and remove failing placeholder\n- 9df136488ad6ec79b372cb8dbbcd470e62cad601 bd-casg-de0.1: Add control message types for bidirectional protocol\n- 2b32998769badc3f4cebe3be4e96573842df7c2e bd-casg-de0.2: Add hook context types for bidirectional protocol\n\n## Child Issues\n- casg-3ac\n- casg-3ac.1\n- casg-3ac.2\n- casg-3ac.3\n- casg-3ac.4\n- casg-3ac.5\n- casg-3ac.6\n- casg-4jq\n- casg-4jq.1\n- casg-4jq.2\n- casg-4jq.3\n- casg-4jq.4\n- casg-4jq.5\n- casg-4jq.6\n- casg-4jq.7\n- casg-7l4\n- casg-7l4.1\n- casg-7l4.2\n- casg-7l4.3\n- casg-7l4.4\n- casg-7l4.5\n- casg-7l4.6\n- casg-7l4.7\n- casg-de0.1\n- casg-de0.2\n- casg-de0.3\n- casg-de0.4\n- casg-de0.5\n- casg-de0.6\n- casg-de0.7\n- casg-lqg\n- casg-lqg.2\n- casg-lqg.3\n- casg-lqg.4\n- casg-lqg.5\n- casg-lqg.6\n- casg-lqg.7\n- casg-red\n- casg-red.1\n- casg-red.2\n- casg-red.3\n- casg-red.4\n- casg-red.5\n- casg-red.6\n\n## Unmet Criterion\nRound-trip encode/decode tests for ALL message types\n\n## Evidence\nFound comprehensive encoder tests (control_encoder_test.gleam) and decoder tests (control_decoder_test.gleam) but no explicit round-trip tests that encode a message then decode it back to verify complete round-trip functionality. Individual components are well-tested but the integration round-trip verification is missing.\n\n## Priority\nP2 (informational)\n\n## Resolution\nThis is advisory (P2/P3) and does not block epic closure. When complete, close this issue.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T05:39:17.893848153Z","created_by":"cyou","updated_at":"2026-01-12T05:53:54.581663828Z","closed_at":"2026-01-12T05:53:54.581663828Z","close_reason":"Closed","labels":["auto_generated","epic_remediation:casg-de0:2c5fa2e0c62de480d69e73a2a0950c68102631cfcb252dc6b670f86ff94a5ecc"]}
{"id":"casg-tc3","title":"Epic 3: Testing Infrastructure","description":"## Overview\nBuild the testing infrastructure including test_runner() for unit tests, mock state management, and comprehensive stream semantics tests.\n\n## Why This is Critical\n- TDD requires test infrastructure before implementation tests\n- test_runner() enables testing without real CLI subprocess\n- Unit tests must not require claude binary (CI portability)\n\n## Scope\n1. **Test Helpers** (test/support/):\n   - env_helpers.gleam - FFI for os:getenv (no envoy dependency)\n   - ets_helpers.gleam - ETS FFI for mock state (TEST-ONLY)\n\n2. **test_runner()** (src/claude_agent_sdk/runner.gleam):\n   - Runner type with spawn/read_next/close function records\n   - test_runner() constructor for mocks\n   - ETS-based state management for stateful mocks\n\n3. **Stream Semantics Tests** (test/stream_test.gleam):\n   - Malformed JSON handling (non-terminal error)\n   - 5+ consecutive errors (terminal error)\n   - Buffer overflow (\u003e10MB line)\n   - exit_status ordering scenarios\n   - Result message semantics\n\n4. **Resource Safety Tests** (test/resource_test.gleam):\n   - with_stream cleanup on early return\n   - with_stream cleanup on panic\n   - collect_items cleanup\n   - Sequential queries don't cross-contaminate\n\n5. **JSON Decoder Tests** (test/json_decode_test.gleam):\n   - Fixture-based decode tests\n   - Unknown type handling\n   - raw_json preservation\n\n6. **CLI Args Tests** (test/cli_args_test.gleam):\n   - Option builder tests\n   - Conflicting option resolution\n   - All flag mappings\n\n## Success Criteria\n- All unit tests pass without claude binary\n- test_runner() provides full mock control\n- Stream error scenarios all tested\n- 100% coverage of error paths\n\n## Dependencies\n- Depends on Epic 0 (basic project structure)\n- Depends on Epic 1 (types to test)\n- Can start in parallel with Epic 2 (test infrastructure first)\n\n## Plan References\n- Unit Test Isolation Contract\n- test_runner() specification\n- Acceptance Criteria (Behavioral) table\n","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-01-10T23:19:44.468098163Z","created_by":"cyou","updated_at":"2026-01-11T02:53:14.45177707Z","closed_at":"2026-01-11T02:53:14.45177707Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-tc3","depends_on_id":"casg-va1","type":"blocks","created_at":"2026-01-10T23:19:52.129618638Z","created_by":"cyou"},{"issue_id":"casg-tc3","depends_on_id":"casg-k92","type":"blocks","created_at":"2026-01-10T23:19:52.182192807Z","created_by":"cyou"}]}
{"id":"casg-tc3.1","title":"Create ETS helpers skeleton for test_runner state management","description":"## Summary\nCreate `test/support/ets_helpers.gleam` with FFI bindings for ETS operations needed by test_runner().\n\n## Deliverables\n- `test/support/ets_helpers.gleam` with:\n  - `new(name: String) -\u003e Table` - FFI to ets:new/2\n  - `insert(table: Table, key: Dynamic, value: Dynamic) -\u003e Nil` - FFI to ets:insert/2\n  - `lookup(table: Table, key: Dynamic) -\u003e Option(Dynamic)` - FFI to ets:lookup/2\n  - `delete(table: Table, key: Dynamic) -\u003e Nil` - FFI to ets:delete/2\n  - `make_ref() -\u003e Dynamic` - FFI to erlang:make_ref/0\n\n## Unit Test Isolation Contract\n- ETS FFI MUST be in test/ directory only, NOT in src/\n- Ensures ETS is never used by runtime modules\n- Invariant: No src/**/*.gleam may import from test/**\n\n## Acceptance Criteria\n- [ ] ets_helpers.gleam compiles successfully\n- [ ] Basic test creates table, inserts, lookups, deletes\n- [ ] make_ref() returns unique refs on each call\n\n## Plan References\n- Lines 2319-2337: ETS FFI Requirements (TEST-ONLY)\n- Lines 2283-2317: ETS Example (Canonical)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:21:39.794793674Z","created_by":"cyou","updated_at":"2026-01-11T02:15:15.896341279Z","closed_at":"2026-01-11T02:15:15.896341279Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-tc3.1","depends_on_id":"casg-tc3","type":"parent-child","created_at":"2026-01-10T23:21:39.79551163Z","created_by":"cyou"}]}
{"id":"casg-tc3.10","title":"Add resource safety helper tests","description":"## Summary\nAdd `test/resource_test.gleam` to validate resource-safety helpers (with_stream, collect_items, collect_messages, fold_stream).\n\n## Deliverables\n- `test/resource_test.gleam` with tests for:\n  - with_stream closes port on early return\n  - with_stream closes port on panic (use gleeunit should.panic or equivalent)\n  - collect_items closes port after full consumption\n  - collect_messages closes port and filters to messages\n  - fold_stream closes port even when fold stops early\n\n## Notes\n- Tests should use test_runner() mocks (no real CLI)\n- Verify close() is invoked exactly once for each helper\n\n## Acceptance Criteria\n- [ ] All helpers guarantee cleanup in tests\n- [ ] Early return/panic scenarios still close the stream\n- [ ] No real subprocesses spawned\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:36:41.645038839Z","created_by":"cyou","updated_at":"2026-01-11T02:32:55.899800455Z","closed_at":"2026-01-11T02:32:55.899800455Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-tc3.10","depends_on_id":"casg-tc3","type":"parent-child","created_at":"2026-01-10T23:36:41.645547486Z","created_by":"cyou"},{"issue_id":"casg-tc3.10","depends_on_id":"casg-j37.11","type":"blocks","created_at":"2026-01-10T23:42:51.988779891Z","created_by":"cyou"},{"issue_id":"casg-tc3.10","depends_on_id":"casg-tc3.3","type":"blocks","created_at":"2026-01-10T23:42:57.063815587Z","created_by":"cyou"}]}
{"id":"casg-tc3.11","title":"Add empty-stdout and incomplete-line warning tests","description":"## Summary\nAdd stream tests for empty-stdout and incomplete-line warning behavior at exit_status.\n\n## Deliverables\n- Additional tests in `test/stream_test.gleam`:\n  - exit_status=0 with no data -\u003e WarningEvent(CleanExitNoResult), EndOfStream\n  - exit_status=0 with incomplete buffer -\u003e WarningEvent(IncompleteLastLine), EndOfStream\n  - exit_status!=0 with empty stdout -\u003e ProcessError with stdout_was_empty=True\n  - exit_status!=0 with incomplete buffer -\u003e ProcessError with last_non_json_line populated\n\n## Acceptance Criteria\n- [ ] All scenarios map to the correct Warning or ProcessError\n- [ ] Warnings are non-terminal and followed by EndOfStream\n- [ ] Diagnostics fields (stdout_was_empty, last_non_json_line) populated correctly\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:36:52.818092331Z","created_by":"cyou","updated_at":"2026-01-11T02:41:20.104684712Z","closed_at":"2026-01-11T02:41:20.104684712Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-tc3.11","depends_on_id":"casg-tc3","type":"parent-child","created_at":"2026-01-10T23:36:52.818696747Z","created_by":"cyou"},{"issue_id":"casg-tc3.11","depends_on_id":"casg-tc3.4","type":"blocks","created_at":"2026-01-10T23:43:02.139249778Z","created_by":"cyou"},{"issue_id":"casg-tc3.11","depends_on_id":"casg-j37.6","type":"blocks","created_at":"2026-01-10T23:43:07.214962555Z","created_by":"cyou"},{"issue_id":"casg-tc3.11","depends_on_id":"casg-j37.7","type":"blocks","created_at":"2026-01-10T23:43:12.289891744Z","created_by":"cyou"}]}
{"id":"casg-tc3.12","title":"[Review] 2 non-blocking findings from casg-tc3.3","description":"## Review Findings\n\nThis issue consolidates 2 non-blocking findings from code review.\n\n**Source issue:** casg-tc3.3\n**Highest priority:** P3\n\n---\n\n### Finding 1: [P3] Runner types not tested in API surface tests\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** test/api_surface_test.gleam:0\n\nThe `api_surface_test.gleam` verifies that Epic 1 types (Message, ContentBlock, QueryError, etc.) are exported from the main SDK module, but it does not include tests for the newly added Runner types (Runner, Handle, ReadResult) or the `test_runner` function.\n\nWhile the types compile and are properly re-exported in `src/claude_agent_sdk.gleam:51-65`, adding tests to `api_surface_test.gleam` would ensure these types remain accessible and maintain API surface consistency with other SDK types.\n\n**Suggested addition**:\n```gleam\npub fn runner_types_importable_test() {\n  // Verify Runner, Handle, ReadResult types can be imported\n  // and test_runner function is accessible\n  import claude_agent_sdk.{type Runner, type Handle, type ReadResult, test_runner}\n  // No need to construct - just verify compilation succeeds\n}\n```\n\nThis is a minor testing completeness issue and does not affect functionality.\n\n---\n\n### Finding 2: [P3] Documentation comment typo in example\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/runner.gleam:79-82\n\nIn the documentation example for `test_runner()`, line 79 has a comment that says `// Requires: import gleam/option.{Some, None}` but the actual pattern matching code on lines 80-82 doesn't use the qualified `option.Some` or `option.None` - it just uses the bare constructors `Some` and `None`.\n\nThe comment was added to address P3 from the previous review, but it doesn't quite match the code. Either:\n1. Change the code to use qualified constructors: `option.Some(state)` and `option.None`\n2. Or update the comment to be clearer: `// Requires: import gleam/option.{Some, None}` should mention this is what test code needs to import\n\nThe current code is technically correct if the test imports `Some` and `None` unqualified, but the example could be clearer about whether to use qualified or unqualified imports.\n\nThis is a very minor documentation clarity issue.\n\n---\n\n\u003c!-- fp:fc7ebd16777d0d79 --\u003e\n\u003c!-- fp:fc1364f523e23525 --\u003e\n\u003c!-- review_finding:d49b3ba40095 --\u003e","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-11T02:23:49.758611036Z","created_by":"cyou","updated_at":"2026-01-11T02:28:47.383457994Z","closed_at":"2026-01-11T02:28:47.383457994Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-tc3.3"],"dependencies":[{"issue_id":"casg-tc3.12","depends_on_id":"casg-tc3","type":"parent-child","created_at":"2026-01-11T02:23:49.759196852Z","created_by":"cyou"}]}
{"id":"casg-tc3.13","title":"[Review] 1 non-blocking finding from casg-tc3.12","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-tc3.12\n**Highest priority:** P3\n\n---\n\n### Finding 1: [P3] test_runner imported but unused from main module\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** test/api_surface_test.gleam:323-328\n\nThe test imports `test_runner` from `claude_agent_sdk` at line 17, but then uses `runner.test_runner()` at line 324 instead. This creates a compiler warning about an unused import.\n\n**Why this happens**: The test correctly uses the qualified call `runner.test_runner()` because `test_runner` has labeled arguments, but the import from the main module is redundant.\n\n**Fix**: Either:\n1. Use the imported `test_runner` directly without the `runner.` qualifier\n2. Remove `test_runner` from the line 17 import list\n\nSince the test's purpose is to verify API surface exports, option 1 is more appropriate:\n```gleam\nlet _test_runner: Runner =\n  test_runner(\n    on_spawn: fn(_cmd, _args, _cwd) { Ok(dynamic.nil()) },\n    on_read: fn(_handle) { runner.Eof },\n    on_close: fn(_handle) { Nil },\n  )\n```\n\nThis is a minor code quality issue that generates compiler warnings.\n\n---\n\n\u003c!-- fp:203662281ccbfb81 --\u003e\n\u003c!-- review_finding:48a6ce9f935a --\u003e","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-11T02:28:47.576055278Z","created_by":"cyou","updated_at":"2026-01-11T02:30:48.856327586Z","closed_at":"2026-01-11T02:30:48.856327586Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-tc3.12"],"dependencies":[{"issue_id":"casg-tc3.13","depends_on_id":"casg-tc3","type":"parent-child","created_at":"2026-01-11T02:28:47.576638466Z","created_by":"cyou"}]}
{"id":"casg-tc3.14","title":"[Review] 3 non-blocking findings from casg-tc3.10","description":"## Review Findings\n\nThis issue consolidates 3 non-blocking findings from code review.\n\n**Source issue:** casg-tc3.10\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Tests spawn real subprocesses instead of using test_runner()\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** test/resource_test.gleam:28-32\n\nThe resource_test.gleam file directly calls `port_ffi.ffi_open_port()` to spawn real `/bin/sh` and `/bin/echo` subprocesses, violating the acceptance criteria:\n\n**Requirements state:**\n- \"Tests should use test_runner() mocks (no real CLI)\"\n- \"No real subprocesses spawned\"\n\n**Current implementation:** All 16 tests in resource_test.gleam spawn actual OS processes using `port_ffi.ffi_open_port()` (lines 28, 65, 120, 134, 154, 174, 190, 203, 221, 238, 253, 274, 303, 346, 367).\n\n**Expected pattern:** Tests should use `test_runner()` with ETS state management, as demonstrated in `test/stream_test.gleam:1113-1297`. This pattern:\n1. Creates an ETS table for mock state\n2. Uses `test_runner()` with on_spawn/on_read/on_close callbacks\n3. Avoids spawning real subprocesses\n4. Provides full control over stream behavior\n\n**Impact:** Tests cannot run in CI environments without `/bin/sh`, violate the testing contract, and don't provide the level of control needed to verify edge cases reliably.\n\n---\n\n### Finding 2: [P2] Missing panic test for with_stream cleanup guarantee\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** test/resource_test.gleam:1\n\nThe deliverables explicitly require testing that `with_stream` closes the port even when the callback panics:\n\n**Requirements state:**\n- \"with_stream closes port on panic (use gleeunit should.panic or equivalent)\"\n\n**Current implementation:** No panic test exists in resource_test.gleam. Searching for \"panic\" yields no matches.\n\n**Why this matters:** The with_stream function should guarantee cleanup even in exceptional circumstances (panics/exceptions). Without this test, we cannot verify that resource leaks don't occur when user code crashes.\n\n**Expected test pattern:**\n```gleam\npub fn with_stream_closes_port_on_panic_test() {\n  // Create a stream with test_runner\n  let query_result = Ok(stream)\n  \n  // Verify that panic inside callback still closes the port\n  should.panic(fn() {\n    with_stream(query_result, fn(_s) {\n      panic as \"Simulated user panic\"\n    })\n  })\n  \n  // Verify close was called via ETS state tracking\n}\n```\n\n---\n\n### Finding 3: [P3] Tests don't verify close() is invoked exactly once\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** test/resource_test.gleam:54-55\n\nThe requirements state: \"Verify close() is invoked exactly once for each helper\"\n\n**Current implementation:** Tests check `is_closed()` state in some cases, but don't actually count how many times `close()` is called. The comment at line 54-55 even acknowledges this limitation:\n\n```gleam\n// Note: The original stream reference is stale after with_stream closes it,\n// but the port resource itself is closed. We verify behavior worked.\n```\n\n**Why exact count matters:** Calling close() multiple times on the same port could lead to:\n1. Attempting to close already-closed ports (should be idempotent, but worth verifying)\n2. Performance issues from redundant cleanup operations\n3. Subtle bugs if close() isn't properly idempotent\n\n**How to fix:** Using `test_runner()` with ETS, the tests could track close invocation count:\n```gleam\non_close: fn(state) {\n  let close_count = get_close_count(state)\n  ets_helpers.insert(table, close_count_key, close_count + 1)\n}\n```\n\nThen verify `close_count == 1` after each helper completes.\n\n---\n\n\u003c!-- fp:f3fdcdf5b594aaa9 --\u003e\n\u003c!-- fp:847f183e1ade6bbb --\u003e\n\u003c!-- fp:27d942d4ced80bf6 --\u003e\n\u003c!-- review_finding:5cc4be514ced --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T02:32:56.091756947Z","created_by":"cyou","updated_at":"2026-01-11T02:49:42.000548077Z","closed_at":"2026-01-11T02:49:42.000548077Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-tc3.10"],"dependencies":[{"issue_id":"casg-tc3.14","depends_on_id":"casg-tc3","type":"parent-child","created_at":"2026-01-11T02:32:56.092309765Z","created_by":"cyou"}]}
{"id":"casg-tc3.2","title":"Create environment helpers for integration test gating","description":"## Summary\nCreate integration-gating helpers that use `test/support/env_helpers.gleam` (shared with Phase 0) to read environment variables.\n\n## Clarification (avoid duplication)\n- `test/support/env_helpers.gleam` is created in Phase 0 (casg-va1.4).\n- This task **reuses** that helper for integration test gating.\n- If env_helpers does not exist yet, create it here **exactly as specified** in casg-va1.4 (do not fork or diverge).\n\n## Deliverables\n- `test/query_integration_test.gleam` (or relevant integration test file) includes:\n  - `integration_enabled(test_name: String) -\u003e Bool`\n  - Reads `CLAUDE_INTEGRATION_TEST` env var via env_helpers.get_env\n\n## Usage Pattern\n```gleam\n// In integration tests\nimport support/env_helpers.{get_env}\n\nfn integration_enabled(test_name: String) -\u003e Bool {\n  case get_env(\"CLAUDE_INTEGRATION_TEST\") {\n    Ok(\"1\") -\u003e True\n    _ -\u003e {\n      io.println(\"[SKIP] \" \u003c\u003e test_name \u003c\u003e \" (set CLAUDE_INTEGRATION_TEST=1 to run)\")\n      False\n    }\n  }\n}\n```\n\n## Acceptance Criteria\n- [ ] integration_enabled() returns True when CLAUDE_INTEGRATION_TEST=1\n- [ ] integration_enabled() returns False and prints skip message otherwise\n- [ ] Uses env_helpers from Phase 0 (single shared helper)\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:21:48.410502245Z","created_by":"cyou","updated_at":"2026-01-11T02:08:08.735395408Z","closed_at":"2026-01-11T02:08:08.735395408Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-tc3.2","depends_on_id":"casg-tc3","type":"parent-child","created_at":"2026-01-10T23:21:48.410989332Z","created_by":"cyou"}]}
{"id":"casg-tc3.3","title":"Implement Runner type and test_runner() with ETS state","description":"## Summary\nImplement the Runner type and test_runner() function in `src/claude_agent_sdk/runner.gleam` that enables unit testing stream semantics without OS processes.\n\n## Deliverables\n- `src/claude_agent_sdk/runner.gleam` with:\n  - `Runner` opaque type (function record with spawn, read_next, close)\n  - `ReadResult` type: `Data(BitArray) | ExitStatus(Int) | ReadError(String) | Eof`\n  - `test_runner(on_spawn, on_read, on_close) -\u003e Runner` - public API for tests\n  - Handle as internal sum type (ErlangHandle, TestHandle)\n\n## test_runner() Signature\n```gleam\npub fn test_runner(\n  on_spawn: fn(String, List(String), String) -\u003e Result(Dynamic, String),\n  on_read: fn(Dynamic) -\u003e ReadResult,\n  on_close: fn(Dynamic) -\u003e Nil,\n) -\u003e Runner\n```\n\n## ETS State Pattern\nTests use ETS with unique ref key for concurrency-safe state management:\n- on_spawn: Create ref, insert initial state into ETS\n- on_read: Lookup state by ref, update ETS, return next ReadResult\n- on_close: Delete ref from ETS\n\n## Unit Test Isolation Contract\n- Handle is NOT pub - test code cannot construct directly\n- test_runner() accepts Dynamic values, wraps in TestHandle internally\n- Tests provide mock functions with their own state types (cast to/from Dynamic)\n\n## Acceptance Criteria\n- [ ] Runner type compiles with spawn, read_next, close functions\n- [ ] test_runner() creates Runner that calls provided callbacks\n- [ ] Handle variants distinguish ErlangHandle vs TestHandle\n- [ ] ReadResult covers Data, ExitStatus, ReadError, Eof cases\n\n## Plan References\n- Lines 2240-2270: test_runner() implementation\n- Lines 2279-2317: State Evolution with ETS\n- Lines 4403: runner.gleam in file map","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:22:03.65736901Z","created_by":"cyou","updated_at":"2026-01-11T02:23:49.548359118Z","closed_at":"2026-01-11T02:23:49.548359118Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-tc3.3","depends_on_id":"casg-tc3","type":"parent-child","created_at":"2026-01-10T23:22:03.658015826Z","created_by":"cyou"},{"issue_id":"casg-tc3.3","depends_on_id":"casg-tc3.1","type":"blocks","created_at":"2026-01-10T23:23:39.863220631Z","created_by":"cyou"}]}
{"id":"casg-tc3.4","title":"Create basic stream semantics test with valid JSON","description":"## Summary\nCreate `test/stream_test.gleam` with initial test demonstrating test_runner() usage with valid NDJSON stream.\n\n## Deliverables\n- `test/stream_test.gleam` with:\n  - Basic test that spawns via test_runner()\n  - Mock yields valid JSON lines (System, Assistant, Result messages)\n  - Verify next() returns Ok(Message(...)) for each valid line\n  - Verify stream ends with Ok(EndOfStream)\n\n## Test Pattern\n```gleam\npub fn valid_json_stream_test() {\n  let table = ets.new(\"mock_state\", [set, public])\n  \n  let runner = test_runner(\n    on_spawn: fn(_, _, _) {\n      let ref = make_ref()\n      ets.insert(table, {ref, [valid_system_json, valid_result_json]})\n      Ok(dynamic.from(ref))\n    },\n    on_read: fn(state) {\n      let ref = dynamic.unsafe_coerce(state)\n      case ets.lookup(table, ref) {\n        [{_, [line, ..rest]}] -\u003e {\n          ets.insert(table, {ref, rest})\n          Data(bit_array.from_string(line))\n        }\n        _ -\u003e Eof\n      }\n    },\n    on_close: fn(state) {\n      let ref = dynamic.unsafe_coerce(state)\n      ets.delete(table, ref)\n    },\n  )\n  \n  let options = default_options()\n    |\u003e with_test_mode(True, runner)\n    |\u003e with_skip_version_check(True)\n  \n  // Verify stream behavior...\n}\n```\n\n## Acceptance Criteria\n- [ ] Test file compiles and runs with `gleam test`\n- [ ] test_runner() successfully mocks stream behavior\n- [ ] Valid JSON lines decode to correct message types\n- [ ] Stream terminates cleanly with EndOfStream\n\n## Plan References\n- Lines 219-237: Standard unit test setup pattern\n- Lines 2287-2315: ETS Example (Canonical)\n- Lines 4751: stream_test.gleam in test structure","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:22:17.760502458Z","created_by":"cyou","updated_at":"2026-01-11T02:30:40.282378519Z","closed_at":"2026-01-11T02:30:40.282378519Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-tc3.4","depends_on_id":"casg-tc3","type":"parent-child","created_at":"2026-01-10T23:22:17.761079625Z","created_by":"cyou"},{"issue_id":"casg-tc3.4","depends_on_id":"casg-tc3.3","type":"blocks","created_at":"2026-01-10T23:23:40.3506747Z","created_by":"cyou"},{"issue_id":"casg-tc3.4","depends_on_id":"casg-tc3.1","type":"blocks","created_at":"2026-01-10T23:23:40.864216511Z","created_by":"cyou"}]}
{"id":"casg-tc3.5","title":"Implement malformed JSON error tests (non-terminal and terminal)","description":"## Summary\nAdd tests to `test/stream_test.gleam` for malformed JSON handling: 1-4 consecutive errors (non-terminal) and 5+ consecutive errors (terminal TooManyDecodeErrors).\n\n## Test Scenarios\n\n### Non-Terminal (1-4 consecutive malformed lines)\n```gleam\npub fn malformed_json_non_terminal_test() {\n  // Mock yields: valid_json, \"bad json\", valid_json\n  // Expected: Ok(Message), Error(JsonDecodeError), Ok(Message)\n  // Error counter resets on success\n}\n```\n\n### Terminal (5+ consecutive malformed lines)\n```gleam\npub fn malformed_json_terminal_test() {\n  // Mock yields: 5x \"bad json line N\"\n  // Expected: Error(JsonDecodeError) x4, then Error(TooManyDecodeErrors)\n  // TooManyDecodeErrors is terminal - stream stops\n}\n```\n\n## NDJSON Policy (from plan)\n| Scenario | Classification | SDK Behavior |\n|----------|---------------|--------------|\n| 1-4 consecutive non-JSON | Tolerated | JsonDecodeError (non-terminal), continues |\n| 5+ consecutive non-JSON | Not Supported | TooManyDecodeErrors (terminal) |\n| Non-JSON mixed with valid | Tolerated | Errors for bad, processes good |\n\n## Acceptance Criteria\n- [ ] Single malformed line returns Error(JsonDecodeError), stream continues\n- [ ] 4 consecutive malformed lines return 4 JsonDecodeErrors, stream continues\n- [ ] 5 consecutive malformed lines: 4 JsonDecodeErrors then TooManyDecodeErrors\n- [ ] Error counter resets to 0 after successful parse\n- [ ] TooManyDecodeErrors is terminal (subsequent next() returns EndOfStream)\n\n## Plan References\n- Lines 2429-2436: NDJSON Policy table\n- Lines 4693-4694: Acceptance criteria for malformed JSON\n- Lines 4844: Error counter resets on success","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:22:31.73025987Z","created_by":"cyou","updated_at":"2026-01-11T02:34:52.727290428Z","closed_at":"2026-01-11T02:34:52.727290428Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-tc3.5","depends_on_id":"casg-tc3","type":"parent-child","created_at":"2026-01-10T23:22:31.731380793Z","created_by":"cyou"},{"issue_id":"casg-tc3.5","depends_on_id":"casg-tc3.4","type":"blocks","created_at":"2026-01-10T23:23:46.278936678Z","created_by":"cyou"}]}
{"id":"casg-tc3.6","title":"Implement buffer overflow test (\u003e10MB = terminal)","description":"## Summary\nAdd test to `test/stream_test.gleam` for buffer overflow handling: lines \u003e10MB trigger terminal BufferOverflow error.\n\n## Test Scenario\n```gleam\npub fn buffer_overflow_at_10mb_test() {\n  let huge_json = generate_large_message(11_000_000)  // 11MB\n  // Mock yields this oversized line\n  // Expected: Error(BufferOverflow) - terminal error\n}\n\n/// Generate a valid NDJSON message with specified content size\nfn generate_large_message(size_bytes: Int) -\u003e String {\n  let padding = string.repeat(\"A\", size_bytes - 100)  // Account for JSON structure\n  json.object([\n    #(\"type\", json.string(\"assistant\")),\n    #(\"message\", json.object([\n      #(\"content\", json.array([\n        json.object([\n          #(\"type\", json.string(\"text\")),\n          #(\"text\", json.string(padding))\n        ])\n      ]))\n    ]))\n  ])\n  |\u003e json.to_string\n}\n```\n\n## Also test valid large message (1MB) works\n```gleam\npub fn buffer_handles_1mb_message_test() {\n  let large_json = generate_large_message(1_000_000)\n  // Should decode successfully - not near limit\n}\n```\n\n## Key Points\n- Large payloads generated at runtime, NOT stored as fixtures\n- 10MB limit from internal/constants.gleam\n- BufferOverflow is terminal - stream stops after this error\n\n## Acceptance Criteria\n- [ ] 1MB message decodes successfully\n- [ ] 10MB message triggers BufferOverflow (terminal)\n- [ ] 15MB message triggers BufferOverflow (terminal)\n- [ ] BufferOverflow is terminal (subsequent next() returns EndOfStream)\n- [ ] No large fixtures stored in repo (generated at runtime)\n\n## Plan References\n- Lines 4695: Acceptance criteria for buffer overflow\n- Lines 4765-4799: Large payload testing (generated at runtime)\n- Lines 4813: 10MB buffer limit decision","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:22:46.245788538Z","created_by":"cyou","updated_at":"2026-01-11T02:39:17.409337876Z","closed_at":"2026-01-11T02:39:17.409337876Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-tc3.6","depends_on_id":"casg-tc3","type":"parent-child","created_at":"2026-01-10T23:22:46.246428324Z","created_by":"cyou"},{"issue_id":"casg-tc3.6","depends_on_id":"casg-tc3.4","type":"blocks","created_at":"2026-01-10T23:23:50.857984292Z","created_by":"cyou"}]}
{"id":"casg-tc3.7","title":"Implement exit status ordering tests","description":"## Summary\nAdd tests to `test/stream_test.gleam` for exit status ordering relative to Result message.\n\n## Test Scenarios\n\n### exit_status BEFORE Result (abnormal)\n```gleam\npub fn exit_status_before_result_test() {\n  // Mock yields: System message, ExitStatus(1) - no Result\n  // Expected: Error(ProcessError) with diagnostic\n}\n```\n\n### Result THEN exit_status=0 (normal completion)\n```gleam\npub fn result_then_exit_zero_test() {\n  // Mock yields: System, Assistant, Result, ExitStatus(0)\n  // Expected: Ok(Message(System)), Ok(Message(Assistant)), \n  //           Ok(Message(Result)), Ok(EndOfStream)\n  // exit_status=0 after Result is ignored silently\n}\n```\n\n### Result THEN exit_status!=0 (warning case)\n```gleam\npub fn result_then_nonzero_exit_test() {\n  // Mock yields: Result, ExitStatus(1)\n  // Expected: Ok(Message(Result)), \n  //           Ok(WarningEvent(NonZeroExitAfterResult(1))),\n  //           Ok(EndOfStream)\n}\n```\n\n### exit_status=0 BEFORE Result (clean but unexpected)\n```gleam\npub fn clean_exit_no_result_test() {\n  // Mock yields: System, ExitStatus(0) - no Result\n  // Expected: Ok(Message(System)),\n  //           Ok(WarningEvent(CleanExitNoResult)),\n  //           Ok(EndOfStream)\n}\n```\n\n## Key Points\n- Result message is authoritative (once seen, exit_status matters less)\n- Non-zero exit after Result = Warning, not Error\n- Exit before Result = ProcessError (actionable diagnostic)\n\n## Acceptance Criteria\n- [ ] exit_status before Result → Error(ProcessError) with diagnostic\n- [ ] Result then exit_status=0 → normal EndOfStream\n- [ ] Result then exit_status!=0 → WarningEvent then EndOfStream\n- [ ] exit_status=0 before Result → WarningEvent(CleanExitNoResult)\n\n## Plan References\n- Lines 4697-4700: Acceptance criteria for exit status scenarios\n- Lines 4825: Result message authoritative decision","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:23:00.501330623Z","created_by":"cyou","updated_at":"2026-01-11T02:35:28.299735207Z","closed_at":"2026-01-11T02:35:28.299735207Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-tc3.7","depends_on_id":"casg-tc3","type":"parent-child","created_at":"2026-01-10T23:23:00.502359437Z","created_by":"cyou"},{"issue_id":"casg-tc3.7","depends_on_id":"casg-tc3.4","type":"blocks","created_at":"2026-01-10T23:23:47.317734923Z","created_by":"cyou"}]}
{"id":"casg-tc3.8","title":"Create CLI argument building tests","description":"## Summary\nCreate `test/cli_args_test.gleam` with tests for CLI argument building from QueryOptions.\n\n## Deliverables\n- `test/cli_args_test.gleam` testing build_cli_args() pure function\n\n## Test Scenarios\n\n### Required flags always present\n```gleam\npub fn required_flags_test() {\n  // All queries MUST include: --output-format stream-json --verbose --print\n}\n```\n\n### Optional model flag\n```gleam\npub fn model_flag_test() {\n  // with_model(\"sonnet\") → args include \"--model sonnet\"\n}\n```\n\n### Precedence rules for conflicting options\n```gleam\npub fn system_prompt_precedence_test() {\n  // system_prompt AND append_system_prompt set → only --system-prompt emitted\n}\n\npub fn allowed_disallowed_tools_precedence_test() {\n  // allowed_tools AND disallowed_tools set → only --allowed-tools emitted\n}\n\npub fn session_precedence_test() {\n  // resume_session_id AND continue_session=True → only --resume emitted\n}\n```\n\n### MCP flags\n```gleam\npub fn mcp_config_flag_test() {\n  // with_mcp_config(\"/path/mcp.json\") → args include \"--mcp-config /path/mcp.json\"\n}\n```\n\n## Key Points\n- Pure function tests - no I/O, no FFI\n- Tests option builder behavior without subprocess\n- Validates precedence rules from plan\n\n## Acceptance Criteria\n- [ ] Required flags (--output-format, --verbose, --print) always included\n- [ ] --model flag included when model set\n- [ ] system_prompt takes precedence over append_system_prompt\n- [ ] allowed_tools takes precedence over disallowed_tools\n- [ ] resume_session_id takes precedence over continue_session\n- [ ] MCP config path correctly formatted\n\n## Plan References\n- Lines 4665-4669: CLI argument acceptance criteria\n- Lines 4836: Consolidated precedence rules decision\n- Lines 4750: cli_args_test.gleam in test structure","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:23:14.854219223Z","created_by":"cyou","updated_at":"2026-01-11T02:06:10.309498875Z","closed_at":"2026-01-11T02:06:10.309498875Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-tc3.8","depends_on_id":"casg-tc3","type":"parent-child","created_at":"2026-01-10T23:23:14.854907599Z","created_by":"cyou"}]}
{"id":"casg-tc3.9","title":"Create message type invariant tests","description":"## Summary\nCreate `test/message_test.gleam` with tests for message type construction and invariants.\n\n## Deliverables\n- `test/message_test.gleam` testing message type behavior\n\n## Test Scenarios\n\n### StreamItem type coverage\n```gleam\npub fn stream_item_variants_test() {\n  // Verify all StreamItem variants exist and are constructable:\n  // - Message(msg)\n  // - WarningEvent(warning)\n  // - EndOfStream\n}\n```\n\n### Message type variants\n```gleam\npub fn message_variants_test() {\n  // Verify all Message variants:\n  // - System(system_data)\n  // - Assistant(assistant_data)\n  // - Result(result_data)\n  // - User(user_data)\n}\n```\n\n### ContentBlock type coverage\n```gleam\npub fn content_block_variants_test() {\n  // Verify ContentBlock variants:\n  // - TextBlock(text)\n  // - ToolUseBlock(id, name, input)\n  // - ToolResultBlock(tool_use_id, content, is_error)\n  // - ThinkingBlock(thinking)\n  // - UnknownBlock(raw_json)  // Forward compatibility\n}\n```\n\n### Warning type coverage\n```gleam\npub fn warning_variants_test() {\n  // Verify Warning/WarningCode variants:\n  // - NonZeroExitAfterResult(exit_code)\n  // - CleanExitNoResult\n  // - UnexpectedMessageAfterResult\n  // - UnparseableCliVersion(raw_string)\n  // - IncompleteLastLine\n}\n```\n\n### Error type terminal classification\n```gleam\npub fn error_terminal_classification_test() {\n  // Verify is_terminal() for each error type:\n  // Terminal: TooManyDecodeErrors, BufferOverflow, ProcessError (abnormal)\n  // Non-terminal: JsonDecodeError, UnexpectedMessageError\n}\n```\n\n## Key Points\n- Type-level tests - constructability and pattern matching\n- No I/O or subprocess spawning\n- Forward compatibility: UnknownBlock for new content types\n\n## Acceptance Criteria\n- [ ] All StreamItem variants constructable and matchable\n- [ ] All Message variants constructable with correct fields\n- [ ] All ContentBlock variants including UnknownBlock\n- [ ] All Warning variants constructable\n- [ ] is_terminal() correctly classifies all error types\n- [ ] UnexpectedMessageError preserves raw_json for forward compat\n\n## Plan References\n- Lines 4662-4664: Message decoding acceptance criteria\n- Lines 4692-4701: Stream behavior acceptance criteria\n- Lines 4747: message_test.gleam in test structure\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:23:30.233811017Z","created_by":"cyou","updated_at":"2026-01-11T02:10:24.31851125Z","closed_at":"2026-01-11T02:10:24.31851125Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-tc3.9","depends_on_id":"casg-tc3","type":"parent-child","created_at":"2026-01-10T23:23:30.23509584Z","created_by":"cyou"}]}
{"id":"casg-va1","title":"Epic 0: Phase 0 - FFI \u0026 Port Validation","description":"## Overview\nThis is the **gating epic** - all other work depends on this completing successfully. Phase 0 validates that the Erlang FFI port operations work correctly before any other SDK implementation begins.\n\n## Why This is Critical\nThe plan states: \"This validation is a blocking prerequisite - no further implementation proceeds until port options are confirmed working.\"\n\nKey gating invariants:\n- Port config failure = nothing works\n- v1 uses port_ffi directly (not Runner) for production\n- Port lifecycle: drain-then-close\n\n## Scope\n1. Project setup with pinned dependencies in gleam.toml\n2. Erlang FFI module (claude_agent_sdk_ffi.erl) with:\n   - open_port/3 - spawn subprocess with required options\n   - receive_port_msg_blocking/1 - blocking read\n   - receive_port_msg_timeout/2 - timed read with timeout\n   - close_port/1 - close port with mailbox drain\n3. Gleam port bindings (port_ffi.gleam) with:\n   - Opaque Port type\n   - PortMessage type (Data, ExitStatus, Eof, Timeout)\n   - ffi_open_port, receive_blocking, receive_timeout, ffi_close_port\n4. Phase 0 validation tests (compile + runtime)\n\n## Success Criteria\n- `gleam build` compiles successfully\n- Phase 0 compile tests pass (typecheck FFI bindings)\n- Phase 0 runtime tests pass (spawn echo, receive data, receive exit_status)\n\n## Plan References\n- Authoritative FFI Interface section\n- Phase 0 Two-Suite Structure\n- Port Lifecycle Contract","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-01-10T23:18:56.381509513Z","created_by":"cyou","updated_at":"2026-01-11T00:19:09.945230106Z","closed_at":"2026-01-11T00:19:09.945230106Z","close_reason":"Closed"}
{"id":"casg-va1.1","title":"Project setup with gleam.toml and failing Phase 0 compile test skeleton","description":"## Goal\nEstablish the Gleam project structure with pinned dependencies and create failing compile tests that will verify FFI bindings exist.\n\n## Context\nThis is the foundation task for Phase 0 - FFI \u0026 Port Validation. All other Phase 0 work depends on this project structure being in place.\n\nPlan reference: Phase 0 Dependency Version Policy, Naming \u0026 Namespace section\n\n## TDD Steps\n1. Create gleam.toml with exact pinned dependencies (tests will fail because FFI modules don't exist yet)\n2. Create skeleton src/claude_agent_sdk.gleam (main module placeholder)\n3. Create src/claude_agent_sdk/internal/.gitkeep for internal module directory\n4. Create test/phase0_compile_check_test.gleam with imports that will fail to compile until FFI is implemented\n5. Verify `gleam build` fails with expected missing module errors\n\n## Files\n- gleam.toml - [New] - Project config with pinned dependencies:\n  - gleam_stdlib = \"= 0.44.0\"\n  - gleam_erlang = \"= 1.3.0\"\n  - gleam_json = \"= 2.0.0\"\n  - gleeunit = \"= 1.2.0\" (dev)\n- src/claude_agent_sdk.gleam - [New] - Main module placeholder\n- src/claude_agent_sdk/internal/.gitkeep - [New] - Directory structure\n- test/phase0_compile_check_test.gleam - [New] - Compile test skeleton (will fail initially)\n\n## Acceptance Criteria\n- gleam.toml exists with exact version pins (= syntax, not ^)\n- `gleam deps download` succeeds\n- `gleam build` fails with expected errors (FFI module not found)\n- Directory structure matches plan Naming \u0026 Namespace section\n- Package name is claude_agent_sdk\n\n## Verification\n- gleam deps download succeeds\n- gleam build fails with predictable FFI import error (expected at this stage)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:21:48.372868729Z","created_by":"cyou","updated_at":"2026-01-10T23:47:49.493254355Z","closed_at":"2026-01-10T23:47:49.493254355Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-va1.1","depends_on_id":"casg-va1","type":"parent-child","created_at":"2026-01-10T23:21:48.373466826Z","created_by":"cyou"}]}
{"id":"casg-va1.10","title":"[Review] 3 non-blocking findings from casg-va1.6","description":"## Review Findings\n\nThis issue consolidates 3 non-blocking findings from code review.\n\n**Source issue:** casg-va1.6\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Port not closed on test failure (resource leak)\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** test/phase0_runtime_test.gleam:61-100\n\nIn `run_spawn_test()` (lines 61-100) and `run_timed_receive_test()` (lines 111-144), if any assertion fails or panic occurs, the port is not closed because `ffi_close_port(port)` is at the end of the function and won't be reached after a panic.\n\n**Impact**: Resource leak when tests fail. Ports remain open until process termination.\n\n**Fix**: Wrap test logic in a function that returns Result, use a defer-like pattern, or ensure ports are closed in all branches. Example:\n```gleam\nlet port = port_ffi.ffi_open_port(executable, args, \"\")\nlet result = test_operations(port)\nport_ffi.ffi_close_port(port)\ncase result {\n  Ok(_) -\u003e Nil\n  Error(msg) -\u003e panic as msg\n}\n```\n\n---\n\n### Finding 2: [P2] Incorrect FFI binding for bitarray_to_string\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** test/phase0_runtime_test.gleam:175-176\n\nLine 176 declares `bitarray_to_string` as calling `erlang:binary_to_list`, but this function converts a binary to a charlist (List(Int)), not to a String. The type signature claims it returns `String`, which is incorrect.\n\n**Impact**: When `int_to_string()` is called (currently only in error paths), it will fail at runtime with a type error because `binary_to_list` returns a charlist, not a string.\n\n**Fix**: Since Gleam Strings are UTF-8 binaries at runtime, BitArray and String are already compatible. Remove this function and directly cast, or use an identity function:\n```gleam\nfn bitarray_to_string(bin: BitArray) -\u003e String {\n  // In Erlang, binaries and strings are the same at runtime\n  // This is just a type-level conversion\n  case bit_array.to_string(bin) {\n    Ok(s) -\u003e s\n    Error(_) -\u003e panic as \"Invalid UTF-8\"\n  }\n}\n```\n\nAlternatively, since `list_to_binary` already returns a BitArray that is a valid String representation, you can skip the conversion entirely.\n\n---\n\n### Finding 3: [P3] Inefficient drain on already-closed ports\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk_ffi.erl:52-59\n\nIn `close_port/1` (lines 52-59), the function calls `drain_port_messages(Port, 100)` before attempting to close the port. If the port is already closed, the drain will still execute up to 100 iterations with 50ms timeouts (potentially 5 seconds of wasted time), even though no messages will arrive.\n\n**Impact**: Performance degradation when closing already-closed ports. Each failed drain iteration waits 50ms unnecessarily.\n\n**Fix**: Move the drain inside the try block, or check if port is valid before draining:\n```erlang\nclose_port(Port) -\u003e\n    try\n        drain_port_messages(Port, 100),\n        erlang:port_close(Port)\n    catch\n        error:badarg -\u003e ok  % Port already closed\n    end,\n    ok.\n```\n\nAlternatively, add a port validity check before draining, though this adds complexity.\n\n---\n\n\u003c!-- fp:0045e49b4c17338b --\u003e\n\u003c!-- fp:efc643c219dc49a2 --\u003e\n\u003c!-- fp:c545b82083b9dd7b --\u003e\n\u003c!-- review_finding:1df4e5b33fbc --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T00:10:28.467495857Z","created_by":"cyou","updated_at":"2026-01-11T00:15:23.968300166Z","closed_at":"2026-01-11T00:15:23.968300166Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-va1.6"],"dependencies":[{"issue_id":"casg-va1.10","depends_on_id":"casg-va1","type":"parent-child","created_at":"2026-01-11T00:10:28.468125913Z","created_by":"cyou"}]}
{"id":"casg-va1.11","title":"[Review] 3 non-blocking findings from casg-va1.7","description":"## Review Findings\n\nThis issue consolidates 3 non-blocking findings from code review.\n\n**Source issue:** casg-va1.7\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] confirmed_imports.gleam has no actual usage in codebase\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/internal/confirmed_imports.gleam:1-66\n\nThe file `src/claude_agent_sdk/internal/confirmed_imports.gleam` was created as a \"reference\" for other modules to import from (per task description: \"All modules should import from here to ensure consistency\"), but:\n\n1. No modules actually import from it (grep shows no imports except in docs)\n2. The `verify_imports()` function at lines 54-65 exists only to suppress unused import warnings\n3. The version info functions (lines 41-51) are exported but never called\n\nThis creates maintenance burden without providing value. The module doesn't enforce consistency - it just documents what was verified.\n\n**Impact**: Dead code that will become stale over time as dependencies are updated.\n\n**Recommendation**: Either:\n- Have actual modules import from this file to enforce consistency (as intended)\n- Or remove the file and keep only the phase0-confirmation.md documentation\n\n---\n\n### Finding 2: [P3] Missing imports documented in issue specification\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/internal/confirmed_imports.gleam:1-40\n\nThe issue specification (casg-va1.7) specified importing `gleam/regex` (\"from_string, scan\") at line in the template, but the actual implementation in `confirmed_imports.gleam` does not include this import.\n\nOriginal spec imports:\n```gleam\nimport gleam/regex      // from_string, scan\n```\n\nActual implementation: No regex import present.\n\nWhile this may be intentional (regex not actually needed), it creates a discrepancy between the documented requirements and implementation. The issue acceptance criteria states \"confirmed_imports.gleam lists all verified stdlib imports\" but regex is missing.\n\n**Impact**: Minor - documentation/spec mismatch. If regex is actually needed later, this will need to be updated.\n\n**Recommendation**: Either add regex imports or update the issue spec to reflect that regex is not required.\n\n---\n\n### Finding 3: [P3] Issue status shows 'open' despite commit completion\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** .beads/issues.jsonl:0\n\nIn the `.beads/issues.jsonl` diff, issue `casg-va1.7` has status `\"status\":\"in_progress\"` at line after the commit, but the commit message and artifacts indicate the task is complete:\n\n- Commit message: \"Create Phase 0 confirmation artifact and confirmed imports\" (done)\n- phase0-confirmation.md line 49: \"Phase 0: COMPLETE\"\n- All acceptance criteria appear met\n\nThe issue should have `\"status\":\"closed\"` to match the completion state.\n\n**Impact**: Tracking inconsistency - completed work appears incomplete in issue tracker.\n\n**Recommendation**: Update issue status to `\"closed\"` with appropriate `closed_at` timestamp and `close_reason`.\n\n---\n\n\u003c!-- fp:5a1db9a3545b17b3 --\u003e\n\u003c!-- fp:494f38c2511c8342 --\u003e\n\u003c!-- fp:3cae267e3925f116 --\u003e\n\u003c!-- review_finding:94de111a078d --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T00:14:51.083281647Z","created_by":"cyou","updated_at":"2026-01-11T00:17:04.283235511Z","closed_at":"2026-01-11T00:17:04.283235511Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-va1.7"],"dependencies":[{"issue_id":"casg-va1.11","depends_on_id":"casg-va1","type":"parent-child","created_at":"2026-01-11T00:14:51.083804253Z","created_by":"cyou"}]}
{"id":"casg-va1.12","title":"[Review] 1 non-blocking finding from casg-va1.11","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-va1.11\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Stale reference to deleted file in phase0-confirmation.md\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** plans/phase0-confirmation.md:42\n\nThe commit successfully deleted `src/claude_agent_sdk/internal/confirmed_imports.gleam` as intended (addressing Finding 1), but failed to update the documentation artifact `plans/phase0-confirmation.md` which still references this file.\n\n**Location**: `plans/phase0-confirmation.md:42` lists the deleted file in the Artifacts table:\n```markdown\n| `src/claude_agent_sdk/internal/confirmed_imports.gleam` | Re-exports verified imports for consistency |\n```\n\n**Impact**: Documentation is now inconsistent with the codebase. Users following the Phase 0 confirmation artifact will expect a file that doesn't exist.\n\n**Fix**: Remove line 42 from the Artifacts table in `phase0-confirmation.md`, or update the documentation to reflect that import verification is documented only in the markdown file itself, not in a separate `.gleam` file.\n\n---\n\n\u003c!-- fp:e9dfeeda81716162 --\u003e\n\u003c!-- review_finding:506d354949b3 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T00:19:10.044799985Z","created_by":"cyou","updated_at":"2026-01-11T00:20:27.586891017Z","closed_at":"2026-01-11T00:20:27.586891017Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-va1.11"],"dependencies":[{"issue_id":"casg-va1.12","depends_on_id":"casg-va1","type":"parent-child","created_at":"2026-01-11T00:19:10.045387671Z","created_by":"cyou"}]}
{"id":"casg-va1.2","title":"Implement Erlang FFI module (claude_agent_sdk_ffi.erl)","description":"## Goal\nCreate the Erlang FFI module that provides low-level port operations. This is the core FFI layer that all port communication flows through.\n\n## Context\nPlan reference: Authoritative FFI Interface (Single Source of Truth)\n\nThe SDK uses FFI-only for port operations because gleam_erlang/port does NOT expose required options (spawn_executable, use_stdio).\n\n## TDD Steps\n1. Create src/claude_agent_sdk_ffi.erl with all exported functions\n2. Verify Erlang module compiles with `gleam build`\n3. Module name MUST match filename exactly (case-sensitive)\n\n## Files\n- src/claude_agent_sdk_ffi.erl - [New] - Erlang FFI module with:\n  - -module(claude_agent_sdk_ffi).\n  - -export([open_port/3, receive_port_msg_blocking/1, receive_port_msg_timeout/2, close_port/1]).\n  - open_port/3: Spawns port with spawn_executable, args, cd, stream, binary, exit_status, use_stdio\n  - receive_port_msg_blocking/1: Blocking receive, returns {\"data\", Bytes} | {\"exit_status\", Code} | {\"eof\", nil}\n  - receive_port_msg_timeout/2: Timed receive, adds {\"timeout\", nil} case\n  - close_port/1: port_close + bounded mailbox drain (max 100 msgs, 50ms timeout)\n\n## Implementation Details\nPort options (all required):\n| Option | Purpose |\n|--------|---------|\n| spawn_executable | Spawn by executable path |\n| stream | Raw byte stream mode |\n| binary | Binary data (not list) |\n| exit_status | Receive exit code |\n| use_stdio | Connect stdin/stdout |\n\nFFI returns STRING tags (not atoms) for simpler Gleam decoding:\n- {\"data\", Bytes}\n- {\"exit_status\", Code}\n- {\"eof\", nil}\n- {\"timeout\", nil}\n\n## Acceptance Criteria\n- Module name matches filename: claude_agent_sdk_ffi\n- All 4 functions exported: open_port/3, receive_port_msg_blocking/1, receive_port_msg_timeout/2, close_port/1\n- No Erlang syntax errors\n- Bounded drain in close_port prevents infinite loops (max 100 iterations, 50ms timeout per message)\n\n## Verification\n- gleam build compiles .erl to .beam without errors\n- No Erlang compilation warnings","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:22:05.89054076Z","created_by":"cyou","updated_at":"2026-01-10T23:58:58.387874397Z","closed_at":"2026-01-10T23:58:58.387874397Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-va1.2","depends_on_id":"casg-va1","type":"parent-child","created_at":"2026-01-10T23:22:05.891334326Z","created_by":"cyou"},{"issue_id":"casg-va1.2","depends_on_id":"casg-va1.1","type":"blocks","created_at":"2026-01-10T23:23:40.171487532Z","created_by":"cyou"}]}
{"id":"casg-va1.3","title":"Implement Gleam port_ffi bindings","description":"## Goal\nCreate Gleam bindings that wrap the Erlang FFI module with type-safe APIs.\n\n## Context\nPlan reference: Authoritative FFI Interface - Gleam bindings section\n\nThese bindings provide the Gleam-side interface to the Erlang FFI functions. Uses opaque Port type for type safety.\n\n## TDD Steps\n1. Create src/claude_agent_sdk/internal/port_ffi.gleam\n2. Implement opaque Port type wrapping Dynamic\n3. Implement @external bindings to Erlang FFI\n4. Implement decode_port_message for uniform 2-tuple decoding\n5. Verify `gleam build` succeeds\n\n## Files\n- src/claude_agent_sdk/internal/port_ffi.gleam - [New] - Gleam FFI bindings with:\n  - opaque type Port { Port(inner: Dynamic) }\n  - type PortMessage { Data(BitArray) | ExitStatus(Int) | Eof | Timeout }\n  - ffi_open_port(path, args, cwd) -\u003e Port\n  - receive_blocking(port) -\u003e Result(PortMessage, String)\n  - receive_timeout(port, timeout_ms) -\u003e Result(PortMessage, String)\n  - ffi_close_port(port) -\u003e Nil\n  - decode_port_message(raw) - internal decoder for 2-tuple FFI responses\n\n## Implementation Details\nFFI contract (2-tuples ONLY):\n- {\"data\", Bytes} -\u003e Data(BitArray)\n- {\"exit_status\", Code} -\u003e ExitStatus(Int)\n- {\"eof\", nil} -\u003e Eof\n- {\"timeout\", nil} -\u003e Timeout\n\nDecoder uses dynamic.tuple2(dynamic.string, dynamic.any) for uniform parsing.\n\n## Acceptance Criteria\n- Port type is opaque (internal Dynamic hidden from users)\n- All 4 FFI functions have Gleam wrappers\n- decode_port_message handles all 4 message types\n- Errors return Result with descriptive String messages\n- No public export of raw FFI functions (only wrapped versions)\n\n## Verification\n- gleam build succeeds\n- gleam check passes type checking\n- Imports from claude_agent_sdk/internal/port_ffi work in tests","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:22:20.482219092Z","created_by":"cyou","updated_at":"2026-01-11T00:01:59.463715412Z","closed_at":"2026-01-11T00:01:59.463715412Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-va1.3","depends_on_id":"casg-va1","type":"parent-child","created_at":"2026-01-10T23:22:20.483490215Z","created_by":"cyou"},{"issue_id":"casg-va1.3","depends_on_id":"casg-va1.2","type":"blocks","created_at":"2026-01-10T23:23:40.667719512Z","created_by":"cyou"}]}
{"id":"casg-va1.4","title":"Implement test env_helpers.gleam for environment variable access","description":"## Goal\nCreate a minimal FFI helper for environment variable access in tests, avoiding the need for an envoy dependency.\n\n## Context\nPlan reference: Testing Constraints - No envoy dependency\n\nThe plan explicitly states: \"Environment variable access in tests uses a tiny FFI helper instead of adding envoy as a dependency. This reduces supply chain surface for minimal benefit.\"\n\n## TDD Steps\n1. Create test/support/ directory\n2. Create test/support/env_helpers.gleam with os:getenv FFI\n3. Verify import works in test files\n\n## Files\n- test/support/env_helpers.gleam - [New] - FFI helper with:\n  - @external(erlang, \"os\", \"getenv\") fn ffi_getenv(name: String) -\u003e Dynamic\n  - pub fn get_env(name: String) -\u003e Result(String, Nil)\n    - Returns Ok(value) if set and non-empty\n    - Returns Error(Nil) if not set or empty\n\n## Implementation Details\n```gleam\nimport gleam/dynamic.{type Dynamic}\n\n@external(erlang, \"os\", \"getenv\")\nfn ffi_getenv(name: String) -\u003e Dynamic\n\npub fn get_env(name: String) -\u003e Result(String, Nil) {\n  case dynamic.string(ffi_getenv(name)) {\n    Ok(value) if value != \"\" -\u003e Ok(value)\n    _ -\u003e Error(Nil)  // Not set or empty\n  }\n}\n```\n\n## Acceptance Criteria\n- No envoy dependency in gleam.toml\n- get_env returns Result(String, Nil)\n- Empty string treated same as not set (Error(Nil))\n- Used by Phase 0 runtime tests for PHASE0_RUNTIME check\n\n## Verification\n- gleam build succeeds\n- Import from test/support/env_helpers works in test files","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:22:35.368982412Z","created_by":"cyou","updated_at":"2026-01-10T23:50:19.18308996Z","closed_at":"2026-01-10T23:50:19.18308996Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-va1.4","depends_on_id":"casg-va1","type":"parent-child","created_at":"2026-01-10T23:22:35.370301004Z","created_by":"cyou"},{"issue_id":"casg-va1.4","depends_on_id":"casg-va1.1","type":"blocks","created_at":"2026-01-10T23:23:41.162677329Z","created_by":"cyou"}]}
{"id":"casg-va1.5","title":"Implement Phase 0 compile-check tests (Suite A)","description":"## Goal\nCreate compile-check tests that verify all required APIs exist at the pinned dependency versions. These are ALWAYS REQUIRED tests that run in all environments.\n\n## Context\nPlan reference: Phase 0 Two-Suite Structure - Suite A: Compile Checks\n\nSuite A validates: gleam build succeeds, FFI bindings exist and typecheck. No subprocess spawning.\n\n## TDD Steps\n1. Create test/phase0_compile_check_test.gleam\n2. Add tests that verify API existence by referencing functions (compile-time check)\n3. Add tests that verify FFI bindings typecheck correctly\n4. Run `gleam test test/phase0_compile_check_test.gleam` to verify\n\n## Files\n- test/phase0_compile_check_test.gleam - [New] - Compile-time verification tests:\n  - api_exists_compile_check_test() - verifies stdlib APIs exist:\n    - bit_array.from_string, bit_array.byte_size, bit_array.to_string\n    - dynamic.tuple2, dynamic.string, dynamic.int, dynamic.bit_array\n    - regex.from_string, regex.scan\n  - ffi_bindings_typecheck_test() - verifies port_ffi module loads:\n    - Import port_ffi\n    - Reference function types (compile-time check)\n  - api_confirmation_test() - runtime verification of stdlib behaviors:\n    - bit_array functions work correctly\n    - dynamic decoding works for tagged tuples\n    - regex works for version parsing pattern\n\n## Implementation Details\nFrom plan:\n```gleam\n/// This test verifies that required APIs exist by attempting to use them.\n/// If compilation succeeds, the APIs exist in the pinned dependency versions.\n/// No runtime behavior tested - just existence.\npub fn api_exists_compile_check_test() {\n  // These calls will fail compilation if APIs don't exist\n  let _ = bit_array.from_string\n  let _ = bit_array.byte_size\n  // ...etc\n  Nil\n}\n```\n\n## Acceptance Criteria\n- Suite A tests pass in ALL environments (compile-only, no subprocess spawning)\n- Verifies gleam_stdlib APIs at pinned version 0.44.0\n- Verifies port_ffi bindings compile and typecheck\n- Tests run successfully with `gleam test`\n\n## Verification\n- gleam build succeeds\n- gleam test test/phase0_compile_check_test.gleam passes\n- No runtime subprocess spawning in these tests","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:22:52.19501534Z","created_by":"cyou","updated_at":"2026-01-11T00:06:25.131578357Z","closed_at":"2026-01-11T00:06:25.131578357Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-va1.5","depends_on_id":"casg-va1","type":"parent-child","created_at":"2026-01-10T23:22:52.196028414Z","created_by":"cyou"},{"issue_id":"casg-va1.5","depends_on_id":"casg-va1.3","type":"blocks","created_at":"2026-01-10T23:23:41.654756962Z","created_by":"cyou"}]}
{"id":"casg-va1.6","title":"Implement Phase 0 runtime port validation tests (Suite B)","description":"## Goal\nCreate runtime tests that validate the actual port spawn/read/close operations work correctly. These tests are OPT-IN via PHASE0_RUNTIME=1 environment variable.\n\n## Context\nPlan reference: Phase 0 Two-Suite Structure - Suite B: Runtime Spawn Checks\n\nSuite B validates: port_ffi spawn/read/close works with real subprocess. Opt-in only to avoid failures in restricted environments.\n\n## TDD Steps\n1. Create test/phase0_runtime_test.gleam\n2. Implement PHASE0_RUNTIME check using env_helpers.get_env\n3. Implement phase0_test_command() for cross-platform test (Unix: /bin/echo, Windows: cmd.exe)\n4. Implement port spawn/read/exit_status/close validation\n5. Implement timed receive validation\n6. Run with `PHASE0_RUNTIME=1 gleam test test/phase0_runtime_test.gleam`\n\n## Files\n- test/phase0_runtime_test.gleam - [New] - Runtime validation tests:\n  - phase0_runtime_spawn_test() - validates spawn -\u003e read -\u003e exit_status -\u003e close flow\n  - phase0_timed_receive_test() - validates receive_timeout behavior\n  - Helper: record_phase0_skip(test_name, reason) - prints [SKIP:PHASE0] to stdout\n  - Helper: phase0_test_command() - returns platform-specific echo command\n  - Helper: decode_os_family(raw) - decodes os:type/0 result\n\n## Implementation Details\nCross-platform test commands:\n| Platform | Executable | Args | Expected Output |\n|----------|-----------|------|-----------------|\n| Linux/macOS | /bin/echo | [\"test\"] | test\\n (5 bytes) |\n| Windows | cmd.exe | [\"/c\", \"echo test\"] | test\\r\\n (6 bytes) |\n\nSkip mechanism (stdout-only, no file writes):\n```gleam\nfn record_phase0_skip(test_name: String, reason: String) -\u003e Nil {\n  let line = \"[SKIP:PHASE0] \" \u003c\u003e test_name \u003c\u003e \": \" \u003c\u003e reason\n  io.println(line)  // Stdout only - NO file.write()\n}\n```\n\nRuntime test structure:\n```gleam\npub fn phase0_runtime_spawn_test() {\n  case get_env(\"PHASE0_RUNTIME\") {\n    Ok(\"1\") -\u003e run_spawn_test()\n    _ -\u003e record_phase0_skip(\"phase0_runtime_spawn_test\", \"PHASE0_RUNTIME not set\")\n  }\n}\n```\n\n## Acceptance Criteria\n- Tests skip with stdout message when PHASE0_RUNTIME not set\n- Tests run and pass when PHASE0_RUNTIME=1\n- Validates: spawn port, read Data message, read ExitStatus message, close port\n- Validates: receive_timeout returns Timeout after exit\n- Cross-platform support (Unix/Windows via os:type detection)\n- No file writes - skip messages go to stdout only\n\n## Verification\n- gleam test passes (with skips) when PHASE0_RUNTIME not set\n- PHASE0_RUNTIME=1 gleam test passes on Linux/macOS\n- Skip messages visible: [SKIP:PHASE0] test_name: reason","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T23:23:13.502252926Z","created_by":"cyou","updated_at":"2026-01-11T00:10:28.286091447Z","closed_at":"2026-01-11T00:10:28.286091447Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-va1.6","depends_on_id":"casg-va1","type":"parent-child","created_at":"2026-01-10T23:23:13.502828162Z","created_by":"cyou"},{"issue_id":"casg-va1.6","depends_on_id":"casg-va1.3","type":"blocks","created_at":"2026-01-10T23:23:48.296476981Z","created_by":"cyou"},{"issue_id":"casg-va1.6","depends_on_id":"casg-va1.4","type":"blocks","created_at":"2026-01-10T23:23:48.825965991Z","created_by":"cyou"}]}
{"id":"casg-va1.7","title":"Create Phase 0 confirmation artifact and document verified imports","description":"## Goal\nCreate the Phase 0 confirmation artifact documenting validation results and create the confirmed_imports.gleam file for other modules to reference.\n\n## Context\nPlan reference: Phase 0 Confirmation artifact, Confirmed imports file\n\nThis is the final Phase 0 deliverable that certifies the FFI layer is working and documents verified API imports.\n\n## TDD Steps\n1. Run all Phase 0 tests (compile + runtime)\n2. Create src/claude_agent_sdk/internal/confirmed_imports.gleam with verified imports\n3. Create Phase 0 confirmation markdown artifact in plans/\n4. Commit manifest.toml (Gleam's lockfile)\n\n## Files\n- src/claude_agent_sdk/internal/confirmed_imports.gleam - [New] - Verified imports:\n  ```gleam\n  // Phase 0 verified these imports exist at pinned versions.\n  // All modules should import from here to ensure consistency.\n\n  // Standard library (verified at gleam_stdlib = 0.44.0)\n  import gleam/bit_array  // byte_size, from_string, to_string\n  import gleam/dynamic    // tuple2, string, int, bit_array\n  import gleam/regex      // from_string, scan\n  import gleam/result     // map, try, unwrap\n  import gleam/list       // map, filter, fold\n  import gleam/option     // Some, None, unwrap\n\n  // JSON (verified at gleam_json = 2.0.0)\n  import gleam/json       // decode, object, array, string, int\n  ```\n\n- plans/phase0-confirmation.md - [New] - Confirmation artifact:\n  ```markdown\n  # Phase 0 Confirmation\n  Date: YYYY-MM-DD\n  Environment: Linux/macOS/Windows, OTP version, Gleam version\n\n  ## Compile Check: PASS/FAIL\n  ## Runtime Port Test: PASS/SKIP (reason)\n  ## Notes: ...\n  ```\n\n- manifest.toml - [Commit] - Gleam lockfile for reproducible builds\n\n## Acceptance Criteria\n- confirmed_imports.gleam lists all verified stdlib imports\n- Phase 0 confirmation artifact documents test results\n- manifest.toml committed to version control\n- All imports verified against pinned dependency versions\n- Phase 0 complete - gate passed for subsequent implementation\n\n## Verification\n- gleam build succeeds with confirmed_imports.gleam\n- confirmation artifact has completed status\n- manifest.toml exists and is committed\n- No floating version ranges in gleam.toml (all = syntax)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:23:31.068383237Z","created_by":"cyou","updated_at":"2026-01-11T00:14:50.885136681Z","closed_at":"2026-01-11T00:14:50.885136681Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-va1.7","depends_on_id":"casg-va1","type":"parent-child","created_at":"2026-01-10T23:23:31.06954292Z","created_by":"cyou"},{"issue_id":"casg-va1.7","depends_on_id":"casg-va1.5","type":"blocks","created_at":"2026-01-10T23:23:49.301507089Z","created_by":"cyou"},{"issue_id":"casg-va1.7","depends_on_id":"casg-va1.6","type":"blocks","created_at":"2026-01-10T23:23:49.782969693Z","created_by":"cyou"}]}
{"id":"casg-va1.8","title":"[Review] 3 non-blocking findings from casg-va1.2","description":"## Review Findings\n\nThis issue consolidates 3 non-blocking findings from code review.\n\n**Source issue:** casg-va1.2\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P3] Unused import in phase0_compile_check_test.gleam\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** test/phase0_compile_check_test.gleam:10\n\nThe `port_ffi` module is imported at line 10 but never used in the test file. The compiler warning indicates this import should be removed or the test should actually use the imported module to verify FFI bindings.\n\n```gleam\nimport claude_agent_sdk/internal/port_ffi  // Line 10 - unused\n```\n\nThis suggests the test suite is incomplete - it should verify that the FFI bindings exist and are callable, which was the stated goal of Phase 0 compile checks.\n\n---\n\n### Finding 2: [P2] close_port drain may miss messages due to port_close timing\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk_ffi.erl:44-46\n\nIn `close_port/1`, the implementation calls `erlang:port_close(Port)` before draining messages:\n\n```erlang\nclose_port(Port) -\u003e\n    erlang:port_close(Port),\n    drain_port_messages(Port, 100).\n```\n\nOnce `port_close` is called, the port is closed and no new messages will be queued. However, there may be messages already in the mailbox that were sent before the close. The current implementation is correct for draining those existing messages.\n\nHowever, if the port sends final messages (like exit_status) at close time, there's a race condition where those messages might arrive between the close and the drain. The specification states the drain prevents \"infinite loops\" but doesn't address whether all final messages are guaranteed to be received.\n\nThis is not a critical bug since the bounded drain (100 iterations, 50ms timeout) prevents hangs, but it could lead to lost exit_status messages in edge cases.\n\n---\n\n### Finding 3: [P3] Decoder error messages discard underlying error details\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** src/claude_agent_sdk/internal/port_ffi.gleam:74-86\n\nIn `decode_port_message/1`, when decoding fails, the underlying error is discarded:\n\n```gleam\nOk(#(\"data\", payload)) -\u003e\n  case decode.run(payload, decode.bit_array) {\n    Ok(bytes) -\u003e Ok(Data(bytes))\n    Error(_) -\u003e Error(\"Invalid data payload: expected BitArray\")  // Line 76\n  }\n```\n\nThe `Error(_)` pattern throws away the actual decode error, which could contain useful debugging information about why the decode failed (e.g., \"expected BitArray but got integer 42\").\n\nWhile the fixed error messages are clear about what was expected, they don't include information about what was actually received. Consider preserving the error details:\n\n```gleam\nError(errors) -\u003e Error(\"Invalid data payload: expected BitArray. Details: \" \u003c\u003e string.inspect(errors))\n```\n\nThis applies to lines 76, 81, and 86.\n\n---\n\n\u003c!-- fp:42d8130dede63fa3 --\u003e\n\u003c!-- fp:37883c59be1b9c79 --\u003e\n\u003c!-- fp:62eb94ce1aefb51e --\u003e\n\u003c!-- review_finding:efd28601cced --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T23:58:58.570296321Z","created_by":"cyou","updated_at":"2026-01-11T00:01:28.281561539Z","closed_at":"2026-01-11T00:01:28.281561539Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-va1.2"],"dependencies":[{"issue_id":"casg-va1.8","depends_on_id":"casg-va1","type":"parent-child","created_at":"2026-01-10T23:58:58.570828588Z","created_by":"cyou"}]}
{"id":"casg-va1.9","title":"[Review] 3 non-blocking findings from casg-va1.5","description":"## Review Findings\n\nThis issue consolidates 3 non-blocking findings from code review.\n\n**Source issue:** casg-va1.5\n**Highest priority:** P3\n\n---\n\n### Finding 1: [P3] Tuple decoder test doesn't verify runtime behavior\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** test/phase0_compile_check_test.gleam:94-100\n\nThe `api_confirmation_test` function at lines 94-100 creates a tuple decoder but only assigns it to `_` without testing it. The comment states \"Can't create Dynamic tuples directly, so we verify the decoder compiles\" - but this is only a compile-time check, not a runtime confirmation as the function name suggests.\n\nWhile the decoder does get tested indirectly in `port_ffi.gleam`, the test structure is misleading. Consider either:\n1. Moving this to `api_exists_compile_check_test` since it's a compile-time check\n2. Removing it entirely since the port_ffi tests already verify tuple decoding\n3. Adding a comment explaining that runtime tuple decoding is verified in port_ffi tests\n\n---\n\n### Finding 2: [P3] Missing regex API checks mentioned in requirements\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** test/phase0_compile_check_test.gleam:29-54\n\nThe implementation context and task description specify verifying `regex.from_string` and `regex.scan` APIs, but these are not included in the compile check tests. The task description states:\n\n```\napi_exists_compile_check_test() - verifies stdlib APIs exist:\n  - regex.from_string, regex.scan\n```\n\nHowever, no regex imports or checks are present in the test file. While this may be intentional if regex is not actually needed, it creates a discrepancy between the documented requirements and the implementation.\n\nConsider either:\n1. Adding regex checks if they're actually needed\n2. Updating the task description to remove regex from the requirements\n\n---\n\n### Finding 3: [P3] Dynamic tuple test comment is misleading\n\n**Priority:** P3\n**Reviewer:** agent_sdk\n**Location:** test/phase0_compile_check_test.gleam:83-91\n\nAt line 83, the comment says \"decode a tagged tuple (simulates FFI message format)\" but the actual test at line 84 only creates a simple Dynamic string, not a tuple. The test is:\n\n```gleam\nlet tagged: Dynamic = dynamic.string(\"test_tag\")\nlet decoder = decode.string\n```\n\nThis doesn't test tuple decoding at all - it just tests string decoding. The comment implies this is testing the FFI message format (which uses 2-tuples), but the actual code doesn't match.\n\nConsider updating the comment to accurately reflect what's being tested, e.g., \"Test basic dynamic string decoding\"\n\n---\n\n\u003c!-- fp:d31039693df72571 --\u003e\n\u003c!-- fp:b7e82da20f6d6771 --\u003e\n\u003c!-- fp:f605cb0c5ca4140e --\u003e\n\u003c!-- review_finding:fe1b213cd81b --\u003e","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-11T00:06:25.315249199Z","created_by":"cyou","updated_at":"2026-01-11T00:09:01.919849679Z","closed_at":"2026-01-11T00:09:01.919849679Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-va1.5"],"dependencies":[{"issue_id":"casg-va1.9","depends_on_id":"casg-va1","type":"parent-child","created_at":"2026-01-11T00:06:25.315751736Z","created_by":"cyou"}]}
{"id":"casg-wbu","title":"[P3] Documentation still references removed {packet, 0} option","description":"## Review Finding\n\n**Priority:** P3\n**Trigger:** run_end\n**Baseline:** 6b1bc9c..548f92b\n**Location:** src/claude_agent_sdk_ffi.erl:47\n\n---\n\nThe `{packet, 0}` option was correctly removed from `open_port_bidir`, but the documentation comments still reference it. Line 47 in `claude_agent_sdk_ffi.erl` says `{packet, 0}: raw binary mode, no framing` and line 40 in `bidir_runner.gleam` also mentions `{packet, 0}`. These stale comments could confuse developers reading the code.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-12T07:42:41.742381856Z","created_by":"cyou","updated_at":"2026-01-12T15:09:34.235769319Z","closed_at":"2026-01-12T15:09:34.235769319Z","close_reason":"Closed","labels":["auto_generated","cumulative-review","fp:c11bed168ab507b6","review_finding","trigger:run_end"]}
{"id":"casg-wh8","title":"[Review] 1 non-blocking finding from casg-bev","description":"## Review Findings\n\nThis issue consolidates 1 non-blocking finding from code review.\n\n**Source issue:** casg-bev\n**Highest priority:** P2\n\n---\n\n### Finding 1: [P2] Test doesn't verify actual query() behavior\n\n**Priority:** P2\n**Reviewer:** agent_sdk\n**Location:** test/query_integration_test.gleam:559-577\n\nThe test `test_mode_without_runner_returns_error_test()` only verifies that `TestModeError` can be pattern matched, but doesn't actually call `query()` to verify the defensive check works. The test comment at line 560 says \"Create options with test_mode=True but no runner\" but then just constructs the error directly.\n\nSince Gleam allows direct construction of public types, users can write:\n```gleam\nQueryOptions(..default_options(), test_mode: True, test_runner: None)\n```\n\nThe test should actually call `query()` with manually constructed misconfigured options to verify the early validation at src/claude_agent_sdk.gleam:330-336 works correctly.\n\n---\n\n\u003c!-- fp:968140003f0ec4ba --\u003e\n\u003c!-- review_finding:1387a8744d46 --\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T05:04:46.195708314Z","created_by":"cyou","updated_at":"2026-01-11T05:08:43.145743922Z","closed_at":"2026-01-11T05:08:43.145743922Z","close_reason":"Closed","labels":["auto_generated","review_finding","source:casg-bev"]}
{"id":"casg-xjv","title":"Epic: Achieve full unit coverage (no mocks) + comprehensive E2E integration suite","description":"Goal: verify and reach full unit test coverage without mocks/fakes, and add end-to-end integration scripts with detailed logging. This epic tracks audit, policy decisions, refactors, coverage instrumentation, and E2E harness.","notes":"SELF-DOC UPDATE (2026-01-11)\nCONTEXT:\n- This epic captures the repo-wide shift to strict no-mock unit testing + a real E2E integration suite.\n- Policy and inventory are codified in `plans/testing-policy.md` and `plans/testing-inventory.md`.\n- The intent is high confidence without brittle fakes while still validating real CLI/port boundaries.\n\nGOAL / OUTCOME:\n- Full unit coverage for pure logic (per policy thresholds) with no test_runner/ETS mocks.\n- A scripted E2E harness with structured JSONL logs, artifacts, and CI opt-in gating.\n- Clear docs so future work can resume without conversation context.\n\nSCOPE / NON-GOALS:\n- Unit tests avoid real CLI and avoid mock runners; integration/E2E handle CLI/port boundaries.\n- This epic itself does not edit files; it is the organizing umbrella.\n\nSUBTASK MAP (children):\n- casg-xjv.1 (closed): define no-mock policy and test category boundaries.\n- casg-xjv.3 (closed): inventory tests and existing mock usage.\n- casg-xjv.2: coverage instrumentation + reporting.\n- casg-xjv.4: gap analysis vs policy and critical paths.\n- casg-xjv.5: design non-mock stream/runner test strategy.\n- casg-xjv.6: rewrite stream tests (remove test_runner/ETS).\n- casg-xjv.7: rewrite resource/cleanup tests (remove test_runner/ETS).\n- casg-xjv.8: decide test_runner policy (deprecate/isolate) and doc update.\n- casg-xjv.9: remove decoder test skips + expand fixtures.\n- casg-xjv.10 (closed): define E2E scenarios.\n- casg-xjv.11: implement E2E runner scripts + structured logs.\n- casg-xjv.12: E2E artifacts/retention + triage guidance.\n- casg-xjv.13: integrate E2E scripts into CI (opt-in gating).\n- casg-xjv.14 (closed): doc policy.\n- casg-xjv.15 (closed): doc E2E runbook.\n\nDEPENDENCY OVERLAY (high-level order):\n- Policy + inventory first (done) -\u003e coverage instrumentation -\u003e gap analysis -\u003e decoder test un-gating.\n- Stream/runner strategy -\u003e stream/resource test rewrites.\n- E2E scenarios -\u003e runner scripts -\u003e CI integration -\u003e artifacts + triage docs.\n\nCONSIDERATIONS / RATIONALE:\n- Avoid flaky tests by using deterministic helper binaries for port_ffi paths.\n- Keep integration/E2E behind explicit env gates with clear skip messaging.\n- Document decisions so future contributors understand why mocks were removed.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-11T04:19:12.027296528Z","created_by":"cyou","updated_at":"2026-01-11T04:59:56.77888291Z","closed_at":"2026-01-11T04:59:56.77888291Z","close_reason":"Closed"}
{"id":"casg-xjv.1","title":"Define test policy: 'no mocks/fakes' scope, unit/integration/e2e criteria","description":"Decide what counts as a mock/fake and whether any test doubles are acceptable (e.g., real OS ports vs. local CLI harness). Define success criteria for \"full unit coverage\" (line/branch? public API? error paths). Clarify how env-gated tests (CLAUDE_INTEGRATION_TEST, PHASE0_RUNTIME, DECODER_IMPLEMENTED) fit into the policy. Output: written policy + acceptance checklist.","notes":"DOC: plans/testing-policy.md (policy + acceptance criteria)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-11T04:19:28.520731414Z","created_by":"cyou","updated_at":"2026-01-11T04:30:25.468988096Z","closed_at":"2026-01-11T04:30:25.468988096Z","close_reason":"Completed: documented no-mock policy and acceptance criteria in plans/testing-policy.md","dependencies":[{"issue_id":"casg-xjv.1","depends_on_id":"casg-xjv","type":"parent-child","created_at":"2026-01-11T04:19:28.52143969Z","created_by":"cyou"}]}
{"id":"casg-xjv.10","title":"Define E2E integration scenarios and required environment","description":"Enumerate end-to-end flows (auth preflight, simple query, session resume, error paths, NDJSON purity, CLI version edge cases). Specify required env vars, credentials, and prerequisites. Output: scenario list + success criteria.","notes":"DOC: plans/e2e-scenarios.md (scenario definitions + prerequisites)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-11T04:20:49.01585305Z","created_by":"cyou","updated_at":"2026-01-11T04:30:35.602948261Z","closed_at":"2026-01-11T04:30:35.602948261Z","close_reason":"Completed: E2E scenarios + prerequisites in plans/e2e-scenarios.md","dependencies":[{"issue_id":"casg-xjv.10","depends_on_id":"casg-xjv","type":"parent-child","created_at":"2026-01-11T04:20:49.016470817Z","created_by":"cyou"}]}
{"id":"casg-xjv.11","title":"Implement E2E runner scripts with structured, detailed logging","description":"Create scripts (e.g., in scripts/e2e/) to run scenarios with verbose, timestamped logs: command lines, env, CLI version, stdout/stderr capture, and step timing. Prefer JSONL log format plus human-readable summary. Output: runnable script + sample logs.","notes":"SELF-DOC UPDATE (2026-01-11)\nCONTEXT:\n- E2E scenarios are defined in `plans/e2e-scenarios.md` and require a runnable harness.\n- Logging design is specified in `plans/e2e-logging-design.md` and needs implementation.\n\nGOAL / OUTCOME:\n- A runnable E2E script suite that executes scenarios and emits structured JSONL logs + summaries.\n- Logs must be rich enough for CI triage and safe (redacted secrets).\n\nSUBTASKS:\n- Implement runner script(s) under `scripts/e2e/` with scenario selection and gating.\n- Emit JSONL events per logging schema and write human-readable summary.\n- Capture redacted stdout/stderr and metadata (CLI version, OS, run_id).\n\nFILES (planned):\n- `scripts/e2e/` (new) including runner + helpers.\n- `scripts/e2e/README.md` (usage + examples).\n- `artifacts/e2e/` output directory (runtime only, not committed).\n\nDEPENDENCIES:\n- Depends on casg-xjv.10 (scenario definitions) and casg-xjv (epic).\n- Blocks casg-xjv.12 and casg-xjv.13 (both rely on runner output/artifacts).\n\nCONSIDERATIONS:\n- Ensure redaction rules for secrets and long-line truncation.\n- Keep output deterministic and stable for CI parsing.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-11T04:20:57.187397889Z","created_by":"cyou","updated_at":"2026-01-11T05:04:31.305196269Z","closed_at":"2026-01-11T05:04:31.305196269Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-xjv.11","depends_on_id":"casg-xjv","type":"parent-child","created_at":"2026-01-11T04:20:57.187972285Z","created_by":"cyou"},{"issue_id":"casg-xjv.11","depends_on_id":"casg-xjv.10","type":"blocks","created_at":"2026-01-11T04:22:29.567984985Z","created_by":"cyou"}]}
{"id":"casg-xjv.12","title":"Add E2E log artifacts, retention, and failure triage guidance","description":"Capture logs as CI artifacts; define retention policy and how to redact secrets. Add troubleshooting doc for common failures (CLI missing, auth, NDJSON impurity). Output: docs + CI artifact config.","notes":"SELF-DOC UPDATE (2026-01-11)\nCONTEXT:\n- Once E2E runner scripts exist, we need CI artifact capture + documentation for triage.\n- Logging design (plans/e2e-logging-design.md) specifies artifacts and retention expectations.\n\nGOAL / OUTCOME:\n- CI uploads E2E artifacts (events.jsonl, summary, stdout/stderr, metadata).\n- A concise triage guide explaining common failures and remediation steps.\n\nSUBTASKS:\n- Add artifact upload to CI for E2E runs, with retention policy.\n- Define redaction rules and confirm no secrets are stored.\n- Write a triage doc covering CLI missing, auth missing, NDJSON impurity, and timeouts.\n\nFILES (planned):\n- `.github/workflows/test.yml` (artifact upload + retention settings).\n- `docs/e2e-triage.md` (new) for troubleshooting guidance.\n\nDEPENDENCIES:\n- Depends on casg-xjv.11 (runner output format) and casg-xjv.13 (CI job wiring).\n\nCONSIDERATIONS:\n- Upload artifacts for failed runs at minimum; optional for all runs if cost allows.\n- Ensure artifact paths align with the runner's output directory structure.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T04:21:06.255696267Z","created_by":"cyou","updated_at":"2026-01-11T05:10:08.837615482Z","closed_at":"2026-01-11T05:10:08.837615482Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-xjv.12","depends_on_id":"casg-xjv","type":"parent-child","created_at":"2026-01-11T04:21:06.256230374Z","created_by":"cyou"},{"issue_id":"casg-xjv.12","depends_on_id":"casg-xjv.11","type":"blocks","created_at":"2026-01-11T04:22:34.63905913Z","created_by":"cyou"},{"issue_id":"casg-xjv.12","depends_on_id":"casg-xjv.13","type":"blocks","created_at":"2026-01-11T04:46:08.377653824Z","created_by":"cyou"}]}
{"id":"casg-xjv.13","title":"Integrate E2E scripts into CI with opt-in gating","description":"Wire E2E runner into CI (manual/cron/label-based). Ensure secrets handling, env gating, and clear skip messaging. Output: CI job + README updates for running locally and in CI.","notes":"SELF-DOC UPDATE (2026-01-11)\nCONTEXT:\n- E2E scripts need CI integration with explicit gating to avoid running in every PR by default.\n- This is the wiring step that makes E2E runnable in CI without compromising security.\n\nGOAL / OUTCOME:\n- A CI job that can run E2E scenarios when opt-in conditions are met (label/manual/cron).\n- Clear documentation for local and CI execution.\n\nSUBTASKS:\n- Add an E2E job in `.github/workflows/test.yml` with gating env vars.\n- Ensure secrets handling is explicit and safe.\n- Provide clear skip messaging and instructions when gating is not satisfied.\n- Update README with how to run E2E locally and in CI.\n\nFILES (planned):\n- `.github/workflows/test.yml` (E2E job definition and gating).\n- `README.md` (user-facing run instructions).\n\nDEPENDENCIES:\n- Depends on casg-xjv.11 (runner scripts).\n- Blocks casg-xjv.12 because both touch CI workflow files.\n\nCONSIDERATIONS:\n- E2E should be opt-in to avoid flaky or secret-dependent failures on every PR.\n- Ensure environment variables are clearly documented.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T04:21:15.386651048Z","created_by":"cyou","updated_at":"2026-01-11T05:07:43.688226659Z","closed_at":"2026-01-11T05:07:43.688226659Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-xjv.13","depends_on_id":"casg-xjv","type":"parent-child","created_at":"2026-01-11T04:21:15.387193804Z","created_by":"cyou"},{"issue_id":"casg-xjv.13","depends_on_id":"casg-xjv.11","type":"blocks","created_at":"2026-01-11T04:22:39.706279826Z","created_by":"cyou"}]}
{"id":"casg-xjv.14","title":"Doc-only: Testing policy, coverage goals, and definitions","description":"Write doc describing test taxonomy (unit/integration/e2e), what counts as mock/fake, and coverage target definition. No code changes.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T04:24:02.336525258Z","created_by":"cyou","updated_at":"2026-01-11T04:24:50.532216043Z","closed_at":"2026-01-11T04:24:50.532216043Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-xjv.14","depends_on_id":"casg-xjv","type":"parent-child","created_at":"2026-01-11T04:24:02.337057655Z","created_by":"cyou"}]}
{"id":"casg-xjv.15","title":"Doc-only: E2E runbook with logging expectations","description":"Write E2E runbook: prerequisites, env vars, step-by-step runs, log format, redaction, and troubleshooting. No code changes.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T04:24:11.0998385Z","created_by":"cyou","updated_at":"2026-01-11T04:24:48.857792814Z","closed_at":"2026-01-11T04:24:48.857792814Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-xjv.15","depends_on_id":"casg-xjv","type":"parent-child","created_at":"2026-01-11T04:24:11.100478746Z","created_by":"cyou"}]}
{"id":"casg-xjv.2","title":"Baseline coverage instrumentation and reporting","description":"Investigate Gleam/Erlang coverage tooling (e.g., cover integration, test flags, CI artifacts). Add scripts/config to generate per-module and per-function coverage, plus summary thresholds. Output: repeatable command to produce coverage report + documented how-to.","notes":"SELF-DOC UPDATE (2026-01-11)\nCONTEXT:\n- Coverage baselining is required before we can identify gaps or enforce the no-mock coverage goals.\n- Output from this task feeds casg-xjv.4 (gap analysis) and informs future test additions.\n\nGOAL / OUTCOME:\n- A repeatable, documented coverage command that produces per-module and per-function coverage + summary totals.\n- A written baseline snapshot to compare against future changes.\n\nSUBTASKS:\n- Research Gleam/Erlang coverage options (cover, rebar3 cover, gleam test flags) and choose a stable path.\n- Implement a script/command wrapper with consistent output format.\n- Capture baseline metrics and document how to run + interpret results.\n\nFILES (planned):\n- `scripts/coverage.sh` (new) or similar helper.\n- `plans/coverage-reporting.md` (new) with run instructions and baseline numbers.\n- Avoid touching CI/workflows here to prevent overlap with E2E CI tasks.\n\nDEPENDENCIES:\n- Depends on policy definition (casg-xjv.1) and epic alignment (casg-xjv).\n- Blocks casg-xjv.4 (gap analysis).\n\nCONSIDERATIONS:\n- Coverage thresholds apply only to eligible pure modules (no port/CLI boundary code).\n- Keep generated coverage artifacts out of git; update `.gitignore` only if needed.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-11T04:19:36.492546608Z","created_by":"cyou","updated_at":"2026-01-11T05:14:48.361435658Z","closed_at":"2026-01-11T05:14:48.361435658Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-xjv.2","depends_on_id":"casg-xjv","type":"parent-child","created_at":"2026-01-11T04:19:36.493036345Z","created_by":"cyou"},{"issue_id":"casg-xjv.2","depends_on_id":"casg-xjv.1","type":"blocks","created_at":"2026-01-11T04:21:33.788995148Z","created_by":"cyou"}]}
{"id":"casg-xjv.3","title":"Inventory existing tests, mocks, and env-gated skips","description":"Catalog all test modules and classify: pure unit, integration, phase0 runtime, decoder-skipped, etc. Identify mock/fake usage (test_runner, ETS helpers, process dictionary, stubbed ports) and where real OS ports are used. Output: matrix of tests vs modules/features, with mock usage flagged.","notes":"DOC: plans/testing-inventory.md (current tests + mock usage matrix)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-11T04:19:45.921250788Z","created_by":"cyou","updated_at":"2026-01-11T04:30:30.533763331Z","closed_at":"2026-01-11T04:30:30.533763331Z","close_reason":"Completed: test inventory + mock usage matrix in plans/testing-inventory.md","dependencies":[{"issue_id":"casg-xjv.3","depends_on_id":"casg-xjv","type":"parent-child","created_at":"2026-01-11T04:19:45.921820564Z","created_by":"cyou"},{"issue_id":"casg-xjv.3","depends_on_id":"casg-xjv.1","type":"blocks","created_at":"2026-01-11T04:21:38.857609705Z","created_by":"cyou"}]}
{"id":"casg-xjv.4","title":"Coverage gap analysis against policy and critical paths","description":"Use coverage report + test inventory to identify untested modules, branches, and error paths. Highlight SDK critical paths (query/stream lifecycle, decoder, options, FFI bindings) and map to tests. Output: prioritized gap list with proposed test additions.","notes":"SELF-DOC UPDATE (2026-01-11)\nCONTEXT:\n- After coverage instrumentation (casg-xjv.2) and the test inventory (casg-xjv.3), we need a concrete gap list.\n- This is the prioritization step that turns policy into actionable test work.\n\nGOAL / OUTCOME:\n- A prioritized list of untested modules/branches with links to the policy-critical paths.\n- A clear mapping from missing coverage to specific tests or refactors needed.\n\nSUBTASKS:\n- Run coverage baseline and map coverage to modules/functions.\n- Cross-check against `plans/testing-inventory.md` to spot missing or misclassified tests.\n- Identify critical path areas (query/stream lifecycle, decoder behavior, options, FFI boundaries).\n- Produce a ranked gap list with recommended next steps.\n\nFILES (planned):\n- `plans/testing-gaps.md` (new) as the canonical gap report.\n- Avoid editing `plans/testing-inventory.md` unless factual corrections are needed (to minimize overlap).\n\nDEPENDENCIES:\n- Depends on casg-xjv.2 (coverage baseline) and casg-xjv.3 (inventory).\n- Blocks casg-xjv.9 (decoder skip removal + fixture completeness).\n\nCONSIDERATIONS:\n- Do not treat port/CLI boundary code as unit-coverage targets; those belong to phase0/integration/E2E.\n- Ensure gap list is actionable (each item tied to a specific file/function and test type).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-11T04:19:53.933047644Z","created_by":"cyou","updated_at":"2026-01-11T05:19:12.258424724Z","closed_at":"2026-01-11T05:19:12.258424724Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-xjv.4","depends_on_id":"casg-xjv","type":"parent-child","created_at":"2026-01-11T04:19:53.933551121Z","created_by":"cyou"},{"issue_id":"casg-xjv.4","depends_on_id":"casg-xjv.2","type":"blocks","created_at":"2026-01-11T04:21:43.926830397Z","created_by":"cyou"},{"issue_id":"casg-xjv.4","depends_on_id":"casg-xjv.3","type":"blocks","created_at":"2026-01-11T04:21:49.002124831Z","created_by":"cyou"}]}
{"id":"casg-xjv.5","title":"Design non-mock testing strategy for stream/runner paths","description":"Propose how to test stream semantics and runner behavior without mocks/fakes: options include real port_ffi to /bin/echo, deterministic local helper binary, or recorded CLI sessions. Evaluate feasibility vs policy and document risks (platform variance, flakiness). Output: agreed approach + test harness design.","notes":"DOC: plans/non-mock-testing-strategy.md (strategy + acceptance criteria)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-11T04:20:03.002125008Z","created_by":"cyou","updated_at":"2026-01-11T04:57:00.443976996Z","closed_at":"2026-01-11T04:57:00.443976996Z","close_reason":"Completed: documented non-mock testing strategy in plans/non-mock-testing-strategy.md","dependencies":[{"issue_id":"casg-xjv.5","depends_on_id":"casg-xjv","type":"parent-child","created_at":"2026-01-11T04:20:03.002654745Z","created_by":"cyou"},{"issue_id":"casg-xjv.5","depends_on_id":"casg-xjv.1","type":"blocks","created_at":"2026-01-11T04:21:54.07601915Z","created_by":"cyou"},{"issue_id":"casg-xjv.5","depends_on_id":"casg-xjv.3","type":"blocks","created_at":"2026-01-11T04:21:59.151891365Z","created_by":"cyou"}]}
{"id":"casg-xjv.6","title":"Replace mock-based stream semantics tests with non-mock equivalents","description":"Convert test_runner-based stream tests to use the approved non-mock strategy (real port_ffi or deterministic helper). Ensure NDJSON parsing, buffer overflow, exit-status handling, and result sequencing are covered without fake runners.","notes":"SELF-DOC UPDATE (2026-01-11)\nCONTEXT:\n- `test/stream_test.gleam` currently contains a section of test_runner + ETS-based stream semantics tests.\n- Policy prohibits mocks/fakes for stream behavior; we need to replace these with real port_ffi behavior.\n\nGOAL / OUTCOME:\n- Stream semantics tests that exercise real port_ffi behavior (no test_runner or ETS).\n- Coverage for NDJSON parsing, buffer overflow, exit status handling, and Result sequencing.\n\nSUBTASKS:\n- Identify the test_runner-based section in `test/stream_test.gleam` and remove it.\n- Implement equivalent tests using the strategy defined in casg-xjv.5.\n- Add deterministic helper(s) in test/support if needed.\n- Ensure tests are stable on Unix and Windows (conditional path handling if required).\n\nFILES (planned):\n- `test/stream_test.gleam` (primary rewrite).\n- `test/support/stream_helpers.gleam` (new helper module) and/or `test/support/port_helpers.gleam`.\n- Avoid touching shared helpers like `test/support/ets_helpers.gleam` to minimize cross-task overlap.\n\nDEPENDENCIES:\n- Depends on casg-xjv.5 (non-mock strategy).\n- This task blocks casg-47z because both will touch `test/stream_test.gleam`.\n\nCONSIDERATIONS:\n- Preserve existing test coverage intent while swapping out the runner implementation.\n- Keep the tests fast; use a tiny helper binary rather than real CLI.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-11T04:20:12.247229275Z","created_by":"cyou","updated_at":"2026-01-11T05:07:16.968372788Z","closed_at":"2026-01-11T05:07:16.968372788Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-xjv.6","depends_on_id":"casg-xjv","type":"parent-child","created_at":"2026-01-11T04:20:12.247903251Z","created_by":"cyou"},{"issue_id":"casg-xjv.6","depends_on_id":"casg-xjv.5","type":"blocks","created_at":"2026-01-11T04:22:04.221895142Z","created_by":"cyou"}]}
{"id":"casg-xjv.7","title":"Replace mock-based resource/cleanup tests with non-mock equivalents","description":"Refactor tests in test/resource_test.gleam (and any close-tracking ETS mocks) to validate close/cleanup behavior using real ports or deterministic helpers, aligned with non-mock policy.","notes":"SELF-DOC UPDATE (2026-01-11)\nCONTEXT:\n- `test/resource_test.gleam` uses test_runner + ETS to simulate close/cleanup behavior.\n- No-mock policy requires these tests to use real port/runner behavior instead.\n\nGOAL / OUTCOME:\n- Resource/cleanup tests rewritten to use real port_ffi interactions (or helper binary) without mocks.\n- Maintain coverage of close idempotency, resource lifecycle, and cleanup behavior.\n\nSUBTASKS:\n- Replace ETS-backed test_runner usage with the chosen non-mock strategy.\n- Add a small helper module for resource/cleanup test utilities.\n- Verify all resource tests pass without environment gating.\n\nFILES (planned):\n- `test/resource_test.gleam` (primary rewrite).\n- `test/support/resource_helpers.gleam` (new helper module for deterministic port usage).\n- Avoid shared helper edits to reduce overlap with other tasks.\n\nDEPENDENCIES:\n- Depends on casg-xjv.5 (non-mock strategy).\n\nCONSIDERATIONS:\n- Ensure cleanup is deterministic and does not leak ports or ETS state.\n- Keep runtime behavior consistent across platforms.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-11T04:20:21.060598435Z","created_by":"cyou","updated_at":"2026-01-11T05:06:25.809096669Z","closed_at":"2026-01-11T05:06:25.809096669Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-xjv.7","depends_on_id":"casg-xjv","type":"parent-child","created_at":"2026-01-11T04:20:21.061267551Z","created_by":"cyou"},{"issue_id":"casg-xjv.7","depends_on_id":"casg-xjv.5","type":"blocks","created_at":"2026-01-11T04:22:09.289470602Z","created_by":"cyou"}]}
{"id":"casg-xjv.8","title":"Evaluate test_runner usage and decide deprecation or isolation","description":"Identify all unit tests using test_runner() and decide whether to remove, rewrite, or reclassify as integration. Update docs to reflect new policy and ensure production API remains unchanged.","notes":"DOC: plans/test-runner-deprecation.md (evaluation + plan)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-11T04:20:30.885158183Z","created_by":"cyou","updated_at":"2026-01-11T04:57:05.519652454Z","closed_at":"2026-01-11T04:57:05.519652454Z","close_reason":"Completed: documented test_runner evaluation/deprecation plan in plans/test-runner-deprecation.md","dependencies":[{"issue_id":"casg-xjv.8","depends_on_id":"casg-xjv","type":"parent-child","created_at":"2026-01-11T04:20:30.88571104Z","created_by":"cyou"},{"issue_id":"casg-xjv.8","depends_on_id":"casg-xjv.1","type":"blocks","created_at":"2026-01-11T04:22:14.353026534Z","created_by":"cyou"},{"issue_id":"casg-xjv.8","depends_on_id":"casg-xjv.3","type":"blocks","created_at":"2026-01-11T04:22:19.423837729Z","created_by":"cyou"}]}
{"id":"casg-xjv.9","title":"Remove decoder test skips and ensure full fixture coverage","description":"Flip DECODER_IMPLEMENTED gating by ensuring decoders are complete and tests run by default. Validate all fixtures in test/fixtures and add missing edge cases.","notes":"SELF-DOC UPDATE (2026-01-11)\nCONTEXT:\n- Decoder tests are gated behind `DECODER_IMPLEMENTED`, which hides regressions.\n- We need full fixture coverage and default-on decoder tests once decoders are correct.\n\nGOAL / OUTCOME:\n- Remove the DECODER_IMPLEMENTED gate and run decoder tests by default.\n- Ensure fixtures cover all expected content block types and edge cases.\n\nSUBTASKS:\n- Audit existing fixtures in `test/fixtures/` for missing fields and edge cases.\n- Add missing fixtures (including negative cases) and update fixture README.\n- Enable decoder tests by default and ensure they pass.\n\nFILES (planned):\n- `test/json_decode_test.gleam` (remove skip gating, add coverage).\n- `test/fixtures/*.json` and `test/fixtures/README.md`.\n- `src/claude_agent_sdk/internal/decoder.gleam` only if fixes are required to pass tests.\n\nDEPENDENCIES:\n- Depends on casg-xjv.4 (gap analysis) and casg-xjv (epic).\n- Also depends on casg-m2h because both touch decoder tests/fixtures.\n\nCONSIDERATIONS:\n- Keep fixture data representative of real CLI output or spec-defined payloads.\n- Negative fixtures should assert errors for missing required fields (see casg-m2h).","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T04:20:39.568934995Z","created_by":"cyou","updated_at":"2026-01-11T06:06:56.012393419Z","closed_at":"2026-01-11T06:06:56.012393419Z","close_reason":"Closed","dependencies":[{"issue_id":"casg-xjv.9","depends_on_id":"casg-xjv","type":"parent-child","created_at":"2026-01-11T04:20:39.569490352Z","created_by":"cyou"},{"issue_id":"casg-xjv.9","depends_on_id":"casg-xjv.4","type":"blocks","created_at":"2026-01-11T04:22:24.492329805Z","created_by":"cyou"},{"issue_id":"casg-xjv.9","depends_on_id":"casg-m2h","type":"blocks","created_at":"2026-01-11T04:45:29.906621893Z","created_by":"cyou"}]}
